"use strict";var e,t,n=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.polyfill={}}var t=e.prototype;return t.set=function(e){this.platform=e,this.polyfill=e.polyfill},t.dispose=function(){var e;null===(e=this.platform)||void 0===e||e.dispose(),this.platform=null,this.polyfill=null},e}());function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}!function(e){e[e.Disjoint=0]="Disjoint",e[e.Contains=1]="Contains",e[e.Intersects=2]="Intersects"}(e||(e={})),function(e){e[e.Back=0]="Back",e[e.Front=1]="Front",e[e.Intersecting=2]="Intersecting"}(t||(t={}));var a=function(){function e(){}return e.clamp=function(e,t,n){return Math.max(t,Math.min(n,e))},e.equals=function(t,n){return Math.abs(t-n)<=e.zeroTolerance},e.isPowerOf2=function(e){return 0==(e&e-1)},e.radianToDegree=function(t){return t*e.radToDegreeFactor},e.degreeToRadian=function(t){return t*e.degreeToRadFactor},e}();a.zeroTolerance=1e-6,a.radToDegreeFactor=180/Math.PI,a.degreeToRadFactor=Math.PI/180;var o=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this._x=void 0,this._y=void 0,this._z=void 0,this._onValueChanged=null,this._x=e,this._y=t,this._z=n}e.add=function(e,t,n){n._x=e._x+t._x,n._y=e._y+t._y,n._z=e._z+t._z,n._onValueChanged&&n._onValueChanged()},e.subtract=function(e,t,n){n._x=e._x-t._x,n._y=e._y-t._y,n._z=e._z-t._z,n._onValueChanged&&n._onValueChanged()},e.multiply=function(e,t,n){n._x=e._x*t._x,n._y=e._y*t._y,n._z=e._z*t._z,n._onValueChanged&&n._onValueChanged()},e.divide=function(e,t,n){n._x=e._x/t._x,n._y=e._y/t._y,n._z=e._z/t._z,n._onValueChanged&&n._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z},e.cross=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=t._x,s=t._y,l=t._z;n.set(r*l-a*s,a*o-i*l,i*s-r*o)},e.distance=function(e,t){var n=t._x-e._x,i=t._y-e._y,r=t._z-e._z;return Math.sqrt(n*n+i*i+r*r)},e.distanceSquared=function(e,t){var n=t._x-e._x,i=t._y-e._y,r=t._z-e._z;return n*n+i*i+r*r},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)&&a.equals(e._z,t._z)},e.lerp=function(e,t,n,i){var r=e._x,a=e._y,o=e._z;i._x=r+(t._x-r)*n,i._y=a+(t._y-a)*n,i._z=o+(t._z-o)*n,i._onValueChanged&&i._onValueChanged()},e.max=function(e,t,n){n._x=Math.max(e._x,t._x),n._y=Math.max(e._y,t._y),n._z=Math.max(e._z,t._z),n._onValueChanged&&n._onValueChanged()},e.min=function(e,t,n){n._x=Math.min(e._x,t._x),n._y=Math.min(e._y,t._y),n._z=Math.min(e._z,t._z),n._onValueChanged&&n._onValueChanged()},e.negate=function(e,t){t._x=-e._x,t._y=-e._y,t._z=-e._z,t._onValueChanged&&t._onValueChanged()},e.normalize=function(e,t){var n=e._x,i=e._y,r=e._z,o=Math.sqrt(n*n+i*i+r*r);o>a.zeroTolerance&&(o=1/o,t.set(n*o,i*o,r*o))},e.scale=function(e,t,n){n._x=e._x*t,n._y=e._y*t,n._z=e._z*t,n._onValueChanged&&n._onValueChanged()},e.transformNormal=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=t.elements;n._x=i*o[0]+r*o[4]+a*o[8],n._y=i*o[1]+r*o[5]+a*o[9],n._z=i*o[2]+r*o[6]+a*o[10],n._onValueChanged&&n._onValueChanged()},e.transformToVec3=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=t.elements;n._x=i*o[0]+r*o[4]+a*o[8]+o[12],n._y=i*o[1]+r*o[5]+a*o[9]+o[13],n._z=i*o[2]+r*o[6]+a*o[10]+o[14],n._onValueChanged&&n._onValueChanged()},e.transformToVec4=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=t.elements;n._x=i*o[0]+r*o[4]+a*o[8]+o[12],n._y=i*o[1]+r*o[5]+a*o[9]+o[13],n._z=i*o[2]+r*o[6]+a*o[10]+o[14],n._w=i*o[3]+r*o[7]+a*o[11]+o[15],n._onValueChanged&&n._onValueChanged()},e.transformCoordinate=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=t.elements,s=i*o[3]+r*o[7]+a*o[11]+o[15];s=1/s,n._x=(i*o[0]+r*o[4]+a*o[8]+o[12])*s,n._y=(i*o[1]+r*o[5]+a*o[9]+o[13])*s,n._z=(i*o[2]+r*o[6]+a*o[10]+o[14])*s,n._onValueChanged&&n._onValueChanged()},e.transformByQuat=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=t._x,s=t._y,l=t._z,u=t._w,c=u*i+s*a-l*r,h=u*r+l*i-o*a,_=u*a+o*r-s*i,d=-o*i-s*r-l*a;n._x=c*u-d*o-h*l+_*s,n._y=h*u-d*s-_*o+c*l,n._z=_*u-d*l-c*s+h*o,n._onValueChanged&&n._onValueChanged()};var t=e.prototype;return t.set=function(e,t,n){return this._x=e,this._y=t,this._z=n,this._onValueChanged&&this._onValueChanged(),this},t.add=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._onValueChanged&&this._onValueChanged(),this},t.subtract=function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._onValueChanged&&this._onValueChanged(),this},t.multiply=function(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._onValueChanged&&this._onValueChanged(),this},t.divide=function(e){return this._x/=e._x,this._y/=e._y,this._z/=e._z,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y,n=this._z;return Math.sqrt(e*e+t*t+n*n)},t.lengthSquared=function(){var e=this._x,t=this._y,n=this._z;return e*e+t*t+n*n},t.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this._x*=e,this._y*=e,this._z*=e,this._onValueChanged&&this._onValueChanged(),this},t.transformNormal=function(t){return e.transformNormal(this,t,this),this},t.transformToVec3=function(t){return e.transformToVec3(this,t,this),this},t.transformCoordinate=function(t){return e.transformCoordinate(this,t,this),this},t.transformByQuat=function(t){return e.transformByQuat(this,t,this),this},t.clone=function(){return new e(this._x,this._y,this._z)},t.copyFrom=function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._onValueChanged&&this._onValueChanged(),this},t.copyFromArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._onValueChanged&&this._onValueChanged(),this},t.copyToArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z},r(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._onValueChanged&&this._onValueChanged()}}]),e}();o._zero=new o(0,0,0),o._one=new o(1,1,1),new o;var s=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.min=new o,this.max=new o,e&&this.min.copyFrom(e),t&&this.max.copyFrom(t)}e.fromCenterAndExtent=function(e,t,n){o.subtract(e,t,n.min),o.add(e,t,n.max)},e.fromPoints=function(e,t){if(!e||0===e.length)throw new Error("points must be array and length must > 0");var n=t.min,i=t.max;n.x=n.y=n.z=Number.MAX_VALUE,i.x=i.y=i.z=-Number.MAX_VALUE;for(var r=0,a=e.length;r<a;++r){var s=e[r];o.min(n,s,n),o.max(i,s,i)}},e.fromSphere=function(e,t){var n=e.center,i=e.radius,r=t.min,a=t.max;r.x=n.x-i,r.y=n.y-i,r.z=n.z-i,a.x=n.x+i,a.y=n.y+i,a.z=n.z+i},e.transform=function(t,n,i){var r=e._tempVec30,a=e._tempVec31;t.getCenter(r),t.getExtent(a),o.transformCoordinate(r,n,r);var s=a.x,l=a.y,u=a.z,c=n.elements;a.x=Math.abs(s*c[0])+Math.abs(l*c[4])+Math.abs(u*c[8]),a.y=Math.abs(s*c[1])+Math.abs(l*c[5])+Math.abs(u*c[9]),a.z=Math.abs(s*c[2])+Math.abs(l*c[6])+Math.abs(u*c[10]),o.subtract(r,a,i.min),o.add(r,a,i.max)},e.merge=function(e,t,n){return o.min(e.min,t.min,n.min),o.max(e.max,t.max,n.max),n};var t=e.prototype;return t.getCenter=function(e){return o.add(this.min,this.max,e),o.scale(e,.5,e),e},t.getExtent=function(e){return o.subtract(this.max,this.min,e),o.scale(e,.5,e),e},t.getCorners=function(e){void 0===e&&(e=[]);var t=this.min,n=this.max,i=t.x,r=t.y,a=t.z,s=n.x,l=n.y,u=n.z,c=e.length;if(c<8)for(var h=0,_=8-c;h<_;++h)e[c+h]=new o;return e[0].set(i,l,u),e[1].set(s,l,u),e[2].set(s,r,u),e[3].set(i,r,u),e[4].set(i,l,a),e[5].set(s,l,a),e[6].set(s,r,a),e[7].set(i,r,a),e},t.transform=function(t){return e.transform(this,t,this),this},t.clone=function(){return new e(this.min,this.max)},t.copyFrom=function(e){return this.min.copyFrom(e.min),this.max.copyFrom(e.max),this},e}();s._tempVec30=new o,s._tempVec31=new o;var l=function(){function n(){}return n.distancePlaneAndPoint=function(e,t){return o.dot(e.normal,t)+e.distance},n.intersectsPlaneAndPoint=function(e,i){var r=n.distancePlaneAndPoint(e,i);return r>0?t.Front:r<0?t.Back:t.Intersecting},n.intersectsPlaneAndBox=function(e,i){var r=i.min,a=i.max,o=e.normal,s=n._tempVec30,l=n._tempVec31;return o.x>=0?(s.x=a.x,l.x=r.x):(s.x=r.x,l.x=a.x),o.y>=0?(s.y=a.y,l.y=r.y):(s.y=r.y,l.y=a.y),o.z>=0?(s.z=a.z,l.z=r.z):(s.z=r.z,l.z=a.z),n.distancePlaneAndPoint(e,s)<0?t.Back:n.distancePlaneAndPoint(e,l)>0?t.Front:t.Intersecting},n.intersectsPlaneAndSphere=function(e,i){var r=i.center,a=i.radius,o=n.distancePlaneAndPoint(e,r);return o>a?t.Front:o<-a?t.Back:t.Intersecting},n.intersectsRayAndPlane=function(e,t){var n=t.normal,i=a.zeroTolerance,r=o.dot(n,e.direction);if(Math.abs(r)<i)return-1;var s=o.dot(n,e.origin),l=(-t.distance-s)/r;if(l<0){if(l<-i)return-1;l=0}return l},n.intersectsRayAndBox=function(e,t){var n=a.zeroTolerance,i=e.origin,r=e.direction,o=t.min,s=t.max,l=r.x,u=r.y,c=r.z,h=i.x,_=i.y,d=i.z,f=0,p=Number.MAX_VALUE;if(Math.abs(l)<n){if(h<o.x||h>s.x)return-1}else{var g=1/l,v=(o.x-h)*g,m=(s.x-h)*g;if(v>m){var y=v;v=m,m=y}if((f=Math.max(v,f))>(p=Math.min(m,p)))return-1}if(Math.abs(u)<n){if(_<o.y||_>s.y)return-1}else{var x=1/u,w=(o.y-_)*x,b=(s.y-_)*x;if(w>b){var C=w;w=b,b=C}if((f=Math.max(w,f))>(p=Math.min(b,p)))return-1}if(Math.abs(c)<n){if(d<o.z||d>s.z)return-1}else{var T=1/c,S=(o.z-d)*T,A=(s.z-d)*T;if(S>A){var P=S;S=A,A=P}if((f=Math.max(S,f))>(p=Math.min(A,p)))return-1}return f},n.intersectsRayAndSphere=function(e,t){var i=e.origin,r=e.direction,a=t.center,s=t.radius,l=n._tempVec30;o.subtract(i,a,l);var u=o.dot(l,r),c=o.dot(l,l)-s*s;if(u>0&&c>0)return-1;var h=u*u-c;if(h<0)return-1;var _=-u-Math.sqrt(h);return _<0&&(_=0),_},n.intersectsBoxAndBox=function(e,t){return!(e.min.x>t.max.x||t.min.x>e.max.x)&&(!(e.min.y>t.max.y||t.min.y>e.max.y)&&!(e.min.z>t.max.z||t.min.z>e.max.z))},n.intersectsSphereAndSphere=function(e,t){var n=e.radius+t.radius;return o.distanceSquared(e.center,t.center)<n*n},n.intersectsSphereAndBox=function(e,t){var i=e.center,r=t.max,a=t.min,s=n._tempVec30;return s.set(Math.max(a.x,Math.min(i.x,r.x)),Math.max(a.y,Math.min(i.y,r.y)),Math.max(a.z,Math.min(i.z,r.z))),o.distanceSquared(i,s)<=e.radius*e.radius},n.intersectsFrustumAndBox=function(e,t){for(var i=t.min,r=t.max,a=n._tempVec30,s=0;s<6;++s){var l=e.getPlane(s),u=l.normal;if(a.set(u.x>=0?i.x:r.x,u.y>=0?i.y:r.y,u.z>=0?i.z:r.z),o.dot(u,a)>-l.distance)return!1}return!0},n.frustumContainsBox=function(i,r){for(var a=r.min,o=r.max,s=n._tempVec30,l=n._tempVec31,u=e.Contains,c=0;c<6;++c){var h=i.getPlane(c),_=h.normal;if(_.x>=0?(s.x=o.x,l.x=a.x):(s.x=a.x,l.x=o.x),_.y>=0?(s.y=o.y,l.y=a.y):(s.y=a.y,l.y=o.y),_.z>=0?(s.z=o.z,l.z=a.z):(s.z=a.z,l.z=o.z),n.intersectsPlaneAndPoint(h,l)===t.Front)return e.Disjoint;n.intersectsPlaneAndPoint(h,s)===t.Front&&(u=e.Intersects)}return u},n.frustumContainsSphere=function(i,r){for(var a=e.Contains,o=0;o<6;++o){var s=i.getPlane(o),l=n.intersectsPlaneAndSphere(s,r);if(l===t.Front)return e.Disjoint;if(l===t.Intersecting){a=e.Intersects;break}}return a},n}();l._tempVec30=new o,l._tempVec31=new o;var u=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.normal=new o,this.distance=0,e&&this.normal.copyFrom(e),this.distance=t}e.normalize=function(e,t){var n=e.normal,i=1/n.length();o.scale(n,i,t.normal),t.distance=e.distance*i},e.fromPoints=function(e,t,n,i){var r=e.x,a=e.y,o=e.z,s=t.x-r,l=t.y-a,u=t.z-o,c=n.x-r,h=n.y-a,_=n.z-o,d=l*_-u*h,f=u*c-s*_,p=s*h-l*c,g=1/Math.sqrt(d*d+f*f+p*p),v=d*g,m=f*g,y=p*g,x=i.normal;x.x=v,x.y=m,x.z=y,i.distance=-(v*r+m*a+y*o)};var t=e.prototype;return t.normalize=function(){return e.normalize(this,this),this},t.clone=function(){var t=new e;return t.copyFrom(this),t},t.copyFrom=function(e){return this.normal.copyFrom(e.normal),this.distance=e.distance,this},e}(),c=function(){function t(e){void 0===e&&(e=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new u,this.far=new u,this.left=new u,this.right=new u,this.top=new u,this.bottom=new u,e&&this.calculateFromMatrix(e)}var n=t.prototype;return n.getPlane=function(e){switch(e){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},n.calculateFromMatrix=function(e){var t=e.elements,n=t[0],i=t[1],r=t[2],a=t[3],o=t[4],s=t[5],l=t[6],u=t[7],c=t[8],h=t[9],_=t[10],d=t[11],f=t[12],p=t[13],g=t[14],v=t[15];this.near.normal.set(-a-r,-u-l,-d-_),this.near.distance=-v-g,this.near.normalize(),this.far.normal.set(r-a,l-u,_-d),this.far.distance=g-v,this.far.normalize(),this.left.normal.set(-a-n,-u-o,-d-c),this.left.distance=-v-f,this.left.normalize(),this.right.normal.set(n-a,o-u,c-d),this.right.distance=f-v,this.right.normalize(),this.top.normal.set(i-a,s-u,h-d),this.top.distance=p-v,this.top.normalize(),this.bottom.normal.set(-a-i,-u-s,-d-h),this.bottom.distance=-v-p,this.bottom.normalize()},n.intersectsBox=function(e){return l.intersectsFrustumAndBox(this,e)},n.intersectsSphere=function(t){return l.frustumContainsSphere(this,t)!==e.Disjoint},n.clone=function(){var e=new t;return e.copyFrom(this),e},n.copyFrom=function(e){return this.near.copyFrom(e.near),this.far.copyFrom(e.far),this.left.copyFrom(e.left),this.right.copyFrom(e.right),this.top.copyFrom(e.top),this.bottom.copyFrom(e.bottom),this},t}(),h=function(){function e(e,t,n,i,r,a,o,s,l){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=1),this.elements=new Float32Array(9);var u=this.elements;u[0]=e,u[1]=t,u[2]=n,u[3]=i,u[4]=r,u[5]=a,u[6]=o,u[7]=s,u[8]=l}e.add=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]+r[0],a[1]=i[1]+r[1],a[2]=i[2]+r[2],a[3]=i[3]+r[3],a[4]=i[4]+r[4],a[5]=i[5]+r[5],a[6]=i[6]+r[6],a[7]=i[7]+r[7],a[8]=i[8]+r[8]},e.subtract=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements;a[0]=i[0]-r[0],a[1]=i[1]-r[1],a[2]=i[2]-r[2],a[3]=i[3]-r[3],a[4]=i[4]-r[4],a[5]=i[5]-r[5],a[6]=i[6]-r[6],a[7]=i[7]-r[7],a[8]=i[8]-r[8]},e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],c=i[4],h=i[5],_=i[6],d=i[7],f=i[8],p=r[0],g=r[1],v=r[2],m=r[3],y=r[4],x=r[5],w=r[6],b=r[7],C=r[8];a[0]=o*p+u*g+_*v,a[1]=s*p+c*g+d*v,a[2]=l*p+h*g+f*v,a[3]=o*m+u*y+_*x,a[4]=s*m+c*y+d*x,a[5]=l*m+h*y+f*x,a[6]=o*w+u*b+_*C,a[7]=s*w+c*b+d*C,a[8]=l*w+h*b+f*C},e.equals=function(e,t){var n=e.elements,i=t.elements;return a.equals(n[0],i[0])&&a.equals(n[1],i[1])&&a.equals(n[2],i[2])&&a.equals(n[3],i[3])&&a.equals(n[4],i[4])&&a.equals(n[5],i[5])&&a.equals(n[6],i[6])&&a.equals(n[7],i[7])&&a.equals(n[8],i[8])},e.lerp=function(e,t,n,i){var r=e.elements,a=t.elements,o=i.elements,s=1-n;o[0]=r[0]*s+a[0]*n,o[1]=r[1]*s+a[1]*n,o[2]=r[2]*s+a[2]*n,o[3]=r[3]*s+a[3]*n,o[4]=r[4]*s+a[4]*n,o[5]=r[5]*s+a[5]*n,o[6]=r[6]*s+a[6]*n,o[7]=r[7]*s+a[7]*n,o[8]=r[8]*s+a[8]*n},e.rotationQuaternion=function(e,t){var n=t.elements,i=e._x,r=e._y,a=e._z,o=e._w,s=i+i,l=r+r,u=a+a,c=i*s,h=r*s,_=r*l,d=a*s,f=a*l,p=a*u,g=o*s,v=o*l,m=o*u;n[0]=1-_-p,n[3]=h-m,n[6]=d+v,n[1]=h+m,n[4]=1-c-p,n[7]=f-g,n[2]=d-v,n[5]=f+g,n[8]=1-c-_},e.scaling=function(e,t){var n=t.elements;n[0]=e._x,n[1]=0,n[2]=0,n[3]=0,n[4]=e._y,n[5]=0,n[6]=0,n[7]=0,n[8]=1},e.translation=function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=1,n[5]=0,n[6]=e._x,n[7]=e._y,n[8]=1},e.invert=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],_=n[8],d=_*l-u*h,f=-_*s+u*c,p=h*s-l*c,g=r*d+a*f+o*p;g&&(g=1/g,i[0]=d*g,i[1]=(-_*a+o*h)*g,i[2]=(u*a-o*l)*g,i[3]=f*g,i[4]=(_*r-o*c)*g,i[5]=(-u*r+o*s)*g,i[6]=p*g,i[7]=(-h*r+a*c)*g,i[8]=(l*r-a*s)*g)},e.normalMatrix=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],_=n[8],d=n[9],f=n[10],p=n[11],g=n[12],v=n[13],m=n[14],y=n[15],x=r*u-a*l,w=r*c-o*l,b=r*h-s*l,C=a*c-o*u,T=a*h-s*u,S=o*h-s*c,A=_*v-d*g,P=_*m-f*g,M=_*y-p*g,E=d*m-f*v,F=d*y-p*v,R=f*y-p*m,L=x*R-w*F+b*E+C*M-T*P+S*A;if(!L)return null;L=1/L,i[0]=(u*R-c*F+h*E)*L,i[1]=(c*M-l*R-h*P)*L,i[2]=(l*F-u*M+h*A)*L,i[3]=(o*F-a*R-s*E)*L,i[4]=(r*R-o*M+s*P)*L,i[5]=(a*M-r*F-s*A)*L,i[6]=(v*S-m*T+y*C)*L,i[7]=(m*b-g*S-y*w)*L,i[8]=(g*T-v*b+y*x)*L},e.rotate=function(e,t,n){var i=e.elements,r=n.elements,a=Math.sin(t),o=Math.cos(t),s=i[0],l=i[1],u=i[2],c=i[3],h=i[4],_=i[5],d=i[6],f=i[7],p=i[8];r[0]=o*s+a*c,r[1]=o*l+a*h,r[2]=o*u+a*_,r[3]=o*c-a*s,r[4]=o*h-a*l,r[5]=o*_-a*u,r[6]=d,r[7]=f,r[8]=p},e.scale=function(e,t,n){var i=t._x,r=t._y,a=e.elements,o=n.elements;o[0]=i*a[0],o[1]=i*a[1],o[2]=i*a[2],o[3]=r*a[3],o[4]=r*a[4],o[5]=r*a[5],o[6]=a[6],o[7]=a[7],o[8]=a[8]},e.translate=function(e,t,n){var i=t._x,r=t._y,a=e.elements,o=n.elements,s=a[0],l=a[1],u=a[2],c=a[3],h=a[4],_=a[5],d=a[6],f=a[7],p=a[8];o[0]=s,o[1]=l,o[2]=u,o[3]=c,o[4]=h,o[5]=_,o[6]=i*s+r*c+d,o[7]=i*l+r*h+f,o[8]=i*u+r*_+p},e.transpose=function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[5];i[1]=n[3],i[2]=n[6],i[3]=r,i[5]=n[7],i[6]=a,i[7]=o}else i[0]=n[0],i[1]=n[3],i[2]=n[6],i[3]=n[1],i[4]=n[4],i[5]=n[7],i[6]=n[2],i[7]=n[5],i[8]=n[8]};var t=e.prototype;return t.set=function(e,t,n,i,r,a,o,s,l){var u=this.elements;return u[0]=e,u[1]=t,u[2]=n,u[3]=i,u[4]=r,u[5]=a,u[6]=o,u[7]=s,u[8]=l,this},t.add=function(t){return e.add(this,t,this),this},t.subtract=function(t){return e.subtract(this,t,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*(u*a-o*l)+n*(-u*r+o*s)+i*(l*r-a*s)},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotate=function(t){return e.rotate(this,t,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},t.copyFrom=function(e){var t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this},t.copyFromArray=function(e,t){void 0===t&&(t=0);for(var n=this.elements,i=0;i<12;i++)n[i]=e[i+t];return this},t.copyToArray=function(e,t){void 0===t&&(t=0);var n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8]},t.copyFromMatrix=function(e){var t=e.elements,n=this.elements;return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[4],n[4]=t[5],n[5]=t[6],n[6]=t[8],n[7]=t[9],n[8]=t[10],this},e}(),_=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=e,this._y=t,this._z=n,this._w=i}e.add=function(e,t,n){n._x=e._x+t._x,n._y=e._y+t._y,n._z=e._z+t._z,n._w=e._w+t._w,n._onValueChanged&&n._onValueChanged()},e.multiply=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=e._w,s=t._x,l=t._y,u=t._z,c=t._w;n._x=i*c+o*s+r*u-a*l,n._y=r*c+o*l+a*s-i*u,n._z=a*c+o*u+i*l-r*s,n._w=o*c-i*s-r*l-a*u,n._onValueChanged&&n._onValueChanged()},e.conjugate=function(e,t){t._x=-e._x,t._y=-e._y,t._z=-e._z,t._w=e._w,t._onValueChanged&&t._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)&&a.equals(e._z,t._z)&&a.equals(e._w,t._w)},e.rotationAxisAngle=function(t,n,i){var r=e._tempVector3;o.normalize(t,r),n*=.5;var a=Math.sin(n);i._x=r._x*a,i._y=r._y*a,i._z=r._z*a,i._w=Math.cos(n),i._onValueChanged&&i._onValueChanged()},e.rotationEuler=function(t,n,i,r){e.rotationYawPitchRoll(n,t,i,r)},e.rotationYawPitchRoll=function(e,t,n,i){var r=.5*n,a=.5*t,o=.5*e,s=Math.sin(r),l=Math.cos(r),u=Math.sin(a),c=Math.cos(a),h=Math.sin(o),_=Math.cos(o),d=_*c,f=h*u;i._x=_*u*l+h*c*s,i._y=h*c*l-_*u*s,i._z=d*s-f*l,i._w=d*l+f*s,i._onValueChanged&&i._onValueChanged()},e.rotationMatrix3x3=function(e,t){var n,i,r=e.elements,a=r[0],o=r[1],s=r[2],l=r[3],u=r[4],c=r[5],h=r[6],_=r[7],d=r[8],f=a+u+d;f>0?(n=Math.sqrt(f+1),t._w=.5*n,n=.5/n,t._x=(c-_)*n,t._y=(h-s)*n,t._z=(o-l)*n):a>=u&&a>=d?(i=.5/(n=Math.sqrt(1+a-u-d)),t._x=.5*n,t._y=(o+l)*i,t._z=(s+h)*i,t._w=(c-_)*i):u>d?(i=.5/(n=Math.sqrt(1+u-a-d)),t._x=(l+o)*i,t._y=.5*n,t._z=(_+c)*i,t._w=(h-s)*i):(i=.5/(n=Math.sqrt(1+d-a-u)),t._x=(s+h)*i,t._y=(c+_)*i,t._z=.5*n,t._w=(o-l)*i),t._onValueChanged&&t._onValueChanged()},e.invert=function(e,t){var n=e._x,i=e._y,r=e._z,o=e._w,s=n*n+i*i+r*r+o*o;if(s>a.zeroTolerance){var l=1/s;t._x=-n*l,t._y=-i*l,t._z=-r*l,t._w=o*l,t._onValueChanged&&t._onValueChanged()}},e.lerp=function(t,n,i,r){var a=1-i;e.dot(t,n)>=0?(r._x=t._x*a+n._x*i,r._y=t._y*a+n._y*i,r._z=t._z*a+n._z*i,r._w=t._w*a+n._w*i):(r._x=t._x*a-n._x*i,r._y=t._y*a-n._y*i,r._z=t._z*a-n._z*i,r._w=t._w*a-n._w*i),r.normalize()},e.slerp=function(e,t,n,i){var r,o,s=e._x,l=e._y,u=e._z,c=e._w,h=t._x,_=t._y,d=t._z,f=t._w,p=s*h+l*_+u*d+c*f;if(p<0&&(p=-p,h=-h,_=-_,d=-d,f=-f),1-p>a.zeroTolerance){var g=Math.acos(p),v=Math.sin(g);r=Math.sin((1-n)*g)/v,o=Math.sin(n*g)/v}else r=1-n,o=n;i._x=r*s+o*h,i._y=r*l+o*_,i._z=r*u+o*d,i._w=r*c+o*f,i._onValueChanged&&i._onValueChanged()},e.normalize=function(e,t){var n=e._x,i=e._y,r=e._z,o=e._w,s=Math.sqrt(n*n+i*i+r*r+o*o);s>a.zeroTolerance&&(s=1/s,t._x=n*s,t._y=i*s,t._z=r*s,t._w=o*s,t._onValueChanged&&t._onValueChanged())},e.rotationX=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t._x=n,t._y=0,t._z=0,t._w=i,t._onValueChanged&&t._onValueChanged()},e.rotationY=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t._x=0,t._y=n,t._z=0,t._w=i,t._onValueChanged&&t._onValueChanged()},e.rotationZ=function(e,t){e*=.5;var n=Math.sin(e),i=Math.cos(e);t._x=0,t._y=0,t._z=n,t._w=i,t._onValueChanged&&t._onValueChanged()},e.rotateX=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=e._w;t*=.5;var s=Math.sin(t),l=Math.cos(t);n._x=i*l+o*s,n._y=r*l+a*s,n._z=a*l-r*s,n._w=o*l-i*s,n._onValueChanged&&n._onValueChanged()},e.rotateY=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=e._w;t*=.5;var s=Math.sin(t),l=Math.cos(t);n._x=i*l-a*s,n._y=r*l+o*s,n._z=a*l+i*s,n._w=o*l-r*s,n._onValueChanged&&n._onValueChanged()},e.rotateZ=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=e._w;t*=.5;var s=Math.sin(t),l=Math.cos(t);n._x=i*l+r*s,n._y=r*l-i*s,n._z=a*l+o*s,n._w=o*l-a*s,n._onValueChanged&&n._onValueChanged()},e.scale=function(e,t,n){n._x=e._x*t,n._y=e._y*t,n._z=e._z*t,n._w=e._w*t,n._onValueChanged&&n._onValueChanged()};var t=e.prototype;return t.set=function(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onValueChanged&&this._onValueChanged(),this},t.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},t.getAxisAngle=function(e){var t=this._x,n=this._y,i=this._z,r=t*t+n*n+i*i;if(r<a.zeroTolerance)return e._x=1,e._y=0,e._z=0,0;var o=1/r;return e._x=this._x*o,e._y=this._y*o,e._z=this._z*o,2*Math.acos(this._w)},t.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y,n=this._z,i=this._w;return Math.sqrt(e*e+t*t+n*n+i*i)},t.lengthSquared=function(){var e=this._x,t=this._y,n=this._z,i=this._w;return e*e+t*t+n*n+i*i},t.normalize=function(){return e.normalize(this,this),this},t.toEuler=function(e){this._toYawPitchRoll(e);var t=e._x;return e._x=e._y,e._y=t,e._onValueChanged&&e._onValueChanged(),e},t.toYawPitchRoll=function(e){return this._toYawPitchRoll(e),e._onValueChanged&&e._onValueChanged(),e},t.rotateX=function(t){return e.rotateX(this,t,this),this},t.rotateY=function(t){return e.rotateY(this,t,this),this},t.rotateZ=function(t){return e.rotateZ(this,t,this),this},t.rotationAxisAngle=function(t,n){return e.rotationAxisAngle(t,n,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.invert=function(){return e.invert(this,this),this},t.dot=function(t){return e.dot(this,t)},t.lerp=function(t,n){return e.lerp(this,t,n,this),this},t.rotateAxisAngle=function(t,n){return e._tempQuat1.rotationAxisAngle(t,n),this.multiply(e._tempQuat1),this},t.clone=function(){return new e(this._x,this._y,this._z,this._w)},t.copyFrom=function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onValueChanged&&this._onValueChanged(),this},t.copyFromArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onValueChanged&&this._onValueChanged(),this},t.copyToArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w},t._toYawPitchRoll=function(e){var t=this._x,n=this._y,i=this._z,r=this._w,o=t*t,s=n*n,l=i*i,u=t*n,c=i*r,h=i*t,_=n*r,d=n*i,f=t*r;return e._y=Math.asin(2*(f-d)),Math.cos(e.y)>a.zeroTolerance?(e._z=Math.atan2(2*(u+c),1-2*(l+o)),e._x=Math.atan2(2*(h+_),1-2*(s+o))):(e._z=Math.atan2(-2*(u-c),1-2*(s+l)),e._x=0),e},r(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<a.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(e){this._w=e,this._onValueChanged&&this._onValueChanged()}}]),e}();_._tempVector3=new o,_._tempQuat1=new _;var d=function(){function e(e,t,n,i,r,a,o,s,l,u,c,h,_,d,f,p){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===c&&(c=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===p&&(p=1),this.elements=new Float32Array(16);var g=this.elements;g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=r,g[5]=a,g[6]=o,g[7]=s,g[8]=l,g[9]=u,g[10]=c,g[11]=h,g[12]=_,g[13]=d,g[14]=f,g[15]=p}e.multiply=function(e,t,n){var i=e.elements,r=t.elements,a=n.elements,o=i[0],s=i[1],l=i[2],u=i[3],c=i[4],h=i[5],_=i[6],d=i[7],f=i[8],p=i[9],g=i[10],v=i[11],m=i[12],y=i[13],x=i[14],w=i[15],b=r[0],C=r[1],T=r[2],S=r[3],A=r[4],P=r[5],M=r[6],E=r[7],F=r[8],R=r[9],L=r[10],D=r[11],B=r[12],I=r[13],O=r[14],z=r[15];a[0]=o*b+c*C+f*T+m*S,a[1]=s*b+h*C+p*T+y*S,a[2]=l*b+_*C+g*T+x*S,a[3]=u*b+d*C+v*T+w*S,a[4]=o*A+c*P+f*M+m*E,a[5]=s*A+h*P+p*M+y*E,a[6]=l*A+_*P+g*M+x*E,a[7]=u*A+d*P+v*M+w*E,a[8]=o*F+c*R+f*L+m*D,a[9]=s*F+h*R+p*L+y*D,a[10]=l*F+_*R+g*L+x*D,a[11]=u*F+d*R+v*L+w*D,a[12]=o*B+c*I+f*O+m*z,a[13]=s*B+h*I+p*O+y*z,a[14]=l*B+_*I+g*O+x*z,a[15]=u*B+d*I+v*O+w*z},e.equals=function(e,t){var n=e.elements,i=t.elements;return a.equals(n[0],i[0])&&a.equals(n[1],i[1])&&a.equals(n[2],i[2])&&a.equals(n[3],i[3])&&a.equals(n[4],i[4])&&a.equals(n[5],i[5])&&a.equals(n[6],i[6])&&a.equals(n[7],i[7])&&a.equals(n[8],i[8])&&a.equals(n[9],i[9])&&a.equals(n[10],i[10])&&a.equals(n[11],i[11])&&a.equals(n[12],i[12])&&a.equals(n[13],i[13])&&a.equals(n[14],i[14])&&a.equals(n[15],i[15])},e.lerp=function(e,t,n,i){var r=e.elements,a=t.elements,o=i.elements,s=1-n;o[0]=r[0]*s+a[0]*n,o[1]=r[1]*s+a[1]*n,o[2]=r[2]*s+a[2]*n,o[3]=r[3]*s+a[3]*n,o[4]=r[4]*s+a[4]*n,o[5]=r[5]*s+a[5]*n,o[6]=r[6]*s+a[6]*n,o[7]=r[7]*s+a[7]*n,o[8]=r[8]*s+a[8]*n,o[9]=r[9]*s+a[9]*n,o[10]=r[10]*s+a[10]*n,o[11]=r[11]*s+a[11]*n,o[12]=r[12]*s+a[12]*n,o[13]=r[13]*s+a[13]*n,o[14]=r[14]*s+a[14]*n,o[15]=r[15]*s+a[15]*n},e.rotationQuaternion=function(e,t){var n=t.elements,i=e._x,r=e._y,a=e._z,o=e._w,s=i+i,l=r+r,u=a+a,c=i*s,h=r*s,_=r*l,d=a*s,f=a*l,p=a*u,g=o*s,v=o*l,m=o*u;n[0]=1-_-p,n[1]=h+m,n[2]=d-v,n[3]=0,n[4]=h-m,n[5]=1-c-p,n[6]=f+g,n[7]=0,n[8]=d+v,n[9]=f-g,n[10]=1-c-_,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.rotationAxisAngle=function(e,t,n){var i,r,o,s=n.elements,l=e._x,u=e._y,c=e._z,h=Math.sqrt(l*l+u*u+c*c);Math.abs(h)<a.zeroTolerance||(l*=h=1/h,u*=h,c*=h,i=Math.sin(t),o=1-(r=Math.cos(t)),s[0]=l*l*o+r,s[1]=u*l*o+c*i,s[2]=c*l*o-u*i,s[3]=0,s[4]=l*u*o-c*i,s[5]=u*u*o+r,s[6]=c*u*o+l*i,s[7]=0,s[8]=l*c*o+u*i,s[9]=u*c*o-l*i,s[10]=c*c*o+r,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1)},e.rotationTranslation=function(t,n,i){e.rotationQuaternion(t,i);var r=i.elements;r[12]=n._x,r[13]=n._y,r[14]=n._z},e.affineTransformation=function(e,t,n,i){var r=i.elements,a=t._x,o=t._y,s=t._z,l=t._w,u=a+a,c=o+o,h=s+s,_=a*u,d=a*c,f=a*h,p=o*c,g=o*h,v=s*h,m=l*u,y=l*c,x=l*h,w=e._x,b=e._y,C=e._z;r[0]=(1-(p+v))*w,r[1]=(d+x)*w,r[2]=(f-y)*w,r[3]=0,r[4]=(d-x)*b,r[5]=(1-(_+v))*b,r[6]=(g+m)*b,r[7]=0,r[8]=(f+y)*C,r[9]=(g-m)*C,r[10]=(1-(_+p))*C,r[11]=0,r[12]=n._x,r[13]=n._y,r[14]=n._z,r[15]=1},e.scaling=function(e,t){var n=t.elements;n[0]=e._x,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e._y,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e._z,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1},e.translation=function(e,t){var n=t.elements;n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e._x,n[13]=e._y,n[14]=e._z,n[15]=1},e.invert=function(e,t){var n=e.elements,i=t.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=n[4],u=n[5],c=n[6],h=n[7],_=n[8],d=n[9],f=n[10],p=n[11],g=n[12],v=n[13],m=n[14],y=n[15],x=r*u-a*l,w=r*c-o*l,b=r*h-s*l,C=a*c-o*u,T=a*h-s*u,S=o*h-s*c,A=_*v-d*g,P=_*m-f*g,M=_*y-p*g,E=d*m-f*v,F=d*y-p*v,R=f*y-p*m,L=x*R-w*F+b*E+C*M-T*P+S*A;if(!L)return null;L=1/L,i[0]=(u*R-c*F+h*E)*L,i[1]=(o*F-a*R-s*E)*L,i[2]=(v*S-m*T+y*C)*L,i[3]=(f*T-d*S-p*C)*L,i[4]=(c*M-l*R-h*P)*L,i[5]=(r*R-o*M+s*P)*L,i[6]=(m*b-g*S-y*w)*L,i[7]=(_*S-f*b+p*w)*L,i[8]=(l*F-u*M+h*A)*L,i[9]=(a*M-r*F-s*A)*L,i[10]=(g*T-v*b+y*x)*L,i[11]=(d*b-_*T-p*x)*L,i[12]=(u*P-l*E-c*A)*L,i[13]=(r*E-a*P+o*A)*L,i[14]=(v*w-g*C-m*x)*L,i[15]=(_*C-d*w+f*x)*L},e.lookAt=function(t,n,i,r){var a=r.elements,s=e._tempVec30,l=e._tempVec31,u=e._tempVec32;o.subtract(t,n,u),u.normalize(),o.cross(i,u,s),s.normalize(),o.cross(u,s,l),a[0]=s._x,a[1]=l._x,a[2]=u._x,a[3]=0,a[4]=s._y,a[5]=l._y,a[6]=u._y,a[7]=0,a[8]=s._z,a[9]=l._z,a[10]=u._z,a[11]=0,a[12]=-o.dot(s,t),a[13]=-o.dot(l,t),a[14]=-o.dot(u,t),a[15]=1},e.ortho=function(e,t,n,i,r,a,o){var s=o.elements,l=1/(e-t),u=1/(n-i),c=1/(r-a);s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(i+n)*u,s[14]=(a+r)*c,s[15]=1},e.perspective=function(e,t,n,i,r){var a=r.elements,o=1/Math.tan(e/2),s=1/(n-i);a[0]=o/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(i+n)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*n*s,a[15]=0},e.rotateAxisAngle=function(e,t,n,i){var r=t._x,o=t._y,s=t._z,l=Math.sqrt(r*r+o*o+s*s);if(!(Math.abs(l)<a.zeroTolerance)){var u,c,h,_=e.elements,d=i.elements;r*=l=1/l,o*=l,s*=l,u=Math.sin(n),h=1-(c=Math.cos(n));var f=_[0],p=_[1],g=_[2],v=_[3],m=_[4],y=_[5],x=_[6],w=_[7],b=_[8],C=_[9],T=_[10],S=_[11],A=r*r*h+c,P=o*r*h+s*u,M=s*r*h-o*u,E=r*o*h-s*u,F=o*o*h+c,R=s*o*h+r*u,L=r*s*h+o*u,D=o*s*h-r*u,B=s*s*h+c;d[0]=f*A+m*P+b*M,d[1]=p*A+y*P+C*M,d[2]=g*A+x*P+T*M,d[3]=v*A+w*P+S*M,d[4]=f*E+m*F+b*R,d[5]=p*E+y*F+C*R,d[6]=g*E+x*F+T*R,d[7]=v*E+w*F+S*R,d[8]=f*L+m*D+b*B,d[9]=p*L+y*D+C*B,d[10]=g*L+x*D+T*B,d[11]=v*L+w*D+S*B,e!==i&&(d[12]=_[12],d[13]=_[13],d[14]=_[14],d[15]=_[15])}},e.scale=function(e,t,n){var i=e.elements,r=n.elements,a=t._x,o=t._y,s=t._z;r[0]=i[0]*a,r[1]=i[1]*a,r[2]=i[2]*a,r[3]=i[3]*a,r[4]=i[4]*o,r[5]=i[5]*o,r[6]=i[6]*o,r[7]=i[7]*o,r[8]=i[8]*s,r[9]=i[9]*s,r[10]=i[10]*s,r[11]=i[11]*s,r[12]=i[12],r[13]=i[13],r[14]=i[14],r[15]=i[15]},e.translate=function(e,t,n){var i=e.elements,r=n.elements,a=t._x,o=t._y,s=t._z;if(e===n)r[12]=i[0]*a+i[4]*o+i[8]*s+i[12],r[13]=i[1]*a+i[5]*o+i[9]*s+i[13],r[14]=i[2]*a+i[6]*o+i[10]*s+i[14],r[15]=i[3]*a+i[7]*o+i[11]*s+i[15];else{var l=i[0],u=i[1],c=i[2],h=i[3],_=i[4],d=i[5],f=i[6],p=i[7],g=i[8],v=i[9],m=i[10],y=i[11];r[0]=l,r[1]=u,r[2]=c,r[3]=h,r[4]=_,r[5]=d,r[6]=f,r[7]=p,r[8]=g,r[9]=v,r[10]=m,r[11]=y,r[12]=l*a+_*o+g*s+i[12],r[13]=u*a+d*o+v*s+i[13],r[14]=c*a+f*o+m*s+i[14],r[15]=h*a+p*o+y*s+i[15]}},e.transpose=function(e,t){var n=e.elements,i=t.elements;if(t===e){var r=n[1],a=n[2],o=n[3],s=n[6],l=n[7],u=n[11];i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=r,i[6]=n[9],i[7]=n[13],i[8]=a,i[9]=s,i[11]=n[14],i[12]=o,i[13]=l,i[14]=u}else i[0]=n[0],i[1]=n[4],i[2]=n[8],i[3]=n[12],i[4]=n[1],i[5]=n[5],i[6]=n[9],i[7]=n[13],i[8]=n[2],i[9]=n[6],i[10]=n[10],i[11]=n[14],i[12]=n[3],i[13]=n[7],i[14]=n[11],i[15]=n[15]};var t=e.prototype;return t.set=function(e,t,n,i,r,a,o,s,l,u,c,h,_,d,f,p){var g=this.elements;return g[0]=e,g[1]=t,g[2]=n,g[3]=i,g[4]=r,g[5]=a,g[6]=o,g[7]=s,g[8]=l,g[9]=u,g[10]=c,g[11]=h,g[12]=_,g[13]=d,g[14]=f,g[15]=p,this},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8],c=e[9],h=e[10],_=e[11],d=e[12],f=e[13],p=e[14],g=e[15];return(t*o-n*a)*(h*g-_*p)-(t*s-i*a)*(c*g-_*f)+(t*l-r*a)*(c*p-h*f)+(n*s-i*o)*(u*g-_*d)-(n*l-r*o)*(u*p-h*d)+(i*l-r*s)*(u*f-c*d)},t.decompose=function(t,n,i){var r=e._tempMat30,o=this.elements,s=r.elements,l=o[0],u=o[1],c=o[2],h=o[3],d=o[4],f=o[5],p=o[6],g=o[7],v=o[8],m=o[9],y=o[10],x=o[11];t.set(o[12],o[13],o[14]);var w=Math.sign(l*u*c*h)<0?-1:1,b=Math.sign(d*f*p*g)<0?-1:1,C=Math.sign(v*m*y*x)<0?-1:1,T=w*Math.sqrt(l*l+u*u+c*c),S=b*Math.sqrt(d*d+f*f+p*p),A=C*Math.sqrt(v*v+m*m+y*y);if(i.set(T,S,A),Math.abs(T)<a.zeroTolerance||Math.abs(S)<a.zeroTolerance||Math.abs(A)<a.zeroTolerance)return n.identity(),!1;var P=1/T,M=1/S,E=1/A;return s[0]=l*P,s[1]=u*P,s[2]=c*P,s[3]=d*M,s[4]=f*M,s[5]=p*M,s[6]=v*E,s[7]=m*E,s[8]=y*E,_.rotationMatrix3x3(r,n),!0},t.getRotation=function(e){var t=this.elements,n=t[0]+t[5]+t[10];if(n>a.zeroTolerance){var i=2*Math.sqrt(n+1);e._w=.25*i,e._x=(t[6]-t[9])/i,e._y=(t[8]-t[2])/i,e._z=(t[1]-t[4])/i}else if(t[0]>t[5]&&t[0]>t[10]){var r=2*Math.sqrt(1+t[0]-t[5]-t[10]);e._w=(t[6]-t[9])/r,e._x=.25*r,e._y=(t[1]+t[4])/r,e._z=(t[8]+t[2])/r}else if(t[5]>t[10]){var o=2*Math.sqrt(1+t[5]-t[0]-t[10]);e._w=(t[8]-t[2])/o,e._x=(t[1]+t[4])/o,e._y=.25*o,e._z=(t[6]+t[9])/o}else{var s=2*Math.sqrt(1+t[10]-t[0]-t[5]);e._w=(t[1]-t[4])/s,e._x=(t[8]+t[2])/s,e._y=(t[6]+t[9])/s,e._z=.25*s}return e._onValueChanged&&e._onValueChanged(),e},t.getScaling=function(e){var t=this.elements,n=t[0],i=t[1],r=t[2],a=t[4],o=t[5],s=t[6],l=t[8],u=t[9],c=t[10];return e.set(Math.sqrt(n*n+i*i+r*r),Math.sqrt(a*a+o*o+s*s),Math.sqrt(l*l+u*u+c*c)),e},t.getTranslation=function(e){var t=this.elements;return e.set(t[12],t[13],t[14]),e},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotateAxisAngle=function(t,n){return e.rotateAxisAngle(this,t,n,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},t.copyFrom=function(e){var t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this},t.copyFromArray=function(e,t){void 0===t&&(t=0);for(var n=this.elements,i=0;i<16;i++)n[i]=e[i+t];return this},t.copyToArray=function(e,t){void 0===t&&(t=0);var n=this.elements;e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15]},e}();d._tempVec30=new o,d._tempVec31=new o,d._tempVec32=new o,d._tempMat30=new h,d._identity=new d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var f=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.origin=new o,this.direction=new o,e&&this.origin.copyFrom(e),t&&this.direction.copyFrom(t)}var t=e.prototype;return t.intersectPlane=function(e){return l.intersectsRayAndPlane(this,e)},t.intersectSphere=function(e){return l.intersectsRayAndSphere(this,e)},t.intersectBox=function(e){return l.intersectsRayAndBox(this,e)},t.getPoint=function(e,t){return o.scale(this.direction,e,t),t.add(this.origin)},e}(),p=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this._x=void 0,this._y=void 0,this._onValueChanged=null,this._x=e,this._y=t}e.add=function(e,t,n){n._x=e._x+t._x,n._y=e._y+t._y,n._onValueChanged&&n._onValueChanged()},e.subtract=function(e,t,n){n._x=e._x-t._x,n._y=e._y-t._y,n._onValueChanged&&n._onValueChanged()},e.multiply=function(e,t,n){n._x=e._x*t._x,n._y=e._y*t._y,n._onValueChanged&&n._onValueChanged()},e.divide=function(e,t,n){n._x=e._x/t._x,n._y=e._y/t._y,n._onValueChanged&&n._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y},e.distance=function(e,t){var n=t._x-e._x,i=t._y-e._y;return Math.sqrt(n*n+i*i)},e.distanceSquared=function(e,t){var n=t._x-e._x,i=t._y-e._y;return n*n+i*i},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)},e.lerp=function(e,t,n,i){var r=e._x,a=e._y;i._x=r+(t._x-r)*n,i._y=a+(t._y-a)*n,i._onValueChanged&&i._onValueChanged()},e.max=function(e,t,n){n._x=Math.max(e._x,t._x),n._y=Math.max(e._y,t._y),n._onValueChanged&&n._onValueChanged()},e.min=function(e,t,n){n._x=Math.min(e._x,t._x),n._y=Math.min(e._y,t._y),n._onValueChanged&&n._onValueChanged()},e.negate=function(e,t){t._x=-e._x,t._y=-e._y,t._onValueChanged&&t._onValueChanged()},e.normalize=function(e,t){var n=e._x,i=e._y,r=Math.sqrt(n*n+i*i);r>a.zeroTolerance&&(r=1/r,t._x=n*r,t._y=i*r,t._onValueChanged&&t._onValueChanged())},e.scale=function(e,t,n){n._x=e._x*t,n._y=e._y*t,n._onValueChanged&&n._onValueChanged()};var t=e.prototype;return t.set=function(e,t){return this._x=e,this._y=t,this._onValueChanged&&this._onValueChanged(),this},t.add=function(e){return this._x+=e._x,this._y+=e._y,this._onValueChanged&&this._onValueChanged(),this},t.subtract=function(e){return this._x-=e._x,this._y-=e._y,this._onValueChanged&&this._onValueChanged(),this},t.multiply=function(e){return this._x*=e._x,this._y*=e._y,this._onValueChanged&&this._onValueChanged(),this},t.divide=function(e){return this._x/=e._x,this._y/=e._y,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y;return Math.sqrt(e*e+t*t)},t.lengthSquared=function(){var e=this._x,t=this._y;return e*e+t*t},t.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this._x*=e,this._y*=e,this._onValueChanged&&this._onValueChanged(),this},t.clone=function(){return new e(this._x,this._y)},t.copyFrom=function(e){return this._x=e.x,this._y=e.y,this._onValueChanged&&this._onValueChanged(),this},t.copyFromArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._onValueChanged&&this._onValueChanged(),this},t.copyToArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y},r(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}}]),e}();p._zero=new p(0,0),p._one=new p(1,1);var g=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=e,this._y=t,this._z=n,this._w=i}e.add=function(e,t,n){n._x=e._x+t._x,n._y=e._y+t._y,n._z=e._z+t._z,n._w=e._w+t._w,n._onValueChanged&&n._onValueChanged()},e.subtract=function(e,t,n){n._x=e._x-t._x,n._y=e._y-t._y,n._z=e._z-t._z,n._w=e._w-t._w,n._onValueChanged&&n._onValueChanged()},e.multiply=function(e,t,n){n._x=e._x*t._x,n._y=e._y*t._y,n._z=e._z*t._z,n._w=e._w*t._w,n._onValueChanged&&n._onValueChanged()},e.divide=function(e,t,n){n._x=e._x/t._x,n._y=e._y/t._y,n._z=e._z/t._z,n._w=e._w/t._w,n._onValueChanged&&n._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},e.distance=function(e,t){var n=t._x-e._x,i=t._y-e._y,r=t._z-e._z,a=t._w-e._w;return Math.sqrt(n*n+i*i+r*r+a*a)},e.distanceSquared=function(e,t){var n=t._x-e._x,i=t._y-e._y,r=t._z-e._z,a=t._w-e._w;return n*n+i*i+r*r+a*a},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)&&a.equals(e._z,t._z)&&a.equals(e._w,t._w)},e.lerp=function(e,t,n,i){var r=e._x,a=e._y,o=e._z,s=e._w;i._x=r+(t._x-r)*n,i._y=a+(t._y-a)*n,i._z=o+(t._z-o)*n,i._w=s+(t._w-s)*n,i._onValueChanged&&i._onValueChanged()},e.max=function(e,t,n){n._x=Math.max(e._x,t._x),n._y=Math.max(e._y,t._y),n._z=Math.max(e._z,t._z),n._w=Math.max(e._w,t._w),n._onValueChanged&&n._onValueChanged()},e.min=function(e,t,n){n._x=Math.min(e._x,t._x),n._y=Math.min(e._y,t._y),n._z=Math.min(e._z,t._z),n._w=Math.min(e._w,t._w),n._onValueChanged&&n._onValueChanged()},e.negate=function(e,t){t._x=-e._x,t._y=-e._y,t._z=-e._z,t._w=-e._w,t._onValueChanged&&t._onValueChanged()},e.normalize=function(e,t){var n=e._x,i=e._y,r=e._z,o=e._w,s=Math.sqrt(n*n+i*i+r*r+o*o);s>a.zeroTolerance&&(s=1/s,t._x=n*s,t._y=i*s,t._z=r*s,t._w=o*s,t._onValueChanged&&t._onValueChanged())},e.scale=function(e,t,n){n._x=e._x*t,n._y=e._y*t,n._z=e._z*t,n._w=e._w*t,n._onValueChanged&&n._onValueChanged()},e.transform=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=e._w,s=t.elements;n._x=i*s[0]+r*s[4]+a*s[8]+o*s[12],n._y=i*s[1]+r*s[5]+a*s[9]+o*s[13],n._z=i*s[2]+r*s[6]+a*s[10]+o*s[14],n._w=i*s[3]+r*s[7]+a*s[11]+o*s[15],n._onValueChanged&&n._onValueChanged()},e.transformByQuat=function(e,t,n){var i=e._x,r=e._y,a=e._z,o=e._w,s=t._x,l=t._y,u=t._z,c=t._w,h=c*i+l*a-u*r,_=c*r+u*i-s*a,d=c*a+s*r-l*i,f=-s*i-l*r-u*a;n._x=h*c-f*s-_*u+d*l,n._y=_*c-f*l-d*s+h*u,n._z=d*c-f*u-h*l+_*s,n._w=o,n._onValueChanged&&n._onValueChanged()};var t=e.prototype;return t.set=function(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onValueChanged&&this._onValueChanged(),this},t.add=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._onValueChanged&&this._onValueChanged(),this},t.subtract=function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._onValueChanged&&this._onValueChanged(),this},t.multiply=function(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._w*=e._w,this._onValueChanged&&this._onValueChanged(),this},t.divide=function(e){return this._x/=e._x,this._y/=e._y,this._z/=e._z,this._w/=e._w,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y,n=this._z,i=this._w;return Math.sqrt(e*e+t*t+n*n+i*i)},t.lengthSquared=function(){var e=this._x,t=this._y,n=this._z,i=this._w;return e*e+t*t+n*n+i*i},t.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._onValueChanged&&this._onValueChanged(),this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._onValueChanged&&this._onValueChanged(),this},t.clone=function(){return new e(this._x,this._y,this._z,this._w)},t.copyFrom=function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onValueChanged&&this._onValueChanged(),this},t.copyFromArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onValueChanged&&this._onValueChanged(),this},t.copyToArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w},r(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._onValueChanged&&this._onValueChanged()}},{key:"w",get:function(){return this._w},set:function(e){this._w=e,this._onValueChanged&&this._onValueChanged()}}]),e}();g._zero=new g(0,0,0,0),g._one=new g(1,1,1,1);var v=function(){function e(e,t,n,i){void 0===e&&(e=1),void 0===t&&(t=1),void 0===n&&(n=1),void 0===i&&(i=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=e,this.g=t,this.b=n,this.a=i}e.gammaToLinearSpace=function(e){return e<=0?0:e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)},e.linearToGammaSpace=function(e){return e<=0?0:e<.0031308?12.92*e:e<1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)},e.equals=function(e,t){return a.equals(e.r,t.r)&&a.equals(e.g,t.g)&&a.equals(e.b,t.b)&&a.equals(e.a,t.a)},e.add=function(e,t,n){return n.r=e.r+t.r,n.g=e.g+t.g,n.b=e.b+t.b,n.a=e.a+t.a,n},e.scale=function(e,t,n){return n.r=e.r*t,n.g=e.g*t,n.b=e.b*t,n.a=e.a*t,n};var t=e.prototype;return t.set=function(e,t,n,i){return this.r=e,this.g=t,this.b=n,this.a=i,this},t.add=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},t.scale=function(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this},t.clone=function(){return new e(this.r,this.g,this.b,this.a)},t.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},t.toLinear=function(t){return t.r=e.gammaToLinearSpace(this.r),t.g=e.gammaToLinearSpace(this.g),t.b=e.gammaToLinearSpace(this.b),t},t.toGamma=function(t){return t.r=e.linearToGammaSpace(this.r),t.g=e.linearToGammaSpace(this.g),t.b=e.linearToGammaSpace(this.b),t},e}(),m=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=e,this.y=t,this.width=n,this.height=i}var t=e.prototype;return t.set=function(e,t,n,i){return this.x=e,this.y=t,this.width=n,this.height=i,this},t.clone=function(){return new e(this.x,this.y,this.width,this.height)},t.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),y=function(){function e(){this.coefficients=new Float32Array(27)}var t=e.prototype;return t.addLight=function(e,t,n){t.scale(n);var i=this.coefficients,r=e._x,a=e._y,o=e._z,s=t.r,l=t.g,u=t.b,c=.282095,h=-.488603*a,_=.488603*o,d=-.488603*r,f=r*a*1.092548,p=a*o*-1.092548,g=.315392*(3*o*o-1),v=r*o*-1.092548,m=.546274*(r*r-a*a);i[0]+=s*c,i[1]+=l*c,i[2]+=u*c,i[3]+=s*h,i[4]+=l*h,i[5]+=u*h,i[6]+=s*_,i[7]+=l*_,i[8]+=u*_,i[9]+=s*d,i[10]+=l*d,i[11]+=u*d,i[12]+=s*f,i[13]+=l*f,i[14]+=u*f,i[15]+=s*p,i[16]+=l*p,i[17]+=u*p,i[18]+=s*g,i[19]+=l*g,i[20]+=u*g,i[21]+=s*v,i[22]+=l*v,i[23]+=u*v,i[24]+=s*m,i[25]+=l*m,i[26]+=u*m},t.evaluate=function(e,t){var n=this.coefficients,i=e._x,r=e._y,a=e._z,o=.886227,s=-1.023327*r,l=1.023327*a,u=-1.023327*i,c=.858086*r*i,h=-.858086*r*a,_=.247708*(3*a*a-1),d=-.858086*a*i,f=.429042*(i*i-r*r),p=n[0]*o,g=n[1]*o,v=n[2]*o;return p+=n[3]*s+n[6]*l+n[9]*u,g+=n[4]*s+n[7]*l+n[10]*u,v+=n[5]*s+n[8]*l+n[11]*u,p+=n[12]*c+n[15]*h+n[18]*_+n[21]*d+n[24]*f,g+=n[13]*c+n[16]*h+n[19]*_+n[22]*d+n[25]*f,v+=n[14]*c+n[17]*h+n[20]*_+n[23]*d+n[26]*f,t.set(p,g,v,1),t},t.scale=function(e){var t=this.coefficients;t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t[4]*=e,t[5]*=e,t[6]*=e,t[7]*=e,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t[12]*=e,t[13]*=e,t[14]*=e,t[15]*=e,t[16]*=e,t[17]*=e,t[18]*=e,t[19]*=e,t[20]*=e,t[21]*=e,t[22]*=e,t[23]*=e,t[24]*=e,t[25]*=e,t[26]*=e},t.clone=function(){var t=new e;return t.copyFrom(this),t},t.copyFrom=function(e){return e.copyToArray(this.coefficients),this},t.copyFromArray=function(e,t){void 0===t&&(t=0);var n=this.coefficients;n[0]=e[t],n[1]=e[1+t],n[2]=e[2+t],n[3]=e[3+t],n[4]=e[4+t],n[5]=e[5+t],n[6]=e[6+t],n[7]=e[7+t],n[8]=e[8+t],n[9]=e[9+t],n[10]=e[10+t],n[11]=e[11+t],n[12]=e[12+t],n[13]=e[13+t],n[14]=e[14+t],n[15]=e[15+t],n[16]=e[16+t],n[17]=e[17+t],n[18]=e[18+t],n[19]=e[19+t],n[20]=e[20+t],n[21]=e[21+t],n[22]=e[22+t],n[23]=e[23+t],n[24]=e[24+t],n[25]=e[25+t],n[26]=e[26+t]},t.copyToArray=function(e,t){void 0===t&&(t=0);var n=this.coefficients;e[0+t]=n[0],e[1+t]=n[1],e[2+t]=n[2],e[3+t]=n[3],e[4+t]=n[4],e[5+t]=n[5],e[6+t]=n[6],e[7+t]=n[7],e[8+t]=n[8],e[9+t]=n[9],e[10+t]=n[10],e[11+t]=n[11],e[12+t]=n[12],e[13+t]=n[13],e[14+t]=n[14],e[15+t]=n[15],e[16+t]=n[16],e[17+t]=n[17],e[18+t]=n[18],e[19+t]=n[19],e[20+t]=n[20],e[21+t]=n[21],e[22+t]=n[22],e[23+t]=n[23],e[24+t]=n[24],e[25+t]=n[25],e[26+t]=n[26]},e}();function x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function w(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?x(Object(n),!0).forEach((function(t){T(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):x(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function C(e,t,n){return t&&b(e.prototype,t),n&&b(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function S(){return S=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},S.apply(this,arguments)}function A(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,M(e,t)}function P(e){return P=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},P(e)}function M(e,t){return M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},M(e,t)}function E(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function F(e,t,n){return F=E()?Reflect.construct.bind():function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&M(r,n.prototype),r},F.apply(null,arguments)}function R(e){var t="function"==typeof Map?new Map:void 0;return R=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return F(e,arguments,P(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),M(i,e)},R(e)}function L(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function B(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?D(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function I(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function O(e,t,n,i,r){var a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}var z={isArray:"isArray"in Array?Array.isArray:function(e){return"[object Array]"===toString.call(e)},isArrayLike:function(e){return!!e&&"number"==typeof e.length&&"function"!=typeof e},clone:function(e){if("object"!=typeof e||null===e)return e;var t;if(z.isArrayLike(e)){t=e.slice();for(var n=0,i=e.length;n<i;n++)t[n]=z.clone(e[n])}else for(var r in t={},e)e.hasOwnProperty(r)&&(t[r]=z.clone(e[r]));return t},downloadBlob:function(e,t){void 0===t&&(t="");var i=n.polyfill.window.URL.createObjectURL(e),r=n.polyfill.document.createElement("a");n.polyfill.document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",(function(){r.parentElement&&r.parentElement.removeChild(r)})),r.click(),n.polyfill.window.URL.revokeObjectURL(i)}};function N(e,t){var n=e.indexOf(t);if(n<0)return!1;var i=e.length-1;if(n!==i){var r=e[i];e[n]=r}return e.length--,!0}function V(e){return Object.keys(e).map((function(t){return e[t]}))}var U,k=function(){function e(){}return e._reflectGet=function(e,t){for(var n=this._stringToPath(t),i=e,r=0,a=n.length;null!=i&&r<a;)i=i[n[r++]];return r&&r==a?i:void 0},e._stringToPath=function(e){var t=[];return e.charCodeAt(0)===G&&t.push(""),e.replace(W,(function(e,n,i,r){var a=e;i?a=r.replace(H,"$1"):n&&(a=n.trim()),t.push(a)})),t},e}(),G=".".charCodeAt(0),H=/\\(\\)?/g,W=RegExp("[^.[\\]]+|\\[(?:([^\"'][^[]*)|([\"'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))","g");!function(e){e[e.Success=0]="Success",e[e.Pending=1]="Pending",e[e.Failed=2]="Failed"}(U||(U={}));var j=function(e){A(n,e),n.all=function(e){return new n((function(t,n,i){if(!Array.isArray(e))return t([e]);var r=0,a=e.length,o=new Array(a);e.forEach((function(e,s){Promise.resolve(e).then((function(e){o[s]=e,i((r+=1)/a),r==a&&t(o)})).catch((function(e){return n(e)}))}))}))};var t=n.prototype;function n(t){var n,i,r=function(e){if(!(e<=n._progress)){n._progress=e;for(var t,i=B(n._listeners);!(t=i()).done;){(0,t.value)(e)}}};return(n=e.call(this,(function(e,a){t((function(t){Promise.resolve().then((function(){r(1),n._status=U.Success,e(t)}))}),i=function(e){Promise.resolve().then((function(){n._status=U.Failed,a(e)}))},(function(e){Promise.resolve().then((function(){r(e)}))}))}))||this)._status=void 0,n._progress=void 0,n._reject=void 0,n._listeners=void 0,n._reject=i,n._listeners=new Set,n._progress=0,n._status=U.Pending,n}return t.onProgress=function(e){return this._listeners.add(e),this},t.cancel=function(){return this._status!==U.Pending||this._reject("Promise Canceled"),this},C(n,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),n}(R(Promise)),X=function(){function e(e){this.engine=e,this.retryCount=1,this.retryInterval=0,this.timeout=1/0,this._objectPool=Object.create(null),this._editorResourceConfig=Object.create(null),this._virtualPathMap=Object.create(null),this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}e._addLoader=function(e,t,n){this._loaders[e]=t;for(var i=0,r=n.length;i<r;i++)this._extTypeMapping[n[i]]=e},e._getTypeByUrl=function(e){var t=e.split("?")[0];return this._extTypeMapping[t.substring(t.lastIndexOf(".")+1)]};var t=e.prototype;return t.load=function(e){var t=this;if(!Array.isArray(e))return this._loadSingleItem(e);var n=e.map((function(e){return t._loadSingleItem(e)}));return j.all(n)},t.cancelNotLoaded=function(e){var t=this;if(e)if("string"==typeof e){var n;null===(n=this._loadingPromises[e])||void 0===n||n.cancel()}else e.forEach((function(e){var n;null===(n=t._loadingPromises[e])||void 0===n||n.cancel()}));else V(this._loadingPromises).forEach((function(e){e.cancel()}))},t.gc=function(){this._gc(!1)},t.getAssetPath=function(e){return this._assetPool[e]},t.getResourceByRef=function(e){var t=e.refId,n=e.key,i=e.isClone,r=this._objectPool[t];return(r?Promise.resolve(r):this.load({type:this._editorResourceConfig[t].type,url:this._editorResourceConfig[t].path})).then((function(e){return n?k._reflectGet(e,n):e})).then((function(e){return i?e.clone():e}))},t.initVirtualResources=function(e){var t=this;e.forEach((function(e){t._virtualPathMap[e.virtualPath]=e.path,t._editorResourceConfig[e.id]=e}))},t._addAsset=function(e,t){this._assetPool[t.instanceId]=e,this._assetUrlPool[e]=t},t._deleteAsset=function(e){var t=e.instanceId,n=this._assetPool[t];n&&(delete this._assetPool[t],delete this._assetUrlPool[n])},t._addRefObject=function(e,t){this._refObjectPool[e]=t},t._deleteRefObject=function(e){delete this._refObjectPool[e]},t._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._refObjectPool=null,this._loadingPromises=null},t._assignDefaultOptions=function(t){var n,i,r,a,o;if(t.type=null!=(n=t.type)?n:e._getTypeByUrl(t.url),void 0===t.type)throw"asset type should be specified: "+t.url;return t.retryCount=null!=(i=t.retryCount)?i:this.retryCount,t.timeout=null!=(r=t.timeout)?r:this.timeout,t.retryInterval=null!=(a=t.retryInterval)?a:this.retryInterval,t.url=null!=(o=t.url)?o:t.urls.join(","),t},t._loadSingleItem=function(t){var n=this,i=this._assignDefaultOptions("string"==typeof t?{url:t}:t),r=i.url,a=this._virtualPathMap[r]?this._virtualPathMap[r]:r;if(this._assetUrlPool[a])return new j((function(e){e(n._assetUrlPool[a])}));if(this._loadingPromises[a])return this._loadingPromises[i.url];var o=e._loaders[i.type];if(!o)throw"loader not found: "+i.type;i.url=a;var s=o.load(i,this);return this._loadingPromises[a]=s,s.then((function(e){o.useCache&&n._addAsset(a,e),n._loadingPromises&&delete n._loadingPromises[a]})).catch((function(e){return n._loadingPromises&&delete n._loadingPromises[a],Promise.reject(e)})),s},t._gc=function(e){for(var t=V(this._refObjectPool),n=0,i=t.length;n<i;n++)t[n].isGCIgnored&&!e||t[n].destroy()},e}();function K(e,t,n){return void 0===n&&(n=!0),function(i){var r=new i(n);X._addLoader(e,r,t)}}X._loaders={},X._extTypeMapping={};var q,Y=function(){function e(e,t,n,i){void 0===t&&(t=null),void 0===n&&(n={}),void 0===i&&(i=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=(new Date).getTime(),this._target=t,this.data=n,this._currentTarget=null,this._bubbles=i,this._propagationStopped=!1,this._type=e}return e.prototype.stopPropagation=function(){this._propagationStopped=!0},C(e,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(e){this._target=e}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(e){this._currentTarget=e}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),e}();function Q(e,t){ne.registerCloneMode(e,t,q.Ignore)}function J(e,t){ne.registerCloneMode(e,t,q.Assignment)}function Z(e,t){ne.registerCloneMode(e,t,q.Shallow)}function $(e,t){ne.registerCloneMode(e,t,q.Deep)}!function(e){e[e.Ignore=0]="Ignore",e[e.Assignment=1]="Assignment",e[e.Shallow=2]="Shallow",e[e.Deep=3]="Deep"}(q||(q={}));var ee,te,ne=function(){function e(){}return e.registerCloneMode=function(t,n,i){var r=e._subCloneModeMap.get(t.constructor);r||(r=Object.create(null),e._subCloneModeMap.set(t.constructor,r)),r[n]=i},e.getCloneMode=function(t){var n=e._cloneModeMap.get(t);if(!n){n=Object.create(null),e._cloneModeMap.set(t,n);for(var i=e._objectType,r=e._subCloneModeMap;t!==i;){var a=r.get(t);a&&S(n,a),t=Object.getPrototypeOf(t)}}return n},e.deepCloneObject=function(t,n){switch(t.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:n.set(t);break;case Array:for(var i=0,r=t.length;i<r;i++)e._deepCloneObjectItem(t,n,i);break;default:var a=t;if(a.clone&&a.cloneTo)a.cloneTo(n);else for(var o=Object.keys(t),s=0,l=o.length;s<l;s++)e._deepCloneObjectItem(t,n,o[s])}},e._deepCloneObjectItem=function(t,n,i){var r=t[i];if(r instanceof Object)switch(r.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var a=r,o=n[i];null==o?n[i]=a.slice():o.set(a);break;case Array:var s=r,l=n[i];null==l?n[i]=new Array(s.length):l.length=s.length,e.deepCloneObject(s,l);break;default:if(!r.clone||!r.cloneTo){var u=n[i];null==u&&(n[i]=u=new r.constructor),e.deepCloneObject(r,u);break}var c=r,h=n[i];h?c.cloneTo(h):n[i]=c.clone()}else n[i]=r},e}();ne._subCloneModeMap=new Map,ne._cloneModeMap=new Map,ne._objectType=Object.getPrototypeOf(Object);var ie,re,ae,oe,se,le,ue=(ee=function(){function e(){I(this,"_evts",te,this),this._evtCount=0}var t=e.prototype;return t.hasEvent=function(e){return null!=this._evts[e]},t.eventNames=function(){return 0===this._evtCount?[]:Object.keys(this._evts)},t.listenerCount=function(e){var t=this._evts[e];return t?t.fn?1:t.length:0},t.dispatch=function(e,t){if(!this._evts[e])return!1;var n=this._evts[e];if(n.fn)n.once&&this.removeEventListener(e,n.fn),n.fn(t);else for(var i=n.length,r=0;r<i;r++)n[r].once&&this.removeEventListener(e,n[r].fn),n[r].fn(t);return!0},t.on=function(e,t){return this.addEventListener(e,t)},t.once=function(e,t){return this.addEventListener(e,t,!0)},t.addEventListener=function(e,t,n){var i={fn:t,once:n},r=this._evts;return r[e]?r[e].fn?r[e]=[r[e],i]:r[e].push(i):(r[e]=i,this._evtCount++),this},t.off=function(e,t){if(!this._evts[e])return this;if(!t)return this._clearEvent(e),this;var n=this._evts[e];if(n.fn&&n.fn===t)this._clearEvent(e);else{var i=n.indexOf(t);if(i>-1){var r=n[n.length-1];n[i]=r,n.length--,1===n.length&&(this._evts[e]=n[0])}}return this},t.removeEventListener=function(e,t){return this.off(e,t)},t.removeAllEventListeners=function(e){e?this._evts[e]&&this._clearEvent(e):(this._evts=Object.create(null),this._evtCount=0)},t.trigger=function(e){this.dispatch(e.type,e.data)},t._clearEvent=function(e){0==--this._evtCount?this._evts=Object.create(null):delete this._evts[e]},e}(),te=O(ee.prototype,"_evts",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),ee),ce=function(e){},he=console.log.bind(console),_e=console.info.bind(console),de=console.warn.bind(console),fe=console.error.bind(console),pe={debug:ce,info:ce,warn:ce,error:ce,isEnabled:!1,enable:function(){this.debug=he,this.info=_e,this.warn=de,this.error=fe,this.isEnabled=!0},disable:function(){this.debug=ce,this.info=ce,this.warn=ce,this.error=ce,this.isEnabled=!1}},ge=function(){function e(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=n.polyfill.performance?n.polyfill.performance:Date,this._timeScale=1,this._deltaTime=1e-4;var e=this._clock.now();this._startTime=e,this._lastTickTime=e}var t=e.prototype;return t.reset=function(){this._lastTickTime=this._clock.now()},t.tick=function(){var e=this.nowTime;this._deltaTime=(e-this._lastTickTime)*this._timeScale,this._lastTickTime=e},C(e,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),e}(),ve=(oe=function(){function e(e){I(this,"instanceId",re,this),I(this,"_engine",ae,this),this._destroyed=!1,this._engine=e}return e.prototype.destroy=function(){var e;this._destroyed||(null===(e=this._engine.resourceManager)||void 0===e||e._deleteAsset(this),this._destroyed=!0)},C(e,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),e}(),oe._instanceIdCounter=0,re=O((ie=oe).prototype,"instanceId",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++ve._instanceIdCounter}}),ae=O(ie.prototype,"_engine",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ie);!function(e){e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT=5124]="INT",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.FLOAT_ARRAY=35677]="FLOAT_ARRAY",e[e.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",e[e.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",e[e.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",e[e.INT_ARRAY=100003]="INT_ARRAY",e[e.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",e[e.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",e[e.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",e[e.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",e[e.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",e[e.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",e[e.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",e[e.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT"}(se||(se={})),function(e){e.shaderVertexID="shaderVertexID",e.standardDerivatives="OES_standard_derivatives",e.shaderTextureLod="EXT_shader_texture_lod",e.elementIndexUint="OES_element_index_uint",e.depthTexture="WEBGL_depth_texture",e.drawBuffers="WEBGL_draw_buffers",e.vertexArrayObject="OES_vertex_array_object",e.instancedArrays="ANGLE_instanced_arrays",e.multipleSample="multipleSampleOnlySupportedInWebGL2",e.textureFloat="OES_texture_float",e.textureFloatLinear="OES_texture_float_linear",e.textureHalfFloat="OES_texture_half_float",e.textureHalfFloatLinear="OES_texture_half_float_linear",e.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",e.colorBufferFloat="EXT_color_buffer_float",e.colorBufferHalfFloat="EXT_color_buffer_half_float",e.textureFilterAnisotropic="EXT_texture_filter_anisotropic",e.blendMinMax="EXT_blend_minmax",e.astc="WEBGL_compressed_texture_astc",e.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",e.etc="WEBGL_compressed_texture_etc",e.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",e.etc1="WEBGL_compressed_texture_etc1",e.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",e.pvrtc="WEBGL_compressed_texture_pvrtc",e.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",e.s3tc="WEBGL_compressed_texture_s3tc",e.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc"}(le||(le={}));var me=function(){function e(e){void 0===e&&(e=0),this._elements=void 0,this.length=0,this._elements=new Array(e)}var t=e.prototype;return t.add=function(e){this.length===this._elements.length?this._elements.push(e):this._elements[this.length]=e,this.length++},t.delete=function(e){var t=this._elements.indexOf(e);this.deleteByIndex(t)},t.get=function(e){if(e>=this.length)throw"Index is out of range.";return this._elements[e]},t.deleteByIndex=function(e){var t=this._elements,n=null,i=this.length-1;return e!==i&&(n=t[i],t[e]=n),this.length--,n},t.garbageCollection=function(){this._elements.length=this.length},e}(),ye=function(){function e(){this._mask=[],this._length=0}e.unionCollection=function(e,t,n){var i,r,a,o,s=n._mask;e._length<t._length?(i=e._length,r=t._length,a=e._mask,o=t._mask):(i=t._length,r=e._length,a=t._mask,o=e._mask);var l=0;for(s.length<r&&(s.length=r);l<i;l++)s[l]=a[l]|o[l];for(;l<r;l++)s[l]=o[l];n._length=r};var t=e.prototype;return t.enable=function(e){var t=e._maskIndex,n=t+1,i=this._mask,r=this._length;if(r<n){for(i.length<n&&(i.length=n);r<t;r++)i[r]=0;i[t]=e._maskValue,this._length=n}else i[t]|=e._maskValue},t.disable=function(e){var t=e._maskIndex,n=this._mask,i=this._length-1;if(!(t>i)){var r=n[t]&~e._maskValue;t==i&&0===r?this._length--:n[t]=r}},t.unionCollection=function(e){var t=e._mask,n=e._length,i=this._mask,r=this._length;if(r<n){i.length<n&&(i.length=n);for(var a=0;a<r;a++)i[a]|=t[a];for(;a<n;a++)i[a]=t[a];this._length=n}else for(var o=0;o<n;o++)i[o]|=t[o]},t.complementaryCollection=function(e){for(var t=e._mask,n=this._mask,i=this._length-1,r=Math.min(e._length-1,i);r>=0;r--){var a=n[r]&~t[r];r==i&&0===a?(i--,this._length--):n[r]=a}},t.intersectionCollection=function(e){for(var t=e._mask,n=this._mask,i=this._length-1;i>=0;i--){var r=n[i]&t[i];0==r&&i==this._length-1?this._length--:n[i]=r}},t.isEnable=function(e){var t=e._maskIndex;return!(t>=this._length)&&0!=(this._mask[t]&e._maskValue)},t.clear=function(){this._length=0},e}(),xe=function(){function e(){this._onStartScripts=new me,this._onUpdateScripts=new me,this._onLateUpdateScripts=new me,this._onPhysicsUpdateScripts=new me,this._disableScripts=[],this._destroyScripts=[],this._onUpdateAnimations=new me,this._renderers=new me,this._onUpdateRenderers=new me,this._componentsContainerPool=[]}var t=e.prototype;return t.addRenderer=function(e){e._rendererIndex=this._renderers.length,this._renderers.add(e)},t.removeRenderer=function(e){var t=this._renderers.deleteByIndex(e._rendererIndex);t&&(t._rendererIndex=e._rendererIndex),e._rendererIndex=-1},t.addOnStartScript=function(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)},t.removeOnStartScript=function(e){var t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1},t.addOnUpdateScript=function(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)},t.removeOnUpdateScript=function(e){var t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnLateUpdateScript=function(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)},t.removeOnLateUpdateScript=function(e){var t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1},t.addOnPhysicsUpdateScript=function(e){e._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(e)},t.removeOnPhysicsUpdateScript=function(e){var t=this._onPhysicsUpdateScripts.deleteByIndex(e._onPhysicsUpdateIndex);t&&(t._onPhysicsUpdateIndex=e._onPhysicsUpdateIndex),e._onPhysicsUpdateIndex=-1},t.addOnUpdateAnimations=function(e){e._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(e)},t.removeOnUpdateAnimations=function(e){var t=this._onUpdateAnimations.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnUpdateRenderers=function(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)},t.removeOnUpdateRenderers=function(e){var t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addDisableScript=function(e){this._disableScripts.push(e)},t.addDestroyScript=function(e){this._destroyScripts.push(e)},t.callScriptOnStart=function(){var e=this._onStartScripts;if(e.length>0){for(var t=e._elements,n=0;n<e.length;n++){var i=t[n];i._waitHandlingInValid||(i._started=!0,i._onStartIndex=-1,i.onStart())}e.length=0}},t.callScriptOnUpdate=function(e){for(var t=this._onUpdateScripts._elements,n=this._onUpdateScripts.length-1;n>=0;--n){var i=t[n];!i._waitHandlingInValid&&i._started&&i.onUpdate(e)}},t.callScriptOnLateUpdate=function(e){for(var t=this._onLateUpdateScripts._elements,n=this._onLateUpdateScripts.length-1;n>=0;--n){var i=t[n];!i._waitHandlingInValid&&i._started&&i.onLateUpdate(e)}},t.callScriptOnPhysicsUpdate=function(){for(var e=this._onPhysicsUpdateScripts._elements,t=this._onPhysicsUpdateScripts.length-1;t>=0;--t){var n=e[t];!n._waitHandlingInValid&&n._started&&n.onPhysicsUpdate()}},t.callAnimationUpdate=function(e){for(var t=this._onUpdateAnimations._elements,n=this._onUpdateAnimations.length-1;n>=0;--n)t[n].update(e)},t.callRendererOnUpdate=function(e){for(var t=this._onUpdateRenderers._elements,n=this._onUpdateRenderers.length-1;n>=0;--n)t[n].update(e)},t.callRender=function(t){for(var n=t._camera,i=this._renderers._elements,r=this._renderers.length-1;r>=0;--r){var a=i[r];if(n.cullingMask&a._entity.layer&&(!n.enableFrustumCulling||(a.isCulled=!n._frustum.intersectsBox(a.bounds),!a.isCulled))){var s=n.entity.transform,l=s.worldPosition,u=a.bounds.getCenter(e._tempVector0);if(n.isOrthographic){var c=s.getWorldForward(e._tempVector1);o.subtract(u,l,u),a._distanceForSort=o.dot(u,c)}else a._distanceForSort=o.distanceSquared(u,l);a._updateShaderData(t),a._render(n),ye.unionCollection(n._globalShaderMacro,a.shaderData._macroCollection,a._globalShaderMacro)}}},t.handlingInvalidScripts=function(){var e=this._disableScripts,t=this._destroyScripts,n=e.length;if(n>0){for(var i=n-1;i>=0;i--){var r=e[i];r._waitHandlingInValid&&r._handlingInValid()}e.length=0}if((n=t.length)>0){for(var a=n-1;a>=0;a--)t[a].onDestroy();t.length=0}},t.callCameraOnBeginRender=function(e){for(var t=e.entity._scripts,n=t.length-1;n>=0;--n){var i=t.get(n);i._waitHandlingInValid||i.onBeginRender(e)}},t.callCameraOnEndRender=function(e){for(var t=e.entity._scripts,n=t.length-1;n>=0;--n){var i=t.get(n);i._waitHandlingInValid||i.onEndRender(e)}},t.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},t.putActiveChangedTempList=function(e){e.length=0,this._componentsContainerPool.push(e)},e}();xe._tempVector0=new o,xe._tempVector1=new o;var we,be=function(){function e(){}return e.cloneComponent=function(e,t){for(var n=ne.getCloneMode(e.constructor),i=Object.keys(e),r=0,a=i.length;r<a;r++){var o=i[r];switch(n[o]){case void 0:case q.Assignment:t[o]=e[o];break;case q.Shallow:var s=e[o];if(s instanceof Object){var l=t[o];null==l&&(l=t[o]=s.constructor()),S(l,s)}else t[o]=s;break;case q.Deep:var u=e[o];if(u instanceof Object){var c=t[o];null==c&&(c=t[o]=u.constructor()),ne.deepCloneObject(u,c)}else t[o]=u}}e._cloneTo&&e._cloneTo(t)},e}(),Ce=function(){function e(){}return e._register=function(e,t){this._addDependency(e,t,this._dependenciesMap),this._addDependency(t,e,this._invDependenciesMap)},e._addCheck=function(t,n){var i=e._dependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++){var o=i[r];t.getComponent(o)||t.addComponent(o)}},e._removeCheck=function(t,n){var i=e._invDependenciesMap.get(n);if(i)for(var r=0,a=i.length;r<a;r++)if(t.getComponent(i[r]))throw"you should remove "+i[r]+" before adding "+n},e._addDependency=function(e,t,n){var i=n.get(e);i||(i=[],n.set(e,i)),-1===i.indexOf(t)&&i.push(t)},e}();function Te(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){t.forEach((function(t){return Ce._register(e,t)}))}}Ce._dependenciesMap=new Map,Ce._invDependenciesMap=new Map,function(e){e[e.Layer0=1]="Layer0",e[e.Layer1=2]="Layer1",e[e.Layer2=4]="Layer2",e[e.Layer3=8]="Layer3",e[e.Layer4=16]="Layer4",e[e.Layer5=32]="Layer5",e[e.Layer6=64]="Layer6",e[e.Layer7=128]="Layer7",e[e.Layer8=256]="Layer8",e[e.Layer9=512]="Layer9",e[e.Layer10=1024]="Layer10",e[e.Layer11=2048]="Layer11",e[e.Layer12=4096]="Layer12",e[e.Layer13=8192]="Layer13",e[e.Layer14=16384]="Layer14",e[e.Layer15=32768]="Layer15",e[e.Layer16=65536]="Layer16",e[e.Layer17=131072]="Layer17",e[e.Layer18=262144]="Layer18",e[e.Layer19=524288]="Layer19",e[e.Layer20=1048576]="Layer20",e[e.Layer21=2097152]="Layer21",e[e.Layer22=4194304]="Layer22",e[e.Layer23=8388608]="Layer23",e[e.Layer24=16777216]="Layer24",e[e.Layer25=33554432]="Layer25",e[e.Layer26=67108864]="Layer26",e[e.Layer27=134217728]="Layer27",e[e.Layer28=268435456]="Layer28",e[e.Layer29=536870912]="Layer29",e[e.Layer30=1073741824]="Layer30",e[e.Layer31=2147483648]="Layer31",e[e.Everything=4294967295]="Everything",e[e.Nothing=0]="Nothing"}(we||(we={}));var Se,Ae,Pe,Me,Ee,Fe,Re,Le,De,Be,Ie,Oe,ze,Ne,Ve,Ue,ke,Ge,He,We,je,Xe,Ke=function(){function e(){this._flagManagers=[]}var t=e.prototype;return t.clearFromManagers=function(){this._removeFromManagers(),this._flagManagers.length=0},t.destroy=function(){this._removeFromManagers(),this._flagManagers=null},t._removeFromManagers=function(){for(var e=this._flagManagers,t=0,n=e.length;t<n;t++)N(e[t]._updateFlags,this)},e}(),qe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).flag=!0,t}return A(t,e),t.prototype.dispatch=function(){this.flag=!0},t}(Ke),Ye=(Se=function(e){function t(t){var n;return I(n=e.call(this,t.engine)||this,"_entity",Ae,L(n)),I(n,"_awoken",Pe,L(n)),I(n,"_destroyed",Me,L(n)),I(n,"_phasedActive",Ee,L(n)),I(n,"_enabled",Fe,L(n)),n._entity=t,n}A(t,e);var n=t.prototype;return n.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&this._enabled&&this._onDisable(),this._destroyed=!0,this._onDestroy())},n._onAwake=function(){},n._onEnable=function(){},n._onDisable=function(){},n._onDestroy=function(){},n._setActive=function(e){var t=this._entity;e?(!this._awoken&&t._isActiveInHierarchy&&(this._awoken=!0,this._onAwake()),!this._phasedActive&&t._isActiveInHierarchy&&this._enabled&&(this._phasedActive=!0,this._onEnable())):!this._phasedActive||t._isActiveInHierarchy&&this._enabled||(this._phasedActive=!1,this._onDisable())},C(t,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,this._entity.isActiveInHierarchy&&(e?(this._phasedActive=!0,this._onEnable()):(this._phasedActive=!1,this._onDisable())))}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),t}(ve),Ae=O(Se.prototype,"_entity",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pe=O(Se.prototype,"_awoken",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Me=O(Se.prototype,"_destroyed",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ee=O(Se.prototype,"_phasedActive",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fe=O(Se.prototype,"_enabled",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Se),Qe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).listener=void 0,t}return A(t,e),t.prototype.dispatch=function(e){this.listener&&this.listener(e)},t}(Ke),Je=function(){function e(){this._updateFlags=[]}var t=e.prototype;return t.createFlag=function(e){var t=new e;return this.addFlag(t),t},t.addFlag=function(e){this._updateFlags.push(e),e._flagManagers.push(this)},t.dispatch=function(e){for(var t=this._updateFlags,n=t.length-1;n>=0;n--)t[n].dispatch(e)},e}(),Ze=(je=function(e){function t(t){var n;return I(n=e.call(this,t)||this,"_position",Le,L(n)),I(n,"_rotation",De,L(n)),I(n,"_rotationQuaternion",Be,L(n)),I(n,"_scale",Ie,L(n)),I(n,"_worldPosition",Oe,L(n)),I(n,"_worldRotation",ze,L(n)),I(n,"_worldRotationQuaternion",Ne,L(n)),I(n,"_lossyWorldScale",Ve,L(n)),I(n,"_localMatrix",Ue,L(n)),I(n,"_worldMatrix",ke,L(n)),I(n,"_updateFlagManager",Ge,L(n)),I(n,"_isParentDirty",He,L(n)),I(n,"_parentTransformCache",We,L(n)),n._dirtyFlag=Xe.WmWpWeWqWs,n._onPositionChanged=n._onPositionChanged.bind(L(n)),n._onWorldPositionChanged=n._onWorldPositionChanged.bind(L(n)),n._onRotationChanged=n._onRotationChanged.bind(L(n)),n._onWorldRotationChanged=n._onWorldRotationChanged.bind(L(n)),n._onRotationQuaternionChanged=n._onRotationQuaternionChanged.bind(L(n)),n._onWorldRotationQuaternionChanged=n._onWorldRotationQuaternionChanged.bind(L(n)),n._onScaleChanged=n._onScaleChanged.bind(L(n)),n._position._onValueChanged=n._onPositionChanged,n._worldPosition._onValueChanged=n._onWorldPositionChanged,n._rotation._onValueChanged=n._onRotationChanged,n._worldRotation._onValueChanged=n._onWorldRotationChanged,n._rotationQuaternion._onValueChanged=n._onRotationQuaternionChanged,n._worldRotationQuaternion._onValueChanged=n._onWorldRotationQuaternionChanged,n._scale._onValueChanged=n._onScaleChanged,n}A(t,e);var n=t.prototype;return n.setPosition=function(e,t,n){this._position.set(e,t,n)},n.setRotation=function(e,t,n){this._rotation.set(e,t,n)},n.setRotationQuaternion=function(e,t,n,i){this._rotationQuaternion.set(e,t,n,i)},n.setScale=function(e,t,n){this._scale.set(e,t,n)},n.setWorldPosition=function(e,t,n){this._worldPosition.set(e,t,n)},n.setWorldRotation=function(e,t,n){this._worldRotation.set(e,t,n)},n.setWorldRotationQuaternion=function(e,t,n,i){this._worldRotationQuaternion.set(e,t,n,i)},n.getWorldForward=function(e){var t=this.worldMatrix.elements;return e.set(-t[8],-t[9],-t[10]),e.normalize()},n.getWorldRight=function(e){var t=this.worldMatrix.elements;return e.set(t[0],t[1],t[2]),e.normalize()},n.getWorldUp=function(e){var t=this.worldMatrix.elements;return e.set(t[4],t[5],t[6]),e.normalize()},n.translate=function(e,n,i,r){if("number"==typeof e){var a=t._tempVec30;a.set(e,n,i),this._translate(a,r)}else this._translate(e,n)},n.rotate=function(e,t,n,i){"number"==typeof e?this._rotateXYZ(e,t,n,i):this._rotateXYZ(e.x,e.y,e.z,t)},n.rotateByAxis=function(e,n,i){void 0===i&&(i=!0);var r=n*a.degreeToRadFactor;_.rotationAxisAngle(e,r,t._tempQuat0),this._rotateByQuat(t._tempQuat0,i)},n.lookAt=function(e,n){var i=t._tempVec30;o.subtract(this.worldPosition,e,i);var r=i.length();if(!(r<=a.zeroTolerance)){i.scale(1/r);var s=t._tempVec31;if(n?o.cross(n,i,s):s.set(i.z,0,-i.x),!((r=s.length())<=a.zeroTolerance)){s.scale(1/r);var l=t._tempVec32;o.cross(i,s,l);var u=t._tempMat41,c=u.elements;c[0]=s.x,c[1]=s.y,c[2]=s.z,c[4]=l.x,c[5]=l.y,c[6]=l.z,c[8]=i.x,c[9]=i.y,c[10]=i.z,u.getRotation(this._worldRotationQuaternion)}}},n.registerWorldChangeFlag=function(){return this._updateFlagManager.createFlag(qe)},n._registerWorldChangeListener=function(){return this._updateFlagManager.createFlag(Qe)},n._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},n._isFrontFaceInvert=function(){var e=this.lossyWorldScale,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t},n._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(Xe.WmWp)){this._worldAssociatedChange(Xe.WmWp);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionFlag()}}},n._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(Xe.WmWeWq)){this._worldAssociatedChange(Xe.WmWeWq);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndRotationFlag()}}},n._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(Xe.WmWpWeWq)){this._worldAssociatedChange(Xe.WmWpWeWq);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndRotationFlag()}}},n._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(Xe.WmWs)){this._worldAssociatedChange(Xe.WmWs);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndScaleFlag()}}},n._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(Xe.WmWpWs)){this._worldAssociatedChange(Xe.WmWpWs);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateWorldPositionAndScaleFlag()}}},n._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(Xe.WmWpWeWqWs)){this._worldAssociatedChange(Xe.WmWpWeWqWs);for(var e=this._entity._children,t=0,n=e.length;t<n;t++){var i;null===(i=e[t].transform)||void 0===i||i._updateAllWorldFlag()}}},n._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,t=this._entity.parent;t;){var n=t.transform;if(n){e=n;break}t=t.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},n._getScaleMatrix=function(){var e=t._tempQuat0,n=t._tempMat30,i=t._tempMat31,r=t._tempMat32;return i.copyFromMatrix(this.worldMatrix),_.invert(this.worldRotationQuaternion,e),h.rotationQuaternion(e,n),h.multiply(n,i,r),r},n._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch()},n._rotateByQuat=function(e,t){t?_.multiply(this.rotationQuaternion,e,this._rotationQuaternion):_.multiply(e,this.worldRotationQuaternion,this._worldRotationQuaternion)},n._translate=function(e,n){if(void 0===n&&(n=!0),n){var i=t._tempVec30;o.transformByQuat(e,this.worldRotationQuaternion,i),this._worldPosition.add(i)}else this._worldPosition.add(e)},n._rotateXYZ=function(e,n,i,r){void 0===r&&(r=!0);var o=a.degreeToRadFactor,s=t._tempQuat0;_.rotationEuler(e*o,n*o,i*o,s),this._rotateByQuat(s,r)},n._onPositionChanged=function(){this._setDirtyFlagTrue(Xe.LocalMatrix),this._updateWorldPositionFlag()},n._onWorldPositionChanged=function(){var e=this._worldPosition,n=this._getParentTransform();n?(d.invert(n.worldMatrix,t._tempMat41),o.transformCoordinate(e,t._tempMat41,this._position)):this._position.copyFrom(e),this._setDirtyFlagFalse(Xe.WorldPosition)},n._onRotationChanged=function(){this._setDirtyFlagTrue(Xe.LocalMatrix|Xe.LocalQuat),this._setDirtyFlagFalse(Xe.LocalEuler),this._updateWorldRotationFlag()},n._onWorldRotationChanged=function(){var e=this._worldRotation;_.rotationEuler(a.degreeToRadian(e.x),a.degreeToRadian(e.y),a.degreeToRadian(e.z),this._worldRotationQuaternion),this._setDirtyFlagFalse(Xe.WorldEuler)},n._onRotationQuaternionChanged=function(){this._setDirtyFlagTrue(Xe.LocalMatrix|Xe.LocalEuler),this._setDirtyFlagFalse(Xe.LocalQuat),this._updateWorldRotationFlag()},n._onWorldRotationQuaternionChanged=function(){var e=this._worldRotationQuaternion,n=this._getParentTransform();if(n){var i=t._tempQuat0;_.invert(n.worldRotationQuaternion,i),_.multiply(i,e,this._rotationQuaternion)}else this._rotationQuaternion.copyFrom(e);this._setDirtyFlagFalse(Xe.WorldQuat)},n._onScaleChanged=function(){this._setDirtyFlagTrue(Xe.LocalMatrix),this._updateWorldScaleFlag()},C(t,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&this._position.copyFrom(e)}},{key:"worldPosition",get:function(){var e=this._worldPosition;return this._isContainDirtyFlag(Xe.WorldPosition)&&(e._onValueChanged=null,this._getParentTransform()?this.worldMatrix.getTranslation(e):e.copyFrom(this._position),e._onValueChanged=this._onWorldPositionChanged,this._setDirtyFlagFalse(Xe.WorldPosition)),e},set:function(e){this._worldPosition!==e&&this._worldPosition.copyFrom(e)}},{key:"rotation",get:function(){var e=this._rotation;return this._isContainDirtyFlag(Xe.LocalEuler)&&(e._onValueChanged=null,this._rotationQuaternion.toEuler(e),e._onValueChanged=this._onRotationChanged,e.scale(a.radToDegreeFactor),this._setDirtyFlagFalse(Xe.LocalEuler)),e},set:function(e){this._rotation!==e&&this._rotation.copyFrom(e)}},{key:"worldRotation",get:function(){var e=this._worldRotation;return this._isContainDirtyFlag(Xe.WorldEuler)&&(e._onValueChanged=null,this.worldRotationQuaternion.toEuler(e),e.scale(a.radToDegreeFactor),e._onValueChanged=this._onWorldRotationChanged,this._setDirtyFlagFalse(Xe.WorldEuler)),e},set:function(e){this._worldRotation!==e&&this._worldRotation.copyFrom(e)}},{key:"rotationQuaternion",get:function(){var e=this._rotationQuaternion;return this._isContainDirtyFlag(Xe.LocalQuat)&&(e._onValueChanged=null,_.rotationEuler(a.degreeToRadian(this._rotation.x),a.degreeToRadian(this._rotation.y),a.degreeToRadian(this._rotation.z),e),e._onValueChanged=this._onRotationQuaternionChanged,this._setDirtyFlagFalse(Xe.LocalQuat)),e},set:function(e){this._rotationQuaternion!==e?e.normalized?this._rotationQuaternion.copyFrom(e):_.normalize(e,this._rotationQuaternion):e.normalized||e.normalize()}},{key:"worldRotationQuaternion",get:function(){var e=this._worldRotationQuaternion;if(this._isContainDirtyFlag(Xe.WorldQuat)){e._onValueChanged=null;var t=this._getParentTransform();null!=t?_.multiply(t.worldRotationQuaternion,this.rotationQuaternion,e):e.copyFrom(this.rotationQuaternion),e._onValueChanged=this._onWorldRotationQuaternionChanged,this._setDirtyFlagFalse(Xe.WorldQuat)}return e},set:function(e){this._worldRotationQuaternion!==e&&(e.normalized?this._worldRotationQuaternion.copyFrom(e):_.normalize(e,this._worldRotationQuaternion)),e.normalized||e.normalize()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&this._scale.copyFrom(e)}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(Xe.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix().elements;this._lossyWorldScale.set(e[0],e[4],e[8])}else this._lossyWorldScale.copyFrom(this._scale);this._setDirtyFlagFalse(Xe.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(Xe.LocalMatrix)&&(d.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(Xe.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&this._localMatrix.copyFrom(e),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(Xe.LocalEuler),this._setDirtyFlagFalse(Xe.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(Xe.WorldMatrix)){var e=this._getParentTransform();e?d.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.copyFrom(this.localMatrix),this._setDirtyFlagFalse(Xe.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&this._worldMatrix.copyFrom(e);var n=this._getParentTransform();n?(d.invert(n.worldMatrix,t._tempMat42),d.multiply(t._tempMat42,e,this._localMatrix)):this._localMatrix.copyFrom(e),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(Xe.WorldMatrix)}}]),t}(Ye),je._tempQuat0=new _,je._tempVec30=new o,je._tempVec31=new o,je._tempVec32=new o,je._tempMat30=new h,je._tempMat31=new h,je._tempMat32=new h,je._tempMat41=new d,je._tempMat42=new d,Le=O((Re=je).prototype,"_position",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),De=O(Re.prototype,"_rotation",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Be=O(Re.prototype,"_rotationQuaternion",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _}}),Ie=O(Re.prototype,"_scale",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o(1,1,1)}}),Oe=O(Re.prototype,"_worldPosition",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),ze=O(Re.prototype,"_worldRotation",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Ne=O(Re.prototype,"_worldRotationQuaternion",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _}}),Ve=O(Re.prototype,"_lossyWorldScale",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o(1,1,1)}}),Ue=O(Re.prototype,"_localMatrix",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),ke=O(Re.prototype,"_worldMatrix",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Ge=O(Re.prototype,"_updateFlagManager",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Je}}),He=O(Re.prototype,"_isParentDirty",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),We=O(Re.prototype,"_parentTransformCache",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Re);!function(e){e[e.LocalEuler=1]="LocalEuler",e[e.LocalQuat=2]="LocalQuat",e[e.WorldPosition=4]="WorldPosition",e[e.WorldEuler=8]="WorldEuler",e[e.WorldQuat=16]="WorldQuat",e[e.WorldScale=32]="WorldScale",e[e.LocalMatrix=64]="LocalMatrix",e[e.WorldMatrix=128]="WorldMatrix",e[e.WmWp=132]="WmWp",e[e.WmWeWq=152]="WmWeWq",e[e.WmWpWeWq=156]="WmWpWeWq",e[e.WmWs=160]="WmWs",e[e.WmWpWs=164]="WmWpWs",e[e.WmWpWeWqWs=188]="WmWpWeWqWs"}(Xe||(Xe={}));var $e,et=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=void 0,i.layer=we.Layer0,i.transform=void 0,i._isActiveInHierarchy=!1,i._components=[],i._scripts=new me,i._children=[],i._scene=void 0,i._isRoot=!1,i._isActive=!0,i._siblingIndex=-1,i._parent=null,i._activeChangedComponents=void 0,i._invModelMatrix=new d,i._inverseWorldMatFlag=void 0,i.name=n,i.transform=i.addComponent(Ze),i._inverseWorldMatFlag=i.transform.registerWorldChangeFlag(),i}A(t,e),t._findChildByName=function(e,t){for(var n=e._children,i=n.length-1;i>=0;i--){var r=n[i];if(r.name===t)return r}return null},t._traverseSetOwnerScene=function(e,t){e._scene=t;for(var n=e._children,i=e.childCount-1;i>=0;i--)this._traverseSetOwnerScene(n[i],t)};var n=t.prototype;return n.addComponent=function(e){Ce._addCheck(this,e);var t=new e(this);return this._components.push(t),t._setActive(!0),t},n.getComponent=function(e){for(var t=this._components.length-1;t>=0;t--){var n=this._components[t];if(n instanceof e)return n}},n.getComponents=function(e,t){t.length=0;for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}return t},n.getComponentsIncludeChildren=function(e,t){return t.length=0,this._getComponentsInChildren(e,t),t},n.addChild=function(e,n){var i;if("number"==typeof e?i=e:(i=void 0,n=e),n._isRoot){n._scene._removeFromEntityList(n),n._isRoot=!1,this._addToChildrenList(i,n),n._parent=this;var r=this._scene;n._scene!==r&&t._traverseSetOwnerScene(n,r),this._isActiveInHierarchy?!n._isActiveInHierarchy&&n._isActive&&n._processActive():n._isActiveInHierarchy&&n._processInActive(),n._setTransformDirty()}else n._setParent(this,i)},n.removeChild=function(e){e._setParent(null)},n.getChild=function(e){return this._children[e]},n.findByName=function(e){var n=this._children,i=t._findChildByName(this,e);if(i)return i;for(var r=n.length-1;r>=0;r--){var a=n[r].findByName(e);if(a)return a}return null},n.findByPath=function(e){for(var n=e.split("/"),i=this,r=0,a=n.length;r<a;++r){var o=n[r];if(o&&!(i=t._findChildByName(i,o)))return null}return i},n.createChild=function(e){var n=new t(this.engine,e);return n.layer=this.layer,n.parent=this,n},n.clearChildren=function(){for(var e=this._children,n=e.length-1;n>=0;n--){var i=e[n];i._parent=null,i._isActiveInHierarchy&&i._processInActive(),t._traverseSetOwnerScene(i,null)}e.length=0},n.clone=function(){var e=new t(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var n=this._children,i=0,r=this._children.length;i<r;i++){var a=n[i];e.addChild(a.clone())}for(var o=this._components,s=0,l=o.length;s<l;s++){var u=o[s];if(!(u instanceof Ze)){var c=e.addComponent(u.constructor);be.cloneComponent(u,c)}}return e},n.destroy=function(){if(!this._destroyed){e.prototype.destroy.call(this);for(var t=this._components,n=t.length-1;n>=0;n--)t[n].destroy();this._components.length=0;for(var i=this._children,r=i.length-1;r>=0;r--)i[r].destroy();this._children.length=0,this._isRoot?(this._scene._removeFromEntityList(this),this._isRoot=!1):this._removeFromParent()}},n._removeComponent=function(e){Ce._removeCheck(this,e.constructor);var t=this._components;t.splice(t.indexOf(e),1)},n._addScript=function(e){e._entityScriptsIndex=this._scripts.length,this._scripts.add(e)},n._removeScript=function(e){var t=this._scripts.deleteByIndex(e._entityScriptsIndex);t&&(t._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1},n._removeFromParent=function(){var e=this._parent;if(null!=e){var t=e._children,n=this._siblingIndex;t.splice(n,1);for(var i=t.length;n<i;n++)t[n]._siblingIndex--;this._parent=null,this._siblingIndex=-1}},n._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},n._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},n._addToChildrenList=function(e,t){var n=this._children,i=n.length;if(void 0===e)t._siblingIndex=i,n.push(t);else{if(e<0||e>i)throw"The index "+e+" is out of child list bounds "+i;t._siblingIndex=e,n.splice(e,0,t);for(var r=e+1,a=i+1;r<a;r++)n[r]._siblingIndex++}},n._setParent=function(e,n){var i=this._parent;if(e!==i){if(this._removeFromParent(),this._parent=e,e){e._addToChildrenList(n,this);var r=e._scene;this._scene!==r&&t._traverseSetOwnerScene(this,r),e._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),i&&t._traverseSetOwnerScene(this,null);this._setTransformDirty()}},n._getComponentsInChildren=function(e,t){for(var n=this._components.length-1;n>=0;n--){var i=this._components[n];i instanceof e&&t.push(i)}for(var r=this._children.length-1;r>=0;r--)this._children[r]._getComponentsInChildren(e,t)},n._setActiveComponents=function(e){for(var t=this._activeChangedComponents,n=0,i=t.length;n<i;++n)t[n]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(t),this._activeChangedComponents=null},n._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var t=this._components,n=t.length-1;n>=0;n--){var i=t[n];(i.enabled||!i._awoken)&&e.push(i)}for(var r=this._children,a=r.length-1;a>=0;a--){var o=r[a];o.isActive&&o._setActiveInHierarchy(e)}},n._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var t=this._components,n=t.length-1;n>=0;n--){var i=t[n];i.enabled&&e.push(i)}for(var r=this._children,a=r.length-1;a>=0;a--){var o=r[a];o.isActive&&o._setInActiveInHierarchy(e)}},n._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setTransformDirty()},n._setSiblingIndex=function(e,t){if((t=Math.min(t,e.length-1))<0)throw"Sibling index "+t+" should large than 0";if(this._siblingIndex!==t){var n=this._siblingIndex;if(t<n)for(var i=n;i>=t;i--){var r=i==t?this:e[i-1];e[i]=r,r._siblingIndex=i}else for(var a=n;a<=t;a++){var o=a==t?this:e[a+1];e[a]=o,o._siblingIndex=a}}},n.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(d.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},C(t,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var t=this._parent;(null!=t&&t._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this._setParent(e)}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"siblingIndex",get:function(){return this._siblingIndex},set:function(e){if(-1===this._siblingIndex)throw"The entity "+this.name+" is not in the hierarchy";this._setSiblingIndex(this._isRoot?this._scene._rootEntities:this._parent._children,e)}}]),t}(ve),tt=function(){function e(){this._features=[],this._objects=[]}var t=e.prototype;return t.registerFeature=function(e){for(var t=this._features,n=0,i=t.length;n<i;n++)if(t[n]===e)return;t.push(e);for(var r=this._objects,a=0,o=r.length;a<o;a++)r[a].features.push(new e)},t.addObject=function(e){e.features=[];for(var t=0,n=this._features.length;t<n;t++){var i;e.features.push(new this._features[t](null!=(i=e.engine)?i:e))}this._objects.push(e)},t.callFeatureMethod=function(e,t,n){for(var i=e.features,r=i.length,a=0;a<r;a++){var o=i[a];o[t]&&o[t].apply(o,n)}},t.findFeature=function(e,t){for(var n=e.features,i=n.length,r=0;r<i;r++){var a=n[r];if(a.constructor===t)return a}},e}();exports.Keys=void 0,($e=exports.Keys||(exports.Keys={}))[$e.Backquote=0]="Backquote",$e[$e.Backslash=1]="Backslash",$e[$e.Backspace=2]="Backspace",$e[$e.BracketLeft=3]="BracketLeft",$e[$e.BracketRight=4]="BracketRight",$e[$e.Comma=5]="Comma",$e[$e.Digit0=6]="Digit0",$e[$e.Digit1=7]="Digit1",$e[$e.Digit2=8]="Digit2",$e[$e.Digit3=9]="Digit3",$e[$e.Digit4=10]="Digit4",$e[$e.Digit5=11]="Digit5",$e[$e.Digit6=12]="Digit6",$e[$e.Digit7=13]="Digit7",$e[$e.Digit8=14]="Digit8",$e[$e.Digit9=15]="Digit9",$e[$e.Equal=16]="Equal",$e[$e.IntlBackslash=17]="IntlBackslash",$e[$e.IntlRo=18]="IntlRo",$e[$e.IntlYen=19]="IntlYen",$e[$e.KeyA=20]="KeyA",$e[$e.KeyB=21]="KeyB",$e[$e.KeyC=22]="KeyC",$e[$e.KeyD=23]="KeyD",$e[$e.KeyE=24]="KeyE",$e[$e.KeyF=25]="KeyF",$e[$e.KeyG=26]="KeyG",$e[$e.KeyH=27]="KeyH",$e[$e.KeyI=28]="KeyI",$e[$e.KeyJ=29]="KeyJ",$e[$e.KeyK=30]="KeyK",$e[$e.KeyL=31]="KeyL",$e[$e.KeyM=32]="KeyM",$e[$e.KeyN=33]="KeyN",$e[$e.KeyO=34]="KeyO",$e[$e.KeyP=35]="KeyP",$e[$e.KeyQ=36]="KeyQ",$e[$e.KeyR=37]="KeyR",$e[$e.KeyS=38]="KeyS",$e[$e.KeyT=39]="KeyT",$e[$e.KeyU=40]="KeyU",$e[$e.KeyV=41]="KeyV",$e[$e.KeyW=42]="KeyW",$e[$e.KeyX=43]="KeyX",$e[$e.KeyY=44]="KeyY",$e[$e.KeyZ=45]="KeyZ",$e[$e.Minus=46]="Minus",$e[$e.Period=47]="Period",$e[$e.Quote=48]="Quote",$e[$e.Semicolon=49]="Semicolon",$e[$e.Slash=50]="Slash",$e[$e.AltLeft=51]="AltLeft",$e[$e.AltRight=52]="AltRight",$e[$e.CapsLock=53]="CapsLock",$e[$e.ContextMenu=54]="ContextMenu",$e[$e.ControlLeft=55]="ControlLeft",$e[$e.ControlRight=56]="ControlRight",$e[$e.Enter=57]="Enter",$e[$e.MetaLeft=58]="MetaLeft",$e[$e.MetaRight=59]="MetaRight",$e[$e.ShiftLeft=60]="ShiftLeft",$e[$e.ShiftRight=61]="ShiftRight",$e[$e.Space=62]="Space",$e[$e.Tab=63]="Tab",$e[$e.Convert=64]="Convert",$e[$e.KanaMode=65]="KanaMode",$e[$e.Lang1=66]="Lang1",$e[$e.Lang2=67]="Lang2",$e[$e.Lang3=68]="Lang3",$e[$e.Lang4=69]="Lang4",$e[$e.Lang5=70]="Lang5",$e[$e.NonConvert=71]="NonConvert",$e[$e.Delete=72]="Delete",$e[$e.End=73]="End",$e[$e.Help=74]="Help",$e[$e.Home=75]="Home",$e[$e.Insert=76]="Insert",$e[$e.PageDown=77]="PageDown",$e[$e.PageUp=78]="PageUp",$e[$e.ArrowDown=79]="ArrowDown",$e[$e.ArrowLeft=80]="ArrowLeft",$e[$e.ArrowRight=81]="ArrowRight",$e[$e.ArrowUp=82]="ArrowUp",$e[$e.NumLock=83]="NumLock",$e[$e.Numpad0=84]="Numpad0",$e[$e.Numpad1=85]="Numpad1",$e[$e.Numpad2=86]="Numpad2",$e[$e.Numpad3=87]="Numpad3",$e[$e.Numpad4=88]="Numpad4",$e[$e.Numpad5=89]="Numpad5",$e[$e.Numpad6=90]="Numpad6",$e[$e.Numpad7=91]="Numpad7",$e[$e.Numpad8=92]="Numpad8",$e[$e.Numpad9=93]="Numpad9",$e[$e.NumpadAdd=94]="NumpadAdd",$e[$e.NumpadBackspace=95]="NumpadBackspace",$e[$e.NumpadClear=96]="NumpadClear",$e[$e.NumpadClearEntry=97]="NumpadClearEntry",$e[$e.NumpadComma=98]="NumpadComma",$e[$e.NumpadDecimal=99]="NumpadDecimal",$e[$e.NumpadDivide=100]="NumpadDivide",$e[$e.NumpadEnter=101]="NumpadEnter",$e[$e.NumpadEqual=102]="NumpadEqual",$e[$e.NumpadHash=103]="NumpadHash",$e[$e.NumpadMemoryAdd=104]="NumpadMemoryAdd",$e[$e.NumpadMemoryClear=105]="NumpadMemoryClear",$e[$e.NumpadMemoryRecall=106]="NumpadMemoryRecall",$e[$e.NumpadMemoryStore=107]="NumpadMemoryStore",$e[$e.NumpadMemorySubtract=108]="NumpadMemorySubtract",$e[$e.NumpadMultiply=109]="NumpadMultiply",$e[$e.NumpadParenLeft=110]="NumpadParenLeft",$e[$e.NumpadParenRight=111]="NumpadParenRight",$e[$e.NumpadStar=112]="NumpadStar",$e[$e.NumpadSubtract=113]="NumpadSubtract",$e[$e.Escape=114]="Escape",$e[$e.F1=115]="F1",$e[$e.F2=116]="F2",$e[$e.F3=117]="F3",$e[$e.F4=118]="F4",$e[$e.F5=119]="F5",$e[$e.F6=120]="F6",$e[$e.F7=121]="F7",$e[$e.F8=122]="F8",$e[$e.F9=123]="F9",$e[$e.F10=124]="F10",$e[$e.F11=125]="F11",$e[$e.F12=126]="F12",$e[$e.F13=127]="F13",$e[$e.F14=128]="F14",$e[$e.F15=129]="F15",$e[$e.Fn=130]="Fn",$e[$e.FnLock=131]="FnLock",$e[$e.PrintScreen=132]="PrintScreen",$e[$e.ScrollLock=133]="ScrollLock",$e[$e.Pause=134]="Pause",$e[$e.BrowserBack=135]="BrowserBack",$e[$e.BrowserFavorites=136]="BrowserFavorites",$e[$e.BrowserForward=137]="BrowserForward",$e[$e.BrowserHome=138]="BrowserHome",$e[$e.BrowserRefresh=139]="BrowserRefresh",$e[$e.BrowserSearch=140]="BrowserSearch",$e[$e.BrowserStop=141]="BrowserStop",$e[$e.Eject=142]="Eject",$e[$e.LaunchApp1=143]="LaunchApp1",$e[$e.LaunchApp2=144]="LaunchApp2",$e[$e.LaunchMail=145]="LaunchMail",$e[$e.MediaPlayPause=146]="MediaPlayPause",$e[$e.MediaSelect=147]="MediaSelect",$e[$e.MediaStop=148]="MediaStop",$e[$e.MediaTrackNext=149]="MediaTrackNext",$e[$e.MediaTrackPrevious=150]="MediaTrackPrevious",$e[$e.Power=151]="Power",$e[$e.Sleep=152]="Sleep",$e[$e.AudioVolumeDown=153]="AudioVolumeDown",$e[$e.AudioVolumeMute=154]="AudioVolumeMute",$e[$e.AudioVolumeUp=155]="AudioVolumeUp",$e[$e.WakeUp=156]="WakeUp",$e[$e.Hyper=157]="Hyper",$e[$e.Super=158]="Super",$e[$e.Turbo=159]="Turbo",$e[$e.Abort=160]="Abort",$e[$e.Resume=161]="Resume",$e[$e.Suspend=162]="Suspend",$e[$e.Again=163]="Again",$e[$e.Copy=164]="Copy",$e[$e.Cut=165]="Cut",$e[$e.Find=166]="Find",$e[$e.Open=167]="Open",$e[$e.Paste=168]="Paste",$e[$e.Props=169]="Props",$e[$e.Select=170]="Select",$e[$e.Undo=171]="Undo",$e[$e.Hiragana=172]="Hiragana",$e[$e.Katakana=173]="Katakana",$e[$e.Unidentified=174]="Unidentified";var nt,it=function(){function e(e){this._curHeldDownKeyToIndexMap=[],this._upKeyToFrameCountMap=[],this._downKeyToFrameCountMap=[],this._curFrameHeldDownList=new me,this._curFrameDownList=new me,this._curFrameUpList=new me,this._htmlCanvas=void 0,this._nativeEvents=[],this._hadListener=!1,this._htmlCanvas=e,e.tabIndex=e.tabIndex,this._onKeyEvent=this._onKeyEvent.bind(this),e.addEventListener("keydown",this._onKeyEvent),e.addEventListener("keyup",this._onKeyEvent),this._hadListener=!0}var t=e.prototype;return t._update=function(e){var t=this._nativeEvents,n=this._curFrameDownList,i=this._curFrameUpList;if(n.length=0,i.length=0,t.length>0){for(var r=this._curHeldDownKeyToIndexMap,a=this._curFrameHeldDownList,o=this._downKeyToFrameCountMap,s=this._upKeyToFrameCountMap,l=0,u=t.length;l<u;l++){var c=t[l],h=exports.Keys[c.code];switch(c.type){case"keydown":null==r[h]&&(n.add(h),a.add(h),r[h]=a.length-1,o[h]=e);break;case"keyup":var _=r[h];if(null!=_){r[h]=null;var d=a.deleteByIndex(_);d&&(r[d]=_)}i.add(h),s[h]=e}}t.length=0}},t._onFocus=function(){this._hadListener||(this._htmlCanvas.addEventListener("keydown",this._onKeyEvent),this._htmlCanvas.addEventListener("keyup",this._onKeyEvent),this._hadListener=!0)},t._onBlur=function(){this._hadListener&&(this._htmlCanvas.removeEventListener("keydown",this._onKeyEvent),this._htmlCanvas.removeEventListener("keyup",this._onKeyEvent),this._curHeldDownKeyToIndexMap.length=0,this._curFrameHeldDownList.length=0,this._curFrameDownList.length=0,this._curFrameUpList.length=0,this._nativeEvents.length=0,this._hadListener=!1)},t._destroy=function(){this._hadListener&&(this._htmlCanvas.removeEventListener("keydown",this._onKeyEvent),this._htmlCanvas.removeEventListener("keyup",this._onKeyEvent),this._hadListener=!1),this._curHeldDownKeyToIndexMap=null,this._upKeyToFrameCountMap=null,this._downKeyToFrameCountMap=null,this._nativeEvents=null,this._curFrameHeldDownList=null,this._curFrameDownList=null,this._curFrameUpList=null},t._onKeyEvent=function(e){e.cancelable&&e.preventDefault(),this._nativeEvents.push(e)},e}();!function(e){e[e.None=0]="None",e[e.Color=1]="Color",e[e.Depth=2]="Depth",e[e.Stencil=4]="Stencil",e[e.ColorDepth=3]="ColorDepth",e[e.ColorStencil=5]="ColorStencil",e[e.DepthStencil=6]="DepthStencil",e[e.All=7]="All"}(nt||(nt={}));var rt,at=function(){this.entity=null,this.distance=0,this.point=new o,this.normal=new o},ot=function(){function e(e){var t=this;this._initialized=!1,this._engine=void 0,this._restTime=0,this._colliders=new me,this._gravity=new o(0,-9.81,0),this._nativePhysicsManager=void 0,this._physicalObjectsMap={},this._onContactEnter=function(e,n){for(var i=t._physicalObjectsMap[e],r=t._physicalObjectsMap[n],a=i.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onCollisionEnter(r)}for(var u=0,c=(a=r.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onCollisionEnter(i)}},this._onContactExit=function(e,n){for(var i=t._physicalObjectsMap[e],r=t._physicalObjectsMap[n],a=i.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onCollisionExit(r)}for(var u=0,c=(a=r.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onCollisionExit(i)}},this._onContactStay=function(e,n){for(var i=t._physicalObjectsMap[e],r=t._physicalObjectsMap[n],a=i.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onCollisionStay(r)}for(var u=0,c=(a=r.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onCollisionStay(i)}},this._onTriggerEnter=function(e,n){for(var i=t._physicalObjectsMap[e],r=t._physicalObjectsMap[n],a=i.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onTriggerEnter(r)}for(var u=0,c=(a=r.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onTriggerEnter(i)}},this._onTriggerExit=function(e,n){for(var i=t._physicalObjectsMap[e],r=t._physicalObjectsMap[n],a=i.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onTriggerExit(r)}for(var u=0,c=(a=r.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onTriggerExit(i)}},this._onTriggerStay=function(e,n){for(var i=t._physicalObjectsMap[e],r=t._physicalObjectsMap[n],a=i.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onTriggerStay(r)}for(var u=0,c=(a=r.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onTriggerStay(i)}},this.fixedTimeStep=1/60,this.maxSumTimeStep=1/3,this._engine=e}var t=e.prototype;return t.initialize=function(t){this._initialized||(e._nativePhysics=t,this._nativePhysicsManager=e._nativePhysics.createPhysicsManager(this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay),this._initialized=!0)},t.raycast=function(e,t,n,i){var r,a=this,o=Number.MAX_VALUE;"number"==typeof t?o=t:null!=t&&(r=t);var s=we.Everything;if("number"==typeof n?s=n:null!=n&&(r=n),i&&(r=i),null!=r){var l=this._nativePhysicsManager.raycast(e,o,(function(e,t,n,i){r.entity=a._physicalObjectsMap[e]._collider.entity,r.distance=t,r.normal.copyFrom(i),r.point.copyFrom(n)}));return!!l&&(!!(r.entity.layer&s)||(r.entity=null,r.distance=0,r.point.set(0,0,0),r.normal.set(0,0,0),!1))}return this._nativePhysicsManager.raycast(e,o)},t._update=function(e){var t=this.fixedTimeStep,n=this._nativePhysicsManager,i=this._engine._componentsManager,r=e+this._restTime,a=Math.floor(Math.min(this.maxSumTimeStep,r)/t);this._restTime=r-a*t;for(var o=0;o<a;o++)i.callScriptOnPhysicsUpdate(),this._callColliderOnUpdate(),n.update(t),this._callColliderOnLateUpdate()},t._addColliderShape=function(e){this._physicalObjectsMap[e.id]=e,this._nativePhysicsManager.addColliderShape(e._nativeShape)},t._removeColliderShape=function(e){delete this._physicalObjectsMap[e.id],this._nativePhysicsManager.removeColliderShape(e._nativeShape)},t._addCollider=function(e){-1===e._index&&(e._index=this._colliders.length,this._colliders.add(e)),this._nativePhysicsManager.addCollider(e._nativeCollider)},t._addCharacterController=function(e){-1===e._index&&(e._index=this._colliders.length,this._colliders.add(e)),this._nativePhysicsManager.addCharacterController(e._nativeCollider)},t._removeCollider=function(e){var t=this._colliders.deleteByIndex(e._index);t&&(t._index=e._index),e._index=-1,this._nativePhysicsManager.removeCollider(e._nativeCollider)},t._removeCharacterController=function(e){var t=this._colliders.deleteByIndex(e._index);t&&(t._index=e._index),e._index=-1,this._nativePhysicsManager.removeCharacterController(e._nativeCollider)},t._callColliderOnUpdate=function(){for(var e=this._colliders._elements,t=this._colliders.length-1;t>=0;--t)e[t]._onUpdate()},t._callColliderOnLateUpdate=function(){for(var e=this._colliders._elements,t=this._colliders.length-1;t>=0;--t)e[t]._onLateUpdate()},C(e,[{key:"gravity",get:function(){return this._gravity},set:function(e){var t=this._gravity;t!==e&&t.copyFrom(e),this._nativePhysicsManager.setGravity(t)}}]),e}();ot._nativePhysics=void 0,function(e){e[e.Average=0]="Average",e[e.Minimum=1]="Minimum",e[e.Multiply=2]="Multiply",e[e.Maximum=3]="Maximum"}(rt||(rt={}));var st,lt,ut,ct,ht=function(){function e(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=rt.Average,this._frictionCombine=rt.Average,this._nativeMaterial=void 0,this._nativeMaterial=ot._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}return e.prototype._destroy=function(){this._nativeMaterial.destroy()},C(e,[{key:"bounciness",get:function(){return this._bounciness},set:function(e){this._bounciness=e,this._nativeMaterial.setBounciness(e)}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(e){this._dynamicFriction=e,this._nativeMaterial.setDynamicFriction(e)}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(e){this._staticFriction=e,this._nativeMaterial.setStaticFriction(e)}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(e){this._bounceCombine=e,this._nativeMaterial.setBounceCombine(e)}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(e){this._frictionCombine=e,this._nativeMaterial.setFrictionCombine(e)}}]),e}(),_t=Te(Ze)((lt=function(e){function t(t){var n;return I(n=e.call(this,t)||this,"_index",ut,L(n)),n._nativeCollider=void 0,n._updateFlag=void 0,n._shapes=[],n._updateFlag=n.entity.transform.registerWorldChangeFlag(),n}A(t,e);var n=t.prototype;return n.addShape=function(e){var t=e._collider;t!==this&&(t&&t.removeShape(e),this._shapes.push(e),this.engine.physicsManager._addColliderShape(e),e._collider=this,this._nativeCollider.addShape(e._nativeShape))},n.removeShape=function(e){var t=this._shapes.indexOf(e);-1!==t&&(this._shapes.splice(t,1),this.engine.physicsManager._removeColliderShape(e),e._collider=null,this._nativeCollider.removeShape(e._nativeShape))},n.clearShapes=function(){for(var e=this._shapes,t=0,n=e.length;t<n;t++){var i=e[t];this.engine.physicsManager._removeColliderShape(i),i._destroy(),this._nativeCollider.removeShape(i._nativeShape)}e.length=0},n._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion);for(var t=e.lossyWorldScale,n=0,i=this.shapes.length;n<i;n++)this.shapes[n]._nativeShape.setWorldScale(t);this._updateFlag.flag=!1}},n._onLateUpdate=function(){},n._onEnable=function(){this.engine.physicsManager._addCollider(this)},n._onDisable=function(){this.engine.physicsManager._removeCollider(this)},n._onDestroy=function(){this.clearShapes(),this._nativeCollider.destroy()},C(t,[{key:"shapes",get:function(){return this._shapes}}]),t}(Ye),ut=O(lt.prototype,"_index",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),st=lt))||st;!function(e){e[e.PreventClimbing=0]="PreventClimbing",e[e.PreventClimbingAndForceSliding=1]="PreventClimbingAndForceSliding"}(ct||(ct={}));var dt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._index=-1,n._stepOffset=0,n._nonWalkableMode=ct.PreventClimbing,n._upDirection=new o(0,1,0),n._slopeLimit=0,n._nativeCollider=ot._nativePhysics.createCharacterController(),n}A(t,e);var n=t.prototype;return n.move=function(e,t,n){return this._nativeCollider.move(e,t,n)},n.addShape=function(t){if(this._shapes.length>0)throw"only allow single shape on controller!";e.prototype.addShape.call(this,t),this._updateFlag.flag=!0},n.clearShapes=function(){this._shapes.length>0&&e.prototype.removeShape.call(this,this._shapes[0])},n._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform,t=this.shapes;this._nativeCollider.setWorldPosition(e.worldPosition);for(var n=e.lossyWorldScale,i=0,r=t.length;i<r;i++)t[i]._nativeShape.setWorldScale(n);this._updateFlag.flag=!1}},n._onLateUpdate=function(){var e=this.entity.transform.worldPosition;this._nativeCollider.getWorldPosition(e),this.entity.transform.worldPosition=e,this._updateFlag.flag=!1},n._onEnable=function(){this.engine.physicsManager._addCharacterController(this)},n._onDisable=function(){this.engine.physicsManager._removeCharacterController(this)},C(t,[{key:"stepOffset",get:function(){return this._stepOffset},set:function(e){this._stepOffset=e,this._nativeCollider.setStepOffset(e)}},{key:"nonWalkableMode",get:function(){return this._nonWalkableMode},set:function(e){this._nonWalkableMode=e,this._nativeCollider.setNonWalkableMode(e)}},{key:"upDirection",get:function(){return this._upDirection},set:function(e){this._upDirection!==e&&this._upDirection.copyFrom(e),this._nativeCollider.setUpDirection(this._upDirection)}},{key:"slopeLimit",get:function(){return this._slopeLimit},set:function(e){this._slopeLimit=e,this._nativeCollider.setSlopeLimit(e)}}]),t}(_t),ft=function(){function e(){this._collider=void 0,this._nativeShape=void 0,this._id=void 0,this._position=new o,this._material=void 0,this._isTrigger=!1,this._isSceneQuery=!0,this._contactOffset=0,this._material=new ht,this._id=e._idGenerator++}var t=e.prototype;return t.setPosition=function(e,t,n){this._position.set(e,t,n),this._nativeShape.setPosition(this._position)},t._destroy=function(){this._material._destroy(),this._nativeShape.destroy()},C(e,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"contactOffset",get:function(){return this._contactOffset},set:function(e){this._contactOffset=e,this._nativeShape.setContactOffset(e)}},{key:"material",get:function(){return this._material},set:function(e){this._material=e,this._nativeShape.setMaterial(e._nativeMaterial)}},{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&this._position.copyFrom(e),this._nativeShape.setPosition(e)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._nativeShape.setIsTrigger(e)}}]),e}();ft._idGenerator=0;var pt,gt=function(e){function t(){var t;return(t=e.call(this)||this)._size=new o(1,1,1),t._nativeShape=ot._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t}return A(t,e),t.prototype.setSize=function(e,t,n){this._size.x=e,this._size.y=t,this._size.z=n,this._nativeShape.setSize(this._size)},C(t,[{key:"size",get:function(){return this._size},set:function(e){this._size!=e&&this._size.copyFrom(e),this._nativeShape.setSize(e)}}]),t}(ft),vt=function(e){function t(){var t;return(t=e.call(this)||this)._radius=1,t._nativeShape=ot._nativePhysics.createSphereColliderShape(t._id,t._radius,t._material._nativeMaterial),t}return A(t,e),C(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._nativeShape.setRadius(e)}}]),t}(ft),mt=function(e){function t(){var t;return(t=e.call(this)||this)._rotation=new o,t._nativeShape=ot._nativePhysics.createPlaneColliderShape(t._id,t._material._nativeMaterial),t}return A(t,e),t.prototype.setRotation=function(e,t,n){this._rotation.set(e,t,n),this._nativeShape.setRotation(this._rotation)},C(t,[{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation!=e&&this._rotation.copyFrom(e),this._nativeShape.setRotation(e)}}]),t}(ft);!function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(pt||(pt={}));var yt,xt,wt=function(e){function t(){var t;return(t=e.call(this)||this)._radius=1,t._height=2,t._upAxis=pt.Y,t._nativeShape=ot._nativePhysics.createCapsuleColliderShape(t._id,t._radius,t._height,t._material._nativeMaterial),t._nativeShape.setUpAxis(pt.Y),t}return A(t,e),C(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._nativeShape.setRadius(e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._nativeShape.setHeight(e)}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis=e,this._nativeShape.setUpAxis(e)}}]),t}(ft),bt=Te(_t)(yt=function(e){function t(t){var n;return(n=e.call(this,t)||this)._connectedCollider=new Ct,n._collider=new Ct,n._nativeJoint=void 0,n._force=0,n._torque=0,n._connectedCollider.localPosition=new o,n}return A(t,e),C(t,[{key:"connectedCollider",get:function(){return this._connectedCollider.collider},set:function(e){this._connectedCollider.collider!==e&&(this._connectedCollider.collider=e,this._nativeJoint.setConnectedCollider(e._nativeCollider))}},{key:"connectedAnchor",get:function(){return this._connectedCollider.localPosition},set:function(e){var t=this._connectedCollider.localPosition;e!==t&&t.copyFrom(e),this._nativeJoint.setConnectedAnchor(e)}},{key:"connectedMassScale",get:function(){return this._connectedCollider.massScale},set:function(e){e!==this._connectedCollider.massScale&&(this._connectedCollider.massScale=e,this._nativeJoint.setConnectedMassScale(e))}},{key:"connectedInertiaScale",get:function(){return this._connectedCollider.inertiaScale},set:function(e){e!==this._connectedCollider.inertiaScale&&(this._connectedCollider.inertiaScale=e,this._nativeJoint.setConnectedInertiaScale(e))}},{key:"massScale",get:function(){return this._collider.massScale},set:function(e){e!==this._collider.massScale&&(this._collider.massScale=e,this._nativeJoint.setMassScale(e))}},{key:"inertiaScale",get:function(){return this._collider.inertiaScale},set:function(e){e!==this._collider.inertiaScale&&(this._collider.inertiaScale=e,this._nativeJoint.setInertiaScale(e))}},{key:"breakForce",get:function(){return this._force},set:function(e){e!==this._force&&(this._force=e,this._nativeJoint.setBreakForce(e))}},{key:"breakTorque",get:function(){return this._torque},set:function(e){e!==this._torque&&(this._torque=e,this._nativeJoint.setBreakTorque(e))}}]),t}(Ye))||yt,Ct=function(){this.collider=null,this.localPosition=void 0,this.localRotation=void 0,this.massScale=0,this.inertiaScale=0},Tt=function(e){function t(){return e.apply(this,arguments)||this}return A(t,e),t.prototype._onAwake=function(){var e=this._collider;e.collider=this.entity.getComponent(_t),this._nativeJoint=ot._nativePhysics.createFixedJoint(e.collider._nativeCollider)},t}(bt);!function(e){e[e.LimitEnabled=1]="LimitEnabled",e[e.DriveEnabled=2]="DriveEnabled",e[e.DriveFreeSpin=4]="DriveFreeSpin"}(xt||(xt={}));var St,At=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._axis=new o(1,0,0),t._hingeFlags=0,t._useSpring=!1,t._jointMonitor=void 0,t._limits=void 0,t}return A(t,e),t.prototype._onAwake=function(){var e=this._collider;e.localPosition=new o,e.collider=this.entity.getComponent(_t),this._nativeJoint=ot._nativePhysics.createHingeJoint(e.collider._nativeCollider)},C(t,[{key:"axis",get:function(){return this._axis},set:function(e){var t=this._axis;e!==t&&t.copyFrom(e),this._nativeJoint.setAxis(t)}},{key:"swingOffset",get:function(){return this._collider.localPosition},set:function(e){var t=this._collider.localPosition;e!==t&&t.copyFrom(e),this._nativeJoint.setSwingOffset(t)}},{key:"angle",get:function(){return this._nativeJoint.getAngle()}},{key:"velocity",get:function(){return this._nativeJoint.getVelocity()}},{key:"useLimits",get:function(){return(this._hingeFlags&xt.LimitEnabled)==xt.LimitEnabled},set:function(e){e!==this.useLimits&&(this._hingeFlags|=xt.LimitEnabled),this._nativeJoint.setHingeJointFlag(xt.LimitEnabled,e)}},{key:"useMotor",get:function(){return(this._hingeFlags&xt.DriveEnabled)==xt.DriveEnabled},set:function(e){e!==this.useMotor&&(this._hingeFlags|=xt.DriveEnabled),this._nativeJoint.setHingeJointFlag(xt.DriveEnabled,e)}},{key:"useSpring",get:function(){return this._useSpring},set:function(e){this._useSpring=e,this.limits=this._limits}},{key:"motor",get:function(){return this._jointMonitor},set:function(e){this._jointMonitor=e,this._nativeJoint.setDriveVelocity(e.targetVelocity),this._nativeJoint.setDriveForceLimit(e.forceLimit),this._nativeJoint.setDriveGearRatio(e.gearRation),this._nativeJoint.setHingeJointFlag(xt.DriveFreeSpin,e.freeSpin)}},{key:"limits",get:function(){return this._limits},set:function(e){this._limits=e,this.useSpring?this._nativeJoint.setSoftLimit(e.min,e.max,e.stiffness,e.damping):this._nativeJoint.setHardLimit(e.min,e.max,e.contactDistance)}}]),t}(bt),Pt=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._minDistance=0,t._maxDistance=0,t._tolerance=.25,t._stiffness=0,t._damping=0,t}return A(t,e),t.prototype._onAwake=function(){var e=this._collider;e.localPosition=new o,e.collider=this.entity.getComponent(_t),this._nativeJoint=ot._nativePhysics.createSpringJoint(e.collider._nativeCollider)},C(t,[{key:"swingOffset",get:function(){return this._collider.localPosition},set:function(e){var t=this._collider.localPosition;e!==t&&t.copyFrom(e),this._nativeJoint.setSwingOffset(e)}},{key:"minDistance",get:function(){return this._minDistance},set:function(e){this._minDistance=e,this._nativeJoint.setMinDistance(e)}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,this._nativeJoint.setMaxDistance(e)}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._nativeJoint.setTolerance(e)}},{key:"stiffness",get:function(){return this._stiffness},set:function(e){this._stiffness=e,this._nativeJoint.setStiffness(e)}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping=e,this._nativeJoint.setDamping(e)}}]),t}(bt);!function(e){e[e.Sides=1]="Sides",e[e.Up=2]="Up",e[e.Down=4]="Down"}(St||(St={}));var Mt,Et,Ft,Rt,Lt=function(e){function t(t){var n,i=(n=e.call(this,t)||this).entity.transform;return n._nativeCollider=ot._nativePhysics.createStaticCollider(i.worldPosition,i.worldRotationQuaternion),n}return A(t,e),t}(_t),Dt=function(e){function t(t){var n;(n=e.call(this,t)||this)._linearDamping=0,n._angularDamping=0,n._linearVelocity=new o,n._angularVelocity=new o,n._mass=0,n._centerOfMass=new o,n._inertiaTensor=new o,n._maxAngularVelocity=0,n._maxDepenetrationVelocity=0,n._sleepThreshold=0,n._solverIterations=0,n._isKinematic=!1,n._constraints=0,n._collisionDetectionMode=Mt.Discrete;var i=n.entity.transform;return n._nativeCollider=ot._nativePhysics.createDynamicCollider(i.worldPosition,i.worldRotationQuaternion),n}A(t,e);var n=t.prototype;return n.applyForce=function(e){this._nativeCollider.addForce(e)},n.applyTorque=function(e){this._nativeCollider.addTorque(e)},n.move=function(e,t){this._nativeCollider.move(e,t)},n.sleep=function(){this._nativeCollider.sleep()},n.wakeUp=function(){this._nativeCollider.wakeUp()},n._onLateUpdate=function(){var e=this.entity.transform,t=e.worldPosition,n=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(t,n),this._updateFlag.flag=!1},C(t,[{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._nativeCollider.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._nativeCollider.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._linearVelocity},set:function(e){this._linearVelocity!==e&&this._linearVelocity.copyFrom(e),this._nativeCollider.setLinearVelocity(this._linearVelocity)}},{key:"angularVelocity",get:function(){return this._angularVelocity},set:function(e){this._angularVelocity!==e&&this._angularVelocity.copyFrom(e),this._nativeCollider.setAngularVelocity(this._angularVelocity)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._nativeCollider.setMass(e)}},{key:"centerOfMass",get:function(){return this._centerOfMass},set:function(e){this._centerOfMass!==e&&this._centerOfMass.copyFrom(e),this._nativeCollider.setCenterOfMass(this._centerOfMass)}},{key:"inertiaTensor",get:function(){return this._inertiaTensor},set:function(e){this._inertiaTensor!==e&&this._inertiaTensor.copyFrom(e),this._nativeCollider.setInertiaTensor(this._inertiaTensor)}},{key:"maxAngularVelocity",get:function(){return this._maxAngularVelocity},set:function(e){this._maxAngularVelocity=e,this._nativeCollider.setMaxAngularVelocity(e)}},{key:"maxDepenetrationVelocity",get:function(){return this._maxDepenetrationVelocity},set:function(e){this._maxDepenetrationVelocity=e,this._nativeCollider.setMaxDepenetrationVelocity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e,this._nativeCollider.setSleepThreshold(e)}},{key:"solverIterations",get:function(){return this._solverIterations},set:function(e){this._solverIterations=e,this._nativeCollider.setSolverIterations(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._nativeCollider.setIsKinematic(e)}},{key:"constraints",get:function(){return this._constraints},set:function(e){this._constraints=e,this._nativeCollider.setConstraints(e)}},{key:"collisionDetectionMode",get:function(){return this._collisionDetectionMode},set:function(e){this._collisionDetectionMode=e,this._nativeCollider.setCollisionDetectionMode(e)}}]),t}(_t);!function(e){e[e.Discrete=0]="Discrete",e[e.Continuous=1]="Continuous",e[e.ContinuousDynamic=2]="ContinuousDynamic",e[e.ContinuousSpeculative=3]="ContinuousSpeculative"}(Mt||(Mt={})),function(e){e[e.None=0]="None",e[e.FreezePositionX=1]="FreezePositionX",e[e.FreezePositionY=2]="FreezePositionY",e[e.FreezePositionZ=4]="FreezePositionZ",e[e.FreezeRotationX=8]="FreezeRotationX",e[e.FreezeRotationY=16]="FreezeRotationY",e[e.FreezeRotationZ=32]="FreezeRotationZ"}(Et||(Et={})),function(e){e[e.Down=0]="Down",e[e.Move=1]="Move",e[e.Up=2]="Up",e[e.Leave=3]="Leave"}(Ft||(Ft={})),exports.PointerButton=void 0,(Rt=exports.PointerButton||(exports.PointerButton={}))[Rt.Primary=0]="Primary",Rt[Rt.Auxiliary=1]="Auxiliary",Rt[Rt.Secondary=2]="Secondary",Rt[Rt.XButton1=3]="XButton1",Rt[Rt.XButton2=4]="XButton2",Rt[Rt.XButton3=5]="XButton3",Rt[Rt.XButton4=6]="XButton4",Rt[Rt.XButton5=7]="XButton5",Rt[Rt.XButton6=8]="XButton6",Rt[Rt.XButton7=9]="XButton7",Rt[Rt.XButton8=10]="XButton8";var Bt,It=function(e){this.id=void 0,this.phase=Ft.Leave,this.position=new p,this._uniqueID=void 0,this.id=e},Ot=function(){function e(e,t){this._pointers=[],this._movingDelta=new p,this._multiPointerEnabled=!0,this._buttons=0,this._upMap=[],this._downMap=[],this._downList=new me,this._upList=new me,this._currentPosition=new p,this._currentPressedEntity=void 0,this._currentEnteredEntity=void 0,this._engine=void 0,this._canvas=void 0,this._htmlCanvas=void 0,this._nativeEvents=[],this._pointerPool=void 0,this._keyEventList=[],this._keyEventCount=0,this._needOverallPointers=!1,this._hadListener=!1,this._lastPositionFrameCount=0,this._engine=e,this._canvas=e.canvas,this._htmlCanvas=t,t.oncontextmenu=function(e){return!1};var n=this._onPointerEvent=this._onPointerEvent.bind(this);t.addEventListener("pointerdown",n),t.addEventListener("pointerup",n),t.addEventListener("pointerout",n),t.addEventListener("pointermove",n),this._hadListener=!0,this._pointerPool=new Array(11)}var t=e.prototype;return t._update=function(e){if(this._needOverallPointers&&this._overallPointers(),this._downList.length=0,this._upList.length=0,this._movingDelta.set(0,0),this._nativeEvents.length>0&&this._handlePointerEvent(this._nativeEvents,e),this._pointers.length>0&&(this._lastPositionFrameCount=e),this._engine.physicsManager._initialized){var t=this._pointerRayCast(),n=this._keyEventCount;if(n>0){for(var i=this._keyEventList,r=0;r<n;r++)switch(i[r]){case Bt.Down:this._firePointerDown(t);break;case Bt.Up:this._firePointerUpAndClick(t)}this._firePointerExitAndEnter(t),i[n-1]===Bt.Leave&&(this._currentPressedEntity=null),this._keyEventCount=0}else this._firePointerDrag(),this._firePointerExitAndEnter(t)}},t._onFocus=function(){if(!this._hadListener){var e=this._htmlCanvas,t=this._onPointerEvent;e.addEventListener("pointerdown",t),e.addEventListener("pointerup",t),e.addEventListener("pointerout",t),e.addEventListener("pointermove",t),this._hadListener=!0}},t._onBlur=function(){if(this._hadListener){var e=this._htmlCanvas,t=this._onPointerEvent;e.removeEventListener("pointerdown",t),e.removeEventListener("pointerup",t),e.removeEventListener("pointerout",t),e.removeEventListener("pointermove",t),this._nativeEvents.length=0,this._pointerPool.length=0,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._downList.length=0,this._upList.length=0,this._hadListener=!1}},t._destroy=function(){if(this._hadListener){var e=this._htmlCanvas,t=this._onPointerEvent;e.removeEventListener("pointerdown",t),e.removeEventListener("pointerup",t),e.removeEventListener("pointerout",t),e.removeEventListener("pointermove",t),this._hadListener=!1}this._nativeEvents.length=0,this._pointerPool.length=0,this._pointers.length=0,this._currentPosition=null,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._engine=null,this._canvas=null},t._onPointerEvent=function(e){e.cancelable&&e.preventDefault(),"pointerdown"===e.type&&this._htmlCanvas.focus(),this._nativeEvents.push(e)},t._overallPointers=function(){for(var e=this._pointers,t=0,n=e.length,i=0;i<n;i++)e[i].phase===Ft.Leave?t++:t>0&&(e[i-t]=e[i]);e.length=n-t,this._needOverallPointers=!1},t._getIndexByPointerID=function(e){for(var t=this._pointers,n=t.length-1;n>=0;n--)if(t[n]._uniqueID===e)return n;return-1},t._addPointer=function(e,t,n,i){var r=this._pointers,a=r.length;if(0===a||this._multiPointerEnabled){for(var o=this._pointerPool,s=0;s<a&&!(r[s].id>s);s++);var l=o[s];l||(l=o[s]=new It(s)),l._uniqueID=e,l.position.set(t,n),l.phase=i,r.splice(s,0,l)}},t._removePointer=function(e){this._pointers[e].phase=Ft.Leave},t._updatePointer=function(e,t,n,i){var r=this._pointers[e];r.position.set(t,n),r.phase=i},t._handlePointerEvent=function(e,t){for(var n=this._pointers,i=this._keyEventList,r=this._upMap,a=this._downMap,o=this._upList,s=this._downList,l=n.length,u=this._canvas.width/this._htmlCanvas.clientWidth,c=this._canvas.height/this._htmlCanvas.clientHeight,h=e.length,_=0;_<h;_++){var d=e[_],f=d.button|exports.PointerButton.Primary,p=this._getIndexByPointerID(d.pointerId);switch(d.type){case"pointerdown":-1===p?(this._addPointer(d.pointerId,d.offsetX*u,d.offsetY*c,Ft.Down),l++):this._updatePointer(p,d.offsetX*u,d.offsetY*c,Ft.Down),l>=1&&(i[this._keyEventCount++]=Bt.Down),s.add(f),a[f]=t;break;case"pointerup":p>=0&&(this._updatePointer(p,d.offsetX*u,d.offsetY*c,Ft.Up),l>=1&&(i[this._keyEventCount++]=Bt.Up)),o.add(f),r[f]=t;break;case"pointermove":-1===p?(this._addPointer(d.pointerId,d.offsetX*u,d.offsetY*c,Ft.Move),l++):this._updatePointer(p,d.offsetX*u,d.offsetY*c,Ft.Move);break;case"pointerout":p>=0&&(this._removePointer(p),0==--l&&(i[this._keyEventCount++]=Bt.Leave),this._needOverallPointers=!0)}}this._buttons=e[h-1].buttons;var g=n.length;if(g>0){var v=this._currentPosition,m=v.x,y=v.y;if(0===l){var x=e[h-1];v.set(x.offsetX*u,x.offsetY*c)}else{v.set(0,0);for(var w=0;w<g;w++)v.add(n[w].position);v.scale(1/g)}this._lastPositionFrameCount===t-1&&this._movingDelta.set(v.x-m,v.y-y)}e.length=0},t._pointerRayCast=function(){if(this._pointers.length>0)for(var t=e._tempPoint,n=e._tempRay,i=e._tempHitResult,r=this._engine.sceneManager.activeScene._activeCameras,a=this._currentPosition.x/this._canvas.width,o=this._currentPosition.y/this._canvas.height,s=r.length-1;s>=0;s--){var l=r[s];if(l.enabled&&!l.renderTarget){var u=l.viewport,c=u.x,h=u.y,_=u.z,d=u.w;if(a>=c&&o>=h&&a-c<=_&&o-h<=d){if(t.set((a-c)/_,(o-h)/d),this._engine.physicsManager.raycast(l.viewportPointToRay(t,n),Number.MAX_VALUE,l.cullingMask,i))return i.entity;if(l.clearFlags&nt.Color)return null}}}return null},t._firePointerDrag=function(){if(this._currentPressedEntity)for(var e=this._currentPressedEntity._scripts,t=e.length-1;t>=0;t--){var n=e.get(t);n._waitHandlingInValid||n.onPointerDrag()}},t._firePointerExitAndEnter=function(e){if(this._currentEnteredEntity!==e){if(this._currentEnteredEntity)for(var t=this._currentEnteredEntity._scripts,n=t.length-1;n>=0;n--){var i=t.get(n);i._waitHandlingInValid||i.onPointerExit()}if(e)for(var r=e._scripts,a=r.length-1;a>=0;a--){var o=r.get(a);o._waitHandlingInValid||o.onPointerEnter()}this._currentEnteredEntity=e}},t._firePointerDown=function(e){if(e)for(var t=e._scripts,n=t.length-1;n>=0;n--){var i=t.get(n);i._waitHandlingInValid||i.onPointerDown()}this._currentPressedEntity=e},t._firePointerUpAndClick=function(e){var t=this._currentPressedEntity;if(t){for(var n=t===e,i=t._scripts,r=i.length-1;r>=0;r--){var a=i.get(r);a._waitHandlingInValid||(n&&a.onPointerClick(),a.onPointerUp())}this._currentPressedEntity=null}},e}();Ot.Buttons=[1,4,2,8,16,32,64,128,256,512,1024],Ot._tempRay=new f,Ot._tempPoint=new p,Ot._tempHitResult=new at,function(e){e[e.Down=0]="Down",e[e.Up=1]="Up",e[e.Leave=2]="Leave"}(Bt||(Bt={}));var zt,Nt=function(){function e(e){this._delta=new o,this._nativeEvents=[],this._canvas=void 0,this._hadListener=void 0,this._onWheelEvent=this._onWheelEvent.bind(this),e.addEventListener("wheel",this._onWheelEvent),this._canvas=e,this._hadListener=!0}var t=e.prototype;return t._update=function(){var e=this._delta;e.set(0,0,0);var t=this._nativeEvents;if(t.length>0){for(var n=t.length-1;n>=0;n--){var i=t[n];e.x+=i.deltaX,e.y+=i.deltaY,e.z+=i.deltaZ}t.length=0}},t._onFocus=function(){this._hadListener||(this._canvas.addEventListener("wheel",this._onWheelEvent),this._hadListener=!0)},t._onBlur=function(){this._hadListener&&(this._canvas.removeEventListener("wheel",this._onWheelEvent),this._nativeEvents.length=0,this._delta.set(0,0,0),this._hadListener=!1)},t._destroy=function(){this._hadListener&&(this._canvas.removeEventListener("wheel",this._onWheelEvent),this._hadListener=!1),this._nativeEvents=null},t._onWheelEvent=function(e){e.cancelable&&e.preventDefault(),this._nativeEvents.push(e)},e}(),Vt=function(){var e=t.prototype;function t(e){this._initialized=!1,this._curFrameCount=0,this._wheelManager=void 0,this._pointerManager=void 0,this._keyboardManager=void 0;var t=e._canvas._webCanvas;void 0!==n.polyfill.OffscreenCanvas&&t instanceof n.polyfill.OffscreenCanvas||(this._wheelManager=new Nt(t),this._pointerManager=new Ot(e,t),this._keyboardManager=new it(t),this._onBlur=this._onBlur.bind(this),n.polyfill.window.addEventListener("blur",this._onBlur),this._onFocus=this._onFocus.bind(this),n.polyfill.window.addEventListener("focus",this._onFocus),this._initialized=!0)}return e.isKeyHeldDown=function(e){return!!this._initialized&&(void 0===e?this._keyboardManager._curFrameHeldDownList.length>0:null!=this._keyboardManager._curHeldDownKeyToIndexMap[e])},e.isKeyDown=function(e){return!!this._initialized&&(void 0===e?this._keyboardManager._curFrameDownList.length>0:this._keyboardManager._downKeyToFrameCountMap[e]===this._curFrameCount)},e.isKeyUp=function(e){return!!this._initialized&&(void 0===e?this._keyboardManager._curFrameUpList.length>0:this._keyboardManager._upKeyToFrameCountMap[e]===this._curFrameCount)},e.isPointerHeldDown=function(e){return!!this._initialized&&(void 0===e?0!==this._pointerManager._buttons:0!=(this._pointerManager._buttons&Ot.Buttons[e]))},e.isPointerDown=function(e){return!!this._initialized&&(void 0===e?this._pointerManager._downList.length>0:this._pointerManager._downMap[e]===this._curFrameCount)},e.isPointerUp=function(e){return!!this._initialized&&(void 0===e?this._pointerManager._upList.length>0:this._pointerManager._upMap[e]===this._curFrameCount)},e._update=function(){this._initialized&&(++this._curFrameCount,this._wheelManager._update(),this._pointerManager._update(this._curFrameCount),this._keyboardManager._update(this._curFrameCount))},e._destroy=function(){this._initialized&&(n.polyfill.window.removeEventListener("blur",this._onBlur),n.polyfill.window.removeEventListener("focus",this._onFocus),this._wheelManager._destroy(),this._pointerManager._destroy(),this._keyboardManager._destroy())},e._onBlur=function(){this._wheelManager._onBlur(),this._pointerManager._onBlur(),this._keyboardManager._onBlur()},e._onFocus=function(){this._wheelManager._onFocus(),this._pointerManager._onFocus(),this._keyboardManager._onFocus()},C(t,[{key:"pointers",get:function(){return this._initialized?this._pointerManager._pointers:null}},{key:"multiPointerEnabled",get:function(){return!!this._initialized&&this._pointerManager._multiPointerEnabled},set:function(e){this._initialized&&(this._pointerManager._multiPointerEnabled=e)}},{key:"wheelDelta",get:function(){return this._initialized?this._wheelManager._delta:null}},{key:"pointerMovingDelta",get:function(){return this._initialized?this._pointerManager._movingDelta:null}},{key:"pointerPosition",get:function(){return this._initialized&&this._pointerManager._pointers.length>0?this._pointerManager._currentPosition:null}}]),t}();!function(e){e[e.Opaque=0]="Opaque",e[e.AlphaTest=1]="AlphaTest",e[e.Transparent=2]="Transparent"}(zt||(zt={}));var Ut,kt=function(e){function t(t){var n;return(n=e.call(this,t)||this).isGCIgnored=!1,n._refCount=0,t.resourceManager._addRefObject(n.instanceId,L(n)),n}A(t,e);var n=t.prototype;return n.destroy=function(t){if(void 0===t&&(t=!1),this._destroyed)return!0;if(!t&&0!==this._refCount)return!1;var n=this._engine.resourceManager;n&&(e.prototype.destroy.call(this),n._deleteRefObject(this.instanceId));var i=this._getRefCount();return i>0&&this._addRefCount(-i),this._engine=null,this._onDestroy(),!0},n._getRefCount=function(){return this._refCount},n._addRefCount=function(e){this._refCount+=e},n._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},C(t,[{key:"refCount",get:function(){return this._refCount}}]),t}(ve);!function(e){e[e.Scene=0]="Scene",e[e.Camera=1]="Camera",e[e.Renderer=2]="Renderer",e[e.Material=3]="Material"}(Ut||(Ut={}));var Gt,Ht=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._format=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t}A(t,e);var n=t.prototype;return n.generateMipmaps=function(){this._mipmap&&this._platformTexture.generateMipmaps()},n._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},n._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},n._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},C(t,[{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var t=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>t&&(pe.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+t),e=t),e<1&&(pe.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}}]),t}(kt);!function(e){e[e.Float=0]="Float",e[e.Int=1]="Int",e[e.Vector2=2]="Vector2",e[e.Vector3=3]="Vector3",e[e.Vector4=4]="Vector4",e[e.Matrix=5]="Matrix",e[e.Color=6]="Color",e[e.Texture=7]="Texture",e[e.FloatArray=8]="FloatArray",e[e.IntArray=9]="IntArray",e[e.TextureArray=10]="TextureArray"}(Gt||(Gt={}));var Wt,jt=w(w({common:"#define GLSLIFY 1\n#define PI 3.14159265359\n#define RECIPROCAL_PI 0.31830988618\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2(float x){return x*x;}vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}",common_vert:"#define GLSLIFY 1\nattribute vec3 POSITION;\n#ifdef O3_HAS_UV\nattribute vec2 TEXCOORD_0;\n#endif\n#ifdef O3_HAS_UV1\nattribute vec2 TEXCOORD_1;\n#endif\n#ifdef O3_HAS_SKIN\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;\n#ifdef O3_USE_JOINT_TEXTURE\nuniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}\n#else\nuniform mat4 u_jointMatrix[O3_JOINTS_NUM];\n#endif\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\nattribute vec4 COLOR_0;\n#endif\nuniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nattribute vec3 NORMAL;\n#endif\n#ifdef O3_HAS_TANGENT\nattribute vec4 TANGENT;\n#endif\n#endif\n",common_frag:"#define GLSLIFY 1\nuniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;",color_share:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nvarying vec4 v_color;\n#endif\n",normal_share:"#define GLSLIFY 1\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nvarying vec3 v_normal;\n#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nvarying mat3 v_TBN;\n#endif\n#endif\n#endif\n",uv_share:"#define GLSLIFY 1\nvarying vec2 v_uv;\n#ifdef O3_HAS_UV1\nvarying vec2 v_uv1;\n#endif\n",worldpos_share:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvarying vec3 v_pos;\n#endif\n",shadow_share:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\nuniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nuniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n#endif\n",fog_share:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nvarying vec3 v_fogDepth;uniform vec3 u_fogColor;\n#ifdef O3_FOG_EXP2\nuniform float u_fogDensity;\n#else\nuniform float u_fogNear;uniform float u_fogFar;\n#endif\n#endif\n",begin_normal_vert:"#define GLSLIFY 1\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nvec3 normal=vec3(NORMAL);\n#endif\n#ifdef O3_HAS_TANGENT\nvec4 tangent=vec4(TANGENT);\n#endif\n#endif\n",begin_position_vert:"#define GLSLIFY 1\nvec4 position=vec4(POSITION,1.0);",position_vert:"#define GLSLIFY 1\n#ifndef O3_GENERATE_SHADOW_MAP\ngl_Position=u_MVPMat*position;\n#endif\n",color_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nv_color=COLOR_0;\n#endif\n",normal_vert:"#define GLSLIFY 1\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nv_normal=normalize(mat3(u_normalMat)*normal);\n#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nvec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);\n#endif\n#endif\n#endif\n",skinning_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_SKIN\n#ifdef O3_USE_JOINT_TEXTURE\nmat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);\n#else\nmat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];\n#endif\nposition=skinMatrix*position;\n#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)\nnormal=vec4(skinMatrix*vec4(normal,0.0)).xyz;\n#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\ntangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;\n#endif\n#endif\n#endif\n",blendShape_input:"#define GLSLIFY 1\n#ifdef OASIS_BLENDSHAPE\n#ifdef OASIS_BLENDSHAPE_TEXTURE\nuniform mediump sampler2DArray u_blendShapeTexture;uniform ivec3 u_blendShapeTextureInfo;uniform float u_blendShapeWeights[OASIS_BLENDSHAPE_COUNT];\n#else\nattribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;\n#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )\n#ifdef OASIS_BLENDSHAPE_NORMAL\nattribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;\n#endif\n#ifdef OASIS_BLENDSHAPE_TANGENT\nattribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;\n#endif\nuniform float u_blendShapeWeights[4];\n#else\nattribute vec3 POSITION_BS4;attribute vec3 POSITION_BS5;attribute vec3 POSITION_BS6;attribute vec3 POSITION_BS7;uniform float u_blendShapeWeights[8];\n#endif\n#endif\n#ifdef OASIS_BLENDSHAPE_TEXTURE\nvec3 getBlendShapeVertexElement(int blendShapeIndex,int vertexElementIndex){int y=vertexElementIndex/u_blendShapeTextureInfo.y;int x=vertexElementIndex-y*u_blendShapeTextureInfo.y;ivec3 uv=ivec3(x,y,blendShapeIndex);return texelFetch(u_blendShapeTexture,uv,0).xyz;}\n#endif\n#endif\n",blendShape_vert:"#define GLSLIFY 1\n#ifdef OASIS_BLENDSHAPE\n#ifdef OASIS_BLENDSHAPE_TEXTURE\nint vertexOffset=gl_VertexID*u_blendShapeTextureInfo.x;for(int i=0;i<OASIS_BLENDSHAPE_COUNT;i++){int vertexElementOffset=vertexOffset;float weight=u_blendShapeWeights[i];position.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;\n#ifndef OMIT_NORMAL\n#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )\nvertexElementOffset+=1;normal+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;\n#endif\n#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nvertexElementOffset+=1;tangent.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;\n#endif\n#endif\n}\n#else\nposition.xyz+=POSITION_BS0*u_blendShapeWeights[0];position.xyz+=POSITION_BS1*u_blendShapeWeights[1];position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];\n#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )\n#ifndef OMIT_NORMAL\n#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )\nnormal+=NORMAL_BS0*u_blendShapeWeights[0];normal+=NORMAL_BS1*u_blendShapeWeights[1];normal+=NORMAL_BS2*u_blendShapeWeights[2];normal+=NORMAL_BS3*u_blendShapeWeights[3];\n#endif\n#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\ntangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];tangent.xyz+=TANGENT_BS2*u_blendShapeWeights[2];tangent.xyz+=TANGENT_BS3*u_blendShapeWeights[3];\n#endif\n#endif\n#else\nposition.xyz+=POSITION_BS4*u_blendShapeWeights[4];position.xyz+=POSITION_BS5*u_blendShapeWeights[5];position.xyz+=POSITION_BS6*u_blendShapeWeights[6];position.xyz+=POSITION_BS7*u_blendShapeWeights[7];\n#endif\n#endif\n#endif\n",uv_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_UV\nv_uv=TEXCOORD_0;\n#else\nv_uv=vec2(0.,0.);\n#endif\n#ifdef O3_HAS_UV1\nv_uv1=TEXCOORD_1;\n#endif\n#ifdef O3_NEED_TILINGOFFSET\nv_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;\n#endif\n",worldpos_vert:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;\n#endif\n",shadow_vert:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\ngl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nfor(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}\n#endif\n",fog_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nv_fogDepth=(u_MVMat*position).xyz;\n#endif\n",light_frag_define:"#define GLSLIFY 1\n#ifdef O3_DIRECT_LIGHT_COUNT\nstruct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nstruct PointLight{vec3 color;vec3 position;float distance;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nstruct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngleCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];\n#endif\nstruct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight u_envMapLight;\n#ifdef O3_USE_SH\nuniform vec3 u_env_sh[9];\n#endif\n#ifdef O3_USE_SPECULAR_ENV\nuniform samplerCube u_env_specularSampler;\n#endif\n",mobile_material_frag:"#define GLSLIFY 1\nuniform vec4 u_emissiveColor;uniform vec4 u_baseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;\n#ifdef EMISSIVETEXTURE\nuniform sampler2D u_emissiveTexture;\n#endif\n#ifdef BASETEXTURE\nuniform sampler2D u_baseTexture;\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nuniform sampler2D u_specularTexture;\n#endif\n#ifdef NORMALTEXTURE\nuniform sampler2D u_normalTexture;\n#endif\n",fog_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nfloat fogDepth=length(v_fogDepth);\n#ifdef O3_FOG_EXP2\nfloat fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));\n#else\nfloat fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);\n#endif\n",begin_mobile_frag:"#define GLSLIFY 1\nvec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_baseColor;vec4 specular=u_specularColor;\n#ifdef EMISSIVETEXTURE\nvec4 emissiveTextureColor=texture2D(u_emissiveTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nemissiveTextureColor=gammaToLinear(emissiveTextureColor);\n#endif\nemission*=emissiveTextureColor;\n#endif\n#ifdef BASETEXTURE\nvec4 diffuseTextureColor=texture2D(u_baseTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\ndiffuseTextureColor=gammaToLinear(diffuseTextureColor);\n#endif\ndiffuse*=diffuseTextureColor;\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\ndiffuse*=v_color;\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nvec4 specularTextureColor=texture2D(u_specularTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nspecularTextureColor=gammaToLinear(specularTextureColor);\n#endif\nspecular*=specularTextureColor;\n#endif\nambient=vec4(u_envMapLight.diffuse*u_envMapLight.diffuseIntensity,1.0)*diffuse;",begin_viewdir_frag:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvec3 V=normalize(u_cameraPos-v_pos);\n#endif\n",mobile_blinnphong_frag:"#define GLSLIFY 1\n#ifdef NORMALTEXTURE\nmat3 tbn=getTBN();vec3 N=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);\n#else\nvec3 N=getNormal();\n#endif\nvec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);\n#ifdef O3_DIRECT_LIGHT_COUNT\nDirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=directionalLight.color*s;}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nPointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=pointLight.color*s;}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nSpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decayTotal;lightSpecular+=spotLight.color*s;}\n#endif\ndiffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);\n#ifdef ALPHA_CUTOFF\nif(diffuse.a<u_alphaCutoff){discard;}\n#endif\n",noise_common:"#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}\n#define K 0.142857142857\n#define Ko 0.428571428571\n#define K2 0.020408163265306\n#define Kd2 0.0714285714285\n#define Kz 0.166666666667\n#define Kzo 0.416666666667\n#define jitter 1.0\n#define jitter1 0.8\n",noise_cellular_2D:"#define GLSLIFY 1\nvec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}",noise_cellular_2x2:"#define GLSLIFY 1\nvec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}",noise_cellular_2x2x2:"#define GLSLIFY 1\nvec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}",noise_cellular_3D:"#define GLSLIFY 1\nvec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}",noise_cellular:"#define GLSLIFY 1\n#include <noise_cellular_2D>\n#include <noise_cellular_3D>\n#include <noise_cellular_2x2>\n#include <noise_cellular_2x2x2>\n",noise_perlin_2D:"#define GLSLIFY 1\nfloat perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}",noise_perlin_3D:"#define GLSLIFY 1\nfloat perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}",noise_perlin_4D:"#define GLSLIFY 1\nfloat perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}",noise_perlin:"#define GLSLIFY 1\n#include <noise_perlin_2D>\n#include <noise_perlin_3D>\n#include <noise_perlin_4D>\n",noise_psrd_2D:"#define GLSLIFY 1\nvec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}",noise_simplex_2D:"#define GLSLIFY 1\nfloat simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}",noise_simplex_3D_grad:"#define GLSLIFY 1\nfloat simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}",noise_simplex_3D:"#define GLSLIFY 1\nfloat simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}",noise_simplex_4D:"#define GLSLIFY 1\nvec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}\n#define F4 0.309016994374947451\nfloat simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}",noise_simplex:"#define GLSLIFY 1\n#include <noise_simplex_2D>\n#include <noise_simplex_3D>\n#include <noise_simplex_3D_grad>\n#include <noise_simplex_4D>\n"},{pbr_frag_define:"#define GLSLIFY 1\nuniform float u_alphaCutoff;uniform vec4 u_baseColor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_PBRSpecularColor;uniform float u_glossiness;uniform vec3 u_emissiveColor;\n#ifdef CLEARCOAT\nuniform float u_clearCoat;uniform float u_clearCoatRoughness;\n#endif\nuniform float u_normalIntensity;uniform float u_occlusionIntensity;uniform float u_occlusionTextureCoord;\n#ifdef BASETEXTURE\nuniform sampler2D u_baseTexture;\n#endif\n#ifdef NORMALTEXTURE\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef EMISSIVETEXTURE\nuniform sampler2D u_emissiveTexture;\n#endif\n#ifdef ROUGHNESSMETALLICTEXTURE\nuniform sampler2D u_roughnessMetallicTexture;\n#endif\n#ifdef SPECULARGLOSSINESSTEXTURE\nuniform sampler2D u_specularGlossinessTexture;\n#endif\n#ifdef OCCLUSIONTEXTURE\nuniform sampler2D u_occlusionTexture;\n#endif\n#ifdef HAS_CLEARCOATTEXTURE\nuniform sampler2D u_clearCoatTexture;\n#endif\n#ifdef HAS_CLEARCOATROUGHNESSTEXTURE\nuniform sampler2D u_clearCoatRoughnessTexture;\n#endif\n#ifdef HAS_CLEARCOATNORMALTEXTURE\nuniform sampler2D u_clearCoatNormalTexture;\n#endif\nstruct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct Geometry{vec3 position;vec3 normal;vec3 viewDir;float dotNV;\n#ifdef CLEARCOAT\nvec3 clearCoatNormal;float clearCoatDotNV;\n#endif\n};struct Material{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;\n#ifdef CLEARCOAT\nfloat clearCoat;float clearCoatRoughness;\n#endif\n};",pbr_helper:"#define GLSLIFY 1\n#include <normal_get>\nfloat computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getAARoughnessFactor(vec3 normal){\n#ifdef HAS_DERIVATIVES\nvec3 dxy=max(abs(dFdx(normal)),abs(dFdy(normal)));return 0.04+max(max(dxy.x,dxy.y),dxy.z);\n#else\nreturn 0.04;\n#endif\n}void initGeometry(out Geometry geometry){geometry.position=v_pos;geometry.viewDir=normalize(u_cameraPos-v_pos);\n#if defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE)\nmat3 tbn=getTBN();\n#endif\n#ifdef NORMALTEXTURE\ngeometry.normal=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);\n#else\ngeometry.normal=getNormal();\n#endif\ngeometry.dotNV=saturate(dot(geometry.normal,geometry.viewDir));\n#ifdef CLEARCOAT\n#ifdef HAS_CLEARCOATNORMALTEXTURE\ngeometry.clearCoatNormal=getNormalByNormalTexture(tbn,u_clearCoatNormalTexture,u_normalIntensity,v_uv);\n#else\ngeometry.clearCoatNormal=getNormal();\n#endif\ngeometry.clearCoatDotNV=saturate(dot(geometry.clearCoatNormal,geometry.viewDir));\n#endif\n}void initMaterial(out Material material,const in Geometry geometry){vec4 baseColor=u_baseColor;float metal=u_metal;float roughness=u_roughness;vec3 specularColor=u_PBRSpecularColor;float glossiness=u_glossiness;float alphaCutoff=u_alphaCutoff;\n#ifdef BASETEXTURE\nvec4 baseTextureColor=texture2D(u_baseTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nbaseTextureColor=gammaToLinear(baseTextureColor);\n#endif\nbaseColor*=baseTextureColor;\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\nbaseColor*=v_color;\n#endif\n#ifdef ALPHA_CUTOFF\nif(baseColor.a<alphaCutoff){discard;}\n#endif\n#ifdef ROUGHNESSMETALLICTEXTURE\nvec4 metalRoughMapColor=texture2D(u_roughnessMetallicTexture,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;\n#endif\n#ifdef SPECULARGLOSSINESSTEXTURE\nvec4 specularGlossinessColor=texture2D(u_specularGlossinessTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nspecularGlossinessColor=gammaToLinear(specularGlossinessColor);\n#endif\nspecularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;\n#endif\n#ifdef IS_METALLIC_WORKFLOW\nmaterial.diffuseColor=baseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(0.04),baseColor.rgb,metal);material.roughness=roughness;\n#else\nfloat specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=baseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=1.0-glossiness;\n#endif\nmaterial.roughness=max(material.roughness,getAARoughnessFactor(geometry.normal));\n#ifdef CLEARCOAT\nmaterial.clearCoat=u_clearCoat;material.clearCoatRoughness=u_clearCoatRoughness;\n#ifdef HAS_CLEARCOATTEXTURE\nmaterial.clearCoat*=texture2D(u_clearCoatTexture,v_uv).r;\n#endif\n#ifdef HAS_CLEARCOATROUGHNESSTEXTURE\nmaterial.clearCoatRoughness*=texture2D(u_clearCoatRoughnessTexture,v_uv).g;\n#endif\nmaterial.clearCoat=saturate(material.clearCoat);material.clearCoatRoughness=max(material.clearCoatRoughness,getAARoughnessFactor(geometry.clearCoatNormal));\n#endif\nmaterial.opacity=baseColor.a;}\n#include <brdf>\n#include <direct_irradiance_frag_define>\n#include <ibl_frag_define>\n",brdf:"#define GLSLIFY 1\nfloat F_Schlick(float dotLH){return 0.04+0.96*(pow(1.0-dotLH,5.0));}vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(vec3 incidentDirection,vec3 viewDir,vec3 normal,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+viewDir);float dotNL=saturate(dot(normal,incidentDirection));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}",direct_irradiance_frag_define:"#define GLSLIFY 1\nvoid addDirectRadiance(vec3 incidentDirection,vec3 color,Geometry geometry,Material material,inout ReflectedLight reflectedLight){float attenuation=1.0;\n#ifdef CLEARCOAT\nfloat clearCoatDotNL=saturate(dot(geometry.clearCoatNormal,incidentDirection));vec3 clearCoatIrradiance=clearCoatDotNL*color;reflectedLight.directSpecular+=material.clearCoat*clearCoatIrradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.clearCoatNormal,vec3(0.04),material.clearCoatRoughness);attenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);\n#endif\nfloat dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color*PI;reflectedLight.directSpecular+=attenuation*irradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.normal,material.specularColor,material.roughness);reflectedLight.directDiffuse+=attenuation*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#ifdef O3_DIRECT_LIGHT_COUNT\nvoid addDirectionalDirectLightRadiance(DirectLight directionalLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nvoid addPointDirectLightRadiance(PointLight pointLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nvoid addSpotDirectLightRadiance(SpotLight spotLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}\n#endif\nvoid addTotalDirectRadiance(Geometry geometry,Material material,inout ReflectedLight reflectedLight){\n#ifdef O3_DIRECT_LIGHT_COUNT\nDirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nPointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nSpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}\n#endif\n}",ibl_frag_define:"#define GLSLIFY 1\nvec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){normal.x=-normal.x;vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getLightProbeRadiance(vec3 viewDir,vec3 normal,float roughness,int maxMIPLevel,float specularIntensity){\n#ifndef O3_USE_SPECULAR_ENV\nreturn vec3(0);\n#else\nvec3 reflectVec=reflect(-viewDir,normal);reflectVec.x=-reflectVec.x;float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);\n#ifdef HAS_TEX_LOD\nvec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);\n#endif\n#ifdef O3_DECODE_ENV_RGBM\nenvMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;\n#ifdef OASIS_COLORSPACE_GAMMA\nenvMapColor=linearToGamma(envMapColor);\n#endif\n#else\n#ifndef OASIS_COLORSPACE_GAMMA\nenvMapColor=gammaToLinear(envMapColor);\n#endif\n#endif\nreturn envMapColor.rgb*specularIntensity;\n#endif\n}",pbr_frag:"#define GLSLIFY 1\nGeometry geometry;Material material;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));initGeometry(geometry);initMaterial(material,geometry);addTotalDirectRadiance(geometry,material,reflectedLight);\n#ifdef O3_USE_SH\nvec3 irradiance=getLightProbeIrradiance(u_env_sh,geometry.normal);\n#ifdef OASIS_COLORSPACE_GAMMA\nirradiance=linearToGamma(vec4(irradiance,1.0)).rgb;\n#endif\nirradiance*=u_envMapLight.diffuseIntensity;\n#else\nvec3 irradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;irradiance*=PI;\n#endif\nreflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry.viewDir,geometry.normal,material.roughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);float radianceAttenuation=1.0;\n#ifdef CLEARCOAT\nvec3 clearCoatRadiance=getLightProbeRadiance(geometry.viewDir,geometry.clearCoatNormal,material.clearCoatRoughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);reflectedLight.indirectSpecular+=clearCoatRadiance*material.clearCoat*envBRDFApprox(vec3(0.04),material.clearCoatRoughness,geometry.clearCoatDotNV);radianceAttenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);\n#endif\nreflectedLight.indirectSpecular+=radianceAttenuation*radiance*envBRDFApprox(material.specularColor,material.roughness,geometry.dotNV);\n#ifdef OCCLUSIONTEXTURE\nvec2 aoUV=v_uv;\n#ifdef O3_HAS_UV1\nif(u_occlusionTextureCoord==1.0){aoUV=v_uv1;}\n#endif\nfloat ambientOcclusion=(texture2D(u_occlusionTexture,aoUV).r-1.0)*u_occlusionIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#ifdef O3_USE_SPECULAR_ENV\nreflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,geometry.dotNV);\n#endif\n#endif\nvec3 emissiveRadiance=u_emissiveColor;\n#ifdef EMISSIVETEXTURE\nvec4 emissiveColor=texture2D(u_emissiveTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nemissiveColor=gammaToLinear(emissiveColor);\n#endif\nemissiveRadiance*=emissiveColor.rgb;\n#endif\nvec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);\n#ifndef OASIS_COLORSPACE_GAMMA\ntargetColor=linearToGamma(targetColor);\n#endif\ngl_FragColor=targetColor;"}),{},{normal_get:"#define GLSLIFY 1\nvec3 getNormal(){\n#ifdef O3_HAS_NORMAL\nvec3 normal=normalize(v_normal);\n#elif defined(HAS_DERIVATIVES)\nvec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 normal=normalize(cross(pos_dx,pos_dy));\n#else\nvec3 normal=vec3(0,0,1);\n#endif\nnormal*=float(gl_FrontFacing)*2.0-1.0;return normal;}vec3 getNormalByNormalTexture(mat3 tbn,sampler2D normalTexture,float normalIntensity,vec2 uv){vec3 normal=texture2D(normalTexture,uv).rgb;normal=normalize(tbn*((2.0*normal-1.0)*vec3(normalIntensity,normalIntensity,1.0)));normal*=float(gl_FrontFacing)*2.0-1.0;return normal;}mat3 getTBN(){\n#if defined(O3_HAS_NORMAL) && defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nmat3 tbn=v_TBN;\n#else\nvec3 normal=getNormal();vec3 position=v_pos;vec2 uv=gl_FrontFacing? v_uv:-v_uv;\n#ifdef HAS_DERIVATIVES\nvec3 dp1=dFdx(position);vec3 dp2=dFdy(position);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));mat3 tbn=mat3(tangent*invmax,binormal*invmax,normal);\n#else\nmat3 tbn=mat3(vec3(0.0),vec3(0.0),normal);\n#endif\n#endif\nreturn tbn;}"}),Xt=function(){function e(){}return e.parseCustomMacros=function(e){return e.map((function(e){return"#define "+e+"\n"})).join("")},e.parseIncludes=function(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,(function(t,n){var i=jt[n];return void 0===i?(pe.error('Shader slice "'+t.trim()+'" not founded.'),""):e.parseIncludes(i)}))},e.parseExtension=function(e){return e.map((function(e){return"#extension "+e+" : enable\n"})).join("")},e.convertTo300=function(e,t){if(e=(e=(e=(e=e.replace(/\battribute\b/g,"in")).replace(/\bvarying\b/g,t?"in":"out")).replace(/\btexture(2D|Cube)\b/g,"texture")).replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),t)if(/\bgl_FragData\[.+?\]/g.test(e)){var n=(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")).match(/\bgl_FragData\[.+?\]/g);e=this._replaceMRTShader(e,n)}else e=(e=e.replace(/void\s+?main\s*\(/g,"out vec4 glFragColor;\nvoid main(")).replace(/\bgl_FragColor\b/g,"glFragColor");return e},e._replaceMRTShader=function(e,t){for(var n="",i=new Set,r=0;r<t.length;r++){var a=t[r].match(/\bgl_FragData\[(.+?)\]/);i.add(a[1])}return i.forEach((function(e){n+="layout(location="+e+") out vec4 fragOutColor"+e+";\n"})),n+="void main(",e=(e=e.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1")).replace(/void\s+?main\s*\(/g,n)},e}(),Kt=function e(t,n,i,r){this.name=void 0,this.value=void 0,this._nameId=void 0,this._maskIndex=void 0,this._maskValue=void 0,this.name=t,this._maskIndex=i,this._maskValue=r,this.value=n;var a=e._macroNameIdMap,o=a[t];void 0===a[t]&&(a[t]=o=e._macroNameCounter++),this._nameId=o};Kt._macroNameIdMap=Object.create(null),Kt._macroNameCounter=0,function(e){e[e.Linear=0]="Linear",e[e.Gamma=1]="Gamma"}(Wt||(Wt={}));var qt=function(){function e(e){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this.textureIndex=void 0,this.textureDefault=void 0,this._rhi=void 0,this._gl=void 0,this._colorSpace=void 0;var t=e._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=e.settings.colorSpace}var t=e.prototype;return t.upload1f=function(e,t){this.cacheValue!==t&&(this._gl.uniform1f(e.location,t),this.cacheValue=t)},t.upload1fv=function(e,t){this._gl.uniform1fv(e.location,t)},t.upload2f=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g||(this._colorSpace===Wt.Linear?this._gl.uniform2f(e.location,v.gammaToLinearSpace(t.r),v.gammaToLinearSpace(t.g)):this._gl.uniform2f(e.location,t.r,t.g),n.x=t.r,n.y=t.g):n.x===t.x&&n.y===t.y||(this._gl.uniform2f(e.location,t.x,t.y),n.x=t.x,n.y=t.y)},t.upload2fv=function(e,t){this._gl.uniform2fv(e.location,t)},t.upload3f=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b||(this._colorSpace===Wt.Linear?this._gl.uniform3f(e.location,v.gammaToLinearSpace(t.r),v.gammaToLinearSpace(t.g),v.gammaToLinearSpace(t.b)):this._gl.uniform3f(e.location,t.r,t.g,t.b),n.x=t.r,n.y=t.g,n.z=t.b):n.x===t.x&&n.y===t.y&&n.z===t.z||(this._gl.uniform3f(e.location,t.x,t.y,t.z),n.x=t.x,n.y=t.y,n.z=t.z)},t.upload3fv=function(e,t){this._gl.uniform3fv(e.location,t)},t.upload4f=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b&&n.w===t.a||(this._colorSpace===Wt.Linear?this._gl.uniform4f(e.location,v.gammaToLinearSpace(t.r),v.gammaToLinearSpace(t.g),v.gammaToLinearSpace(t.b),t.a):this._gl.uniform4f(e.location,t.r,t.g,t.b,t.a),n.x=t.r,n.y=t.g,n.z=t.b,n.w=t.a):n.x===t.x&&n.y===t.y&&n.z===t.z&&n.w===t.w||(this._gl.uniform4f(e.location,t.x,t.y,t.z,t.w),n.x=t.x,n.y=t.y,n.z=t.z,n.w=t.w)},t.upload4fv=function(e,t){this._gl.uniform4fv(e.location,t)},t.upload1i=function(e,t){this.cacheValue!==t&&(this._gl.uniform1i(e.location,t),this.cacheValue=t)},t.upload1iv=function(e,t){this._gl.uniform1iv(e.location,t)},t.upload2i=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g||(this._gl.uniform2i(e.location,t.r,t.g),n.x=t.r,n.y=t.g):n.x===t.x&&n.y===t.y||(this._gl.uniform2i(e.location,t.x,t.y),n.x=t.x,n.y=t.y)},t.upload2iv=function(e,t){this._gl.uniform2iv(e.location,t)},t.upload3i=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b||(this._gl.uniform3i(e.location,t.r,t.g,t.b),n.x=t.r,n.y=t.g,n.z=t.b):n.x===t.x&&n.y===t.y&&n.z===t.z||(this._gl.uniform3i(e.location,t.x,t.y,t.z),n.x=t.x,n.y=t.y,n.z=t.z)},t.upload3iv=function(e,t){this._gl.uniform3iv(e.location,t)},t.upload4i=function(e,t){var n=this.cacheValue;void 0!==t.r?n.x===t.r&&n.y===t.g&&n.z===t.b&&n.w===t.a||(this._gl.uniform4i(e.location,t.r,t.g,t.b,t.a),n.x=t.r,n.y=t.g,n.z=t.b,n.w=t.a):n.x===t.x&&n.y===t.y&&n.z===t.z&&n.w===t.w||(this._gl.uniform4i(e.location,t.x,t.y,t.z,t.w),n.x=t.x,n.y=t.y,n.z=t.z,n.w=t.w)},t.upload4iv=function(e,t){this._gl.uniform4iv(e.location,t)},t.uploadMat4=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t.elements)},t.uploadMat4v=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t)},t.uploadTexture=function(e,t){var n=this._rhi;n.activeTexture(e.textureIndex),n.bindTexture(t._platformTexture)},t.uploadTextureArray=function(e,t){for(var n=this._rhi,i=e.textureIndex,r=0;r<t.length;r++){var a=t[r];n.activeTexture(i[r]),n.bindTexture(a._platformTexture)}},e}(),Yt=function(){this.constUniforms=[],this.textureUniforms=[]},Qt=function(){function e(t,n,i){this.id=void 0,this.sceneUniformBlock=new Yt,this.cameraUniformBlock=new Yt,this.rendererUniformBlock=new Yt,this.materialUniformBlock=new Yt,this.otherUniformBlock=new Yt,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=t,this._gl=t._hardwareRenderer.gl,this._glProgram=this._createProgram(n,i),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=e._counter++}e._addLineNum=function(e){var t,n=e.split("\n"),i=(n.length+1).toString().length+6;return n.map((function(e,n){if((t="0:"+(n+1)).length>=i)return t.substring(0,i)+e;for(var r=0;r<i-t.length;r++)t+=" ";return t+e})).join("\n")};var t=e.prototype;return t.uploadAll=function(e,t){this.uploadUniforms(e,t),this.uploadTextures(e,t)},t.uploadUniforms=function(e,t){for(var n=t._propertyValueMap,i=e.constUniforms,r=0,a=i.length;r<a;r++){var o=i[r],s=n[o.propertyId];null!=s&&o.applyFunc(o,s)}},t.uploadTextures=function(e,t){var n=t._propertyValueMap,i=e.textureUniforms;if(i)for(var r=0,a=i.length;r<a;r++){var o=i[r],s=n[o.propertyId];s&&!s.destroyed?o.applyFunc(o,s):o.applyFunc(o,o.textureDefault)}},t.uploadUnGroupTextures=function(){var e=this.otherUniformBlock.textureUniforms;if(e)for(var t=0,n=e.length;t<n;t++){var i=e[t];i.applyFunc(i,i.textureDefault)}},t.groupingOtherUniformBlock=function(){var e=this.otherUniformBlock,t=e.constUniforms,n=e.textureUniforms;t.length>0&&this._groupingSubOtherUniforms(t,!1),n.length>0&&this._groupingSubOtherUniforms(n,!0)},t.bind=function(){var e=this._engine._hardwareRenderer;return e._currentBind!==this&&(this._gl.useProgram(this._glProgram),e._currentBind=this,!0)},t.destroy=function(){var e=this._gl;this._vertexShader&&e.deleteShader(this._vertexShader),this._fragmentShader&&e.deleteShader(this._fragmentShader),this._glProgram&&e.deleteProgram(this._glProgram)},t._groupingSubOtherUniforms=function(e,t){for(var n=e.length-1;n>=0;n--){var i=e[n],r=Zt._getShaderPropertyGroup(i.name);void 0!==r&&(e.splice(e.indexOf(i),1),this._groupingUniform(i,r,t))}},t._groupingUniform=function(e,t,n){switch(t){case Ut.Scene:n?this.sceneUniformBlock.textureUniforms.push(e):this.sceneUniformBlock.constUniforms.push(e);break;case Ut.Camera:n?this.cameraUniformBlock.textureUniforms.push(e):this.cameraUniformBlock.constUniforms.push(e);break;case Ut.Renderer:n?this.rendererUniformBlock.textureUniforms.push(e):this.rendererUniformBlock.constUniforms.push(e);break;case Ut.Material:n?this.materialUniformBlock.textureUniforms.push(e):this.materialUniformBlock.constUniforms.push(e);break;default:n?this.otherUniformBlock.textureUniforms.push(e):this.otherUniformBlock.constUniforms.push(e)}},t._createProgram=function(e,t){var n=this._gl,i=this._createShader(n.VERTEX_SHADER,e);if(!i)return null;var r=this._createShader(n.FRAGMENT_SHADER,t);if(!r)return null;var a=n.createProgram();return n.attachShader(a,i),n.attachShader(a,r),n.linkProgram(a),n.validateProgram(a),n.isContextLost()?(pe.error("Context lost while linking program."),n.deleteShader(i),n.deleteShader(r),null):pe.isEnabled&&!n.getProgramParameter(a,n.LINK_STATUS)?(pe.error("Could not link WebGL program. \n"+n.getProgramInfoLog(a)),n.deleteProgram(a),null):(this._vertexShader=i,this._fragmentShader=r,a)},t._createShader=function(t,n){var i=this._gl,r=i.createShader(t);return r?(i.shaderSource(r,n),i.compileShader(r),i.isContextLost()?(pe.error("Context lost while compiling shader."),i.deleteShader(r),null):pe.isEnabled&&!i.getShaderParameter(r,i.COMPILE_STATUS)?(pe.error("Could not compile WebGL shader.\n"+i.getShaderInfoLog(r),e._addLineNum(n)),i.deleteShader(r),null):r):(pe.error("Context lost while create shader."),null)},t._recordLocation=function(){var e=this,t=this._gl,n=this._glProgram,i=this._getUniformInfos(),r=this._getAttributeInfos();i.forEach((function(i){var r=i.name,a=i.size,s=i.type,l=new qt(e._engine),u=!1,c=!1;r.indexOf("[0]")>0&&(r=r.substr(0,r.length-3),u=!0);var h=t.getUniformLocation(n,r);switch(l.name=r,l.propertyId=Zt.getPropertyByName(r)._uniqueId,l.location=h,s){case t.FLOAT:u?l.applyFunc=l.upload1fv:(l.applyFunc=l.upload1f,l.cacheValue=0);break;case t.FLOAT_VEC2:u?l.applyFunc=l.upload2fv:(l.applyFunc=l.upload2f,l.cacheValue=new p(0,0));break;case t.FLOAT_VEC3:u?l.applyFunc=l.upload3fv:(l.applyFunc=l.upload3f,l.cacheValue=new o(0,0,0));break;case t.FLOAT_VEC4:u?l.applyFunc=l.upload4fv:(l.applyFunc=l.upload4f,l.cacheValue=new g(0,0,0,0));break;case t.BOOL:case t.INT:u?l.applyFunc=l.upload1iv:(l.applyFunc=l.upload1i,l.cacheValue=0);break;case t.BOOL_VEC2:case t.INT_VEC2:u?l.applyFunc=l.upload2iv:(l.applyFunc=l.upload2i,l.cacheValue=new p(0,0));break;case t.BOOL_VEC3:case t.INT_VEC3:l.applyFunc=u?l.upload3iv:l.upload3i,l.cacheValue=new o(0,0,0);break;case t.BOOL_VEC4:case t.INT_VEC4:u?l.applyFunc=l.upload4iv:(l.applyFunc=l.upload4i,l.cacheValue=new g(0,0,0));break;case t.FLOAT_MAT4:l.applyFunc=u?l.uploadMat4v:l.uploadMat4;break;case t.SAMPLER_2D:case t.SAMPLER_CUBE:case t.SAMPLER_2D_ARRAY:var _;switch(s){case t.SAMPLER_2D:_=e._engine._magentaTexture2D;break;case t.SAMPLER_CUBE:_=e._engine._magentaTextureCube;break;case t.SAMPLER_2D_ARRAY:_=e._engine._magentaTexture2DArray;break;default:throw new Error("Unsupported texture type.")}if(c=!0,u){for(var d=new Array(a),f=new Int32Array(a),v=new Array(a),m=0;m<a;m++)d[m]=_,f[m]=e._activeTextureUint,v[m]=t.TEXTURE0+e._activeTextureUint++;l.textureDefault=d,l.textureIndex=v,l.applyFunc=l.uploadTextureArray,e.bind(),t.uniform1iv(h,f),l.uploadTextureArray(l,d)}else{var y=t.TEXTURE0+e._activeTextureUint;l.textureDefault=_,l.textureIndex=y,l.applyFunc=l.uploadTexture,e.bind(),t.uniform1i(h,e._activeTextureUint++),l.uploadTexture(l,_)}}var x=Zt._getShaderPropertyGroup(r);e._groupingUniform(l,x,c)})),r.forEach((function(i){var r=i.name;e.attributeLocation[r]=t.getAttribLocation(n,r)}))},t._getUniformInfos=function(){for(var e=this._gl,t=this._glProgram,n=new Array,i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),r=0;r<i;++r){var a=e.getActiveUniform(t,r);n[r]=a}return n},t._getAttributeInfos=function(){for(var e=this._gl,t=this._glProgram,n=new Array,i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),r=0;r<i;++r){var a=e.getActiveAttrib(t,r);n[r]=a}return n},C(e,[{key:"isValid",get:function(){return this._isValid}}]),e}();Qt._counter=0;var Jt=function(){function e(t){this._uniqueId=void 0,this._group=void 0,this._type=void 0,this.name=void 0,this.name=t,this._uniqueId=e._propertyNameCounter++}return C(e,[{key:"type",get:function(){return this._type}}]),e}();Jt._propertyNameCounter=0;var Zt=function(){function e(t,n,i){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=e._shaderCounter++,this.name=t,this._vertexSource=n,this._fragmentSource=i}e.create=function(t,n,i){var r=e._shaderMap;if(r[t])throw'Shader named "'+t+'" already exists.';return r[t]=new e(t,n,i)},e.find=function(t){return e._shaderMap[t]},e.getMacroByName=function(t,n){var i=n?t+" "+n:t,r=e._macroMap[i];if(!r){var a=e._macroMaskMap,o=e._macroCounter,s=Math.floor(o/32),l=o%32;r=new Kt(t,n,s,1<<l),e._macroMap[i]=r,s==a.length&&(a.length++,a[s]=new Array(32)),a[s][l]=i,e._macroCounter++}return r},e.getPropertyByName=function(t){var n=e._propertyNameMap;if(null!=n[t])return n[t];var i=new Jt(t);return n[t]=i,e._propertyIdMap[i._uniqueId]=i,i},e._getShaderPropertyGroup=function(t){var n=e._propertyNameMap[t];return null==n?void 0:n._group},e._getNamesByMacros=function(t,n){var i=e._macroMaskMap,r=t._mask;n.length=0;for(var a=0,o=t._length;a<o;a++)for(var s=i[a],l=r[a],u=l<0?32:Math.floor(Math.log2(l))+1,c=0;c<u;c++)l&1<<c&&n.push(s[c])};var t=e.prototype;return t.compileVariant=function(t,n){var i=e._compileMacros;i.clear();for(var r=0,a=n.length;r<a;r++)i.enable(e.getMacroByName(n[r]));return this._getShaderProgram(t,i).isValid},t._getShaderProgram=function(t,n){var i=t._getShaderProgramPool(this),r=i.get(n);if(r)return r;var a=t._hardwareRenderer.isWebGL2,o=[];e._getNamesByMacros(n,o);var s=Xt.parseCustomMacros(o),l=a?"#version 300 es":"#version 100",u="\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n      precision highp float;\n      precision highp int;\n    #else\n      precision mediump float;\n      precision mediump int;\n    #endif\n    ";t._hardwareRenderer.canIUse(le.shaderTextureLod)&&(u+="#define HAS_TEX_LOD\n"),t._hardwareRenderer.canIUse(le.standardDerivatives)&&(u+="#define HAS_DERIVATIVES\n");var c=Xt.parseIncludes(" "+l+"\n        "+u+"\n        "+s+"\n        "+this._vertexSource),h=Xt.parseIncludes(" "+l+"\n        "+(a?"":Xt.parseExtension(e._shaderExtension))+"\n        "+u+"\n        "+s+"\n      "+this._fragmentSource);return a&&(c=Xt.convertTo300(c),h=Xt.convertTo300(h,!0)),r=new Qt(t,c,h),i.cache(r),r},e}();Zt._compileMacros=new ye,Zt._propertyIdMap=Object.create(null),Zt._shaderCounter=0,Zt._shaderMap=Object.create(null),Zt._propertyNameMap=Object.create(null),Zt._macroMaskMap=[],Zt._macroCounter=0,Zt._macroMap=Object.create(null),Zt._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var $t,en,tn,nn=function(){function e(e){this._group=void 0,this._propertyValueMap=Object.create(null),this._macroCollection=new ye,this._macroMap=Object.create(null),this._refCount=0,this._group=e}var t=e.prototype;return t.getFloat=function(e){return this.getPropertyValue(e)},t.setFloat=function(e,t){this._setPropertyValue(e,Gt.Float,t)},t.getInt=function(e){return this.getPropertyValue(e)},t.setInt=function(e,t){this._setPropertyValue(e,Gt.Int,t)},t.getFloatArray=function(e){return this.getPropertyValue(e)},t.setFloatArray=function(e,t){this._setPropertyValue(e,Gt.FloatArray,t)},t.getIntArray=function(e){return this.getPropertyValue(e)},t.setIntArray=function(e,t){this._setPropertyValue(e,Gt.IntArray,t)},t.getVector2=function(e){return this.getPropertyValue(e)},t.setVector2=function(e,t){this._setPropertyValue(e,Gt.Vector2,t)},t.getVector3=function(e){return this.getPropertyValue(e)},t.setVector3=function(e,t){this._setPropertyValue(e,Gt.Vector3,t)},t.getVector4=function(e){return this.getPropertyValue(e)},t.setVector4=function(e,t){this._setPropertyValue(e,Gt.Vector4,t)},t.getMatrix=function(e){return this.getPropertyValue(e)},t.setMatrix=function(e,t){this._setPropertyValue(e,Gt.Matrix,t)},t.getColor=function(e){return this.getPropertyValue(e)},t.setColor=function(e,t){this._setPropertyValue(e,Gt.Color,t)},t.getTexture=function(e){return this.getPropertyValue(e)},t.setTexture=function(e,t){if(this._getRefCount()>0){var n=this.getPropertyValue(e);n&&n._addRefCount(-1),t&&t._addRefCount(1)}this._setPropertyValue(e,Gt.Texture,t)},t.getTextureArray=function(e){return this.getPropertyValue(e)},t.setTextureArray=function(e,t){if(this._getRefCount()>0){var n=this.getPropertyValue(e);if(n)for(var i=0,r=n.length;i<r;i++)n[i]._addRefCount(-1);if(t)for(var a=0,o=t.length;a<o;a++)t[a]._addRefCount(1)}this._setPropertyValue(e,Gt.TextureArray,t)},t.getPropertyValue=function(e){return"string"==typeof e&&(e=Zt.getPropertyByName(e)),this._propertyValueMap[e._uniqueId]},t.enableMacro=function(e,t){"string"==typeof e&&(e=Zt.getMacroByName(e,t));var n=e._nameId,i=this._macroMap[n];if(i!==e){var r=this._macroCollection;i&&r.disable(i),r.enable(e),this._macroMap[n]=e}},t.disableMacro=function(e){var t;if("string"==typeof e){if(void 0===(t=Kt._macroNameIdMap[e]))return}else t=e._nameId;var n=this._macroMap[t];n&&(this._macroCollection.disable(n),delete this._macroMap[t])},t.getMacros=function(e){if(!e)return Object.values(this._macroMap);var t=this._macroMap;for(var n in e.length=0,t)e.push(t[n])},t.getProperties=function(e){var t;e?(e.length=0,t=e):t=[];var n=this._propertyValueMap,i=Zt._propertyIdMap;for(var r in n)t.push(i[r]);if(!e)return t},t.clone=function(){var t=new e(this._group);return this.cloneTo(t),t},t.cloneTo=function(e){ne.deepCloneObject(this._macroCollection,e._macroCollection),S(e._macroMap,this._macroMap);for(var t=this._propertyValueMap,n=e._propertyValueMap,i=Object.keys(t),r=0,a=i.length;r<a;r++){var o=i[r],s=t[o];if(null!=s)if("number"==typeof s)n[o]=s;else if(s instanceof Ht)n[o]=s;else if(s instanceof Array||s instanceof Float32Array||s instanceof Int32Array)n[o]=s.slice();else{var l=n[o];l?l.copyFrom(s):n[o]=s.clone()}else n[o]=s}},t._setPropertyValue=function(e,t,n){if("string"==typeof e&&(e=Zt.getPropertyByName(e)),e._group!==this._group){if(void 0!==e._group)throw"Shader property "+e.name+" has been used as "+Ut[e._group]+" group.";e._group=this._group}if(e._type!==t){if(void 0!==e._type)throw"Shader property "+e.name+" has been used as "+Gt[e._type]+" type.";e._type=t}this._propertyValueMap[e._uniqueId]=n},t._getRefCount=function(){return this._refCount},t._addRefCount=function(e){this._refCount+=e;var t=this._propertyValueMap;for(var n in t){var i=t[n];i&&i instanceof Ht&&i._addRefCount(e)}},e}();!function(e){e[e.Zero=0]="Zero",e[e.One=1]="One",e[e.SourceColor=2]="SourceColor",e[e.OneMinusSourceColor=3]="OneMinusSourceColor",e[e.DestinationColor=4]="DestinationColor",e[e.OneMinusDestinationColor=5]="OneMinusDestinationColor",e[e.SourceAlpha=6]="SourceAlpha",e[e.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",e[e.DestinationAlpha=8]="DestinationAlpha",e[e.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",e[e.SourceAlphaSaturate=10]="SourceAlphaSaturate",e[e.BlendColor=11]="BlendColor",e[e.OneMinusBlendColor=12]="OneMinusBlendColor"}($t||($t={})),function(e){e[e.Add=0]="Add",e[e.Subtract=1]="Subtract",e[e.ReverseSubtract=2]="ReverseSubtract",e[e.Min=3]="Min",e[e.Max=4]="Max"}(en||(en={})),function(e){e[e.None=0]="None",e[e.Red=1]="Red",e[e.Green=2]="Green",e[e.Blue=4]="Blue",e[e.Alpha=8]="Alpha",e[e.All=15]="All"}(tn||(tn={}));var rn,an=function(){this.enabled=!1,this.colorBlendOperation=en.Add,this.alphaBlendOperation=en.Add,this.sourceColorBlendFactor=$t.One,this.sourceAlphaBlendFactor=$t.One,this.destinationColorBlendFactor=$t.Zero,this.destinationAlphaBlendFactor=$t.Zero,this.colorWriteMask=tn.All},on=function(){function e(){this.targetBlendState=new an,this.blendColor=new v(0,0,0,0),this.alphaToCoverage=!1}e._getGLBlendFactor=function(e,t){var n=e.gl;switch(t){case $t.Zero:return n.ZERO;case $t.One:return n.ONE;case $t.SourceColor:return n.SRC_COLOR;case $t.OneMinusSourceColor:return n.ONE_MINUS_SRC_COLOR;case $t.DestinationColor:return n.DST_COLOR;case $t.OneMinusDestinationColor:return n.ONE_MINUS_DST_COLOR;case $t.SourceAlpha:return n.SRC_ALPHA;case $t.OneMinusSourceAlpha:return n.ONE_MINUS_SRC_ALPHA;case $t.DestinationAlpha:return n.DST_ALPHA;case $t.OneMinusDestinationAlpha:return n.ONE_MINUS_DST_ALPHA;case $t.SourceAlphaSaturate:return n.SRC_ALPHA_SATURATE;case $t.BlendColor:return n.CONSTANT_COLOR;case $t.OneMinusBlendColor:return n.ONE_MINUS_CONSTANT_COLOR}},e._getGLBlendOperation=function(e,t){var n=e.gl;switch(t){case en.Add:return n.FUNC_ADD;case en.Subtract:return n.FUNC_SUBTRACT;case en.ReverseSubtract:return n.FUNC_REVERSE_SUBTRACT;case en.Min:if(!e.canIUse(le.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return n.MIN;case en.Max:if(!e.canIUse(le.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return n.MAX}};var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.blendState)},t._platformApply=function(t,n){var i=t.gl,r=n.targetBlendState,a=this.targetBlendState,o=a.enabled,s=a.colorBlendOperation,l=a.alphaBlendOperation,u=a.sourceColorBlendFactor,c=a.destinationColorBlendFactor,h=a.sourceAlphaBlendFactor,_=a.destinationAlphaBlendFactor,d=a.colorWriteMask;if(o!==r.enabled&&(o?i.enable(i.BLEND):i.disable(i.BLEND),r.enabled=o),o){u===r.sourceColorBlendFactor&&c===r.destinationColorBlendFactor&&h===r.sourceAlphaBlendFactor&&_===r.destinationAlphaBlendFactor||(i.blendFuncSeparate(e._getGLBlendFactor(t,u),e._getGLBlendFactor(t,c),e._getGLBlendFactor(t,h),e._getGLBlendFactor(t,_)),r.sourceColorBlendFactor=u,r.destinationColorBlendFactor=c,r.sourceAlphaBlendFactor=h,r.destinationAlphaBlendFactor=_),s===r.colorBlendOperation&&l===r.alphaBlendOperation||(i.blendEquationSeparate(e._getGLBlendOperation(t,s),e._getGLBlendOperation(t,l)),r.colorBlendOperation=s,r.alphaBlendOperation=l);var f=this.blendColor;v.equals(n.blendColor,f)||(i.blendColor(f.r,f.g,f.b,f.a),n.blendColor.copyFrom(f))}d!==r.colorWriteMask&&(i.colorMask(0!=(d&tn.Red),0!=(d&tn.Green),0!=(d&tn.Blue),0!=(d&tn.Alpha)),r.colorWriteMask=d);var p=this.alphaToCoverage;p!==n.alphaToCoverage&&(p?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.alphaToCoverage=p)},e}();!function(e){e[e.Never=0]="Never",e[e.Less=1]="Less",e[e.Equal=2]="Equal",e[e.LessEqual=3]="LessEqual",e[e.Greater=4]="Greater",e[e.NotEqual=5]="NotEqual",e[e.GreaterEqual=6]="GreaterEqual",e[e.Always=7]="Always"}(rn||(rn={}));var sn,ln=function(){function e(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=rn.Less}e._getGLCompareFunction=function(e,t){var n=e.gl;switch(t){case rn.Never:return n.NEVER;case rn.Less:return n.LESS;case rn.Equal:return n.EQUAL;case rn.LessEqual:return n.LEQUAL;case rn.Greater:return n.GREATER;case rn.NotEqual:return n.NOTEQUAL;case rn.GreaterEqual:return n.GEQUAL;case rn.Always:return n.ALWAYS}};var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.depthState)},t._platformApply=function(t,n){var i=t.gl,r=this.enabled,a=this.compareFunction,o=this.writeEnabled;r!=n.enabled&&(r?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),n.enabled=r),r&&(a!=n.compareFunction&&(i.depthFunc(e._getGLCompareFunction(t,a)),n.compareFunction=a),o!=n.writeEnabled&&(i.depthMask(o),n.writeEnabled=o))},e}();!function(e){e[e.Off=0]="Off",e[e.Front=1]="Front",e[e.Back=2]="Back"}(sn||(sn={}));var un,cn=function(){function e(){this.cullMode=sn.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var t=e.prototype;return t._apply=function(e,t,n){this._platformApply(e,t.rasterState,n)},t._platformApply=function(e,t,n){var i=e.gl,r=this.cullMode,a=this.depthBias,o=this.slopeScaledDepthBias,s=r!==sn.Off;s!==t._cullFaceEnable&&(s?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),t._cullFaceEnable=s),s&&r!==t.cullMode&&(r==sn.Back?i.cullFace(i.BACK):i.cullFace(i.FRONT),t.cullMode=r),n!==t._frontFaceInvert&&(n?i.frontFace(i.CW):i.frontFace(i.CCW),t._frontFaceInvert=n),a===t.depthBias&&o===t.slopeScaledDepthBias||(0!==a||0!==o?(i.enable(i.POLYGON_OFFSET_FILL),i.polygonOffset(o,a)):i.disable(i.POLYGON_OFFSET_FILL),t.depthBias=a,t.slopeScaledDepthBias=o)},e}();!function(e){e[e.Keep=0]="Keep",e[e.Zero=1]="Zero",e[e.Replace=2]="Replace",e[e.IncrementSaturate=3]="IncrementSaturate",e[e.DecrementSaturate=4]="DecrementSaturate",e[e.Invert=5]="Invert",e[e.IncrementWrap=6]="IncrementWrap",e[e.DecrementWrap=7]="DecrementWrap"}(un||(un={}));var hn,_n,dn,fn,pn,gn,vn,mn,yn,xn,wn,bn,Cn,Tn,Sn,An,Pn,Mn,En,Fn,Rn=function(){function e(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=rn.Always,this.compareFunctionBack=rn.Always,this.passOperationFront=un.Keep,this.passOperationBack=un.Keep,this.failOperationFront=un.Keep,this.failOperationBack=un.Keep,this.zFailOperationFront=un.Keep,this.zFailOperationBack=un.Keep}e._getGLCompareFunction=function(e,t){var n=e.gl;switch(t){case rn.Never:return n.NEVER;case rn.Less:return n.LESS;case rn.Equal:return n.EQUAL;case rn.LessEqual:return n.LEQUAL;case rn.Greater:return n.GREATER;case rn.NotEqual:return n.NOTEQUAL;case rn.GreaterEqual:return n.GEQUAL;case rn.Always:return n.ALWAYS}},e._getGLStencilOperation=function(e,t){var n=e.gl;switch(t){case un.Keep:return n.KEEP;case un.Zero:return n.ZERO;case un.Replace:return n.REPLACE;case un.IncrementSaturate:return n.INCR;case un.DecrementSaturate:return n.DECR;case un.Invert:return n.INVERT;case un.IncrementWrap:return n.INCR_WRAP;case un.DecrementWrap:return n.DECR_WRAP}};var t=e.prototype;return t._apply=function(e,t){this._platformApply(e,t.stencilState)},t._platformApply=function(t,n){var i=t.gl,r=this.enabled,a=this.referenceValue,o=this.mask,s=this.compareFunctionFront,l=this.compareFunctionBack,u=this.failOperationFront,c=this.zFailOperationFront,h=this.passOperationFront,_=this.failOperationBack,d=this.zFailOperationBack,f=this.passOperationBack,p=this.writeMask;if(r!=n.enabled&&(r?i.enable(i.STENCIL_TEST):i.disable(i.STENCIL_TEST),n.enabled=r),r){var g=a!==n.referenceValue||o!==n.mask;(g||s!==n.compareFunctionFront)&&(i.stencilFuncSeparate(i.FRONT,e._getGLCompareFunction(t,s),a,o),n.compareFunctionFront=s),(g||l!==n.compareFunctionBack)&&(i.stencilFuncSeparate(i.BACK,e._getGLCompareFunction(t,l),a,o),n.compareFunctionBack=this.compareFunctionBack),g&&(n.referenceValue=this.referenceValue,n.mask=this.mask),u===n.failOperationFront&&c===n.zFailOperationFront&&h===n.passOperationFront||(i.stencilOpSeparate(i.FRONT,e._getGLStencilOperation(t,u),e._getGLStencilOperation(t,c),e._getGLStencilOperation(t,h)),n.failOperationFront=u,n.zFailOperationFront=c,n.passOperationFront=h),_===n.failOperationBack&&d===n.zFailOperationBack&&f===n.passOperationBack||(i.stencilOpSeparate(i.BACK,e._getGLStencilOperation(t,_),e._getGLStencilOperation(t,d),e._getGLStencilOperation(t,f)),n.failOperationBack=_,n.zFailOperationBack=d,n.passOperationBack=f),p!==n.writeMask&&(i.stencilMask(p),n.writeMask=p)}},e}(),Ln=function(){function e(){this.blendState=new on,this.depthState=new ln,this.stencilState=new Rn,this.rasterState=new cn}return e.prototype._apply=function(e,t){var n=e._hardwareRenderer,i=e._lastRenderState;this.blendState._apply(n,i),this.depthState._apply(n,i),this.stencilState._apply(n,i),this.rasterState._apply(n,i,t)},e}(),Dn=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=void 0,i.shader=void 0,i.renderQueueType=zt.Opaque,i.shaderData=new nn(Ut.Material),i.renderState=new Ln,i.shader=n,i}A(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),ne.deepCloneObject(this.renderState,e.renderState)},n._addRefCount=function(t){e.prototype._addRefCount.call(this,t),this.shaderData._addRefCount(t)},n._preRender=function(e){},n._onDestroy=function(){},t}(kt),Bn=function(){function e(e){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=e}var t=e.prototype;return t.getFromPool=function(){var e=this._elementPoolIndex,t=this._elementPool;if(this._elementPoolIndex++,t.length===e){var n=new this._type;return t.push(n),n}return t[e]},t.resetPool=function(){this._elementPoolIndex=0},e}(),In=function(){this.component=void 0,this.material=void 0,this.multiRenderData=void 0},On=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).mesh=void 0,t.subMesh=void 0,t}return A(t,e),t.prototype.setValue=function(e,t,n,i){this.component=e,this.mesh=t,this.subMesh=n,this.material=i},t}(In),zn=function(){function e(){this._camera=void 0,this._viewProjectMatrix=new d}return e.prototype._setContext=function(e){this._camera=e,d.multiply(e.projectionMatrix,e.viewMatrix,this._viewProjectMatrix)},e}(),Nn=function(e){function t(){var t;return(t=e.call(this)||this).renderData=void 0,t.texture=void 0,t.multiRenderData=!1,t}return A(t,e),t.prototype.setValue=function(e,t,n,i){this.component=e,this.renderData=t,this.material=n,this.texture=i},t}(In),Vn=function(e){function t(){var t;return(t=e.call(this)||this).renderData=void 0,t.isAdd=!0,t.multiRenderData=!1,t}return A(t,e),t.prototype.setValue=function(e,t,n){this.component=e,this.renderData=t,this.material=n},t}(In);!function(e){e[e.None=0]="None",e[e.VisibleInsideMask=1]="VisibleInsideMask",e[e.VisibleOutsideMask=2]="VisibleOutsideMask"}(hn||(hn={}));var Un,kn,Gn=Te(Ze)((Fn=function(e){function t(n){var i;I(i=e.call(this,n)||this,"shaderData",fn,L(i)),I(i,"isCulled",pn,L(i)),I(i,"_distanceForSort",gn,L(i)),I(i,"_onUpdateIndex",vn,L(i)),I(i,"_rendererIndex",mn,L(i)),I(i,"_globalShaderMacro",yn,L(i)),I(i,"_transformChangeFlag",xn,L(i)),I(i,"_bounds",wn,L(i)),I(i,"_overrideUpdate",bn,L(i)),I(i,"_materials",Cn,L(i)),I(i,"_mvMatrix",Tn,L(i)),I(i,"_mvpMatrix",Sn,L(i)),I(i,"_mvInvMatrix",An,L(i)),I(i,"_normalMatrix",Pn,L(i)),I(i,"_materialsInstanced",Mn,L(i)),I(i,"_priority",En,L(i));var r=t.prototype;return i._overrideUpdate=i.update!==r.update,i._transformChangeFlag=i.entity.transform.registerWorldChangeFlag(),i.shaderData._addRefCount(1),i}A(t,e);var n=t.prototype;return n.getInstanceMaterial=function(e){void 0===e&&(e=0);var t=this._materials;if(t.length>e){var n=t[e];if(n)return this._materialsInstanced[e]?n:this._createInstanceMaterial(n,e)}return null},n.getMaterial=function(e){return void 0===e&&(e=0),this._materials[e]||null},n.setMaterial=function(e,t){void 0===t&&(t=null),"number"==typeof e?this._setMaterial(e,t):this._setMaterial(0,e)},n.getInstanceMaterials=function(){for(var e=this._materials,t=this._materialsInstanced,n=0,i=e.length;n<i;n++)t[n]||this._createInstanceMaterial(this._materials[n],n);return e},n.getMaterials=function(){return this._materials},n.setMaterials=function(e){for(var t=e.length,n=this._materials,i=this._materialsInstanced,r=t,a=n.length;r<a;r++){var o=n[r];o&&o._addRefCount(-1)}n.length!==t&&(n.length=t),0!==i.length&&(i.length=0);for(var s=0;s<t;s++){var l=n[s],u=e[s];l!==u&&(n[s]=u,l&&l._addRefCount(-1),u&&u._addRefCount(1))}},n.update=function(e){},n._updateShaderData=function(e){var n=this.shaderData,i=this.entity.transform.worldMatrix,r=this._mvMatrix,a=this._mvpMatrix,o=this._mvInvMatrix,s=this._normalMatrix;d.multiply(e._camera.viewMatrix,i,r),d.multiply(e._viewProjectMatrix,i,a),d.invert(r,o),d.invert(i,s),s.transpose(),n.setMatrix(t._localMatrixProperty,this.entity.transform.localMatrix),n.setMatrix(t._worldMatrixProperty,i),n.setMatrix(t._mvMatrixProperty,r),n.setMatrix(t._mvpMatrixProperty,a),n.setMatrix(t._mvInvMatrixProperty,o),n.setMatrix(t._normalMatrixProperty,s)},n._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},n._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},n._render=function(e){throw"not implement"},n._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1);for(var t=this._materials,n=0,i=t.length;n<i;n++){var r;null===(r=t[n])||void 0===r||r._addRefCount(-1)}},n._updateBounds=function(e){},n._createInstanceMaterial=function(e,t){var n=e.clone();return n.name=n.name+"(Instance)",e._addRefCount(-1),n._addRefCount(1),this._materialsInstanced[t]=!0,this._materials[t]=n,n},n._setMaterial=function(e,t){var n=this._materials;e>=n.length&&(n.length=e+1);var i=n[e];if(i!==t){var r=this._materialsInstanced;e<r.length&&(r[e]=!1),i&&i._addRefCount(-1),t&&t._addRefCount(1),n[e]=t}},C(t,[{key:"materialCount",get:function(){return this._materials.length},set:function(e){var t=this._materials,n=this._materialsInstanced;t.length!==e&&(t.length=e),n.length>e&&(n.length=e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),t}(Ye),Fn._localMatrixProperty=Zt.getPropertyByName("u_localMat"),Fn._worldMatrixProperty=Zt.getPropertyByName("u_modelMat"),Fn._mvMatrixProperty=Zt.getPropertyByName("u_MVMat"),Fn._mvpMatrixProperty=Zt.getPropertyByName("u_MVPMat"),Fn._mvInvMatrixProperty=Zt.getPropertyByName("u_MVInvMat"),Fn._normalMatrixProperty=Zt.getPropertyByName("u_normalMat"),fn=O((dn=Fn).prototype,"shaderData",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new nn(Ut.Renderer)}}),pn=O(dn.prototype,"isCulled",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gn=O(dn.prototype,"_distanceForSort",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vn=O(dn.prototype,"_onUpdateIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),mn=O(dn.prototype,"_rendererIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),yn=O(dn.prototype,"_globalShaderMacro",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ye}}),xn=O(dn.prototype,"_transformChangeFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wn=O(dn.prototype,"_bounds",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),bn=O(dn.prototype,"_overrideUpdate",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cn=O(dn.prototype,"_materials",[Z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tn=O(dn.prototype,"_mvMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Sn=O(dn.prototype,"_mvpMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),An=O(dn.prototype,"_mvInvMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Pn=O(dn.prototype,"_normalMatrix",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Mn=O(dn.prototype,"_materialsInstanced",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),En=O(dn.prototype,"_priority",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_n=dn))||_n;var Hn,Wn,jn,Xn,Kn,qn,Yn,Qn,Jn,Zn,$n,ei,ti,ni=function(e){}((kn=function(){function e(){}return e.resetData=function(t){var n=t._renderData,i=n.vertexCount=4,r=n.positions,a=n.uvs;if(r.length<i)for(var s=r.length;s<i;s++)r.push(new o),a.push(new p);n.triangles=e._rectangleTriangles},e.updatePositions=function(t){var n=t.width,i=t.height,r=t.sprite,a=r.pivot,o=a.x,l=a.y,u=e._worldMatrix,c=u.elements,h=t.entity.transform.worldMatrix.elements,_=t.flipX?-n:n,d=t.flipY?-i:i;c[0]=h[0]*_,c[1]=h[1]*_,c[2]=h[2]*_,c[4]=h[4]*d,c[5]=h[5]*d,c[6]=h[6]*d,c[8]=h[8],c[9]=h[9],c[10]=h[10],c[12]=h[12]-o*c[0]-l*c[4],c[13]=h[13]-o*c[1]-l*c[5],c[14]=h[14]-o*c[2]-l*c[6];for(var f=r._getPositions(),p=t._renderData.positions,g=0;g<4;g++){var v=f[g],m=v.x,y=v.y;p[g].set(c[0]*m+c[4]*y+c[12],c[1]*m+c[5]*y+c[13],c[2]*m+c[6]*y+c[14])}s.transform(r._getBounds(),u,t._bounds)},e.updateUVs=function(e){var t=e.sprite._getUVs(),n=e._renderData.uvs,i=t[0],r=i.x,a=i.y,o=t[3],s=o.x,l=o.y;n[0].set(r,a),n[1].set(s,a),n[2].set(r,l),n[3].set(s,l)},e}(),kn._rectangleTriangles=[0,1,2,2,1,3],kn._worldMatrix=new d,Un=kn))||Un,ii=function(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.vertexCount=e,this.positions=t,this.uvs=n,this.triangles=i,this.color=r};!function(e){e[e.texture=1]="texture",e[e.size=2]="size",e[e.atlasRotate=4]="atlasRotate",e[e.atlasRegion=8]="atlasRegion",e[e.atlasRegionOffset=16]="atlasRegionOffset",e[e.region=32]="region",e[e.pivot=64]="pivot",e[e.border=128]="border"}(Hn||(Hn={})),function(e){e[e.Layer0=1]="Layer0",e[e.Layer1=2]="Layer1",e[e.Layer2=4]="Layer2",e[e.Layer3=8]="Layer3",e[e.Layer4=16]="Layer4",e[e.Layer5=32]="Layer5",e[e.Layer6=64]="Layer6",e[e.Layer7=128]="Layer7",e[e.Layer8=256]="Layer8",e[e.Layer9=512]="Layer9",e[e.Layer10=1024]="Layer10",e[e.Layer11=2048]="Layer11",e[e.Layer12=4096]="Layer12",e[e.Layer13=8192]="Layer13",e[e.Layer14=16384]="Layer14",e[e.Layer15=32768]="Layer15",e[e.Layer16=65536]="Layer16",e[e.Layer17=131072]="Layer17",e[e.Layer18=262144]="Layer18",e[e.Layer19=524288]="Layer19",e[e.Layer20=1048576]="Layer20",e[e.Layer21=2097152]="Layer21",e[e.Layer22=4194304]="Layer22",e[e.Layer23=8388608]="Layer23",e[e.Layer24=16777216]="Layer24",e[e.Layer25=33554432]="Layer25",e[e.Layer26=67108864]="Layer26",e[e.Layer27=134217728]="Layer27",e[e.Layer28=268435456]="Layer28",e[e.Layer29=536870912]="Layer29",e[e.Layer30=1073741824]="Layer30",e[e.Layer31=2147483648]="Layer31",e[e.Everything=4294967295]="Everything"}(Wn||(Wn={}));var ri,ai,oi,si,li=(ti=function(e){function t(n){var i;return I(i=e.call(this,n)||this,"influenceLayers",Xn,L(i)),i._maskElement=void 0,i._renderData=void 0,I(i,"_sprite",Kn,L(i)),I(i,"_width",qn,L(i)),I(i,"_height",Yn,L(i)),I(i,"_flipX",Qn,L(i)),I(i,"_flipY",Jn,L(i)),I(i,"_alphaCutoff",Zn,L(i)),I(i,"_dirtyFlag",$n,L(i)),I(i,"_spriteChangeFlag",ei,L(i)),i._renderData=new ii(4,[],[]),ni.resetData(L(i)),i.setMaterial(i._engine._spriteMaskDefaultMaterial),i.shaderData.setFloat(t._alphaCutoffProperty,i._alphaCutoff),i._onSpriteChange=i._onSpriteChange.bind(L(i)),i}A(t,e);var n=t.prototype;return n._onDestroy=function(){this._sprite=null,this._renderData=null,this._spriteChangeFlag&&(this._spriteChangeFlag.destroy(),this._spriteChangeFlag=null),e.prototype._onDestroy.call(this)},n._render=function(e){var t;if(null!==(t=this.sprite)&&void 0!==t&&t.texture&&this.width&&this.height){(this._transformChangeFlag.flag||this._dirtyFlag&ri.Position)&&(ni.updatePositions(this),this._dirtyFlag&=~ri.Position,this._transformChangeFlag.flag=!1),this._dirtyFlag&ri.UV&&(ni.updateUVs(this),this._dirtyFlag&=~ri.UV);var n=this._engine._spriteMaskElementPool.getFromPool();n.setValue(this,this._renderData,this.getMaterial()),e._renderPipeline._allSpriteMasks.add(this),this._maskElement=n}},n._cloneTo=function(e){e.sprite=this._sprite},n._onSpriteChange=function(e){switch(e){case Hn.texture:this.shaderData.setTexture(t._textureProperty,this.sprite.texture);break;case Hn.region:case Hn.atlasRegionOffset:this._dirtyFlag|=ri.All;break;case Hn.atlasRegion:this._dirtyFlag|=ri.UV}},C(t,[{key:"width",get:function(){return void 0===this._width&&this._sprite&&(this.width=this._sprite.width),this._width},set:function(e){this._width!==e&&(this._width=e,this._dirtyFlag|=ri.Position)}},{key:"height",get:function(){return void 0===this._height&&this._sprite&&(this.height=this._sprite.height),this._height},set:function(e){this._height!==e&&(this._height=e,this._dirtyFlag|=ri.Position)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyFlag|=ri.Position)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyFlag|=ri.Position)}},{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._sprite=e,this._spriteChangeFlag&&this._spriteChangeFlag.destroy(),e?(this._spriteChangeFlag=e._registerUpdateFlag(),this._spriteChangeFlag.listener=this._onSpriteChange,this._dirtyFlag|=ri.All,this.shaderData.setTexture(t._textureProperty,e.texture)):(this._spriteChangeFlag=null,this.shaderData.setTexture(t._textureProperty,null)))}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(t._alphaCutoffProperty,e))}},{key:"bounds",get:function(){var e;return null!==(e=this.sprite)&&void 0!==e&&e.texture&&this.width&&this.height?((this._transformChangeFlag.flag||this._dirtyFlag&ri.Position)&&(ni.updatePositions(this),this._dirtyFlag&=~ri.Position,this._transformChangeFlag.flag=!1),this._bounds):br._defaultBoundingBox}}]),t}(Gn),ti._textureProperty=Zt.getPropertyByName("u_maskTexture"),ti._alphaCutoffProperty=Zt.getPropertyByName("u_maskAlphaCutoff"),Xn=O((jn=ti).prototype,"influenceLayers",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.Everything}}),Kn=O(jn.prototype,"_sprite",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qn=O(jn.prototype,"_width",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Yn=O(jn.prototype,"_height",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Qn=O(jn.prototype,"_flipX",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jn=O(jn.prototype,"_flipY",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zn=O(jn.prototype,"_alphaCutoff",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),$n=O(jn.prototype,"_dirtyFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ei=O(jn.prototype,"_spriteChangeFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jn);!function(e){e[e.Position=1]="Position",e[e.UV=2]="UV",e[e.All=3]="All"}(ri||(ri={})),function(e){e[e.Float=0]="Float",e[e.Vector2=1]="Vector2",e[e.Vector3=2]="Vector3",e[e.Vector4=3]="Vector4",e[e.Byte4=4]="Byte4",e[e.UByte4=5]="UByte4",e[e.NormalizedByte4=6]="NormalizedByte4",e[e.NormalizedUByte4=7]="NormalizedUByte4",e[e.Short2=8]="Short2",e[e.UShort2=9]="UShort2",e[e.NormalizedShort2=10]="NormalizedShort2",e[e.NormalizedUShort2=11]="NormalizedUShort2",e[e.Short4=12]="Short4",e[e.UShort4=13]="UShort4",e[e.NormalizedShort4=14]="NormalizedShort4",e[e.NormalizedUShort4=15]="NormalizedUShort4"}(ai||(ai={})),function(e){e[e.Static=0]="Static",e[e.Dynamic=1]="Dynamic",e[e.Stream=2]="Stream"}(oi||(oi={})),function(e){e[e.UInt8=0]="UInt8",e[e.UInt16=1]="UInt16",e[e.UInt32=2]="UInt32"}(si||(si={}));var ui,ci,hi=function(){function e(){}return e._getGLBufferUsage=function(e,t){switch(t){case oi.Static:return e.STATIC_DRAW;case oi.Dynamic:return e.DYNAMIC_DRAW;case oi.Stream:return e.STREAM_DRAW}},e._getGLIndexType=function(e){switch(e){case si.UInt8:return se.UNSIGNED_BYTE;case si.UInt16:return se.UNSIGNED_SHORT;case si.UInt32:return se.UNSIGNED_INT}},e._getGLIndexByteCount=function(e){switch(e){case si.UInt8:return 1;case si.UInt16:return 2;case si.UInt32:return 4}},e._getElementInfo=function(e){var t,n,i=!1;switch(e){case ai.Float:t=1,n=se.FLOAT;break;case ai.Vector2:t=2,n=se.FLOAT;break;case ai.Vector3:t=3,n=se.FLOAT;break;case ai.Vector4:t=4,n=se.FLOAT;break;case ai.Byte4:t=4,n=se.BYTE;break;case ai.UByte4:t=4,n=se.UNSIGNED_BYTE;break;case ai.NormalizedByte4:t=4,n=se.BYTE,i=!0;break;case ai.NormalizedUByte4:t=4,n=se.UNSIGNED_BYTE,i=!0;break;case ai.Short2:t=2,n=se.SHORT;break;case ai.UShort2:t=2,n=se.UNSIGNED_SHORT;break;case ai.NormalizedShort2:t=2,n=se.SHORT,i=!0;break;case ai.NormalizedUShort2:t=2,n=se.UNSIGNED_SHORT,i=!0;break;case ai.Short4:t=4,n=se.SHORT;break;case ai.UShort4:t=4,n=se.UNSIGNED_SHORT;break;case ai.NormalizedShort4:t=4,n=se.SHORT,i=!0;break;case ai.NormalizedUShort4:t=4,n=se.UNSIGNED_SHORT,i=!0}return{size:t,type:n,normalized:i}},e}(),_i=function(){function e(e,t,n,i,r){void 0===r&&(r=0),this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=e,this._offset=t,this._format=n,this._bindingIndex=i,this._glElementInfo=hi._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return C(e,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex},set:function(e){this._bindingIndex=e}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}}]),e}();!function(e){e[e.VertexBuffer=0]="VertexBuffer",e[e.IndexBuffer=1]="IndexBuffer"}(ui||(ui={})),function(e){e[e.None=0]="None",e[e.Discard=1]="Discard"}(ci||(ci={}));var di,fi=function(e){function t(t,n,i,r){var a;void 0===r&&(r=oi.Static),(a=e.call(this,t)||this)._glBindTarget=void 0,a._glBufferUsage=void 0,a._nativeBuffer=void 0,a._hardwareRenderer=void 0,a._type=void 0,a._byteLength=void 0,a._bufferUsage=void 0,a._engine=t,a._type=n,a._bufferUsage=r;var o=t._hardwareRenderer,s=o.gl,l=hi._getGLBufferUsage(s,r),u=n===ui.VertexBuffer?s.ARRAY_BUFFER:s.ELEMENT_ARRAY_BUFFER;return a._nativeBuffer=s.createBuffer(),a._hardwareRenderer=o,a._glBufferUsage=l,a._glBindTarget=u,a.bind(),"number"==typeof i?(a._byteLength=i,s.bufferData(u,i,l)):(a._byteLength=i.byteLength,s.bufferData(u,i,l)),s.bindBuffer(u,null),a}A(t,e);var n=t.prototype;return n.bind=function(){this._hardwareRenderer.gl.bindBuffer(this._glBindTarget,this._nativeBuffer)},n.setData=function(e,t,n,i,r){void 0===t&&(t=0),void 0===n&&(n=0),void 0===r&&(r=ci.None);var a=this._hardwareRenderer.gl,o=this._hardwareRenderer.isWebGL2,s=this._glBindTarget;this.bind(),r===ci.Discard&&a.bufferData(s,this._byteLength,this._glBufferUsage);var l=e.BYTES_PER_ELEMENT||1,u=i?l*i:e.byteLength;if(0!==n||u<e.byteLength){var c=void 0!==e.byteOffset;if(o&&c)a.bufferSubData(s,t,e,n,u/l);else{var h=new Uint8Array(c?e.buffer:e,n*l,u);a.bufferSubData(s,t,h)}}else a.bufferSubData(s,t,e);a.bindBuffer(s,null)},n.getData=function(e,t,n,i){if(void 0===t&&(t=0),void 0===n&&(n=0),!this._hardwareRenderer.isWebGL2)throw"Buffer is write-only on WebGL1.0 platforms.";var r=this._hardwareRenderer.gl;this.bind(),r.getBufferSubData(this._glBindTarget,t,e,n,i)},n._onDestroy=function(){this._hardwareRenderer.gl.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},n.resize=function(e){this.bind(),this._hardwareRenderer.gl.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},C(t,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),t}(kt);!function(e){e[e.Points=0]="Points",e[e.Lines=1]="Lines",e[e.LineLoop=2]="LineLoop",e[e.LineStrip=3]="LineStrip",e[e.Triangles=4]="Triangles",e[e.TriangleStrip=5]="TriangleStrip",e[e.TriangleFan=6]="TriangleFan"}(di||(di={}));var pi,gi,vi,mi,yi,xi=function(){function e(e,t){this._buffer=void 0,this._format=void 0,this._buffer=e,this._format=t}return C(e,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),e}(),wi=function(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=di.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=e,this.count=t,this.topology=n},bi=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).name=void 0,i.bounds=new s,i._vertexElementMap={},i._glIndexType=void 0,i._glIndexByteCount=void 0,i._platformPrimitive=void 0,i._instanceCount=0,i._vertexBufferBindings=[],i._indexBufferBinding=null,i._vertexElements=[],i._enableVAO=!0,i._subMeshes=[],i._updateFlagManager=new Je,i.name=n,i._platformPrimitive=i._engine._hardwareRenderer.createPlatformPrimitive(L(i)),i}A(t,e);var n=t.prototype;return n.addSubMesh=function(e,t,n){return void 0===n&&(n=di.Triangles),"number"==typeof e&&(e=new wi(e,t,n)),this._subMeshes.push(e),e},n.removeSubMesh=function(e){var t=this._subMeshes,n=t.indexOf(e);-1!==n&&t.splice(n,1)},n.clearSubMesh=function(){this._subMeshes.length=0},n.registerUpdateFlag=function(){return this._updateFlagManager.createFlag(qe)},n._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var t in e)delete e[t]},n._addVertexElement=function(e){var t=e.semantic;this._vertexElementMap[t]=e,this._vertexElements.push(e),this._updateFlagManager.dispatch()},n._setVertexBufferBinding=function(e,t){if(this._getRefCount()>0){var n=this._vertexBufferBindings[e];n&&n._buffer._addRefCount(-1),t._buffer._addRefCount(1)}this._vertexBufferBindings[e]=t},n._draw=function(e,t){this._platformPrimitive.draw(e,t)},n._addRefCount=function(t){e.prototype._addRefCount.call(this,t);for(var n=this._vertexBufferBindings,i=0,r=n.length;i<r;i++)n[i]._buffer._addRefCount(t)},n._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},n._setVertexElements=function(e){this._clearVertexElements();for(var t=0,n=e.length;t<n;t++)this._addVertexElement(e[t])},n._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=hi._getGLIndexType(e.format),this._glIndexByteCount=hi._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},C(t,[{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),t}(kt),Ci=function(){function e(e,t){this._buffer=void 0,this._stride=void 0,this._buffer=e,this._stride=t}return C(e,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),e}();!function(e){e[e.Depth=0]="Depth",e[e.DepthStencil=1]="DepthStencil",e[e.Stencil=2]="Stencil",e[e.Depth16=3]="Depth16",e[e.Depth24=4]="Depth24",e[e.Depth32=5]="Depth32",e[e.Depth24Stencil8=6]="Depth24Stencil8",e[e.Depth32Stencil8=7]="Depth32Stencil8"}(pi||(pi={})),function(e){e[e.PositiveX=0]="PositiveX",e[e.NegativeX=1]="NegativeX",e[e.PositiveY=2]="PositiveY",e[e.NegativeY=3]="NegativeY",e[e.PositiveZ=4]="PositiveZ",e[e.NegativeZ=5]="NegativeZ"}(gi||(gi={})),function(e){e[e.Point=0]="Point",e[e.Bilinear=1]="Bilinear",e[e.Trilinear=2]="Trilinear"}(vi||(vi={})),function(e){e[e.R8G8B8=0]="R8G8B8",e[e.R8G8B8A8=1]="R8G8B8A8",e[e.R4G4B4A4=2]="R4G4B4A4",e[e.R5G5B5A1=3]="R5G5B5A1",e[e.R5G6B5=4]="R5G6B5",e[e.Alpha8=5]="Alpha8",e[e.LuminanceAlpha=6]="LuminanceAlpha",e[e.R16G16B16A16=7]="R16G16B16A16",e[e.R32G32B32A32=8]="R32G32B32A32",e[e.DXT1=9]="DXT1",e[e.DXT5=10]="DXT5",e[e.ETC1_RGB=11]="ETC1_RGB",e[e.ETC2_RGB=12]="ETC2_RGB",e[e.ETC2_RGBA5=13]="ETC2_RGBA5",e[e.ETC2_RGBA8=14]="ETC2_RGBA8",e[e.PVRTC_RGB2=15]="PVRTC_RGB2",e[e.PVRTC_RGBA2=16]="PVRTC_RGBA2",e[e.PVRTC_RGB4=17]="PVRTC_RGB4",e[e.PVRTC_RGBA4=18]="PVRTC_RGBA4",e[e.ASTC_4x4=19]="ASTC_4x4",e[e.ASTC_5x5=20]="ASTC_5x5",e[e.ASTC_6x6=21]="ASTC_6x6",e[e.ASTC_8x8=22]="ASTC_8x8",e[e.ASTC_10x10=23]="ASTC_10x10",e[e.ASTC_12x12=24]="ASTC_12x12",e[e.Depth=25]="Depth",e[e.DepthStencil=26]="DepthStencil",e[e.Stencil=27]="Stencil",e[e.Depth16=28]="Depth16",e[e.Depth24=29]="Depth24",e[e.Depth32=30]="Depth32",e[e.Depth24Stencil8=31]="Depth24Stencil8",e[e.Depth32Stencil8=32]="Depth32Stencil8"}(mi||(mi={})),function(e){e[e.Clamp=0]="Clamp",e[e.Repeat=1]="Repeat",e[e.Mirror=2]="Mirror"}(yi||(yi={}));var Ti=function(e){function t(t,n,i,r,a,o){var s;return void 0===a&&(a=pi.Depth),void 0===o&&(o=1),(s=e.call(this,t)||this)._platformRenderTarget=void 0,s._depth=void 0,s._antiAliasing=void 0,s._autoGenerateMipmaps=!0,s._width=void 0,s._height=void 0,s._colorTextures=void 0,s._depthTexture=void 0,s._width=n,s._height=i,s._antiAliasing=o,s._depth=a,s._colorTextures=r?r instanceof Array?r.slice():[r]:[],a instanceof Ht&&(s._depthTexture=a),s._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(L(s)),s}A(t,e);var n=t.prototype;return n.getColorTexture=function(e){return void 0===e&&(e=0),this._colorTextures[e]},n.generateMipmaps=function(){if(this._autoGenerateMipmaps){for(var e=this._colorTextures,t=0,n=e.length;t<n;t++){e[t].generateMipmaps()}this._depthTexture&&this._depthTexture.generateMipmaps()}},n.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},n._setRenderTargetInfo=function(e,t){this._platformRenderTarget.setRenderTargetInfo(e,t)},n._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},C(t,[{key:"autoGenerateMipmaps",get:function(){return this._autoGenerateMipmaps},set:function(e){this._autoGenerateMipmaps=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),t}(ve),Si=function(e){function t(t,n,i,r,a){var o;return void 0===r&&(r=mi.R8G8B8A8),void 0===a&&(a=!0),(o=e.call(this,t)||this)._mipmap=a,o._width=n,o._height=i,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTexture2D(L(o)),o.filterMode=vi.Bilinear,o.wrapModeU=o.wrapModeV=yi.Repeat,o}A(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this._platformTexture.setPixelBuffer(e,t,n,i,r,a)},n.setImageSource=function(e,t,n,i,r,a){void 0===t&&(t=0),void 0===n&&(n=!1),void 0===i&&(i=!1),void 0===r&&(r=0),void 0===a&&(a=0),this._platformTexture.setImageSource(e,t,n,i,r,a)},n.getPixelBuffer=function(e,t,n,i,r,a){var o=arguments.length;1===o?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):2===o?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,t):5===o?this._platformTexture.getPixelBuffer(e,t,n,i,0,r):6===o&&this._platformTexture.getPixelBuffer(e,t,n,i,r,a)},t}(Ht),Ai=function(e){function t(t,n,i,r,a,o){var s;return void 0===a&&(a=mi.R8G8B8A8),void 0===o&&(o=!0),(s=e.call(this,t)||this)._length=void 0,s._mipmap=o,s._width=n,s._height=i,s._length=r,s._format=a,s._mipmapCount=s._getMipmapCount(),s._platformTexture=t._hardwareRenderer.createPlatformTexture2DArray(L(s)),s.filterMode=vi.Bilinear,s.wrapModeU=s.wrapModeV=yi.Repeat,s}A(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o,s){void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),this._platformTexture.setPixelBuffer(e,t,n,i,r,a,o,s)},n.setImageSource=function(e,t,n,i,r,a,o){void 0===n&&(n=0),void 0===i&&(i=!1),void 0===r&&(r=!1),void 0===a&&(a=0),void 0===o&&(o=0),this._platformTexture.setImageSource(e,t,n,i,r,a,o)},n.getPixelBuffer=function(e,t,n,i,r,a,o){var s=arguments.length;1===s?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,t):2===s?this._platformTexture.getPixelBuffer(e,0,0,this._width>>t,this._height>>t,t,n):5===s?this._platformTexture.getPixelBuffer(e,t,n,i,r,0,a):6===s&&this._platformTexture.getPixelBuffer(e,t,n,i,r,a,o)},C(t,[{key:"length",get:function(){return this._length}}]),t}(Ht),Pi=function(e){function t(t,n,i,r){var a;return void 0===i&&(i=mi.R8G8B8A8),void 0===r&&(r=!0),(a=e.call(this,t)||this)._mipmap=r,a._width=n,a._height=n,a._format=i,a._mipmapCount=a._getMipmapCount(),a._platformTexture=t._hardwareRenderer.createPlatformTextureCube(L(a)),a.filterMode=vi.Bilinear,a.wrapModeU=a.wrapModeV=yi.Clamp,a}A(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o){void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),this._platformTexture.setPixelBuffer(e,t,n,i,r,a,o)},n.setImageSource=function(e,t,n,i,r,a,o){void 0===n&&(n=0),void 0===i&&(i=!1),void 0===r&&(r=!1),void 0===a&&(a=0),void 0===o&&(o=0),this._platformTexture.setImageSource(e,t,n,i,r,a,o)},n.getPixelBuffer=function(e,t,n,i,r,a,o){var s=arguments.length;2===s?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,t):3===s?this._platformTexture.getPixelBuffer(e,0,0,this._width>>t,this._height>>t,t,n):6===s?this._platformTexture.getPixelBuffer(e,t,n,i,r,0,a):7===s&&this._platformTexture.getPixelBuffer(e,t,n,i,r,a,o)},t}(Ht),Mi=function(){function e(e,t){this._blendShapeCount=0,this._blendShapes=[],this._blendShapeNames=void 0,this._layoutDirtyListener=new Qe,this._subDataDirtyFlags=[],this._vertexTexture=void 0,this._vertexBuffers=[],this._vertices=void 0,this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._vertexElementOffset=void 0,this._storeInVertexBufferInfo=[],this._maxCountSingleVertexBuffer=0,this._engine=void 0,this._modelMesh=void 0,this._lastCreateHostInfo=new o(0,0,0),this._canUseTextureStoreData=!0,this._dataTextureInfo=new o,this._engine=e,this._modelMesh=t,this._canUseTextureStoreData=this._engine._hardwareRenderer.capability.canUseFloatTextureBlendShape,this._layoutDirtyListener.listener=this._updateLayoutChange.bind(this)}var t=e.prototype;return t._addBlendShape=function(e){this._blendShapes.push(e),this._blendShapeCount++,e._addLayoutChangeFlag(this._layoutDirtyListener),this._updateLayoutChange(e),this._subDataDirtyFlags.push(e._createSubDataDirtyFlag())},t._clearBlendShapes=function(){this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._blendShapes.length=0,this._blendShapeCount=0,this._layoutDirtyListener.clearFromManagers();for(var e=this._subDataDirtyFlags,t=0,n=e.length;t<n;t++)e[t].destroy();e.length=0},t._updateShaderData=function(t,n){var i=this._blendShapeCount;if(i>0){if(t.enableMacro(e._blendShapeMacro),this._useTextureMode())t.enableMacro(e._blendShapeTextureMacro),t.setTexture(e._blendShapeTextureProperty,this._vertexTexture),t.setVector3(e._blendShapeTextureInfoProperty,this._dataTextureInfo),t.setFloatArray(e._blendShapeWeightsProperty,n.blendShapeWeights);else{var r=this._getVertexBufferModeSupportCount();if(i>r){var a=n._condensedBlendShapeWeights;a||(a=new Float32Array(r),n._condensedBlendShapeWeights=a),this._filterCondensedBlendShapeWeights(n.blendShapeWeights,a),t.setFloatArray(e._blendShapeWeightsProperty,a),this._modelMesh._enableVAO=!1,i=r}else t.setFloatArray(e._blendShapeWeightsProperty,n.blendShapeWeights),this._modelMesh._enableVAO=!0;t.disableMacro(e._blendShapeTextureMacro)}t.enableMacro("OASIS_BLENDSHAPE_COUNT",i.toString()),this._useBlendNormal?t.enableMacro(e._blendShapeNormalMacro):t.disableMacro(e._blendShapeNormalMacro),this._useBlendTangent?t.enableMacro(e._blendShapeTangentMacro):t.disableMacro(e._blendShapeTangentMacro)}else t.disableMacro(e._blendShapeMacro),t.disableMacro("OASIS_BLENDSHAPE_COUNT")},t._useTextureMode=function(){return!!this._canUseTextureStoreData&&this._blendShapeCount>this._getVertexBufferModeSupportCount()},t._layoutOrCountChange=function(){var e=this._lastCreateHostInfo;return e.x!==this._blendShapeCount||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent},t._vertexElementsNeedUpdate=function(){var e=this._getVertexBufferModeSupportCount(),t=this._lastCreateHostInfo;return Math.min(t.x,e)!==Math.min(this._blendShapeCount,e)||!!t.y!==this._useBlendNormal||!!t.z!==this._useBlendTangent},t._needUpdateData=function(){for(var e=this._subDataDirtyFlags,t=0,n=e.length;t<n;t++)if(e[t].flag)return!0;return!1},t._addVertexElements=function(e){var t=0;this._vertexElementOffset=e._vertexElements.length;for(var n=0,i=Math.min(this._blendShapeCount,this._getVertexBufferModeSupportCount());n<i;n++)e._addVertexElement(new _i("POSITION_BS"+n,t,ai.Vector3,1)),t+=12,this._useBlendNormal&&(e._addVertexElement(new _i("NORMAL_BS"+n,t,ai.Vector3,1)),t+=12),this._useBlendTangent&&(e._addVertexElement(new _i("TANGENT_BS"+n,t,ai.Vector3,1)),t+=12)},t._update=function(e,t){var n=this._modelMesh.vertexCount,i=this._useTextureMode(),r=this._layoutOrCountChange()||e;r&&(i?this._createTextureArray(n):this._createVertexBuffers(n,t),this._lastCreateHostInfo.set(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent)),this._needUpdateData()&&(i?this._updateTextureArray(n,r):this._updateVertexBuffers(n,r))},t._releaseMemoryCache=function(){for(var e=this._blendShapes,t=e.length,n=new Array(t),i=0;i<t;i++)n[i]=e[i].name;this._blendShapeNames=n,this._layoutDirtyListener.destroy();for(var r=this._subDataDirtyFlags,a=0,o=r.length;a<o;a++)r[a].destroy();this._layoutDirtyListener=null,this._subDataDirtyFlags=null,this._blendShapes=null,this._vertices=null},t._createVertexBuffers=function(e,t){var n=this._engine,i=this._modelMesh,r=this._blendShapeCount,a=this._vertexBuffers,o=3*this._vertexElementCount,s=4*o,l=Math.floor(255/s),u=Math.ceil(r/l),c=o*e*Math.min(l,r);a.length=u,this._vertices=new Float32Array(c),this._maxCountSingleVertexBuffer=l,this._storeInVertexBufferInfo.length=r;for(var h=0;h<u;h++){var _=u-1,d=(h===_?r-_*l:l)*s,f=d*e,p=t?oi.Static:oi.Dynamic,g=new fi(n,ui.VertexBuffer,f,p);i._setVertexBufferBinding(h+1,new Ci(g,d)),a[h]=g}},t._createTextureArray=function(e){var t=this._engine._hardwareRenderer.capability.maxTextureSize,n=this._vertexElementCount,i=n*e,r=1;i>t&&(r=Math.ceil(i/t),i=t);var a=this._vertexTexture,o=this._blendShapes.length;a&&a.destroy(),(a=new Ai(this._engine,i,r,o,mi.R32G32B32A32,!1)).filterMode=vi.Point,this._vertices=new Float32Array(o*i*r*4),this._vertexTexture=a,this._dataTextureInfo.set(n,i,r)},t._updateVertexBuffers=function(e,t){for(var n=this._blendShapes,i=this._maxCountSingleVertexBuffer,r=this._vertices,a=this._vertexBuffers,o=this._storeInVertexBufferInfo,s=this._subDataDirtyFlags,l=3*this._vertexElementCount,u=4*l,c=0,h=n.length;c<h;c++){var _=s[c];if(t||_.flag){var d=n[c].frames,f=d.length,g=d[f-1];if(f>0&&g.deltaPositions.length!==e)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";var v=Math.floor(c/i),m=c%i,y=a[v],x=y.byteLength/(4*e),w=m*l,b=o[c];b||(o[c]=b=new p),b.set(v+1,m*u);for(var C=g.deltaPositions,T=0;T<e;T++){var S=w+x*T,A=C[T];A&&(r[S]=A.x,r[S+1]=A.y,r[S+2]=A.z)}if(w+=3,this._useBlendNormal){var P=g.deltaNormals;if(P)for(var M=0;M<e;M++){var E=w+x*M,F=P[M];F&&(r[E]=F.x,r[E+1]=F.y,r[E+2]=F.z)}w+=3}if(this._useBlendTangent){var R=g.deltaTangents;if(R)for(var L=0;L<e;L++){var D=w+x*L,B=R[L];B&&(r[D]=B.x,r[D+1]=B.y,r[D+2]=B.z)}w+=3}m!==i-1&&c!==h-1||y.setData(r,0,0,y.byteLength/4),_.flag=!1}}},t._updateTextureArray=function(e,t){for(var n=this._blendShapes,i=this._vertexTexture,r=this._vertices,a=this._subDataDirtyFlags,o=0,s=n.length;o<s;o++){var l=a[o],u=i.width*i.height*4;if(t||l.flag){var c=n[o].frames,h=c.length,_=c[h-1];if(h>0&&_.deltaPositions.length!==e)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var d=_,f=d.deltaPositions,p=d.deltaNormals,g=d.deltaTangents,v=o*u,m=0;m<e;m++){var y=f[m];if(r[v]=y.x,r[v+1]=y.y,r[v+2]=y.z,v+=4,p){var x=p[m];r[v]=x.x,r[v+1]=x.y,r[v+2]=x.z,v+=4}if(g){var w=g[m];r[v]=w.x,r[v+1]=w.y,r[v+2]=w.z,v+=4}}l.flag=!1}}i.setPixelBuffer(0,r)},t._updateLayoutChange=function(e){var t=this._blendShapeCount>1,n=1,i=e._useBlendShapeNormal,r=e._useBlendShapeTangent;t&&(i&&(i=this._useBlendNormal),r&&(r=this._useBlendTangent)),i&&n++,r&&n++,this._useBlendNormal=i,this._useBlendTangent=r,this._vertexElementCount=n},t._attributeModeUpdateVertexElement=function(e,t,n,i){var r=this._vertexElementOffset+this._vertexElementCount*i,a=t[n],o=a.x,s=a.y,l=e[r];if(l.bindingIndex=o,l.offset=s,this._useBlendNormal){var u=e[++r];s+=12,u.bindingIndex=o,u.offset=s}if(this._useBlendTangent){var c=e[++r];s+=12,c.bindingIndex=o,c.offset=s}},t._getVertexBufferModeSupportCount=function(){return this._useBlendNormal||this._useBlendTangent?4:8},t._filterCondensedBlendShapeWeights=function(e,t){for(var n,i=t.length,r=this._modelMesh._vertexElements,a=this._storeInVertexBufferInfo,o=Number.POSITIVE_INFINITY,s=0,l=Math.min(e.length,this._blendShapeCount);s<l;s++){var u=e[s];if(s<i)this._attributeModeUpdateVertexElement(r,a,s,s),t[s]=u,u<o&&(o=u,n=s);else if(u>o){this._attributeModeUpdateVertexElement(r,a,s,n),t[n]=u,o=Number.POSITIVE_INFINITY;for(var c=0;c<i;c++){var h=t[c];h<o&&(o=h,n=c)}}}},e}();Mi._blendShapeMacro=Zt.getMacroByName("OASIS_BLENDSHAPE"),Mi._blendShapeTextureMacro=Zt.getMacroByName("OASIS_BLENDSHAPE_TEXTURE"),Mi._blendShapeNormalMacro=Zt.getMacroByName("OASIS_BLENDSHAPE_NORMAL"),Mi._blendShapeTangentMacro=Zt.getMacroByName("OASIS_BLENDSHAPE_TANGENT"),Mi._blendShapeWeightsProperty=Zt.getPropertyByName("u_blendShapeWeights"),Mi._blendShapeTextureProperty=Zt.getPropertyByName("u_blendShapeTexture"),Mi._blendShapeTextureInfoProperty=Zt.getPropertyByName("u_blendShapeTextureInfo");var Ei,Fi=function(e){function t(t,n){var i;return(i=e.call(this,t)||this)._blendShapeManager=void 0,i._vertexCount=0,i._accessible=!0,i._verticesFloat32=null,i._verticesUint8=null,i._indices=null,i._indicesFormat=null,i._vertexSlotChanged=!0,i._vertexChangeFlag=0,i._indicesChangeFlag=!1,i._vertexStrideFloat=0,i._lastUploadVertexCount=-1,i._positions=[],i._normals=null,i._colors=null,i._tangents=null,i._uv=null,i._uv1=null,i._uv2=null,i._uv3=null,i._uv4=null,i._uv5=null,i._uv6=null,i._uv7=null,i._boneWeights=null,i._boneIndices=null,i.name=n,i._blendShapeManager=new Mi(t,L(i)),i}A(t,e);var n=t.prototype;return n.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._positions=e,this._vertexCount=e.length,this._vertexChangeFlag|=Ei.Position},n.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},n.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=Ei.Normal,this._normals=e},n.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},n.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=Ei.Color,this._colors=e},n.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},n.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=null!=e,this._vertexChangeFlag|=Ei.BoneWeight,this._boneWeights=e},n.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},n.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=Ei.BoneIndex,this._boneIndices=e},n.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},n.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=Ei.Tangent,this._tangents=e},n.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},n.setUVs=function(e,t){var n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(t=null!=(n=t)?n:0){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=Ei.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=Ei.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=Ei.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=Ei.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=Ei.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=Ei.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=Ei.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=Ei.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},n.getUVs=function(e){var t;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=null!=(t=e)?t:0){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},n.setIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==e&&(this._indices=e,e instanceof Uint8Array?this._indicesFormat=si.UInt8:e instanceof Uint16Array?this._indicesFormat=si.UInt16:e instanceof Uint32Array&&(this._indicesFormat=si.UInt32)),this._indicesChangeFlag=!0},n.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},n.addBlendShape=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._addBlendShape(e)},n.clearBlendShapes=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._clearBlendShapes()},n.getBlendShapeName=function(e){return this._accessible?this._blendShapeManager._blendShapes[e].name:this._blendShapeManager._blendShapeNames[e]},n.uploadData=function(e){var t,n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var i=this._vertexCount,r=this._updateVertexElements(),a=this._lastUploadVertexCount!==i,o=null===(t=this._vertexBufferBindings[0])||void 0===t?void 0:t._buffer;if(a){null==o||o.destroy();var s=this._vertexStrideFloat,l=new Float32Array(s*i);this._verticesFloat32=l,this._verticesUint8=new Uint8Array(l.buffer),this._updateVertices(l,!0);var u=new fi(this._engine,ui.VertexBuffer,l,e?oi.Static:oi.Dynamic);this._setVertexBufferBinding(0,new Ci(u,4*s)),this._lastUploadVertexCount=i}else if(this._vertexChangeFlag&Ei.All){var c=this._verticesFloat32;this._updateVertices(c,r),o.setData(c)}var h=this._indices,_=null===(n=this._indexBufferBinding)||void 0===n?void 0:n._buffer;if(h)if(_&&h.byteLength==_.byteLength)this._indicesChangeFlag&&(_.setData(h),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new xi(_,this._indicesFormat)),this._indicesChangeFlag=!1);else{null==_||_.destroy();var d=new fi(this._engine,ui.IndexBuffer,h);this._setIndexBufferBinding(new xi(d,this._indicesFormat)),this._indicesChangeFlag=!1}else _&&(_.destroy(),this._setIndexBufferBinding(null));var f=this._blendShapeManager;f._blendShapeCount>0&&f._update(a,e),e&&(this._accessible=!1,this._releaseCache())},n._onDestroy=function(){e.prototype._onDestroy.call(this),this._accessible&&this._releaseCache()},n._updateVertexElements=function(){var e=this._blendShapeManager,t=!e._useTextureMode();if(this._vertexSlotChanged||t&&e._vertexElementsNeedUpdate()){var n=12,i=3;return this._clearVertexElements(),this._addVertexElement(Ri),this._normals&&(this._addVertexElement(new _i("NORMAL",n,ai.Vector3,0)),n+=12,i+=3),this._colors&&(this._addVertexElement(new _i("COLOR_0",n,ai.Vector4,0)),n+=16,i+=4),this._boneWeights&&(this._addVertexElement(new _i("WEIGHTS_0",n,ai.Vector4,0)),n+=16,i+=4),this._boneIndices&&(this._addVertexElement(new _i("JOINTS_0",n,ai.UByte4,0)),n+=4,i+=1),this._tangents&&(this._addVertexElement(new _i("TANGENT",n,ai.Vector4,0)),n+=16,i+=4),this._uv&&(this._addVertexElement(new _i("TEXCOORD_0",n,ai.Vector2,0)),n+=8,i+=2),this._uv1&&(this._addVertexElement(new _i("TEXCOORD_1",n,ai.Vector2,0)),n+=8,i+=2),this._uv2&&(this._addVertexElement(new _i("TEXCOORD_2",n,ai.Vector2,0)),n+=8,i+=2),this._uv3&&(this._addVertexElement(new _i("TEXCOORD_3",n,ai.Vector2,0)),n+=8,i+=2),this._uv4&&(this._addVertexElement(new _i("TEXCOORD_4",n,ai.Vector2,0)),n+=8,i+=2),this._uv5&&(this._addVertexElement(new _i("TEXCOORD_5",n,ai.Vector2,0)),n+=8,i+=2),this._uv6&&(this._addVertexElement(new _i("TEXCOORD_6",n,ai.Vector2,0)),n+=8,i+=2),this._uv7&&(this._addVertexElement(new _i("TEXCOORD_7",n,ai.Vector2,0)),n+=8,i+=2),t&&e._blendShapeCount>0&&e._addVertexElements(this),this._vertexSlotChanged=!1,this._vertexStrideFloat=i,!0}return!1},n._updateVertices=function(e,t){var n=this._vertexStrideFloat,i=this._vertexCount,r=this._positions,a=this._normals,o=this._colors,s=this._vertexChangeFlag,l=this._boneWeights,u=this._boneIndices,c=this._tangents,h=this._uv,_=this._uv1,d=this._uv2,f=this._uv3,p=this._uv4,g=this._uv5,v=this._uv6,m=this._uv7;if(t&&(this._vertexChangeFlag=Ei.All),s&Ei.Position)for(var y=0;y<i;y++){var x=n*y,w=r[y];e[x]=w.x,e[x+1]=w.y,e[x+2]=w.z}var b=3;if(a){if(s&Ei.Normal)for(var C=0;C<i;C++){var T=n*C+b,S=a[C];S&&(e[T]=S.x,e[T+1]=S.y,e[T+2]=S.z)}b+=3}if(o){if(s&Ei.Color)for(var A=0;A<i;A++){var P=n*A+b,M=o[A];M&&(e[P]=M.r,e[P+1]=M.g,e[P+2]=M.b,e[P+3]=M.a)}b+=4}if(l){if(s&Ei.BoneWeight)for(var E=0;E<i;E++){var F=n*E+b,R=l[E];R&&(e[F]=R.x,e[F+1]=R.y,e[F+2]=R.z,e[F+3]=R.w)}b+=4}if(u){if(s&Ei.BoneIndex)for(var L=this._verticesUint8,D=0;D<i;D++){var B=n*D+b,I=u[D];if(I){var O=4*B;L[O]=I.x,L[O+1]=I.y,L[O+2]=I.z,L[O+3]=I.w}}b+=1}if(c){if(s&Ei.Tangent)for(var z=0;z<i;z++){var N=n*z+b,V=c[z];V&&(e[N]=V.x,e[N+1]=V.y,e[N+2]=V.z,e[N+3]=V.w)}b+=4}if(h){if(s&Ei.UV)for(var U=0;U<i;U++){var k=n*U+b,G=h[U];G&&(e[k]=G.x,e[k+1]=G.y)}b+=2}if(_){if(s&Ei.UV1)for(var H=0;H<i;H++){var W=n*H+b,j=_[H];j&&(e[W]=j.x,e[W+1]=j.y)}b+=2}if(d){if(s&Ei.UV2)for(var X=0;X<i;X++){var K=n*X+b,q=d[X];q&&(e[K]=q.x,e[K+1]=q.y)}b+=2}if(f){if(s&Ei.UV3)for(var Y=0;Y<i;Y++){var Q=n*Y+b,J=f[Y];J&&(e[Q]=J.x,e[Q+1]=J.y)}b+=2}if(p){if(s&Ei.UV4)for(var Z=0;Z<i;Z++){var $=n*Z+b,ee=p[Z];ee&&(e[$]=ee.x,e[$+1]=ee.y)}b+=2}if(g){if(s&Ei.UV5)for(var te=0;te<i;te++){var ne=n*te+b,ie=g[te];ie&&(e[ne]=ie.x,e[ne+1]=ie.y)}b+=2}if(v){if(s&Ei.UV6)for(var re=0;re<i;re++){var ae=n*re+b,oe=v[re];oe&&(e[ae]=oe.x,e[ae+1]=oe.y)}b+=2}if(m){if(s&Ei.UV7)for(var se=0;se<i;se++){var le=n*se+b,ue=m[se];ue&&(e[le]=ue.x,e[le+1]=ue.y)}b+=2}this._vertexChangeFlag=0},n._releaseCache=function(){this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._blendShapeManager._releaseMemoryCache()},C(t,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"blendShapes",get:function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._blendShapeManager._blendShapes}},{key:"blendShapeCount",get:function(){return this._blendShapeManager._blendShapeCount}}]),t}(bi),Ri=new _i("POSITION",0,ai.Vector3,0);!function(e){e[e.Position=1]="Position",e[e.Normal=2]="Normal",e[e.Color=4]="Color",e[e.Tangent=8]="Tangent",e[e.BoneWeight=16]="BoneWeight",e[e.BoneIndex=32]="BoneIndex",e[e.UV=64]="UV",e[e.UV1=128]="UV1",e[e.UV2=256]="UV2",e[e.UV3=512]="UV3",e[e.UV4=1024]="UV4",e[e.UV5=2048]="UV5",e[e.UV6=4096]="UV6",e[e.UV7=8192]="UV7",e[e.All=65535]="All"}(Ei||(Ei={}));var Li,Di,Bi,Ii,Oi,zi,Ni,Vi,Ui,ki,Gi,Hi,Wi,ji,Xi=function(e){function t(t){var n;return(n=e.call(this,null)||this).name=t,n.inverseBindMatrices=void 0,n.joints=void 0,n.skeleton=void 0,n.inverseBindMatrices=[],n.joints=[],n.skeleton="none",n}return A(t,e),t}(ve),Ki=(Ii=function(e){function t(t){var n;return I(n=e.call(this,t)||this,"_mesh",Di,L(n)),I(n,"_meshUpdateFlag",Bi,L(n)),n}A(t,e);var n=t.prototype;return n._render=function(e){var n=this._mesh;if(n){if(this._meshUpdateFlag.flag){var i=this.shaderData,r=n._vertexElements;i.disableMacro(t._uvMacro),i.disableMacro(t._uv1Macro),i.disableMacro(t._normalMacro),i.disableMacro(t._tangentMacro),i.disableMacro(t._vertexColorMacro);for(var a=0,o=r.length;a<o;a++){switch(r[a].semantic){case"TEXCOORD_0":i.enableMacro(t._uvMacro);break;case"TEXCOORD_1":i.enableMacro(t._uv1Macro);break;case"NORMAL":i.enableMacro(t._normalMacro);break;case"TANGENT":i.enableMacro(t._tangentMacro);break;case"COLOR_0":i.enableMacro(t._vertexColorMacro)}}this._meshUpdateFlag.flag=!1}for(var s=n.subMeshes,l=e._renderPipeline,u=this._engine._renderElementPool,c=0,h=s.length;c<h;c++){var _=this._materials[c];if(_){var d=u.getFromPool();d.setValue(this,n,s[c],_),l.pushPrimitive(d)}}}else pe.error("mesh is null.")},n._onDestroy=function(){e.prototype._onDestroy.call(this);var t=this._mesh;t&&!t.destroyed&&(t._addRefCount(-1),this._mesh=null)},n._cloneTo=function(e){e.mesh=this._mesh},n._updateBounds=function(e){var t=this._mesh;if(t){var n=t.bounds,i=this._entity.transform.worldMatrix;s.transform(n,i,e)}else e.min.set(0,0,0),e.max.set(0,0,0)},n._setMesh=function(e){var t=this._mesh;t&&(t._addRefCount(-1),this._meshUpdateFlag.destroy()),e&&(e._addRefCount(1),this._meshUpdateFlag=e.registerUpdateFlag()),this._mesh=e},C(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&this._setMesh(e)}}]),t}(Gn),Ii._uvMacro=Zt.getMacroByName("O3_HAS_UV"),Ii._uv1Macro=Zt.getMacroByName("O3_HAS_UV1"),Ii._normalMacro=Zt.getMacroByName("O3_HAS_NORMAL"),Ii._tangentMacro=Zt.getMacroByName("O3_HAS_TANGENT"),Ii._vertexColorMacro=Zt.getMacroByName("O3_HAS_VERTEXCOLOR"),Di=O((Li=Ii).prototype,"_mesh",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Bi=O(Li.prototype,"_meshUpdateFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Li),qi=(ji=function(e){function t(t){var n;return I(n=e.call(this,t)||this,"matrixPalette",zi,L(n)),I(n,"jointNodes",Ni,L(n)),I(n,"jointTexture",Vi,L(n)),I(n,"_hasInitJoints",Ui,L(n)),I(n,"_mat",ki,L(n)),I(n,"_useJointTexture",Gi,L(n)),n._skin=void 0,I(n,"_blendShapeWeights",Hi,L(n)),I(n,"_condensedBlendShapeWeights",Wi,L(n)),n._mat=new d,n._skin=null,n}A(t,e);var n=t.prototype;return n._updateShaderData=function(n){e.prototype._updateShaderData.call(this,n);var i=this.shaderData;!this._useJointTexture&&this.matrixPalette&&i.setFloatArray(t._jointMatrixProperty,this.matrixPalette),this.mesh._blendShapeManager._updateShaderData(i,this)},n._initJoints=function(){if(this._skin){for(var e=this._skin.joints,n=[],i=e.length-1;i>=0;i--)n[i]=this.findByNodeName(this.entity,e[i]);this.matrixPalette=new Float32Array(16*n.length),this.jointNodes=n;var r=this.entity.engine._hardwareRenderer;if(r){var a=r.renderStates.getParameter(r.gl.MAX_VERTEX_UNIFORM_VECTORS),o=Math.floor((a-30)/4),s=this.shaderData,l=n.length;if(l)if(s.enableMacro("O3_HAS_SKIN"),s.setInt(t._jointCountProperty,l),l>o)r.canIUseMoreJoints?this._useJointTexture=!0:pe.error("component's joints count("+l+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+a+", and don't support jointTexture in this device. suggest joint count less than "+o+".",this);else{var u=Math.max(t._maxJoints,l);t._maxJoints=u,s.disableMacro("O3_USE_JOINT_TEXTURE"),s.enableMacro("O3_JOINTS_NUM",u.toString())}else s.disableMacro("O3_HAS_SKIN")}}},n.findByNodeName=function(e,t){if(!e)return null;var n=e.findByName(t);return n||this.findByNodeName(e.parent,t)},n.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,t=this._skin.inverseBindMatrices,n=this.matrixPalette,i=this.entity.getInvModelMatrix(),r=this._mat,a=e.length-1;a>=0;a--)r.identity(),e[a]?d.multiply(e[a].transform.worldMatrix,t[a],r):r.copyFrom(t[a]),d.multiply(i,r,r),n.set(r.elements,16*a);this._useJointTexture&&this.createJointTexture()}},n.createJointTexture=function(){if(!this.jointTexture){var e=this.engine;if(!e._hardwareRenderer)return;this.jointTexture=new Si(e,4,this.jointNodes.length,mi.R32G32B32A32,!1),this.jointTexture.filterMode=vi.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(t._jointSamplerProperty,this.jointTexture)}this.jointTexture.setPixelBuffer(this.matrixPalette)},n._cloneTo=function(t){e.prototype._cloneTo.call(this,t),this._blendShapeWeights&&(t._blendShapeWeights=this._blendShapeWeights.slice())},n._checkBlendShapeWeightLength=function(){var e=this._mesh,t=e?e.blendShapeCount:0,n=this._blendShapeWeights;if(n){if(n.length!==t){var i=new Float32Array(t);if(t>n.length)i.set(n);else for(var r=0,a=n.length;r<a;r++)n[r]=i[r];this._blendShapeWeights=i}}else this._blendShapeWeights=new Float32Array(t)},C(t,[{key:"blendShapeWeights",get:function(){return this._checkBlendShapeWeightLength(),this._blendShapeWeights},set:function(e){this._checkBlendShapeWeightLength();var t=this._blendShapeWeights;if(e.length<=t.length)t.set(e);else for(var n=0,i=t.length;n<i;n++)t[n]=e[n]}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),t}(Ki),ji._jointCountProperty=Zt.getPropertyByName("u_jointCount"),ji._jointSamplerProperty=Zt.getPropertyByName("u_jointSampler"),ji._jointMatrixProperty=Zt.getPropertyByName("u_jointMatrix"),ji._maxJoints=0,zi=O((Oi=ji).prototype,"matrixPalette",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ni=O(Oi.prototype,"jointNodes",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vi=O(Oi.prototype,"jointTexture",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ui=O(Oi.prototype,"_hasInitJoints",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ki=O(Oi.prototype,"_mat",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Gi=O(Oi.prototype,"_useJointTexture",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hi=O(Oi.prototype,"_blendShapeWeights",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wi=O(Oi.prototype,"_condensedBlendShapeWeights",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Oi),Yi=function(){function e(){}return e.createSphere=function(t,n,i,r){void 0===n&&(n=.5),void 0===i&&(i=18),void 0===r&&(r=!0);for(var a=new Fi(t),s=(i=Math.max(2,Math.floor(i)))+1,l=s*s,u=i*i,c=e._generateIndices(t,l,6*u),h=Math.PI,_=2*h,d=1/s,f=1/i,g=new Array(l),v=new Array(l),m=new Array(l),y=0;y<l;++y){var x=y%s*f,w=(y*d|0)*f,b=x*_,C=w*h,T=Math.sin(C),S=-n*Math.cos(b)*T,A=n*Math.cos(C),P=n*Math.sin(b)*T;g[y]=new o(S,A,P),v[y]=new o(S,A,P),m[y]=new p(x,w)}for(var M=0,E=0;E<u;++E){var F=(E*f|0)*s+E%i,R=F+1,L=F+s,D=L+1;c[M++]=R,c[M++]=F,c[M++]=D,c[M++]=F,c[M++]=L,c[M++]=D}var B=a.bounds;return B.min.set(-n,-n,-n),B.max.set(n,n,n),e._initialize(a,g,v,m,c,r),a},e.createCuboid=function(t,n,i,r,a){void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=!0);var s=new Fi(t),l=n/2,u=i/2,c=r/2,h=new Array(24),_=new Array(24),d=new Array(24);h[0]=new o(-l,u,-c),h[1]=new o(l,u,-c),h[2]=new o(l,u,c),h[3]=new o(-l,u,c),_[0]=new o(0,1,0),_[1]=new o(0,1,0),_[2]=new o(0,1,0),_[3]=new o(0,1,0),d[0]=new p(0,0),d[1]=new p(1,0),d[2]=new p(1,1),d[3]=new p(0,1),h[4]=new o(-l,-u,-c),h[5]=new o(l,-u,-c),h[6]=new o(l,-u,c),h[7]=new o(-l,-u,c),_[4]=new o(0,-1,0),_[5]=new o(0,-1,0),_[6]=new o(0,-1,0),_[7]=new o(0,-1,0),d[4]=new p(0,1),d[5]=new p(1,1),d[6]=new p(1,0),d[7]=new p(0,0),h[8]=new o(-l,u,-c),h[9]=new o(-l,u,c),h[10]=new o(-l,-u,c),h[11]=new o(-l,-u,-c),_[8]=new o(-1,0,0),_[9]=new o(-1,0,0),_[10]=new o(-1,0,0),_[11]=new o(-1,0,0),d[8]=new p(0,0),d[9]=new p(1,0),d[10]=new p(1,1),d[11]=new p(0,1),h[12]=new o(l,u,-c),h[13]=new o(l,u,c),h[14]=new o(l,-u,c),h[15]=new o(l,-u,-c),_[12]=new o(1,0,0),_[13]=new o(1,0,0),_[14]=new o(1,0,0),_[15]=new o(1,0,0),d[12]=new p(1,0),d[13]=new p(0,0),d[14]=new p(0,1),d[15]=new p(1,1),h[16]=new o(-l,u,c),h[17]=new o(l,u,c),h[18]=new o(l,-u,c),h[19]=new o(-l,-u,c),_[16]=new o(0,0,1),_[17]=new o(0,0,1),_[18]=new o(0,0,1),_[19]=new o(0,0,1),d[16]=new p(0,0),d[17]=new p(1,0),d[18]=new p(1,1),d[19]=new p(0,1),h[20]=new o(-l,u,-c),h[21]=new o(l,u,-c),h[22]=new o(l,-u,-c),h[23]=new o(-l,-u,-c),_[20]=new o(0,0,-1),_[21]=new o(0,0,-1),_[22]=new o(0,0,-1),_[23]=new o(0,0,-1),d[20]=new p(1,0),d[21]=new p(0,0),d[22]=new p(0,1),d[23]=new p(1,1);var f=new Uint16Array(36);f[0]=0,f[1]=2,f[2]=1,f[3]=2,f[4]=0,f[5]=3,f[6]=4,f[7]=6,f[8]=7,f[9]=6,f[10]=4,f[11]=5,f[12]=8,f[13]=10,f[14]=9,f[15]=10,f[16]=8,f[17]=11,f[18]=12,f[19]=14,f[20]=15,f[21]=14,f[22]=12,f[23]=13,f[24]=16,f[25]=18,f[26]=17,f[27]=18,f[28]=16,f[29]=19,f[30]=20,f[31]=22,f[32]=23,f[33]=22,f[34]=20,f[35]=21;var g=s.bounds;return g.min.set(-l,-u,-c),g.max.set(l,u,c),e._initialize(s,h,_,d,f,a),s},e.createPlane=function(t,n,i,r,a,s){void 0===n&&(n=1),void 0===i&&(i=1),void 0===r&&(r=1),void 0===a&&(a=1),void 0===s&&(s=!0);for(var l=new Fi(t),u=(r=Math.max(1,Math.floor(r)))+1,c=n/2,h=i/2,_=n/r,d=i/(a=Math.max(1,Math.floor(a))),f=u*(a+1),g=a*r,v=e._generateIndices(t,f,6*g),m=1/u,y=1/r,x=1/a,w=new Array(f),b=new Array(f),C=new Array(f),T=0;T<f;++T){var S=T%u,A=T*m|0;w[T]=new o(S*_-c,0,A*d-h),b[T]=new o(0,1,0),C[T]=new p(S*y,A*x)}for(var P=0,M=0;M<g;++M){var E=(M*y|0)*u+M%r,F=E+1,R=E+u,L=R+1;v[P++]=E,v[P++]=R,v[P++]=F,v[P++]=R,v[P++]=L,v[P++]=F}var D=l.bounds;return D.min.set(-c,0,-h),D.max.set(c,0,h),e._initialize(l,w,b,C,v,s),l},e.createCylinder=function(t,n,i,r,a,s,l){void 0===n&&(n=.5),void 0===i&&(i=.5),void 0===r&&(r=2),void 0===a&&(a=20),void 0===s&&(s=1),void 0===l&&(l=!0);for(var u=new Fi(t),c=(a=Math.floor(a))+1,h=.5*r,_=r/(s=Math.floor(s)),d=c*(s+1),f=a*s,g=2*a,v=d+2+g,m=e._generateIndices(t,v,6*f+3*g),y=1/c,x=1/a,w=1/s,b=new Array(v),C=new Array(v),T=new Array(v),S=0,A=Math.PI,P=2*Math.PI,M=i-n,E=M/r,F=M/s,R=0;R<d;++R){var L=R*y|0,D=R%c*x,B=L*w,I=A+D*P,O=Math.sin(I),z=Math.cos(I),N=i-L*F,V=N*O,U=L*_-h,k=N*z;b[R]=new o(V,U,k),C[R]=new o(O,E,z),T[R]=new p(D,1-B)}for(var G=0;G<f;++G){var H=(G*x|0)*c+G%a,W=H+1,j=H+c,X=j+1;m[S++]=W,m[S++]=j,m[S++]=H,m[S++]=W,m[S++]=X,m[S++]=j}b[d]=new o(0,-h,0),C[d]=new o(0,-1,0),T[d]=new p(.5,.5),b[d+1]=new o(0,h,0),C[d+1]=new o(0,1,0),T[d+1]=new p(.5,.5);for(var K=d+2,q=1/(2*n),Y=1/(2*i),Q=c*s,J=0;J<a;++J){var Z=b[J],$=Z.x,ee=Z.z;b[K]=new o($,-h,ee),C[K]=new o(0,-1,0),T[K++]=new p($*Y+.5,.5-ee*Y);var te=b[J+Q];$=te.x,ee=te.z,b[K]=new o($,h,ee),C[K]=new o(0,1,0),T[K++]=new p($*q+.5,ee*q+.5)}for(var ne=d+1,ie=d+2,re=ie+1,ae=0;ae<a;++ae){var oe=2*ae,se=ae===a-1?0:oe+2;m[S++]=d,m[S++]=ie+se,m[S++]=ie+oe,m[S++]=ne,m[S++]=re+oe,m[S++]=re+se}var le=u.bounds,ue=Math.max(n,i);return le.min.set(-ue,-h,-ue),le.max.set(ue,h,ue),e._initialize(u,b,C,T,m,l),u},e.createTorus=function(t,n,i,r,a,s,l){void 0===n&&(n=.5),void 0===i&&(i=.1),void 0===r&&(r=30),void 0===a&&(a=30),void 0===s&&(s=360),void 0===l&&(l=!0);var u=new Fi(t),c=((r=Math.floor(r))+1)*((a=Math.floor(a))+1),h=r*a,_=e._generateIndices(t,c,6*h),d=new Array(c),f=new Array(c),g=new Array(c);s=s/180*Math.PI;for(var v=0,m=0;m<=r;m++)for(var y=0;y<=a;y++){var x=y/a*s,w=m/r*Math.PI*2,b=Math.cos(w),C=Math.sin(w),T=Math.cos(x),S=Math.sin(x),A=new o((n+i*b)*T,(n+i*b)*S,i*C);d[v]=A;var P=n*T,M=n*S;f[v]=new o(A.x-P,A.y-M,A.z).normalize(),g[v++]=new p(y/a,m/r)}v=0;for(var E=1;E<=r;E++)for(var F=1;F<=a;F++){var R=(a+1)*E+F-1,L=(a+1)*(E-1)+F-1,D=(a+1)*(E-1)+F,B=(a+1)*E+F;_[v++]=R,_[v++]=L,_[v++]=B,_[v++]=L,_[v++]=D,_[v++]=B}var I=u.bounds,O=n+i;return I.min.set(-O,-O,-i),I.max.set(O,O,i),e._initialize(u,d,f,g,_,l),u},e.createCone=function(t,n,i,r,a,s){void 0===n&&(n=.5),void 0===i&&(i=2),void 0===r&&(r=20),void 0===a&&(a=1),void 0===s&&(s=!0);for(var l=new Fi(t),u=(r=Math.floor(r))+1,c=.5*i,h=i/(a=Math.floor(a)),_=u*(a+1),d=r*a,f=_+1+r,g=e._generateIndices(t,f,6*d+3*r),v=1/u,m=1/r,y=1/a,x=new Array(f),w=new Array(f),b=new Array(f),C=0,T=Math.PI,S=2*Math.PI,A=n/i,P=0;P<_;++P){var M=P*v|0,E=P%u*m,F=M*y,R=T+E*S,L=Math.sin(R),D=Math.cos(R),B=n-M*n,I=B*L,O=M*h-c,z=B*D;x[P]=new o(I,O,z),w[P]=new o(L,A,D),b[P]=new p(E,1-F)}for(var N=0;N<d;++N){var V=(N*m|0)*u+N%r,U=V+1,k=V+u,G=k+1;g[C++]=U,g[C++]=k,g[C++]=V,g[C++]=U,g[C++]=G,g[C++]=k}x[_]=new o(0,-c,0),w[_]=new o(0,-1,0),b[_]=new p(.5,.5);for(var H=_+1,W=1/(2*n),j=0;j<r;++j){var X=x[j],K=X.x,q=X.z;x[H]=new o(K,-c,q),w[H]=new o(0,-1,0),b[H++]=new p(K*W+.5,.5-q*W)}for(var Y=_+1,Q=0;Q<r;++Q){var J=Q,Z=Q===r-1?0:J+1;g[C++]=_,g[C++]=Y+Z,g[C++]=Y+J}var $=l.bounds;return $.min.set(-n,-c,-n),$.max.set(n,c,n),e._initialize(l,x,w,b,g,s),l},e.createCapsule=function(t,n,i,r,a,s){void 0===n&&(n=.5),void 0===i&&(i=2),void 0===r&&(r=6),void 0===a&&(a=1),void 0===s&&(s=!0);for(var l=new Fi(t),u=(r=Math.max(2,Math.floor(r)))+1,c=.5*i,h=i/(a=Math.floor(a)),_=u*(a+1),d=r*a,f=u*u,g=r*r,v=_+2*f,m=e._generateIndices(t,v,6*(d+2*g)),y=1/u,x=1/r,w=1/a,b=Math.PI,C=2*Math.PI,T=new Array(v),S=new Array(v),A=new Array(v),P=0,M=0;M<_;++M){var E=M*y|0,F=M%u*x,R=E*w,L=b+F*C,D=Math.sin(L),B=Math.cos(L);T[M]=new o(n*D,E*h-c,n*B),S[M]=new o(D,0,B),A[M]=new p(F,1-R)}for(var I=0;I<d;++I){var O=(I*x|0)*u+I%r,z=O+1,N=O+u,V=N+1;m[P++]=z,m[P++]=N,m[P++]=O,m[P++]=z,m[P++]=V,m[P++]=N}e._createCapsuleCap(n,i,r,C,_,1,T,S,A,m,P),e._createCapsuleCap(n,i,r,-C,_+f,-1,T,S,A,m,P+6*g);var U=l.bounds;return U.min.set(-n,-n-c,-n),U.max.set(n,n+c,n),e._initialize(l,T,S,A,m,s),l},e._initialize=function(e,t,n,i,r,a){e.setPositions(t),e.setNormals(n),e.setUVs(i),e.setIndices(r),e.uploadData(a),e.addSubMesh(0,r.length)},e._generateIndices=function(e,t,n){var i=null;if(t>65535){if(!e._hardwareRenderer.canIUse(le.elementIndexUint))throw Error("The vertex count is over limit.");i=new Uint32Array(n)}else i=new Uint16Array(n);return i},e._createCapsuleCap=function(e,t,n,i,r,a,s,l,u,c,h){for(var _=n+1,d=.5*t*a,f=_*_,g=n*n,v=1/_,m=1/n,y=0;y<f;++y){var x=y%_*m,w=(y*v|0)*m,b=x*i,C=w*Math.PI/2,T=Math.sin(C),S=-e*Math.cos(b)*T,A=e*Math.cos(C)*a+d,P=e*Math.sin(b)*T,M=y+r;s[M]=new o(S,A,P),l[M]=new o(S,A-d,P),u[M]=new p(x,w)}for(var E=0;E<g;++E){var F=(E*m|0)*_+E%n+r,R=F+1,L=F+_,D=L+1;c[h++]=R,c[h++]=F,c[h++]=D,c[h++]=F,c[h++]=L,c[h++]=D}},e}(),Qi=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n.setVertexElements=function(e){this._setVertexElements(e)},n.setVertexBufferBinding=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=0);var i=e,r=void 0!==i.buffer;r||(i=new Ci(e,t));var a=this._vertexBufferBindings;a.length<=n&&(a.length=n+1),this._setVertexBufferBinding(r?t:n,i)},n.setVertexBufferBindings=function(e,t){void 0===t&&(t=0);var n=this._vertexBufferBindings,i=e.length,r=t+i;n.length<r&&(n.length=r);for(var a=0;a<i;a++)this._setVertexBufferBinding(t+a,e[a])},n.setIndexBufferBinding=function(e,t){var n=e;n&&(void 0!==n.buffer||(n=new xi(e,t)));this._setIndexBufferBinding(n)},C(t,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),t}(bi),Ji=function(e,t,n,i){if(void 0===n&&(n=null),void 0===i&&(i=null),this.weight=void 0,this.deltaPositions=void 0,this.deltaNormals=void 0,this.deltaTangents=void 0,n&&n.length!==t.length)throw"deltaNormals length must same with deltaPositions length.";if(i&&i.length!==t.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=e,this.deltaPositions=t,this.deltaNormals=n,this.deltaTangents=i},Zi=function(){function e(e){this.name=void 0,this._useBlendShapeNormal=!0,this._useBlendShapeTangent=!0,this._layoutChangeManager=new Je,this._dataChangeManager=new Je,this._frames=[],this.name=e}var t=e.prototype;return t.addFrame=function(e,t,n,i){if("number"==typeof e){var r=new Ji(e,t,n,i);return this._addFrame(r),r}this._addFrame(e)},t.clearFrames=function(){this._frames.length=0,this._updateUseNormalAndTangent(!0,!0),this._dataChangeManager.dispatch()},t._addLayoutChangeFlag=function(e){this._layoutChangeManager.addFlag(e)},t._addDataDirtyFlag=function(e){this._dataChangeManager.addFlag(e)},t._createSubDataDirtyFlag=function(){return this._dataChangeManager.createFlag(qe)},t._addFrame=function(e){var t=this._frames,n=t.length;if(n>0&&e.deltaPositions.length!==t[n-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._frames.push(e),this._updateUseNormalAndTangent(!!e.deltaNormals,!!e.deltaTangents),this._dataChangeManager.dispatch()},t._updateUseNormalAndTangent=function(e,t){var n=this._useBlendShapeNormal&&e,i=this._useBlendShapeTangent&&t;this._useBlendShapeNormal===n&&this._useBlendShapeTangent===i||(this._useBlendShapeNormal=n,this._useBlendShapeTangent=i,this._layoutChangeManager.dispatch(this))},C(e,[{key:"frames",get:function(){return this._frames}}]),e}(),$i=function(){function e(t){this._engine=void 0,this._subMeshPool=new Bn(wi),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._flushId=0,this._vertexCount=0,this._elementCount=0,this._engine=t;var n=e.MAX_VERTEX_COUNT;this._vertices=new Float32Array(9*n),this._indices=new Uint16Array(3*n);for(var i=this._meshes,r=this._meshCount,a=0;a<r;a++)i[a]=this._createMesh(t,a)}var t=e.prototype;return t.drawElement=function(e,t,n){if(e.multiRenderData)for(var i=e.charElements,r=0,a=i.length;r<a;++r)this._drawSubElement(i[r],t,n);else this._drawSubElement(e,t,n)},t._drawSubElement=function(t,n,i){var r=t.renderData.vertexCount;this._vertexCount+r>e.MAX_VERTEX_COUNT&&this.flush(n,i),this._vertexCount+=r,this._batchedQueue[this._elementCount++]=t},t.flush=function(t,n){var i=this._batchedQueue;0!==i.length&&(this._updateData(this._engine),this.drawBatches(t,n),e._canUploadSameBuffer||this._flushId++,i.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},t.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},t.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,t=this._vertexBuffers,n=this._indiceBuffers,i=0,r=e.length;i<r;++i)e[i].destroy();this._meshes=null;for(var a=0,o=t.length;a<o;++a)t[a].destroy();this._vertexBuffers=null;for(var s=0,l=n.length;s<l;++s)n[s].destroy();this._indiceBuffers=null},t._createMesh=function(t,n){var i=e.MAX_VERTEX_COUNT,r=new Qi(t,"BufferMesh"+n),a=[],o=this.createVertexElements(a);return this._vertexBuffers[n]=new fi(t,ui.VertexBuffer,4*i*o,oi.Dynamic),this._indiceBuffers[n]=new fi(t,ui.IndexBuffer,3*i,oi.Dynamic),r.setVertexBufferBinding(this._vertexBuffers[n],o),r.setIndexBufferBinding(this._indiceBuffers[n],si.UInt16),r.setVertexElements(a),r},t._updateData=function(t){var n=this._meshes,i=this._flushId;!e._canUploadSameBuffer&&this._meshCount<=i&&(this._meshCount++,n[i]=this._createMesh(t,i));var r=this._batchedQueue,a=this._vertices,o=this._indices,s=n[i];s.clearSubMesh();for(var l=0,u=0,c=0,h=0,_=0,d=0,f=null,p=0,g=r.length;p<g;p++){var v=r[p];l=this.updateVertices(v,a,l);for(var m=v.renderData.triangles,y=m.length,x=0;x<y;x++)o[u++]=m[x]+_;_+=v.renderData.vertexCount,null===f||this.canBatch(f,v)?h+=y:(s.addSubMesh(this._getSubMeshFromPool(c,h)),c+=h,h=y,r[d++]=f),f=v}s.addSubMesh(this._getSubMeshFromPool(c,h)),r[d]=f,this._vertexBuffers[i].setData(a,0,0,l),this._indiceBuffers[i].setData(o,0,0,u)},t._getSubMeshFromPool=function(e,t){var n=this._subMeshPool.getFromPool();return n.start=e,n.count=t,n.topology=di.Triangles,n},e}();$i.MAX_VERTEX_COUNT=4096,$i._canUploadSameBuffer=!0;var er,tr,nr=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n.createVertexElements=function(e){return e[0]=new _i("POSITION",0,ai.Vector3,0),e[1]=new _i("TEXCOORD_0",12,ai.Vector2,0),20},n.canBatch=function(e,t){if(e.isAdd!==t.isAdd)return!1;var n=e.component.shaderData,i=t.component.shaderData,r=li._textureProperty,a=li._alphaCutoffProperty;return n.getTexture(r)===i.getTexture(r)&&n.getTexture(a)===i.getTexture(a)},n.updateVertices=function(e,t,n){for(var i=e.renderData,r=i.positions,a=i.uvs,o=i.vertexCount,s=0;s<o;s++){var l=r[s],u=a[s];t[n++]=l.x,t[n++]=l.y,t[n++]=l.z,t[n++]=u.x,t[n++]=u.y}return n},n.drawBatches=function(e){for(var t=this._engine,n=this._batchedQueue,i=this._meshes[this._flushId],r=i.subMeshes,a=e.scene.shaderData,o=e.shaderData,s=0,l=r.length;s<l;s++){var u=r[s],c=n[s];if(!u||!c)return;var h=c.component,_=c.material,d=Zt._compileMacros;ye.unionCollection(h._globalShaderMacro,_.shaderData._macroCollection,d);var f=_.renderState.stencilState,p=c.isAdd?un.IncrementSaturate:un.DecrementSaturate;f.passOperationFront=p,f.passOperationBack=p;var g=_.shader._getShaderProgram(t,d);if(!g.isValid)return;g.bind(),g.groupingOtherUniformBlock(),g.uploadAll(g.sceneUniformBlock,a),g.uploadAll(g.cameraUniformBlock,o),g.uploadAll(g.rendererUniformBlock,h.shaderData),g.uploadAll(g.materialUniformBlock,_.shaderData),_.renderState._apply(t,!1),t._hardwareRenderer.drawPrimitive(i,u,g)}},t}($i),ir=function(){function e(e){this._batcher=void 0,this._preMaskLayer=0,this._batcher=new nr(e)}var t=e.prototype;return t.clear=function(){this._preMaskLayer=0,this._batcher.clear()},t.preRender=function(e,t){t.maskInteraction!==hn.None&&(this._batcher.clear(),this._processMasksDiff(e,t),this._batcher.flush(e,null))},t.postRender=function(e){e.maskInteraction!==hn.None&&(this._preMaskLayer=e.maskLayer)},t.destroy=function(){this._batcher.destroy(),this._batcher=null},t._processMasksDiff=function(e,t){var n=this._preMaskLayer,i=t.maskLayer;if(n!==i)for(var r=e._renderPipeline._allSpriteMasks,a=n&i,o=i&~n,s=n&~i,l=r._elements,u=0,c=r.length;u<c;u++){var h=l[u],_=h.influenceLayers;if(!(_&a))if(_&o){var d=h._maskElement;d.isAdd=!0,this._batcher.drawElement(d,e,null)}else if(_&s){var f=h._maskElement;f.isAdd=!1,this._batcher.drawElement(f,e,null)}}},e}(),rr=function(e){function t(){var t;return(t=e.call(this)||this).charElements=[],t.multiRenderData=!0,t}return A(t,e),t}(In);!function(e){e[e.SolidColor=0]="SolidColor",e[e.Sky=1]="Sky",e[e.Texture=2]="Texture"}(er||(er={})),function(e){e[e.AspectFitWidth=0]="AspectFitWidth",e[e.AspectFitHeight=1]="AspectFitHeight",e[e.Fill=2]="Fill"}(tr||(tr={}));var ar,or=function(){this.material=void 0,this.mesh=void 0,this._matrix=new d},sr=function(){function e(e){this._engine=e,this.mode=er.SolidColor,this.solidColor=new v(.25,.25,.25,1),this.sky=new or,this._textureFillMode=tr.AspectFitHeight,this._mesh=void 0,this._texture=null,this._mesh=this._createPlane(e)}var t=e.prototype;return t._resizeBackgroundTexture=function(){if(this._texture){var e=this._engine.canvas,t=e.width,n=e.height,i=this._mesh,r=i.getPositions();switch(this._textureFillMode){case tr.Fill:r[0].set(-1,-1,1),r[1].set(1,-1,1),r[2].set(-1,1,1),r[3].set(1,1,1);break;case tr.AspectFitWidth:var a=this._texture.height*t/this.texture.width/n;r[0].set(-1,-a,1),r[1].set(1,-a,1),r[2].set(-1,a,1),r[3].set(1,a,1);break;case tr.AspectFitHeight:var o=this._texture.width*n/this.texture.height/t;r[0].set(-o,-1,1),r[1].set(o,-1,1),r[2].set(-o,1,1),r[3].set(o,1,1)}i.setPositions(r),i.uploadData(!1)}},t._createPlane=function(e){var t=new Fi(e);t.isGCIgnored=!0;for(var n=new Uint8Array([1,2,0,1,3,2]),i=new Array(4),r=new Array(4),a=0;a<4;++a)i[a]=new o,r[a]=new p(a%2,1-(.5*a|0));return t.setPositions(i),t.setUVs(r),t.setIndices(n),t.uploadData(!1),t.addSubMesh(0,n.length),t},C(e,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._engine._backgroundTextureMaterial.shaderData.setTexture("u_baseTexture",e))}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(e){e!==this._textureFillMode&&(this._textureFillMode=e,this._resizeBackgroundTexture())}}]),e}();!function(e){e[e.SolidColor=0]="SolidColor",e[e.SphericalHarmonics=1]="SphericalHarmonics"}(ar||(ar={}));var lr=function(){function e(){this._diffuseSphericalHarmonics=void 0,this._diffuseSolidColor=new v(.212,.227,.259),this._diffuseIntensity=1,this._specularTexture=void 0,this._specularIntensity=1,this._diffuseMode=ar.SolidColor,this._shArray=new Float32Array(27),this._scenes=[],this._specularTextureDecodeRGBM=!1}var t=e.prototype;return t._addToScene=function(t){this._scenes.push(t);var n=t.shaderData;n.setColor(e._diffuseColorProperty,this._diffuseSolidColor),n.setFloat(e._diffuseIntensityProperty,this._diffuseIntensity),n.setFloat(e._specularIntensityProperty,this._specularIntensity),n.setFloatArray(e._diffuseSHProperty,this._shArray),this._setDiffuseMode(n),this._setSpecularTextureDecodeRGBM(n),this._setSpecularTexture(n)},t._removeFromScene=function(e){var t=this._scenes,n=t.indexOf(e);t.splice(n,1)},t._setDiffuseMode=function(t){this._diffuseMode===ar.SphericalHarmonics?t.enableMacro(e._shMacro):t.disableMacro(e._shMacro)},t._setSpecularTexture=function(t){this._specularTexture?(t.setTexture(e._specularTextureProperty,this._specularTexture),t.setFloat(e._mipLevelProperty,this._specularTexture.mipmapCount-1),t.enableMacro(e._specularMacro)):t.disableMacro(e._specularMacro)},t._setSpecularTextureDecodeRGBM=function(t){this._specularTextureDecodeRGBM?t.enableMacro(e._decodeRGBMMacro):t.disableMacro(e._decodeRGBMMacro)},t._preComputeSH=function(e,t){var n=e.coefficients;t[0]=.886227*n[0],t[1]=.886227*n[1],t[2]=.886227*n[2],t[3]=-1.023327*n[3],t[4]=-1.023327*n[4],t[5]=-1.023327*n[5],t[6]=1.023327*n[6],t[7]=1.023327*n[7],t[8]=1.023327*n[8],t[9]=-1.023327*n[9],t[10]=-1.023327*n[10],t[11]=-1.023327*n[11],t[12]=.858086*n[12],t[13]=.858086*n[13],t[14]=.858086*n[14],t[15]=-.858086*n[15],t[16]=-.858086*n[16],t[17]=-.858086*n[17],t[18]=.247708*n[18],t[19]=.247708*n[19],t[20]=.247708*n[20],t[21]=-.858086*n[21],t[22]=-.858086*n[22],t[23]=-.858086*n[23],t[24]=.429042*n[24],t[25]=.429042*n[25],t[26]=.429042*n[26]},C(e,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(e){this._specularTextureDecodeRGBM=e;for(var t=this._scenes,n=0,i=t.length;n<i;n++)this._setSpecularTextureDecodeRGBM(t[n].shaderData)}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(e){this._diffuseMode=e;for(var t=this._scenes,n=0,i=t.length;n<i;n++)this._setDiffuseMode(t[n].shaderData)}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(e){e!==this._diffuseSolidColor&&this._diffuseSolidColor.copyFrom(e)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(t){if(this._diffuseSphericalHarmonics=t,t){this._preComputeSH(t,this._shArray);for(var n=this._scenes,i=0,r=n.length;i<r;i++)n[i].shaderData.setFloatArray(e._diffuseSHProperty,this._shArray)}}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(t){this._diffuseIntensity=t;for(var n=this._scenes,i=0,r=n.length;i<r;i++)n[i].shaderData.setFloat(e._diffuseIntensityProperty,t)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(e){this._specularTexture=e;for(var t=this._scenes,n=0,i=t.length;n<i;n++)this._setSpecularTexture(t[n].shaderData)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(t){this._specularIntensity=t;for(var n=0,i=this._scenes.length;n<i;n++)this._scenes[n].shaderData.setFloat(e._specularIntensityProperty,t)}}]),e}();lr._shMacro=Zt.getMacroByName("O3_USE_SH"),lr._specularMacro=Zt.getMacroByName("O3_USE_SPECULAR_ENV"),lr._decodeRGBMMacro=Zt.getMacroByName("O3_DECODE_ENV_RGBM"),lr._diffuseColorProperty=Zt.getPropertyByName("u_envMapLight.diffuse"),lr._diffuseSHProperty=Zt.getPropertyByName("u_env_sh"),lr._diffuseIntensityProperty=Zt.getPropertyByName("u_envMapLight.diffuseIntensity"),lr._specularTextureProperty=Zt.getPropertyByName("u_env_specularSampler"),lr._specularIntensityProperty=Zt.getPropertyByName("u_envMapLight.specularIntensity"),lr._mipLevelProperty=Zt.getPropertyByName("u_envMapLight.mipMapLevel");var ur=function(){function e(){}var t=e.prototype;return t.preUpdate=function(e){},t.postUpdate=function(e){},t.preRender=function(e,t){},t.postRender=function(e,t){},t.destroy=function(e){},e}(),cr=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._viewMat=void 0,t._inverseViewMat=void 0,t}A(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.findFeature(fr).attachRenderLight(this)},n._onDisable=function(){this.scene.findFeature(fr).detachRenderLight(this)},C(t,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new d),d.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new d),d.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),t}(Ye);cr._maxLight=10;var hr=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).color=new v(1,1,1,1),t.intensity=1,t._forward=new o,t._lightColor=new v(1,1,1,1),t._reverseDirection=new o,t}return A(t,e),t._updateShaderData=function(e){var n=t._combinedData;e.setFloatArray(t._colorProperty,n.color),e.setFloatArray(t._directionProperty,n.direction)},t.prototype._appendData=function(e){var n=3*e,i=3*e,r=this.lightColor,a=this.direction,o=t._combinedData;o.color[n]=r.r,o.color[n+1]=r.g,o.color[n+2]=r.b,o.direction[i]=a.x,o.direction[i+1]=a.y,o.direction[i+2]=a.z},C(t,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return o.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),t}(cr);hr._colorProperty=Zt.getPropertyByName("u_directLightColor"),hr._directionProperty=Zt.getPropertyByName("u_directLightDirection"),hr._combinedData={color:new Float32Array(3*cr._maxLight),direction:new Float32Array(3*cr._maxLight)};var _r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).color=new v(1,1,1,1),t.intensity=1,t.distance=100,t._lightColor=new v(1,1,1,1),t}return A(t,e),t._updateShaderData=function(e){var n=t._combinedData;e.setFloatArray(t._colorProperty,n.color),e.setFloatArray(t._positionProperty,n.position),e.setFloatArray(t._distanceProperty,n.distance)},t.prototype._appendData=function(e){var n=3*e,i=3*e,r=e,a=this.lightColor,o=this.position,s=t._combinedData;s.color[n]=a.r,s.color[n+1]=a.g,s.color[n+2]=a.b,s.position[i]=o.x,s.position[i+1]=o.y,s.position[i+2]=o.z,s.distance[r]=this.distance},C(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(cr);_r._colorProperty=Zt.getPropertyByName("u_pointLightColor"),_r._positionProperty=Zt.getPropertyByName("u_pointLightPosition"),_r._distanceProperty=Zt.getPropertyByName("u_pointLightDistance"),_r._combinedData={color:new Float32Array(3*cr._maxLight),position:new Float32Array(3*cr._maxLight),distance:new Float32Array(cr._maxLight)};var dr=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).color=new v(1,1,1,1),t.intensity=1,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._forward=new o,t._lightColor=new v(1,1,1,1),t._inverseDirection=new o,t}return A(t,e),t._updateShaderData=function(e){var n=t._combinedData;e.setFloatArray(t._colorProperty,n.color),e.setFloatArray(t._positionProperty,n.position),e.setFloatArray(t._directionProperty,n.direction),e.setFloatArray(t._distanceProperty,n.distance),e.setFloatArray(t._angleCosProperty,n.angleCos),e.setFloatArray(t._penumbraCosProperty,n.penumbraCos)},t.prototype._appendData=function(e){var n=3*e,i=3*e,r=3*e,a=e,o=e,s=e,l=this.lightColor,u=this.position,c=this.direction,h=t._combinedData;h.color[n]=l.r,h.color[n+1]=l.g,h.color[n+2]=l.b,h.position[i]=u.x,h.position[i+1]=u.y,h.position[i+2]=u.z,h.direction[r]=c.x,h.direction[r+1]=c.y,h.direction[r+2]=c.z,h.distance[a]=this.distance,h.angleCos[s]=Math.cos(this.angle),h.penumbraCos[o]=Math.cos(this.angle+this.penumbra)},C(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return o.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(cr);dr._colorProperty=Zt.getPropertyByName("u_spotLightColor"),dr._positionProperty=Zt.getPropertyByName("u_spotLightPosition"),dr._directionProperty=Zt.getPropertyByName("u_spotLightDirection"),dr._distanceProperty=Zt.getPropertyByName("u_spotLightDistance"),dr._angleCosProperty=Zt.getPropertyByName("u_spotLightAngleCos"),dr._penumbraCosProperty=Zt.getPropertyByName("u_spotLightPenumbraCos"),dr._combinedData={color:new Float32Array(3*cr._maxLight),position:new Float32Array(3*cr._maxLight),direction:new Float32Array(3*cr._maxLight),distance:new Float32Array(cr._maxLight),angleCos:new Float32Array(cr._maxLight),penumbraCos:new Float32Array(cr._maxLight)};var fr=function(e){function t(){var t;return(t=e.call(this)||this).visibleLights=void 0,t.visibleLights=[],t}A(t,e);var n=t.prototype;return n.attachRenderLight=function(e){-1==this.visibleLights.indexOf(e)?this.visibleLights.push(e):pe.warn("Light already attached.")},n.detachRenderLight=function(e){var t=this.visibleLights.indexOf(e);-1!=t&&this.visibleLights.splice(t,1)},n._updateShaderData=function(e){for(var t=0,n=0,i=0,r=this.visibleLights,a=0,o=r.length;a<o;a++){var s=r[a];s instanceof hr?s._appendData(t++):s instanceof _r?s._appendData(n++):s instanceof dr&&s._appendData(i++)}t?(hr._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",t.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),n?(_r._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",n.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),i?(dr._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",i.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},t}(ur),pr=function(e){function t(n,i){var r;(r=e.call(this,n)||this).name=void 0,r.background=new sr(r._engine),r.shaderData=new nn(Ut.Scene),r._activeCameras=[],r._isActiveInEngine=!1,r._globalShaderMacro=new ye,r._rootEntities=[],r._ambientLight=void 0,r.features=[],r.name=i||"";var a=r.shaderData;return t.sceneFeatureManager.addObject(L(r)),a._addRefCount(1),r.ambientLight=new lr,n.sceneManager._allScenes.push(L(r)),r}A(t,e);var n=t.prototype;return n.createRootEntity=function(e){var t=new et(this._engine,e);return this.addRootEntity(t),t},n.addRootEntity=function(e,t){var n;"number"==typeof e?n=e:(n=void 0,t=e);var i=t._isRoot;i||(t._isRoot=!0,t._removeFromParent());var r=t._scene;r!==this?(r&&i&&r._removeFromEntityList(t),this._addToRootEntityList(n,t),et._traverseSetOwnerScene(t,this)):i||this._addToRootEntityList(n,t),this._isActiveInEngine?!t._isActiveInHierarchy&&t._isActive&&t._processActive():t._isActiveInHierarchy&&t._processInActive()},n.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeFromEntityList(e),e._isRoot=!1,this._isActiveInEngine&&e._isActiveInHierarchy&&e._processInActive(),et._traverseSetOwnerScene(e,null))},n.getRootEntity=function(e){return void 0===e&&(e=0),this._rootEntities[e]},n.findEntityByName=function(e){for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];if(i.name===e)return i}for(var r=t.length-1;r>=0;r--){var a=t[r].findByName(e);if(a)return a}return null},n.findEntityByPath=function(e){for(var t=e.split("/").filter(Boolean),n=0,i=this.rootEntitiesCount;n<i;n++){var r=this.getRootEntity(n);if(r.name==t[0]){for(var a=1,o=t.length;a<o&&(r=et._findChildByName(r,t[a]));++a);return r}}return null},n.destroy=function(){if(!this._destroyed){this._destroy();var e=this.engine.sceneManager._allScenes;e.splice(e.indexOf(this),1)}},n._attachRenderCamera=function(e){-1===this._activeCameras.indexOf(e)?this._activeCameras.push(e):pe.warn("Camera already attached.")},n._detachRenderCamera=function(e){var t=this._activeCameras.indexOf(e);-1!==t&&this._activeCameras.splice(t,1)},n._processActive=function(e){this._isActiveInEngine=e;for(var t=this._rootEntities,n=t.length-1;n>=0;n--){var i=t[n];i._isActive&&(e?i._processActive():i._processInActive())}},n._updateShaderData=function(){this.findFeature(fr)._updateShaderData(this.shaderData),ye.unionCollection(this.engine._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro)},n._removeFromEntityList=function(e){var t=this._rootEntities,n=e._siblingIndex;t.splice(n,1);for(var i=t.length;n<i;n++)t[n]._siblingIndex--;e._siblingIndex=-1},n._destroy=function(){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),t.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,n=this.rootEntitiesCount;e<n;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,t.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1)},n._addToRootEntityList=function(e,t){var n=this._rootEntities,i=n.length;if(void 0===e)t._siblingIndex=i,n.push(t);else{if(e<0||e>i)throw"The index "+e+" is out of child list bounds "+i;t._siblingIndex=e,n.splice(e,0,t);for(var r=e+1,a=i+1;r<a;r++)n[r]._siblingIndex++}},t.registerFeature=function(e){t.sceneFeatureManager.registerFeature(e)},n.findFeature=function(e){return t.sceneFeatureManager.findFeature(this,e)},C(t,[{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(e){var t=this._ambientLight;t!==e&&(t&&t._removeFromScene(this),e._addToScene(this),this._ambientLight=e)}else pe.warn("The scene must have one ambient light")}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}}]),t}(ve);pr.sceneFeatureManager=new tt;var gr=function(){function e(e){this.engine=e,this._allScenes=[],this._activeScene=void 0}var t=e.prototype;return t.loadScene=function(e,t){var n=this;void 0===t&&(t=!0);var i=this.engine.resourceManager.load(e);return i.then((function(e){var i=n._activeScene;n.activeScene=e,i&&t&&i.destroy()})),i},t.mergeScenes=function(e,t){for(var n=e.rootEntities,i=0,r=n.length;i<r;i++)t.addRootEntity(n[i])},t._destroyAllScene=function(){for(var e=this._allScenes,t=0,n=e.length;t<n;t++)e[t]._destroy();e.length=0},C(e,[{key:"activeScene",get:function(){return this._activeScene},set:function(e){var t=this._activeScene;t!==e&&(t&&t._processActive(!1),e&&e._processActive(!0),this._activeScene=e)}}]),e}(),vr="#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <blendShape_input>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <color_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}",mr="#define GLSLIFY 1\n#include <common_vert>\n#include <blendShape_input>\n#include <normal_share>\n#include <shadow_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <shadow_vert>\n#include <position_vert>\n}",yr=function(){function e(){}return e.init=function(){Zt.create("blinn-phong","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <blendShape_input>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <color_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <light_frag_define>\n#include <mobile_material_frag>\n#include <fog_share>\n#include <normal_get>\nvoid main(){\n#include <begin_mobile_frag>\n#include <begin_viewdir_frag>\n#include <mobile_blinnphong_frag>\ngl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;\n#ifndef OASIS_COLORSPACE_GAMMA\ngl_FragColor=linearToGamma(gl_FragColor);\n#endif\n#include <fog_frag>\n}"),Zt.create("pbr",vr,"#define GLSLIFY 1\n#define IS_METALLIC_WORKFLOW\n#include <common>\n#include <common_frag>\n#include <fog_share>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <light_frag_define>\n#include <pbr_frag_define>\n#include <pbr_helper>\nvoid main(){\n#include <pbr_frag>\n#include <fog_frag>\n}"),Zt.create("pbr-specular",vr,"#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <fog_share>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <light_frag_define>\n#include <pbr_frag_define>\n#include <pbr_helper>\nvoid main(){\n#include <pbr_frag>\n#include <fog_frag>\n}"),Zt.create("unlit","#define GLSLIFY 1\n#include <common_vert>\n#include <blendShape_input>\n#include <uv_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <uv_share>\n#include <fog_share>\nuniform vec4 u_baseColor;uniform float u_alphaCutoff;\n#ifdef BASETEXTURE\nuniform sampler2D u_baseTexture;\n#endif\nvoid main(){vec4 baseColor=u_baseColor;\n#ifdef BASETEXTURE\nvec4 textureColor=texture2D(u_baseTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\ntextureColor=gammaToLinear(textureColor);\n#endif\nbaseColor*=textureColor;\n#endif\n#ifdef ALPHA_CUTOFF\nif(baseColor.a<u_alphaCutoff){discard;}\n#endif\n#ifndef OASIS_COLORSPACE_GAMMA\nbaseColor=linearToGamma(baseColor);\n#endif\ngl_FragColor=baseColor;\n#include <fog_frag>\n}"),Zt.create("shadow-map",mr,"#define GLSLIFY 1\nvec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}"),Zt.create("shadow",mr,"#define GLSLIFY 1\n#ifdef O3_SHADOW_MAP_COUNT\nuniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}\n#endif\nvoid main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);\n#ifdef O3_SHADOW_MAP_COUNT\nfloat visibility=1.0;\n#if (O3_SHADOW_MAP_COUNT == 1)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);\n#elif (O3_SHADOW_MAP_COUNT == 2)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);\n#elif (O3_SHADOW_MAP_COUNT == 3)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);\n#endif\nvisibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);\n#endif\ngl_FragColor=shadowColor;}"),Zt.create("skybox","#define GLSLIFY 1\n#include <common_vert>\nuniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=vec3(-POSITION.x,POSITION.yz);gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}","#define GLSLIFY 1\n#include <common>\nuniform samplerCube u_cube;varying vec3 v_cubeUV;uniform vec4 u_cubeDecodeParam;void main(){vec4 textureColor=textureCube(u_cube,v_cubeUV);if(u_cubeDecodeParam.x>0.0){textureColor=RGBMToLinear(textureColor,u_cubeDecodeParam.y);textureColor=linearToGamma(textureColor);}gl_FragColor=textureColor;}"),Zt.create("particle-shader","#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;\n#ifdef is2d\nuniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;\n#endif\nmat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y;float startTime=a_lifeAndSize.x;float deltaTime=max(mod(u_time-startTime,life),0.0);if((u_once&&u_time>life+startTime)){deltaTime=0.0;}v_lifeLeft=1.0-deltaTime/life;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;\n#ifdef isScaleByLifetime\nscale*=v_lifeLeft;\n#else\nscale*=pow(a_lifeAndSize.w,deltaTime);\n#endif\n#ifdef rotateToVelocity\nvec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;\n#else\nfloat deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;\n#endif\n#ifdef is2d\nvec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);\n#else\n#ifdef rotateToVelocity\nfloat s=sin(angle);float c=cos(angle);\n#else\nfloat s=sin(angle);float c=cos(angle);\n#endif\nvec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;\n#endif\n}","#define GLSLIFY 1\nvarying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){if(v_lifeLeft==1.0){discard;}float alphaFactor=1.0;\n#ifdef fadeIn\nfloat fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);\n#endif\n#ifdef fadeOut\nfloat fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;\n#endif\n#ifdef particleTexture\nvec4 tex=texture2D(u_texture,v_uv);\n#ifdef useOriginColor\ngl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);\n#else\ngl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);\n#endif\n#else\ngl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);\n#endif\n}"),Zt.create("SpriteMask","#define GLSLIFY 1\nuniform mat4 u_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=u_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nuniform sampler2D u_maskTexture;uniform float u_maskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(u_maskTexture,v_uv);if(color.a<u_maskAlphaCutoff){discard;}gl_FragColor=color;}"),Zt.create("Sprite","#define GLSLIFY 1\n#ifdef USE_MODEL_MATRIX\nuniform mat4 u_MVPMat;\n#else\nuniform mat4 u_VPMat;\n#endif\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){\n#ifdef USE_MODEL_MATRIX\ngl_Position=u_MVPMat*vec4(POSITION,1.0);\n#else\ngl_Position=u_VPMat*vec4(POSITION,1.0);\n#endif\nv_uv=TEXCOORD_0;v_color=COLOR_0;}","#define GLSLIFY 1\n#ifdef USE_CUSTOM_TEXTURE\nuniform sampler2D u_cusTomTexture;\n#else\nuniform sampler2D u_spriteTexture;\n#endif\nvarying vec2 v_uv;varying vec4 v_color;void main(){\n#ifdef USE_CUSTOM_TEXTURE\nvec4 baseColor=texture2D(u_cusTomTexture,v_uv);\n#else\nvec4 baseColor=texture2D(u_spriteTexture,v_uv);\n#endif\ngl_FragColor=baseColor*v_color;}"),Zt.create("background-texture","#define GLSLIFY 1\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nuniform sampler2D u_baseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(u_baseTexture,v_uv);}")},e}(),xr=function(){function e(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var t=e.prototype;return t.get=function(e){var t=this._cacheMap,n=e._length;n>this._cacheHierarchy&&this._resizeCacheMapHierarchy(t,0,n);for(var i=e._mask,r=e._length-1,a=this._cacheHierarchy-1,o=0;o<a;o++){var s=r<o?0:i[o],l=t[s];l||(t[s]=l=Object.create(null)),t=l}var u=r<a?0:i[a],c=t[u];return c||(this._lastQueryKey=u,this._lastQueryMap=t),c},t.cache=function(e){this._lastQueryMap[this._lastQueryKey]=e},t._resizeCacheMapHierarchy=function(e,t,n){var i=this._cacheHierarchy-1;if(t==i){for(var r in e)for(var a=e[r],o=0,s=n-i;o<s;o++)o==s-1?e[0]=a:e=e[0==o?r:0]=Object.create(null);this._cacheHierarchy=n}else for(var l in e)this._resizeCacheMapHierarchy(e[l],++t,n)},e}(),wr=new tt;yr.init();var br=function(e){function t(i,r,a){var o;(o=e.call(this)||this).physicsManager=void 0,o.inputManager=void 0,o._componentsManager=new xe,o._hardwareRenderer=void 0,o._lastRenderState=new Ln,o._renderElementPool=new Bn(On),o._spriteElementPool=new Bn(Nn),o._spriteMaskElementPool=new Bn(Vn),o._textElementPool=new Bn(rr),o._spriteDefaultMaterial=void 0,o._spriteMaskDefaultMaterial=void 0,o._renderContext=new zn,o._magentaTexture2D=void 0,o._magentaTextureCube=void 0,o._magentaTexture2DArray=void 0,o._magentaMaterial=void 0,o._backgroundTextureMaterial=void 0,o._renderCount=0,o._shaderProgramPools=[],o._spriteMaskManager=void 0,o._canSpriteBatch=!0,o._macroCollection=new ye,o._canvas=void 0,o._settings={},o._resourceManager=new X(L(o)),o._sceneManager=new gr(L(o)),o._vSyncCount=1,o._targetFrameRate=60,o._time=new ge,o._isPaused=!0,o._requestId=void 0,o._timeoutId=void 0,o._vSyncCounter=1,o._targetFrameInterval=1e3/60,o._destroyed=!1,o._waittingDestroy=!1,o._animate=function(){o._vSyncCount?(o._requestId=n.polyfill.requestAnimationFrame(o._animate),o._vSyncCounter++%o._vSyncCount==0&&(o.update(),o._vSyncCounter=1)):(o._timeoutId=n.polyfill.window.setTimeout(o._animate,o._targetFrameInterval),o.update())},o.features=[],o._hardwareRenderer=r,o._hardwareRenderer.init(i),o.physicsManager=new ot(L(o)),o._canvas=i,wr.addObject(L(o)),o._sceneManager.activeScene=new pr(L(o),"DefaultScene"),o._spriteMaskManager=new ir(L(o)),o._spriteDefaultMaterial=o._createSpriteMaterial(),o._spriteMaskDefaultMaterial=o._createSpriteMaskMaterial(),o.inputManager=new Vt(L(o));var s=new Uint8Array([255,0,255,255]),l=new Si(L(o),1,1,mi.R8G8B8A8,!1);l.setPixelBuffer(s),l.isGCIgnored=!0;var u=new Pi(L(o),1,mi.R8G8B8A8,!1);if(u.setPixelBuffer(gi.PositiveX,s),u.setPixelBuffer(gi.NegativeX,s),u.setPixelBuffer(gi.PositiveY,s),u.setPixelBuffer(gi.NegativeY,s),u.setPixelBuffer(gi.PositiveZ,s),u.setPixelBuffer(gi.NegativeZ,s),u.isGCIgnored=!0,o._magentaTexture2D=l,o._magentaTextureCube=u,r.isWebGL2){var c=new Ai(L(o),1,1,1,mi.R8G8B8A8,!1);c.setPixelBuffer(0,s),c.isGCIgnored=!0,o._magentaTexture2DArray=c}var h=new Dn(L(o),Zt.find("unlit"));h.shaderData.setColor("u_baseColor",new v(1,0,1.01,1)),o._magentaMaterial=h;var _=new Dn(L(o),Zt.find("background-texture"));_.isGCIgnored=!0,_.renderState.depthState.compareFunction=rn.LessEqual,o._backgroundTextureMaterial=_;var d=(null==a?void 0:a.colorSpace)||Wt.Linear;return d===Wt.Gamma&&o._macroCollection.enable(t._gammaMacro),o._settings.colorSpace=d,o}A(t,e);var i=t.prototype;return i.createEntity=function(e){return new et(this,e)},i.pause=function(){this._isPaused=!0,n.polyfill.cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},i.resume=function(){this._isPaused&&(this._isPaused=!1,this.time.reset(),this._requestId=n.polyfill.requestAnimationFrame(this._animate))},i.update=function(){var e=this._time,t=e.deltaTime;e.tick(),this._renderElementPool.resetPool(),this._spriteElementPool.resetPool(),this._spriteMaskElementPool.resetPool(),this._textElementPool.resetPool(),wr.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var n=this._sceneManager._activeScene,i=this._componentsManager;n&&(n._activeCameras.sort((function(e,t){return e.priority-t.priority})),i.callScriptOnStart(),this.physicsManager._initialized&&this.physicsManager._update(t/1e3),this.inputManager._update(),i.callScriptOnUpdate(t),i.callAnimationUpdate(t),i.callScriptOnLateUpdate(t),this._render(n)),wr.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene]),this._waittingDestroy&&this._sceneManager._destroyAllScene(),i.handlingInvalidScripts(),this._waittingDestroy&&this._destroy()},i.run=function(){wr.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new Y("run",this))},i.destroy=function(){this._destroyed||(this._waittingDestroy=!0)},i._destroy=function(){this._resourceManager._destroy(),this._magentaTexture2D.destroy(!0),this._magentaTextureCube.destroy(!0),this.inputManager._destroy(),this.trigger(new Y("shutdown",this)),wr.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager=null,this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,this._spriteMaskManager.destroy(),wr._objects=[],this.removeAllEventListeners(),this._waittingDestroy=!1,this._destroyed=!0},i._getShaderProgramPool=function(e){var t=e._shaderId,n=this._shaderProgramPools,i=n[t];if(!i){var r=t+1;r<n.length&&(n.length=r),n[t]=i=new xr}return i},i._render=function(e){var t=e._activeCameras,n=this._componentsManager,i=this.time.deltaTime;if(n.callRendererOnUpdate(i),e._updateShaderData(),t.length>0)for(var r=0,a=t.length;r<a;r++){var o=t[r];n.callCameraOnBeginRender(o),pr.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,o]),o.render(),pr.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,o]),n.callCameraOnEndRender(o)}else pe.debug("NO active camera.")},i._createSpriteMaterial=function(){var e=new Dn(this,Zt.find("Sprite")),t=e.renderState,n=t.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=$t.SourceAlpha,n.destinationColorBlendFactor=$t.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=$t.One,n.destinationAlphaBlendFactor=$t.OneMinusSourceAlpha,n.colorBlendOperation=n.alphaBlendOperation=en.Add,t.depthState.writeEnabled=!1,t.rasterState.cullMode=sn.Off,e.renderQueueType=zt.Transparent,e.isGCIgnored=!0,e},i._createSpriteMaskMaterial=function(){var e=new Dn(this,Zt.find("SpriteMask")),t=e.renderState;return t.blendState.targetBlendState.colorWriteMask=tn.None,t.rasterState.cullMode=sn.Off,t.stencilState.enabled=!0,t.depthState.enabled=!1,e.isGCIgnored=!0,e},i.findFeature=function(e){return wr.findFeature(this,e)},t.registerFeature=function(e){wr.registerFeature(e)},C(t,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"destroyed",get:function(){return this._destroyed}}]),t}(ue);br._gammaMacro=Zt.getMacroByName("OASIS_COLORSPACE_GAMMA"),br._pixelsPerUnit=100,br._defaultBoundingBox=new s(new o(0,0,0),new o(0,0,0));var Cr,Tr,Sr,Ar,Pr,Mr,Er,Fr,Rr,Lr,Dr=function(){function e(){}return e._isIos=function(){if(!n.polyfill.window)return!1;var e=n.polyfill.window.navigator.userAgent.toLocaleLowerCase();return/iphone|ipad|ipod/.test(e)},C(e,null,[{key:"devicePixelRatio",get:function(){return n.polyfill.window.devicePixelRatio}}]),e}(),Br=function(){function e(){}var t=e.prototype;return t.preLoad=function(e){},t.preTick=function(e,t){},t.postTick=function(e,t){},t.shutdown=function(e){},e}(),Ir=(Cr=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return I(t=e.call.apply(e,[this].concat(i))||this,"_started",Tr,L(t)),I(t,"_onStartIndex",Sr,L(t)),I(t,"_onUpdateIndex",Ar,L(t)),I(t,"_onLateUpdateIndex",Pr,L(t)),I(t,"_onPhysicsUpdateIndex",Mr,L(t)),I(t,"_onPreRenderIndex",Er,L(t)),I(t,"_onPostRenderIndex",Fr,L(t)),I(t,"_entityScriptsIndex",Rr,L(t)),I(t,"_waitHandlingInValid",Lr,L(t)),t}A(t,e);var n=t.prototype;return n.onAwake=function(){},n.onEnable=function(){},n.onStart=function(){},n.onUpdate=function(e){},n.onLateUpdate=function(e){},n.onBeginRender=function(e){},n.onEndRender=function(e){},n.onPhysicsUpdate=function(){},n.onTriggerEnter=function(e){},n.onTriggerExit=function(e){},n.onTriggerStay=function(e){},n.onCollisionEnter=function(e){},n.onCollisionExit=function(e){},n.onCollisionStay=function(e){},n.onPointerDown=function(){},n.onPointerUp=function(){},n.onPointerClick=function(){},n.onPointerEnter=function(){},n.onPointerExit=function(){},n.onPointerDrag=function(){},n.onDisable=function(){},n.onDestroy=function(){},n._onAwake=function(){this.onAwake()},n._onEnable=function(){if(this._waitHandlingInValid)this._waitHandlingInValid=!1;else{var e=this.engine._componentsManager,n=t.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==n.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==n.onLateUpdate&&e.addOnLateUpdateScript(this),this.onPhysicsUpdate!==n.onPhysicsUpdate&&e.addOnPhysicsUpdateScript(this),this._entity._addScript(this)}this.onEnable()},n._onDisable=function(){this._waitHandlingInValid=!0,this._engine._componentsManager.addDisableScript(this),this.onDisable()},n._onDestroy=function(){this._engine._componentsManager.addDestroyScript(this)},n._handlingInValid=function(){var e=this.engine._componentsManager,n=t.prototype;this.onUpdate!==n.onUpdate&&e.removeOnUpdateScript(this),this.onLateUpdate!==n.onLateUpdate&&e.removeOnLateUpdateScript(this),this.onPhysicsUpdate!==n.onPhysicsUpdate&&e.removeOnPhysicsUpdateScript(this),this._entity._removeScript(this),this._waitHandlingInValid=!1},t}(Ye),Tr=O(Cr.prototype,"_started",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sr=O(Cr.prototype,"_onStartIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ar=O(Cr.prototype,"_onUpdateIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Pr=O(Cr.prototype,"_onLateUpdateIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Mr=O(Cr.prototype,"_onPhysicsUpdateIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Er=O(Cr.prototype,"_onPreRenderIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Fr=O(Cr.prototype,"_onPostRenderIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Rr=O(Cr.prototype,"_entityScriptsIndex",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Lr=O(Cr.prototype,"_waitHandlingInValid",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Cr),Or=0,zr=function(){function e(e,t,n,i,r){void 0===e&&(e="RENDER_PASS"+Or++),void 0===t&&(t=0),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.name=e,this.enabled=!0,this.priority=t,this.renderTarget=n,this.replaceMaterial=i,this.mask=r||we.Everything,this.renderOverride=!1}var t=e.prototype;return t.render=function(e,t,n,i){},t.preRender=function(e,t,n,i){},t.postRender=function(e,t,n,i){},e}(),Nr=function(e){function t(){return e.apply(this,arguments)||this}A(t,e);var n=t.prototype;return n.createVertexElements=function(e){return e[0]=new _i("POSITION",0,ai.Vector3,0),e[1]=new _i("TEXCOORD_0",12,ai.Vector2,0),e[2]=new _i("COLOR_0",20,ai.Vector4,0),36},n.canBatch=function(e,t){if(!this._engine._canSpriteBatch)return!1;var n=e.component,i=t.component;return!!this.checkBatchWithMask(n,i)&&(e.texture===t.texture&&e.material===t.material)},n.checkBatchWithMask=function(e,t){var n=e.maskInteraction;return n===t.maskInteraction&&(n===hn.None||e.maskLayer===t.maskLayer)},n.updateVertices=function(e,t,n){for(var i=e.renderData,r=i.positions,a=i.uvs,o=i.color,s=i.vertexCount,l=0;l<s;l++){var u=r[l],c=a[l];t[n++]=u.x,t[n++]=u.y,t[n++]=u.z,t[n++]=c.x,t[n++]=c.y,t[n++]=o.r,t[n++]=o.g,t[n++]=o.b,t[n++]=o.a}return n},n.drawBatches=function(e,n){for(var i=this._engine,r=this._batchedQueue,a=this._meshes[this._flushId],o=a.subMeshes,s=i._spriteMaskManager,l=e.scene.shaderData,u=e.shaderData,c=0,h=o.length;c<h;c++){var _=o[c],d=r[c];if(!_||!d)return;var f=d.component,p=d.material;s.preRender(e,f);var g=Zt._compileMacros;ye.unionCollection(f._globalShaderMacro,p.shaderData._macroCollection,g),(n||p)._preRender(d);var v=(n||p).shader._getShaderProgram(i,g);if(!v.isValid)return;f.shaderData.setTexture(t._textureProperty,d.texture),v.bind(),v.groupingOtherUniformBlock(),v.uploadAll(v.sceneUniformBlock,l),v.uploadAll(v.cameraUniformBlock,u),v.uploadAll(v.rendererUniformBlock,f.shaderData),v.uploadAll(v.materialUniformBlock,p.shaderData),p.renderState._apply(i,!1),i._hardwareRenderer.drawPrimitive(a,_,v),s.postRender(f)}},n.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,t=this._vertexBuffers,n=this._indiceBuffers,i=0,r=e.length;i<r;++i)e[i].destroy();this._meshes=null;for(var a=0,o=t.length;a<o;++a)t[a].destroy();this._vertexBuffers=null;for(var s=0,l=n.length;s<l;++s)n[s].destroy();this._indiceBuffers=null},t}($i);Nr._textureProperty=Zt.getPropertyByName("u_spriteTexture");var Vr,Ur,kr,Gr,Hr,Wr,jr,Xr,Kr,qr,Yr,Qr,Jr,Zr,$r,ea=function(){function e(e){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new Nr(e)}e._compareFromNearToFar=function(e,t){return e.component.priority-t.component.priority||e.component._distanceForSort-t.component._distanceForSort},e._compareFromFarToNear=function(e,t){return e.component.priority-t.component.priority||t.component._distanceForSort-e.component._distanceForSort};var t=e.prototype;return t.pushPrimitive=function(e){this.items.push(e)},t.render=function(e,t,n){var i=this.items;if(0!==i.length){for(var r=e.engine,a=e.scene,o=r._renderCount,s=r._hardwareRenderer,l=a.shaderData,u=e.shaderData,c=0,h=i.length;c<h;c++){var _=i[c];if(_.component.entity.layer&n)if(_.mesh){this._spriteBatcher.flush(e,t);var d=Zt._compileMacros,f=_,p=f.component,g=f.material.destroyed?r._magentaMaterial:f.material,v=p.shaderData,m=g.shaderData;(t||g)._preRender(f),ye.unionCollection(p._globalShaderMacro,m._macroCollection,d);var y=(t||g).shader._getShaderProgram(r,d);if(!y.isValid)continue;var x=y.bind();o!==y._uploadRenderCount?(y.groupingOtherUniformBlock(),y.uploadAll(y.sceneUniformBlock,l),y.uploadAll(y.cameraUniformBlock,u),y.uploadAll(y.rendererUniformBlock,v),y.uploadAll(y.materialUniformBlock,m),y.uploadUnGroupTextures(),y._uploadCamera=e,y._uploadRenderer=p,y._uploadMaterial=g,y._uploadRenderCount=o):(y._uploadCamera!==e?(y.uploadAll(y.cameraUniformBlock,u),y._uploadCamera=e):x&&y.uploadTextures(y.cameraUniformBlock,u),y._uploadRenderer!==p?(y.uploadAll(y.rendererUniformBlock,v),y._uploadRenderer=p):x&&y.uploadTextures(y.rendererUniformBlock,v),y._uploadMaterial!==g?(y.uploadAll(y.materialUniformBlock,m),y._uploadMaterial=g):x&&y.uploadTextures(y.materialUniformBlock,m),x&&y.uploadUnGroupTextures()),g.renderState._apply(r,p.entity.transform._isFrontFaceInvert()),s.drawPrimitive(f.mesh,f.subMesh,y)}else{var w=_;this._spriteBatcher.drawElement(w,e,t)}}this._spriteBatcher.flush(e,t)}},t.clear=function(){this.items.length=0,this._spriteBatcher.clear()},t.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},t.sort=function(e){this._quickSort(this.items,0,this.items.length,e)},t._quickSort=function(e,t,n,i){for(;;){if(n-t<=10)return void this._insertionSort(e,t,n,i);var r=t+n>>1,a=e[t],o=e[n-1],s=e[r];if(i(a,o)>0){var l=a;a=o,o=l}if(i(a,s)>=0){var u=a;a=s,s=o,o=u}else{if(i(o,s)>0){var c=o;o=s,s=c}}e[t]=a,e[n-1]=s;var h=o,_=t+1,d=n-1;e[r]=e[_],e[_]=h;e:for(var f=_+1;f<d;f++){var p=e[f],g=i(p,h);if(g<0)e[f]=e[_],e[_]=p,_++;else if(g>0){do{if(--d==f)break e;g=i(e[d],h)}while(g>0);e[f]=e[d],e[d]=p,g<0&&(p=e[f],e[f]=e[_],e[_]=p,_++)}}n-d<_-t?(this._quickSort(e,d,n,i),n=_):(this._quickSort(e,t,_,i),t=d)}},t._insertionSort=function(e,t,n,i){for(var r=t+1;r<n;r++){var a=void 0,o=e[r];for(a=r-1;a>=t;a--){var s=e[a];if(!(i(s,o)>0))break;e[a+1]=s}e[a+1]=o}},e}(),ta=function(){function e(e){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._allSpriteMasks=new me,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._lastCanvasSize=new p,this._camera=e;var t=e.engine;this._opaqueQueue=new ea(t),this._alphaTestQueue=new ea(t),this._transparentQueue=new ea(t),this._renderPassArray=[],this._defaultPass=new zr("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var t=e.prototype;return t.addRenderPass=function(e,t,n,i,r){if(void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),"string"==typeof e){var a=new zr(e,t,n,i,r);this._renderPassArray.push(a)}else e instanceof zr&&this._renderPassArray.push(e);this._renderPassArray.sort((function(e,t){return e.priority-t.priority}))},t.removeRenderPass=function(e){var t;if("string"==typeof e?t=this.getRenderPass(e):e instanceof zr&&(t=e),t){var n=this._renderPassArray.indexOf(t);this._renderPassArray.splice(n,1)}},t.getRenderPass=function(e){for(var t=0,n=this._renderPassArray.length;t<n;t++){var i=this._renderPassArray[t];if(i.name===e)return i}return null},t.destroy=function(){this._opaqueQueue.destroy(),this._alphaTestQueue.destroy(),this._transparentQueue.destroy(),this._allSpriteMasks=null,this._renderPassArray=null,this._defaultPass=null,this._camera=null},t.render=function(e,t,n){var i=this._camera,r=this._opaqueQueue,a=this._alphaTestQueue,o=this._transparentQueue;i.engine._spriteMaskManager.clear(),r.clear(),a.clear(),o.clear(),this._allSpriteMasks.length=0,i.engine._componentsManager.callRender(e),r.sort(ea._compareFromNearToFar),a.sort(ea._compareFromNearToFar),o.sort(ea._compareFromFarToNear);for(var s=0,l=this._renderPassArray.length;s<l;s++)this._drawRenderPass(this._renderPassArray[s],i,t,n)},t._drawRenderPass=function(e,t,n,i){if(e.preRender(t,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),e.enabled){var r,a,o=t.engine,s=t.scene.background,l=o._hardwareRenderer,u=t.renderTarget||e.renderTarget;l.activeRenderTarget(u,t,i),null==u||u._setRenderTargetInfo(n,i);var c=null!=(r=e.clearFlags)?r:t.clearFlags,h=null!=(a=e.clearColor)?a:s.solidColor;c!==nt.None&&l.clearRenderTarget(t.engine,c,h),e.renderOverride?e.render(t,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(t,e.replaceMaterial,e.mask),this._alphaTestQueue.render(t,e.replaceMaterial,e.mask),t.clearFlags&nt.Color&&(s.mode===er.Sky?this._drawSky(o,t,s.sky):s.mode===er.Texture&&s.texture&&this._drawBackgroundTexture(o,s)),this._transparentQueue.render(t,e.replaceMaterial,e.mask)),null==u||u._blitRenderTarget(),null==u||u.generateMipmaps()}e.postRender(t,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},t.pushPrimitive=function(e){switch(e.material.renderQueueType){case zt.Transparent:this._transparentQueue.pushPrimitive(e);break;case zt.AlphaTest:this._alphaTestQueue.pushPrimitive(e);break;case zt.Opaque:this._opaqueQueue.pushPrimitive(e)}},t._drawBackgroundTexture=function(e,t){var n=e._hardwareRenderer,i=e._backgroundTextureMaterial,r=e.canvas,a=t._mesh;this._lastCanvasSize.x===r.width&&this._lastCanvasSize.y===r.height||t._textureFillMode===tr.Fill||(this._lastCanvasSize.set(r.width,r.height),t._resizeBackgroundTexture());var o=i.shader._getShaderProgram(e,Zt._compileMacros);o.bind(),o.uploadAll(o.materialUniformBlock,i.shaderData),o.uploadUnGroupTextures(),i.renderState._apply(e,!1),n.drawPrimitive(a,a.subMesh,o)},t._drawSky=function(e,t,n){var i=n.material,r=n.mesh,a=n._matrix;if(i)if(r){var o=e._hardwareRenderer,s=i.shaderData,l=i.shader,u=i.renderState,c=Zt._compileMacros;ye.unionCollection(t._globalShaderMacro,s._macroCollection,c);var h=t.viewMatrix,_=t.projectionMatrix;a.copyFrom(h);var f=a.elements;f[12]=f[13]=f[14]=0,d.multiply(_,a,a),s.setMatrix("u_mvpNoscale",a);var p=l._getShaderProgram(e,c);p.bind(),p.groupingOtherUniformBlock(),p.uploadAll(p.materialUniformBlock,s),p.uploadUnGroupTextures(),u._apply(e,!1),o.drawPrimitive(r,r.subMesh,p)}else pe.warn("The mesh of sky is not defined.");else pe.warn("The material of sky is not defined.")},C(e,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),e}(),na=function(){};na.tempVec4=new g,na.tempVec3=new o,na.tempVec2=new p;var ia=Te(Ze)(($r=function(e){function t(t){var n;(n=e.call(this,t)||this).shaderData=new nn(Ut.Camera),n.priority=0,n.enableFrustumCulling=!0,n.clearFlags=nt.All,n.cullingMask=we.Everything,n._globalShaderMacro=new ye,I(n,"_frustum",kr,L(n)),I(n,"_renderPipeline",Gr,L(n)),n._isOrthographic=!1,n._isProjMatSetting=!1,n._nearClipPlane=.1,n._farClipPlane=100,n._fieldOfView=45,n._orthographicSize=10,n._isProjectionDirty=!0,n._isInvProjMatDirty=!0,n._isFrustumProjectDirty=!0,n._customAspectRatio=void 0,n._renderTarget=null,I(n,"_frustumViewChangeFlag",Hr,L(n)),I(n,"_transform",Wr,L(n)),I(n,"_isViewMatrixDirty",jr,L(n)),I(n,"_isInvViewProjDirty",Xr,L(n)),I(n,"_projectionMatrix",Kr,L(n)),I(n,"_viewMatrix",qr,L(n)),I(n,"_viewport",Yr,L(n)),I(n,"_inverseProjectionMatrix",Qr,L(n)),I(n,"_lastAspectSize",Jr,L(n)),I(n,"_invViewProjMat",Zr,L(n));var i=n.entity.transform;return n._transform=i,n._isViewMatrixDirty=i.registerWorldChangeFlag(),n._isInvViewProjDirty=i.registerWorldChangeFlag(),n._frustumViewChangeFlag=i.registerWorldChangeFlag(),n._renderPipeline=new ta(L(n)),n.shaderData._addRefCount(1),n}A(t,e);var n=t.prototype;return n.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},n.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},n.worldToViewportPoint=function(e,t){var n=na.tempVec3,i=na.tempVec4;o.transformCoordinate(e,this.viewMatrix,n),o.transformToVec4(n,this.projectionMatrix,i);var r=i.w;return t.set(.5*(i.x/r+1),.5*(1-i.y/r),-n.z),t},n.viewportToWorldPoint=function(e,t){var n,i=this.nearClipPlane,r=this.farClipPlane,a=1/(i-r);if(this.isOrthographic)n=2*-e.z*a,n+=(r+i)*a;else{var o=e.z;n=-o*(i+r)*a,n+=2*i*r*a,n/=o}return this._innerViewportToWorldPoint(e.x,e.y,(n+1)/2,this._getInvViewProjMat(),t),t},n.viewportPointToRay=function(e,t){var n=this._getInvViewProjMat(),i=this._innerViewportToWorldPoint(e.x,e.y,0,n,t.origin),r=this._innerViewportToWorldPoint(e.x,e.y,1,n,t.direction);return o.subtract(r,i,r),r.normalize(),t},n.screenToViewportPoint=function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(e.x/n.width-i.x)/i.z,t.y=(e.y/n.height-i.y)/i.w,void 0!==e.z&&(t.z=e.z),t},n.viewportToScreenPoint=function(e,t){var n=this.engine.canvas,i=this.viewport;return t.x=(i.x+e.x*i.z)*n.width,t.y=(i.y+e.y*i.w)*n.height,void 0!==e.z&&(t.z=e.z),t},n.worldToScreenPoint=function(e,t){return this.worldToViewportPoint(e,t),this.viewportToScreenPoint(t,t)},n.screenToWorldPoint=function(e,t){return this.screenToViewportPoint(e,t),this.viewportToWorldPoint(t,t)},n.screenPointToRay=function(e,t){var n=na.tempVec2;return this.screenToViewportPoint(e,n),this.viewportPointToRay(n,t)},n.render=function(e,t){void 0===t&&(t=0);var n=this.engine._renderContext;n._setContext(this),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(n._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(n),ye.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),t>0&&!this.engine._hardwareRenderer.isWebGL2&&(t=0,pe.error("mipLevel only take effect in WebGL2.0")),this._renderPipeline.render(n,e,t),this._engine._renderCount++},n._onEnable=function(){this.entity.scene._attachRenderCamera(this)},n._onDisable=function(){this.entity.scene._detachRenderCamera(this)},n._onDestroy=function(){var e;null===(e=this._renderPipeline)||void 0===e||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},n._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},n._innerViewportToWorldPoint=function(e,t,n,i,r){var a=na.tempVec3;return a.set(2*e-1,1-2*t,2*n-1),o.transformCoordinate(a,i,r),r},n._updateShaderData=function(e){var n=this.shaderData;n.setMatrix(t._viewMatrixProperty,this.viewMatrix),n.setMatrix(t._projectionMatrixProperty,this.projectionMatrix),n.setMatrix(t._vpMatrixProperty,e._viewProjectMatrix),n.setMatrix(t._inverseViewMatrixProperty,this._transform.worldMatrix),n.setMatrix(t._inverseProjectionMatrixProperty,this._getInverseProjectionMatrix()),n.setVector3(t._cameraPositionProperty,this._transform.worldPosition)},n._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,d.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},n._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,d.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},C(t,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,t=this._entity.engine.canvas;return null!=(e=this._customAspectRatio)?e:t.width*this._viewport.z/(t.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&this._viewport.copyFrom(e),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,d.rotationTranslation(this._transform.worldRotationQuaternion,this._transform.worldPosition,this._viewMatrix),this._viewMatrix.invert()),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var t=this.aspectRatio;if(this._isOrthographic){var n=this._orthographicSize*t,i=this._orthographicSize;d.ortho(-n,n,-i,i,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}else d.perspective(a.degreeToRadian(this._fieldOfView),t,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}}]),t}(Ye),$r._viewMatrixProperty=Zt.getPropertyByName("u_viewMat"),$r._projectionMatrixProperty=Zt.getPropertyByName("u_projMat"),$r._vpMatrixProperty=Zt.getPropertyByName("u_VPMat"),$r._inverseViewMatrixProperty=Zt.getPropertyByName("u_viewInvMat"),$r._inverseProjectionMatrixProperty=Zt.getPropertyByName("u_projInvMat"),$r._cameraPositionProperty=Zt.getPropertyByName("u_cameraPos"),kr=O((Ur=$r).prototype,"_frustum",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new c}}),Gr=O(Ur.prototype,"_renderPipeline",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hr=O(Ur.prototype,"_frustumViewChangeFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wr=O(Ur.prototype,"_transform",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jr=O(Ur.prototype,"_isViewMatrixDirty",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Xr=O(Ur.prototype,"_isInvViewProjDirty",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Kr=O(Ur.prototype,"_projectionMatrix",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),qr=O(Ur.prototype,"_viewMatrix",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Yr=O(Ur.prototype,"_viewport",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new g(0,0,1,1)}}),Qr=O(Ur.prototype,"_inverseProjectionMatrix",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Jr=O(Ur.prototype,"_lastAspectSize",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new p(0,0)}}),Zr=O(Ur.prototype,"_invViewProjMat",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new d}}),Vr=Ur))||Vr,ra={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"};function aa(e,t){return void 0===t&&(t={}),new j((function(n,i,r){var a,o,s,l,u=null!=(a=t.retryCount)?a:1,c=null!=(o=t.retryInterval)?o:500;t.timeout=null!=(s=t.timeout)?s:Infinity,t.type=null!=(l=t.type)?l:function(e){var t=e.substring(e.lastIndexOf(".")+1);return ra[t]}(e);var h,_="image"===t.type?oa:sa,d=new _a((function(){return _(e,t).onProgress(r).then((function(e){n(e),d.stop()})).catch((function(e){return h=e}))}),u,c);d.start((function(){i(h)}))}))}function oa(e,t){return new j((function(i,r){var a=t.timeout,o=new n.polyfill.Image,s=function(){r(new Error("request "+e+" fail"))};o.onerror=s,o.onabort=s;var l=-1;a!=1/0&&(l=n.polyfill.window.setTimeout((function(){r(new Error("request "+e+" timeout"))}),a)),o.onload=function(e){return function(){n.polyfill.requestAnimationFrame((function(){i(o),o.onload=null,o.onerror=null,o.onabort=null})),clearTimeout(e)}}(l),o.crossOrigin="anonymous",o.src=e}))}function sa(e,t){return new j((function(i,r,a){var o,s=new n.polyfill.XMLHttpRequest;s.timeout=t.timeout,t.method=null!=(o=t.method)?o:"get",s.onload=function(){var t;if(s.status<200||s.status>=300)r(new Error("request failed from: "+e));else{var n=null!=(t=s.response)?t:s.responseText;i(n)}},s.onerror=function(){r(new Error("request failed from: "+e))},s.ontimeout=function(){r(new Error("request timeout from: "+e))},s.onprogress=function(e){a(e.loaded/e.total)},s.open(t.method,e,!0),s.withCredentials="include"===t.credentials,s.responseType=t.type;var l=t.headers;l&&Object.keys(l).forEach((function(e){s.setRequestHeader(e,l[e])})),s.send(t.body)}))}var la,ua,ca,ha,_a=function(){function e(e,t,n){this.execFunc=e,this.totalCount=t,this.interval=n,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var t=e.prototype;return t.start=function(e){this.done=e,this.exec()},t.stop=function(){clearTimeout(this._timeoutId)},t.exec=function(){var e=this;this._currentCount>=this.totalCount?this.done&&this.done():(this._currentCount++,this.execFunc(this._currentCount).then((function(){e._timeoutId=setTimeout(e.exec,e.interval)})))},e}(),da=function(){function e(e){this.useCache=e,this.request=aa}return e.registerClass=function(e,t){this._engineObjects[e]=t},e.getClass=function(e){return this._engineObjects[e]},e}();da._engineObjects={},function(e){e.Text="text",e.JSON="json",e.Buffer="buffer",e.Texture2D="texture2d",e.TextureCube="texture-cube",e.Material="material",e.Mesh="mesh",e.AnimationClip="AnimationClip",e.AnimatorController="AnimatorController",e.Prefab="prefab",e.KTX="ktx",e.KTXCube="ktx-cube",e.Sprite="sprite",e.SpriteAtlas="sprite-atlas",e.Env="environment",e.Scene="scene",e.HDR="HDR"}(la||(la={})),function(e){e[e.Front=0]="Front",e[e.Back=1]="Back",e[e.Double=2]="Double"}(ua||(ua={})),function(e){e[e.Normal=0]="Normal",e[e.Additive=1]="Additive"}(ca||(ca={})),function(e){e[e.UV0=0]="UV0",e[e.UV1=1]="UV1",e[e.UV2=2]="UV2",e[e.UV3=3]="UV3",e[e.UV4=4]="UV4",e[e.UV5=5]="UV5",e[e.UV6=6]="UV6",e[e.UV7=7]="UV7"}(ha||(ha={}));var fa=function(e){function t(n,i){var r;return(r=e.call(this,n,i)||this)._renderFace=ua.Front,r._isTransparent=!1,r._blendMode=void 0,r.blendMode=ca.Normal,r.shaderData.setFloat(t._alphaCutoffProp,0),r}A(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(t){e.prototype.cloneTo.call(this,t),t._renderFace=this._renderFace,t._isTransparent=this._isTransparent,t._blendMode=this._blendMode},C(t,[{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){if(e!==this._isTransparent){this._isTransparent=e;var n=this.renderState,i=n.depthState,r=n.blendState.targetBlendState;e?(r.enabled=!0,i.writeEnabled=!1,this.renderQueueType=zt.Transparent):(r.enabled=!1,i.writeEnabled=!0,this.renderQueueType=this.shaderData.getFloat(t._alphaCutoffProp)?zt.AlphaTest:zt.Opaque)}}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(t._alphaCutoffProp)},set:function(e){this.shaderData.setFloat(t._alphaCutoffProp,e),e>0?(this.shaderData.enableMacro(t._alphaCutoffMacro),this.renderQueueType=this._isTransparent?zt.Transparent:zt.AlphaTest):(this.shaderData.disableMacro(t._alphaCutoffMacro),this.renderQueueType=this._isTransparent?zt.Transparent:zt.Opaque)}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){if(e!==this._renderFace)switch(this._renderFace=e,e){case ua.Front:this.renderState.rasterState.cullMode=sn.Back;break;case ua.Back:this.renderState.rasterState.cullMode=sn.Front;break;case ua.Double:this.renderState.rasterState.cullMode=sn.Off}}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){if(e!==this._blendMode){this._blendMode=e;var t=this.renderState.blendState.targetBlendState;switch(e){case ca.Normal:t.sourceColorBlendFactor=$t.SourceAlpha,t.destinationColorBlendFactor=$t.OneMinusSourceAlpha,t.sourceAlphaBlendFactor=$t.One,t.destinationAlphaBlendFactor=$t.OneMinusSourceAlpha,t.colorBlendOperation=t.alphaBlendOperation=en.Add;break;case ca.Additive:t.sourceColorBlendFactor=$t.SourceAlpha,t.destinationColorBlendFactor=$t.One,t.sourceAlphaBlendFactor=$t.One,t.destinationAlphaBlendFactor=$t.OneMinusSourceAlpha,t.colorBlendOperation=t.alphaBlendOperation=en.Add}}}}]),t}(Dn);fa._baseColorProp=Zt.getPropertyByName("u_baseColor"),fa._baseTextureProp=Zt.getPropertyByName("u_baseTexture"),fa._baseTextureMacro=Zt.getMacroByName("BASETEXTURE"),fa._tilingOffsetProp=Zt.getPropertyByName("u_tilingOffset"),fa._normalTextureProp=Zt.getPropertyByName("u_normalTexture"),fa._normalIntensityProp=Zt.getPropertyByName("u_normalIntensity"),fa._normalTextureMacro=Zt.getMacroByName("NORMALTEXTURE"),fa._emissiveColorProp=Zt.getPropertyByName("u_emissiveColor"),fa._emissiveTextureProp=Zt.getPropertyByName("u_emissiveTexture"),fa._emissiveTextureMacro=Zt.getMacroByName("EMISSIVETEXTURE"),fa._alphaCutoffProp=Zt.getPropertyByName("u_alphaCutoff"),fa._alphaCutoffMacro=Zt.getMacroByName("ALPHA_CUTOFF");var pa=function(e){function t(n){var i,r=(i=e.call(this,n,Zt.find("blinn-phong"))||this).shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(t._baseColorProp,new v(1,1,1,1)),r.setColor(t._specularColorProp,new v(1,1,1,1)),r.setColor(t._emissiveColorProp,new v(0,0,0,1)),r.setVector4(t._tilingOffsetProp,new g(1,1,0,0)),r.setFloat(t._shininessProp,16),r.setFloat(t._normalIntensityProp,1),i}return A(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},C(t,[{key:"baseColor",get:function(){return this.shaderData.getColor(t._baseColorProp)},set:function(e){var n=this.shaderData.getColor(t._baseColorProp);e!==n&&n.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(t._baseTextureProp)},set:function(e){this.shaderData.setTexture(t._baseTextureProp,e),e?this.shaderData.enableMacro(t._baseTextureMacro):this.shaderData.disableMacro(t._baseTextureMacro)}},{key:"specularColor",get:function(){return this.shaderData.getColor(t._specularColorProp)},set:function(e){var n=this.shaderData.getColor(t._specularColorProp);e!==n&&n.copyFrom(e)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(t._specularTextureProp)},set:function(e){this.shaderData.setTexture(t._specularTextureProp,e),e?this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(t._emissiveColorProp)},set:function(e){var n=this.shaderData.getColor(t._emissiveColorProp);e!==n&&n.copyFrom(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(t._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(t._emissiveTextureProp,e),e?this.shaderData.enableMacro(t._emissiveTextureMacro):this.shaderData.disableMacro(t._emissiveTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(t._normalTextureProp)},set:function(e){this.shaderData.setTexture(t._normalTextureProp,e),e?this.shaderData.enableMacro(t._normalTextureMacro):this.shaderData.disableMacro(t._normalTextureMacro)}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(t._normalIntensityProp)},set:function(e){this.shaderData.setFloat(t._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(t._shininessProp)},set:function(e){this.shaderData.setFloat(t._shininessProp,Math.max(e,1e-4))}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(t._tilingOffsetProp)},set:function(e){var n=this.shaderData.getVector4(t._tilingOffsetProp);e!==n&&n.copyFrom(e)}}]),t}(fa);pa._specularColorProp=Zt.getPropertyByName("u_specularColor"),pa._shininessProp=Zt.getPropertyByName("u_shininess"),pa._specularTextureProp=Zt.getPropertyByName("u_specularTexture");var ga=function(e){function t(n,i){var r,a=(r=e.call(this,n,i)||this).shaderData;return a.enableMacro("O3_NEED_WORLDPOS"),a.enableMacro("O3_NEED_TILINGOFFSET"),a.setColor(t._baseColorProp,new v(1,1,1,1)),a.setColor(t._emissiveColorProp,new v(0,0,0,1)),a.setVector4(t._tilingOffsetProp,new g(1,1,0,0)),a.setFloat(t._normalIntensityProp,1),a.setFloat(t._occlusionTextureIntensityProp,1),a.setFloat(t._occlusionTextureCoordProp,ha.UV0),a.setFloat(t._clearCoatProp,0),a.setFloat(t._clearCoatRoughnessProp,0),r}return A(t,e),C(t,[{key:"baseColor",get:function(){return this.shaderData.getColor(t._baseColorProp)},set:function(e){var n=this.shaderData.getColor(t._baseColorProp);e!==n&&n.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(t._baseTextureProp)},set:function(e){this.shaderData.setTexture(t._baseTextureProp,e),e?this.shaderData.enableMacro(t._baseTextureMacro):this.shaderData.disableMacro(t._baseTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(t._normalTextureProp)},set:function(e){this.shaderData.setTexture(t._normalTextureProp,e),e?this.shaderData.enableMacro(t._normalTextureMacro):this.shaderData.disableMacro(t._normalTextureMacro)}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(t._normalIntensityProp)},set:function(e){this.shaderData.setFloat(t._normalIntensityProp,e)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(t._emissiveColorProp)},set:function(e){var n=this.shaderData.getColor(t._emissiveColorProp);e!==n&&n.copyFrom(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(t._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(t._emissiveTextureProp,e),e?this.shaderData.enableMacro(t._emissiveTextureMacro):this.shaderData.disableMacro(t._emissiveTextureMacro)}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(t._occlusionTextureProp)},set:function(e){this.shaderData.setTexture(t._occlusionTextureProp,e),e?this.shaderData.enableMacro("OCCLUSIONTEXTURE"):this.shaderData.disableMacro("OCCLUSIONTEXTURE")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(t._occlusionTextureIntensityProp)},set:function(e){this.shaderData.setFloat(t._occlusionTextureIntensityProp,e)}},{key:"occlusionTextureCoord",get:function(){return this.shaderData.getFloat(t._occlusionTextureCoordProp)},set:function(e){e>ha.UV1&&pe.warn("Occlusion texture uv coordinate must be UV0 or UV1."),this.shaderData.setFloat(t._occlusionTextureCoordProp,e)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(t._tilingOffsetProp)},set:function(e){var n=this.shaderData.getVector4(t._tilingOffsetProp);e!==n&&n.copyFrom(e)}},{key:"clearCoat",get:function(){return this.shaderData.getFloat(t._clearCoatProp)},set:function(e){!!this.shaderData.getFloat(t._clearCoatProp)!=!!e&&(0===e?this.shaderData.disableMacro("CLEARCOAT"):this.shaderData.enableMacro("CLEARCOAT")),this.shaderData.setFloat(t._clearCoatProp,e)}},{key:"clearCoatTexture",get:function(){return this.shaderData.getTexture(t._clearCoatTextureProp)},set:function(e){this.shaderData.setTexture(t._clearCoatTextureProp,e),e?this.shaderData.enableMacro("HAS_CLEARCOATTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATTEXTURE")}},{key:"clearCoatRoughness",get:function(){return this.shaderData.getFloat(t._clearCoatRoughnessProp)},set:function(e){this.shaderData.setFloat(t._clearCoatRoughnessProp,e)}},{key:"clearCoatRoughnessTexture",get:function(){return this.shaderData.getTexture(t._clearCoatRoughnessTextureProp)},set:function(e){this.shaderData.setTexture(t._clearCoatRoughnessTextureProp,e),e?this.shaderData.enableMacro("HAS_CLEARCOATROUGHNESSTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATROUGHNESSTEXTURE")}},{key:"clearCoatNormalTexture",get:function(){return this.shaderData.getTexture(t._clearCoatNormalTextureProp)},set:function(e){this.shaderData.setTexture(t._clearCoatNormalTextureProp,e),e?this.shaderData.enableMacro("HAS_CLEARCOATNORMALTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATNORMALTEXTURE")}}]),t}(fa);ga._occlusionTextureIntensityProp=Zt.getPropertyByName("u_occlusionIntensity"),ga._occlusionTextureCoordProp=Zt.getPropertyByName("u_occlusionTextureCoord"),ga._occlusionTextureProp=Zt.getPropertyByName("u_occlusionTexture"),ga._clearCoatProp=Zt.getPropertyByName("u_clearCoat"),ga._clearCoatTextureProp=Zt.getPropertyByName("u_clearCoatTexture"),ga._clearCoatRoughnessProp=Zt.getPropertyByName("u_clearCoatRoughness"),ga._clearCoatRoughnessTextureProp=Zt.getPropertyByName("u_clearCoatRoughnessTexture"),ga._clearCoatNormalTextureProp=Zt.getPropertyByName("u_clearCoatNormalTexture");var va=function(e){function t(n){var i;return(i=e.call(this,n,Zt.find("pbr"))||this).shaderData.setFloat(t._metallicProp,1),i.shaderData.setFloat(t._roughnessProp,1),i}return A(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},C(t,[{key:"metallic",get:function(){return this.shaderData.getFloat(t._metallicProp)},set:function(e){this.shaderData.setFloat(t._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(t._roughnessProp)},set:function(e){this.shaderData.setFloat(t._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(t._roughnessMetallicTextureProp)},set:function(e){this.shaderData.setTexture(t._roughnessMetallicTextureProp,e),e?this.shaderData.enableMacro("ROUGHNESSMETALLICTEXTURE"):this.shaderData.disableMacro("ROUGHNESSMETALLICTEXTURE")}}]),t}(ga);va._metallicProp=Zt.getPropertyByName("u_metal"),va._roughnessProp=Zt.getPropertyByName("u_roughness"),va._roughnessMetallicTextureProp=Zt.getPropertyByName("u_roughnessMetallicTexture");var ma=function(e){function t(n){var i;return(i=e.call(this,n,Zt.find("pbr-specular"))||this).shaderData.setColor(t._specularColorProp,new v(1,1,1,1)),i.shaderData.setFloat(t._glossinessProp,1),i}return A(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},C(t,[{key:"specularColor",get:function(){return this.shaderData.getColor(t._specularColorProp)},set:function(e){var n=this.shaderData.getColor(t._specularColorProp);e!==n&&n.copyFrom(e)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(t._glossinessProp)},set:function(e){this.shaderData.setFloat(t._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(t._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(t._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro(t._specularGlossinessTextureMacro):this.shaderData.disableMacro(t._specularGlossinessTextureMacro)}}]),t}(ga);ma._specularColorProp=Zt.getPropertyByName("u_PBRSpecularColor"),ma._glossinessProp=Zt.getPropertyByName("u_glossiness"),ma._specularGlossinessTextureProp=Zt.getPropertyByName("u_specularGlossinessTexture"),ma._specularGlossinessTextureMacro=Zt.getMacroByName("SPECULARGLOSSINESSTEXTURE");var ya,xa,wa,ba,Ca=function(e){function t(n){var i,r=(i=e.call(this,n,Zt.find("unlit"))||this).shaderData;return r.enableMacro("OMIT_NORMAL"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(t._baseColorProp,new v(1,1,1,1)),r.setVector4(t._tilingOffsetProp,new g(1,1,0,0)),i}return A(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},C(t,[{key:"baseColor",get:function(){return this.shaderData.getColor(t._baseColorProp)},set:function(e){var n=this.shaderData.getColor(t._baseColorProp);e!==n&&n.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(t._baseTextureProp)},set:function(e){this.shaderData.setTexture(t._baseTextureProp,e),e?this.shaderData.enableMacro(t._baseTextureMacro):this.shaderData.disableMacro(t._baseTextureMacro)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(t._tilingOffsetProp)},set:function(e){var n=this.shaderData.getVector4(t._tilingOffsetProp);e!==n&&n.copyFrom(e)}}]),t}(fa);!function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"}(ya||(ya={})),function(e){e[e.Top=0]="Top",e[e.Center=1]="Center",e[e.Bottom=2]="Bottom"}(xa||(xa={})),function(e){e[e.Overflow=0]="Overflow",e[e.Truncate=1]="Truncate"}(wa||(wa={})),function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Italic=2]="Italic"}(ba||(ba={}));var Ta,Sa=function(e){A(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._sprites=new Array,n._spriteNamesToIndex={},n}return t.getSprite=function(e){var t=this._sprites[this._spriteNamesToIndex[e]];return t||console.warn("There is no sprite named "+e+" in the atlas."),t},t.getSprites=function(e,t){t.length=0;var n=this._spriteNamesToIndex[e];if(void 0!==n)for(var i=this._sprites;n>=0;n--){var r=i[n];r.name===e&&t.push(r)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return t},t._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1},t._onDestroy=function(){this._sprites=null,this._spriteNamesToIndex=null},C(n,[{key:"sprites",get:function(){return this._sprites}}]),n}(kt);!function(e){e[e.Simple=0]="Simple",e[e.Sliced=1]="Sliced"}(Ta||(Ta={}));var Aa,Pa,Ma,Ea=function(e){function t(t,n,i,r,a,o){var l;return void 0===n&&(n=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===o&&(o=null),(l=e.call(this,t)||this).name=void 0,l._assetID=void 0,l._width=void 0,l._height=void 0,l._positions=[new p,new p,new p,new p],l._uvs=[new p,new p,new p,new p],l._bounds=new s,l._texture=null,l._atlasRotated=!1,l._atlasRegion=new m(0,0,1,1),l._atlasRegionOffset=new g(0,0,0,0),l._region=new m(0,0,1,1),l._pivot=new p(.5,.5),l._border=new g(0,0,0,0),l._dirtyFlag=Aa.all,l._updateFlagManager=new Je,l._texture=n,i&&l._region.copyFrom(i),r&&l._pivot.copyFrom(r),a&&l._border.copyFrom(a),l.name=o,l}A(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._engine,this._texture,this._region,this._pivot,this._border,this.name);return e._assetID=this._assetID,e._atlasRotated=this._atlasRotated,e._atlasRegion.copyFrom(this._atlasRegion),e._atlasRegionOffset.copyFrom(this._atlasRegionOffset),e},n._registerUpdateFlag=function(){return this._updateFlagManager.createFlag(Qe)},n._getPositions=function(){return this._dirtyFlag&Aa.positions&&this._updatePositions(),this._positions},n._getUVs=function(){return this._dirtyFlag&Aa.uvs&&this._updateUVs(),this._uvs},n._getBounds=function(){return this._dirtyFlag&Aa.positions&&this._updatePositions(),this._bounds},n._onDestroy=function(){this._texture&&(this._texture=null)},n._calDefaultSize=function(){if(this._texture){var e=this._texture,t=this._atlasRegion,n=this._atlasRegionOffset,i=this._region,r=1/br._pixelsPerUnit;this.width=e.width*t.width/(1-n.x-n.z)*i.width*r,this.height=e.height*t.height/(1-n.y-n.w)*i.height*r}},n._updatePositions=function(){var e=this._atlasRegionOffset,t=this._region,n=t.x,i=t.y,r=t.width,a=t.height,o=1-n-r,s=1-i-a,l=Math.max(e.x-n,0)/r,u=Math.max(e.w-i,0)/a,c=1-Math.max(e.z-o,0)/r,h=1-Math.max(e.y-s,0)/a,_=this._positions;_[0].set(l,u),_[1].set(c,u),_[2].set(l,h),_[3].set(c,h);var d=this._bounds,f=d.min,p=d.max;f.set(l,u,0),p.set(c,h,0),this._dirtyFlag&=~Aa.positions},n._updateUVs=function(){var e=this._uvs,t=this._atlasRegionOffset,n=this._region,i=n.x,r=n.y,a=n.width,o=n.height,s=1-i-a,l=1-r-o,u=this._atlasRegion,c=u.x,h=u.y,_=u.width,d=u.height,f=t.x,p=t.y,g=t.z,v=t.w,m=_/(1-f-g),y=d/(1-p-v),x=Math.max(i-f,0)*m+c,w=Math.max(l-p,0)*y+h,b=_+c-Math.max(s-g,0)*m,C=d+h-Math.max(r-v,0)*y,T=this._border,S=T.x,A=T.y,P=T.z,M=T.w;e[0].set(x,C),e[1].set((i-f+S*a)*m+c,d+h-(r-v+A*o)*y),e[2].set(_+c-(s-g+P*a)*m,(l-p+M*o)*y+h),e[3].set(b,w),this._dirtyFlag&=~Aa.uvs},n._dispatchSpriteChange=function(e){switch(e){case Hn.atlasRegionOffset:case Hn.region:this._dirtyFlag|=Aa.all;break;case Hn.atlasRegion:case Hn.border:this._dirtyFlag|=Aa.uvs}this._updateFlagManager.dispatch(e)},C(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._dispatchSpriteChange(Hn.texture))}},{key:"width",get:function(){return void 0===this._width&&this._calDefaultSize(),this._width},set:function(e){this._width!==e&&(this._width=e,this._dispatchSpriteChange(Hn.size))}},{key:"height",get:function(){return void 0===this._height&&this._calDefaultSize(),this._height},set:function(e){this._height!==e&&(this._height=e,this._dispatchSpriteChange(Hn.size))}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e)}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var t=a.clamp(e.x,0,1),n=a.clamp(e.y,0,1);this._atlasRegion.set(t,n,a.clamp(e.width,0,1-t),a.clamp(e.height,0,1-n)),this._dispatchSpriteChange(Hn.atlasRegion)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var t=a.clamp(e.x,0,1),n=a.clamp(e.y,0,1);this._atlasRegionOffset.set(t,n,a.clamp(e.z,0,1-t),a.clamp(e.w,0,1-n)),this._dispatchSpriteChange(Hn.atlasRegionOffset)}},{key:"region",get:function(){return this._region},set:function(e){var t=this._region,n=a.clamp(e.x,0,1),i=a.clamp(e.y,0,1);t.set(n,i,a.clamp(e.width,0,1-n),a.clamp(e.height,0,1-i)),this._dispatchSpriteChange(Hn.region)}},{key:"pivot",get:function(){return this._pivot},set:function(e){var t=this._pivot;if(t===e)this._dispatchSpriteChange(Hn.pivot);else{var n=e.x,i=e.y;t.x===n&&t.y===i||(t.set(n,i),this._dispatchSpriteChange(Hn.pivot))}}},{key:"border",get:function(){return this._border},set:function(e){var t=this._border,n=a.clamp(e.x,0,1),i=a.clamp(e.y,0,1);t.set(n,i,a.clamp(e.z,0,1-n),a.clamp(e.w,0,1-i)),this._dispatchSpriteChange(Hn.border)}}]),t}(kt);!function(e){e[e.positions=1]="positions",e[e.uvs=2]="uvs",e[e.all=3]="all"}(Aa||(Aa={}));var Fa,Ra,La,Da,Ba,Ia,Oa,za,Na,Va,Ua,ka,Ga,Ha,Wa,ja,Xa=function(e){}((Ma=function(){function e(){}return e.resetData=function(e){var t=e._renderData,n=t.positions,i=t.uvs;if(n.length<16)for(var r=n.length;r<16;r++)n.push(new o),i.push(new p);t.triangles=[]},e.updatePositions=function(t){var n,i,r=t.width,a=t.height,o=t.sprite,s=t._renderData,l=s.positions,u=s.uvs,c=s.triangles,h=o.border,_=o._getUVs(),d=o._getPositions(),f=d[0],p=f.x,g=f.y,v=d[3],m=v.x,y=v.y,x=o.width,w=o.height,b=x*h.x,C=w*h.y,T=w*h.z,S=x*h.w;if(b+T>r){var A=r/(b+T);n=[x*p*A,b*A,b*A,r-x*(1-m)*A]}else n=[x*p,b,r-T,r-x*(1-m)];if(S+C>a){var P=a/(S+C);i=[w*g*P,C*P,C*P,a-w*(1-y)*P]}else i=[w*g,C,a-S,a-w*(1-y)];var M=t.sprite.pivot,E=M.x,F=M.y,R=t.width*E,L=t.height*F,D=e._worldMatrix,B=D.elements,I=t.entity.transform.worldMatrix.elements,O=t.flipX?-1:1,z=t.flipY?-1:1;B[0]=I[0]*O,B[1]=I[1]*O,B[2]=I[2]*O,B[4]=I[4]*z,B[5]=I[5]*z,B[6]=I[6]*z,B[8]=I[8],B[9]=I[9],B[10]=I[10],B[12]=I[12]-R*B[0]-L*B[4],B[13]=I[13]-R*B[1]-L*B[5],B[14]=I[14]-R*B[2]-L*B[6];for(var N=0,V=0,U=0;U<4;U++){for(var k=n[U],G=_[U].x,H=0;H<4;H++){var W=i[H];l[N].set(B[0]*k+B[4]*W+B[12],B[1]*k+B[5]*W+B[13],B[2]*k+B[6]*W+B[14]),u[N].set(G,_[H].y),++N}++V}for(var j=N/V,X=0,K=0;K<V-1;++K)for(var q=0;q<j-1;++q){var Y=K*j+q;c[X++]=Y,c[X++]=Y+1,c[X++]=Y+j,c[X++]=Y+1,c[X++]=Y+j+1,c[X++]=Y+j}t._renderData.vertexCount=V*j,c.length=(V-1)*(j-1)*6;var Q=t._bounds,J=Q.min,Z=Q.max;J.set(n[0],i[0],0),Z.set(n[3],i[3],0),t._bounds.transform(D)},e.updateUVs=function(e){},e}(),Ma._worldMatrix=new d,Pa=Ma))||Pa,Ka=(Wa=function(e){function t(t){var n;return I(n=e.call(this,t)||this,"_renderData",Ra,L(n)),I(n,"_drawMode",La,L(n)),I(n,"_assembler",Da,L(n)),I(n,"_color",Ba,L(n)),I(n,"_sprite",Ia,L(n)),I(n,"_width",Oa,L(n)),I(n,"_height",za,L(n)),I(n,"_flipX",Na,L(n)),I(n,"_flipY",Va,L(n)),I(n,"_maskLayer",Ua,L(n)),I(n,"_maskInteraction",ka,L(n)),I(n,"_dirtyFlag",Ga,L(n)),I(n,"_spriteChangeFlag",Ha,L(n)),n._renderData=new ii(4,[],[],null,n._color),n.drawMode=Ta.Simple,n.setMaterial(n._engine._spriteDefaultMaterial),n._onSpriteChange=n._onSpriteChange.bind(L(n)),n}A(t,e);var n=t.prototype;return n._render=function(e){var t;if(null!==(t=this.sprite)&&void 0!==t&&t.texture&&this.width&&this.height){(this._transformChangeFlag.flag||this._dirtyFlag&ja.Position)&&(this._assembler.updatePositions(this),this._dirtyFlag&=~ja.Position,this._transformChangeFlag.flag=!1),this._dirtyFlag&ja.UV&&(this._assembler.updateUVs(this),this._dirtyFlag&=~ja.UV);var n=this._engine._spriteElementPool.getFromPool();n.setValue(this,this._renderData,this.getMaterial(),this.sprite.texture),e._renderPipeline.pushPrimitive(n)}},n._cloneTo=function(e){e.sprite=this._sprite},n._onDestroy=function(){this._color=null,this._sprite=null,this._assembler=null,this._renderData=null,this._spriteChangeFlag&&(this._spriteChangeFlag.destroy(),this._spriteChangeFlag=null),e.prototype._onDestroy.call(this)},n._updateStencilState=function(){var e=this.getInstanceMaterial().renderState.stencilState,t=this._maskInteraction;if(t===hn.None)e.enabled=!1,e.writeMask=255,e.referenceValue=0,e.compareFunctionFront=e.compareFunctionBack=rn.Always;else{e.enabled=!0,e.writeMask=0,e.referenceValue=1;var n=t===hn.VisibleInsideMask?rn.LessEqual:rn.Greater;e.compareFunctionFront=n,e.compareFunctionBack=n}},n._onSpriteChange=function(e){switch(e){case Hn.texture:this.shaderData.setTexture(t._textureProperty,this.sprite.texture);break;case Hn.size:this._drawMode===Ta.Sliced&&(this._dirtyFlag|=ja.Position);break;case Hn.border:this._drawMode===Ta.Sliced&&(this._dirtyFlag|=ja.All);break;case Hn.region:case Hn.atlasRegionOffset:this._dirtyFlag|=ja.All;break;case Hn.atlasRegion:this._dirtyFlag|=ja.UV;break;case Hn.pivot:this._dirtyFlag|=ja.Position}},C(t,[{key:"drawMode",get:function(){return this._drawMode},set:function(e){if(this._drawMode!==e){switch(this._drawMode=e,e){case Ta.Simple:this._assembler=ni;break;case Ta.Sliced:this._assembler=Xa}this._assembler.resetData(this),this._dirtyFlag|=ja.All}}},{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._sprite=e,this._spriteChangeFlag&&this._spriteChangeFlag.destroy(),e?(this._spriteChangeFlag=e._registerUpdateFlag(),this._spriteChangeFlag.listener=this._onSpriteChange,this._dirtyFlag|=ja.All,this.shaderData.setTexture(t._textureProperty,e.texture)):(this._spriteChangeFlag=null,this.shaderData.setTexture(t._textureProperty,null)))}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"width",get:function(){return void 0===this._width&&this._sprite&&(this.width=this._sprite.width),this._width},set:function(e){this._width!==e&&(this._width=e,this._dirtyFlag|=ja.Position)}},{key:"height",get:function(){return void 0===this._height&&this._sprite&&(this.height=this._sprite.height),this._height},set:function(e){this._height!==e&&(this._height=e,this._dirtyFlag|=ja.Position)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyFlag|=ja.Position)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyFlag|=ja.Position)}},{key:"bounds",get:function(){var e;return null!==(e=this.sprite)&&void 0!==e&&e.texture&&this.width&&this.height?((this._transformChangeFlag.flag||this._dirtyFlag&ja.Position)&&(this._assembler.updatePositions(this),this._dirtyFlag&=~ja.Position,this._transformChangeFlag.flag=!1),this._bounds):br._defaultBoundingBox}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._updateStencilState())}}]),t}(Gn),Wa._textureProperty=Zt.getPropertyByName("u_spriteTexture"),Ra=O((Fa=Wa).prototype,"_renderData",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),La=O(Fa.prototype,"_drawMode",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Da=O(Fa.prototype,"_assembler",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ba=O(Fa.prototype,"_color",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v(1,1,1,1)}}),Ia=O(Fa.prototype,"_sprite",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oa=O(Fa.prototype,"_width",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),za=O(Fa.prototype,"_height",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Na=O(Fa.prototype,"_flipX",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Va=O(Fa.prototype,"_flipY",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ua=O(Fa.prototype,"_maskLayer",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.Layer0}}),ka=O(Fa.prototype,"_maskInteraction",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hn.None}}),Ga=O(Fa.prototype,"_dirtyFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ha=O(Fa.prototype,"_spriteChangeFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fa);!function(e){e[e.Position=1]="Position",e[e.UV=2]="UV",e[e.All=3]="All"}(ja||(ja={}));var qa=function(e){function t(t){var n;return(n=e.call(this,t)||this)._charInfoMap={},n._texture=void 0,n._space=1,n._curX=1,n._curY=1,n._nextY=1,n}A(t,e);var n=t.prototype;return n._onDestroy=function(){this._texture.destroy(),this._texture=null,this._charInfoMap={}},n.uploadCharTexture=function(e){var t=e.w,n=e.h,i=e.data,r=this._space,a=this.texture,o=a.width,s=t+r,l=n+r;if(1+s>=o||1+l>=o)throw Error("The char fontSize is too large.");this._curX+s>=o&&(this._curX=r,this._curY=this._nextY+r);var u=this._curY+l;if(u>this._nextY&&(this._nextY=u),u>=o)return!1;t>0&&n>0&&i&&(a.setPixelBuffer(i,0,this._curX,this._curY,t,n),a.generateMipmaps());var c=1/o,h=this._curX,_=this._curY,d=h*c,f=(h+t)*c,p=_*c,g=(_+n)*c;e.x=h,e.y=_;var v=e.uvs;return v[0].set(d,p),v[1].set(f,p),v[2].set(f,g),v[3].set(d,g),this._curX+=s+r,!0},n.addCharInfo=function(e,t){this._charInfoMap[e.charCodeAt(0)]=t},n.getCharInfo=function(e){return this._charInfoMap[e.charCodeAt(0)]},C(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}}]),t}(kt),Ya=function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this,t)||this)._name="",i._fontAtlases=[],i._lastIndex=-1,i._name=n,i}A(t,e),t.createFromOS=function(e,n){void 0===n&&(n="");var i=t._fontMap,r=i[n];return r||(r=new t(e,n),i[n]=r,r)};var n=t.prototype;return n._uploadCharTexture=function(e){var t=this._fontAtlases,n=this._lastIndex;-1===n&&(this._createFontAtlas(),n++);var i=t[n];i.uploadCharTexture(e)||((i=this._createFontAtlas()).uploadCharTexture(e),n++),this._lastIndex=n,e.data=null},n._addCharInfo=function(e,t){var n=this._lastIndex;t.index=n,this._fontAtlases[n].addCharInfo(e,t)},n._getCharInfo=function(e){for(var t=this._fontAtlases,n=0,i=t.length;n<i;++n){var r=t[n].getCharInfo(e);if(r)return r}return null},n._getTextureByIndex=function(e){var t=this._fontAtlases[e];return t?t.texture:null},n._getLastIndex=function(){return this._lastIndex},n._onDestroy=function(){for(var e=this._fontAtlases,n=0,i=e.length;n<i;++n)e[n].destroy(!0);e.length=0,delete t._fontMap[this._name]},n._createFontAtlas=function(){var e=this.engine,t=new qa(e),n=new Si(e,256,256);return t.texture=n,this._fontAtlases.push(t),t},C(t,[{key:"name",get:function(){return this._name}}]),t}(kt);Ya._fontMap={};var Qa=function e(){this.texture=void 0,this.localPositions=new g,this.renderData=void 0;var t=[new o,new o,new o,new o];this.renderData=new ii(4,t,null,e.triangles,null)};Qa.triangles=[0,2,1,2,0,3];var Ja,Za,$a,eo,to,no,io,ro,ao,oo,so,lo,uo,co,ho,_o,fo,po,go,vo,mo,yo=function(){function e(e,t){this._elements=[],this._type=void 0,this._type=e;for(var n=this._elements,i=0;i<t;++i)n[i]=new e}var t=e.prototype;return t.get=function(){return this._elements.length>0?this._elements.pop():new this._type},t.put=function(e){this._elements.push(e)},e}(),xo=function(){function e(){}return e.textContext=function(){var t=e._textContext;if(!t){var i;try{i=new n.polyfill.OffscreenCanvas(0,0)}catch(e){i=n.polyfill.document.createElement("canvas")}var r=i.getContext("2d");t={canvas:i,context:r},e._textContext=t}return t},e.measureFont=function(t){var n=e._fontSizeInfoCache,i=n[t];return i||(i=e._measureFontOrChar(t),n[t]=i,i)},e.getNativeFontString=function(t,n,i){var r=i&ba.Bold?"bold ":"";return i&ba.Italic&&(r+="italic "),/([\"\'])[^\'\"]+\1/.test(t)||-1!=e._genericFontFamilies.indexOf(t)||(t='"'+t+'"'),r+=n+"px "+t},e.measureChar=function(t,n){return e._measureFontOrChar(n,t)},e.measureTextWithWrap=function(t){for(var n=t.fontSize,i=t.fontStyle,r=t.font.name,a=e.getNativeFontString(r,n,i),o=t._styleFont,s=e.measureFont(a),l=t.text.split(/(?:\r\n|\r|\n)/),u=new Array,c=new Array,h=new Array,_=br._pixelsPerUnit,d=s.size+t.lineSpacing*_,f=t.width*_,p=0,g=l.length;p<g;++p){for(var v=l[p],m="",y=0,x=-1,w=-1,b=0,C=v.length;b<C;++b){var T=v[b],S=e._getCharInfo(T,a,o),A=S.w,P=S.offsetY,M=.5*S.h,E=M+P,F=M-P;y+A>f?0===y?(u.push(T),c.push(A),h.push({ascent:E,descent:F,size:E+F})):(u.push(m),c.push(y),h.push({ascent:x,descent:w,size:x+w}),m=T,y=S.xAdvance,x=E,w=F):(m+=T,y+=S.xAdvance,x<E&&(x=E),w<F&&(w=F))}y>0&&(u.push(m),c.push(y),h.push({ascent:x,descent:w,size:x+w}))}var R=t.height*_;return t.overflowMode===wa.Overflow&&(R=d*u.length),{width:0,height:R,lines:u,lineWidths:c,lineHeight:d,lineMaxSizes:h}},e.measureTextWithoutWrap=function(t){var n=t.fontSize,i=t.fontStyle,r=t.font.name,a=e.getNativeFontString(r,n,i),o=t._styleFont,s=e.measureFont(a),l=t.text.split(/(?:\r\n|\r|\n)/),u=l.length,c=new Array,h=new Array,_=br._pixelsPerUnit,d=s.size+t.lineSpacing*_,f=0,p=t.height*_;t.overflowMode===wa.Overflow&&(p=d*u);for(var g=0;g<u;++g){for(var v=l[g],m=0,y=-1,x=-1,w=0,b=v.length;w<b;++w){var C=e._getCharInfo(v[w],a,o);m+=C.xAdvance;var T=C.offsetY,S=.5*C.h,A=S+T,P=S-T;y<A&&(y=A),x<P&&(x=P)}c[g]=m,h[g]={ascent:y,descent:x,size:y+x},m>f&&(f=m)}return{width:f,height:p,lines:l,lineWidths:c,lineHeight:d,lineMaxSizes:h}},e.getNativeFontHash=function(t,n,i){var r=i&ba.Bold?"bold":"";return i&ba.Italic&&(r+="italic"),/([\"\'])[^\'\"]+\1/.test(t)||-1!=e._genericFontFamilies.indexOf(t)||(t=""+t),r+=n+"px"+t},e._measureFontOrChar=function(t,n){void 0===n&&(n="");var i=e.textContext(),r=i.canvas,a=i.context;a.font=t;var o=n||e._measureString,s=Math.round(a.measureText(o).width),l=Math.ceil(a.measureText(e._measureBaseline).width),u=l*e._heightMultiplier;l=e._baselineMultiplier*l|0,r.width=s,r.height=u,a.font=t,a.fillStyle="#000",a.clearRect(0,0,s,u),a.textBaseline="middle",a.fillStyle="#fff",a.fillText(o,0,l);for(var c,h=a.getImageData(0,0,s,u).data,_=h.length,d=-1,f=-1,g=0,v=0,m=0,y=r.width,x=1/y,w=0;w<_;w+=4){if(0!==h[w+3])c=~~(.25*w*x),-1===d&&(d=c),c>f&&(f=c)}-1!==d&&-1!==f&&(m=(g=l-d)+(v=f-l+1));var b={ascent:g,descent:v,size:m};if(n){var C=null;if(m>0){var T=4*y;C=new Uint8Array(h.buffer,d*T,m*T)}return{x:0,y:0,w:s,h:m,offsetX:0,offsetY:.5*(g-v),xAdvance:s,uvs:[new p,new p,new p,new p],ascent:g,descent:v,index:0,data:C}}return b},e._getCharInfo=function(t,n,i){var r=i._getCharInfo(t);return r||(r=e.measureChar(t,n),i._uploadCharTexture(r),i._addCharInfo(t,r)),r},e}();xo._genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui","math","emoji","fangsong"],xo._measureString="|ÉqÅ",xo._measureBaseline="M",xo._heightMultiplier=2,xo._baselineMultiplier=1.4,xo._fontSizeInfoCache={},xo._textContext=null;var wo,bo=(mo=function(e){function t(t){var n;I(n=e.call(this,t)||this,"_styleFont",Za,L(n)),I(n,"_charRenderDatas",$a,L(n)),I(n,"_dirtyFlag",eo,L(n)),I(n,"_isWorldMatrixDirty",to,L(n)),I(n,"_color",no,L(n)),I(n,"_text",io,L(n)),I(n,"_width",ro,L(n)),I(n,"_height",ao,L(n)),I(n,"_localBounds",oo,L(n)),I(n,"_font",so,L(n)),I(n,"_fontSize",lo,L(n)),I(n,"_fontStyle",uo,L(n)),I(n,"_lineSpacing",co,L(n)),I(n,"_horizontalAlignment",ho,L(n)),I(n,"_verticalAlignment",_o,L(n)),I(n,"_enableWrapping",fo,L(n)),I(n,"_overflowMode",po,L(n)),I(n,"_maskInteraction",go,L(n)),I(n,"_maskLayer",vo,L(n));var i=L(n).engine;return n._isWorldMatrixDirty=t.transform._registerWorldChangeListener(),n._isWorldMatrixDirty.listener=function(){n._setDirtyFlagTrue(wo.WorldPosition|wo.WorldBounds)},n.font=Ya.createFromOS(i),n.setMaterial(i._spriteDefaultMaterial),n}A(t,e);var n=t.prototype;return n._render=function(e){if(!(""===this._text||this.enableWrapping&&this.width<=0||this.overflowMode===wa.Truncate&&this.height<=0)){this._isContainDirtyFlag(wo.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(wo.MaskInteraction)),this._isContainDirtyFlag(wo.StyleFont)&&(this._resetStyleFont(),this._setDirtyFlagFalse(wo.StyleFont)),this._isContainDirtyFlag(wo.LocalPositionBounds)&&(this._updateLocalData(),this._setDirtyFlagFalse(wo.LocalPositionBounds)),this._isContainDirtyFlag(wo.WorldPosition)&&(this._updatePosition(),this._setDirtyFlagFalse(wo.WorldPosition));var t=this._engine._spriteElementPool,n=this._engine._textElementPool.getFromPool(),i=n.charElements,r=this.getMaterial(),a=this._charRenderDatas,o=a.length;n.component=this,n.material=r,i.length=o;for(var s=0;s<o;++s){var l=a[s],u=t.getFromPool();u.setValue(this,l.renderData,r,l.texture),i[s]=u}e._renderPipeline.pushPrimitive(n)}},n._onDestroy=function(){for(var n=this._charRenderDatas,i=0,r=n.length;i<r;++i)t._charRenderDataPool.put(n[i]);n.length=0,this._isWorldMatrixDirty.destroy(),e.prototype._onDestroy.call(this)},n._cloneTo=function(e){e.font=this._font},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._updateBounds=function(e){s.transform(this._localBounds,this._entity.transform.worldMatrix,e)},n._updateStencilState=function(){var e=this.getInstanceMaterial().renderState.stencilState,t=this._maskInteraction;if(t===hn.None)e.enabled=!1,e.writeMask=255,e.referenceValue=0,e.compareFunctionFront=e.compareFunctionBack=rn.Always;else{e.enabled=!0,e.writeMask=0,e.referenceValue=1;var n=t===hn.VisibleInsideMask?rn.LessEqual:rn.Greater;e.compareFunctionFront=n,e.compareFunctionBack=n}},n._resetStyleFont=function(){var e=this._styleFont;e&&(e._addRefCount(-1),e.destroy()),this._styleFont=Ya.createFromOS(this.engine,xo.getNativeFontHash(this.font.name,this.fontSize,this.fontStyle)),this._styleFont._addRefCount(1)},n._updatePosition=function(){for(var e=this.entity.transform.worldMatrix.elements,n=this._charRenderDatas,i=e[0],r=e[1],a=e[2],s=e[4],l=e[5],u=e[6],c=e[12],h=e[13],_=e[14],d=t._tempVec31.set(s,l,u),f=t._tempVec30.set(i,r,a),p=0,g=n.length;p<g;++p){var v=n[p],m=v.localPositions,y=v.renderData.positions,x=m.x,w=m.y,b=y[0];b.x=x*i+w*s+c,b.y=x*r+w*l+h,b.z=x*a+w*u+_;var C=y[1];o.scale(f,m.z-x,C),o.add(b,C,C);var T=y[2];o.scale(d,m.w-w,T),o.add(b,T,y[3]),o.add(C,T,T)}},n._updateLocalData=function(){var e=this.color,n=this.horizontalAlignment,i=this.verticalAlignment,r=this._charRenderDatas,a=this._localBounds,o=a.min,s=a.max;o.set(0,0,0),s.set(0,0,0);var l=br._pixelsPerUnit,u=1/l,c=this._styleFont,h=.5*(this.width*l),_=this.height*l,d=this.enableWrapping?xo.measureTextWithWrap(this):xo.measureTextWithoutWrap(this),f=d.height,p=d.lines,g=d.lineWidths,v=d.lineHeight,m=d.lineMaxSizes,y=t._charRenderDataPool,x=.5*v,w=p.length,b=0,C=.5*v-m[0].ascent,T=.5*v-m[w-1].descent-1;switch(i){case xa.Top:b=.5*_-x+C;break;case xa.Center:b=.5*f-x-.5*(T-C);break;case xa.Bottom:b=f-.5*_-x-T}for(var S=0,A=Number.MAX_SAFE_INTEGER,P=Number.MAX_SAFE_INTEGER,M=Number.MIN_SAFE_INTEGER,E=Number.MIN_SAFE_INTEGER,F=w-1,R=0;R<w;++R){var L=p[R],D=g[R],B=0;switch(n){case ya.Left:B=-h;break;case ya.Center:B=.5*-D;break;case ya.Right:B=h-D}for(var I=0,O=L.length-1;I<=O;++I){var z=L[I],N=c._getCharInfo(z);if(N.h>0){var V=r[S]||y.get(),U=V.renderData,k=V.localPositions;V.texture=c._getTextureByIndex(N.index),U.color=e,U.uvs=N.uvs;var G=B*u,H=(B+N.w)*u,W=(b+N.ascent)*u,j=(b-N.descent+1)*u;k.set(G,W,H,j),r[S]=V,S++,0===R&&(E=Math.max(E,W)),R===F&&(P=Math.min(P,j)),0===I&&(A=Math.min(A,G)),I===O&&(M=Math.max(M,H))}B+=N.xAdvance}b-=v}o.set(A,P,0),s.set(M,E,0);var X=r.length;if(X>S){for(var K=S;K<X;++K)y.put(r[K]);r.length=S}c._getLastIndex()>0&&r.sort((function(e,t){return e.texture.instanceId-t.texture.instanceId}))},C(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"text",get:function(){return this._text},set:function(e){e=e||"",this._text!==e&&(this._text=e,this._setDirtyFlagTrue(wo.Position))}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._setDirtyFlagTrue(wo.Position))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._setDirtyFlagTrue(wo.Position))}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._setDirtyFlagTrue(wo.Font))}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._setDirtyFlagTrue(wo.Font))}},{key:"fontStyle",get:function(){return this._fontStyle},set:function(e){this.fontStyle!==e&&(this._fontStyle=e,this._setDirtyFlagTrue(wo.Font))}},{key:"lineSpacing",get:function(){return this._lineSpacing},set:function(e){this._lineSpacing!==e&&(this._lineSpacing=e,this._setDirtyFlagTrue(wo.Position))}},{key:"horizontalAlignment",get:function(){return this._horizontalAlignment},set:function(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._setDirtyFlagTrue(wo.Position))}},{key:"verticalAlignment",get:function(){return this._verticalAlignment},set:function(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._setDirtyFlagTrue(wo.Position))}},{key:"enableWrapping",get:function(){return this._enableWrapping},set:function(e){this._enableWrapping!==e&&(this._enableWrapping=e,this._setDirtyFlagTrue(wo.Position))}},{key:"overflowMode",get:function(){return this._overflowMode},set:function(e){this._overflowMode!==e&&(this._overflowMode=e,this._setDirtyFlagTrue(wo.Position))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(wo.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"bounds",get:function(){return this._isContainDirtyFlag(wo.StyleFont)&&this._resetStyleFont(),this._isContainDirtyFlag(wo.LocalPositionBounds)&&this._updateLocalData(),this._isContainDirtyFlag(wo.WorldPosition)&&this._updatePosition(),this._isContainDirtyFlag(wo.WorldBounds)&&this._updateBounds(this._bounds),this._setDirtyFlagFalse(wo.Font),this._bounds}}]),t}(Gn),mo._charRenderDataPool=new yo(Qa,50),mo._tempVec30=new o,mo._tempVec31=new o,Za=O((Ja=mo).prototype,"_styleFont",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$a=O(Ja.prototype,"_charRenderDatas",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eo=O(Ja.prototype,"_dirtyFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wo.Font}}),to=O(Ja.prototype,"_isWorldMatrixDirty",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),no=O(Ja.prototype,"_color",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v(1,1,1,1)}}),io=O(Ja.prototype,"_text",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ro=O(Ja.prototype,"_width",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ao=O(Ja.prototype,"_height",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oo=O(Ja.prototype,"_localBounds",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s}}),so=O(Ja.prototype,"_font",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lo=O(Ja.prototype,"_fontSize",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 24}}),uo=O(Ja.prototype,"_fontStyle",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ba.None}}),co=O(Ja.prototype,"_lineSpacing",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ho=O(Ja.prototype,"_horizontalAlignment",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ya.Center}}),_o=O(Ja.prototype,"_verticalAlignment",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xa.Center}}),fo=O(Ja.prototype,"_enableWrapping",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),po=O(Ja.prototype,"_overflowMode",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wa.Overflow}}),go=O(Ja.prototype,"_maskInteraction",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hn.None}}),vo=O(Ja.prototype,"_maskLayer",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wn.Layer0}}),Ja);!function(e){e[e.StyleFont=1]="StyleFont",e[e.LocalPositionBounds=2]="LocalPositionBounds",e[e.WorldPosition=4]="WorldPosition",e[e.WorldBounds=8]="WorldBounds",e[e.MaskInteraction=16]="MaskInteraction",e[e.Position=14]="Position",e[e.Font=15]="Font"}(wo||(wo={}));var Co,To=function(){this.relativePath=void 0,this.type=void 0,this.property=void 0,this.curve=void 0},So=function(){this.time=void 0,this.functionName=void 0,this.parameter=void 0};!function(e){e[e.Position=0]="Position",e[e.Rotation=1]="Rotation",e[e.Scale=2]="Scale",e[e.BlendShapeWeights=3]="BlendShapeWeights"}(Co||(Co={}));var Ao,Po=function(e){function t(t){var n;return(n=e.call(this)||this).name=t,n._curveBindings=[],n._length=0,n._events=[],n}A(t,e);var n=t.prototype;return n.addEvent=function(e,t,n){if("string"==typeof e){var i=new So;i.functionName=e,i.time=t,i.parameter=n,this._events.push(i)}else this._events.push(e);this._events.sort((function(e,t){return e.time-t.time}))},n.clearEvents=function(){this._events.length=0},n.addCurveBinding=function(e,t,n,i){var r;switch(n){case"position":r=Co.Position;break;case"rotation":r=Co.Rotation;break;case"scale":r=Co.Scale;break;case"blendShapeWeights":r=Co.BlendShapeWeights}var a=new To;a.relativePath=e,a.type=t,a.property=r,a.curve=i,i.length>this._length&&(this._length=i.length),this._curveBindings.push(a)},n.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},n._sampleAnimation=function(e,t){for(var n=this._curveBindings.length-1;n>=0;n--){var i=this._curveBindings[n],r=i.curve,a=i.property,o=i.relativePath,s=i.type,l=r.evaluate(t),u=e.findByName(o).transform;if(s===Ze)switch(a){case Co.Position:u.position=l;break;case Co.Rotation:u.rotationQuaternion=l;break;case Co.Scale:u.scale=l}}},C(t,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),t}((function(){}));!function(e){e[e.Float=0]="Float",e[e.FloatArray=1]="FloatArray",e[e.Vector2=2]="Vector2",e[e.Vector3=3]="Vector3",e[e.Vector4=4]="Vector4",e[e.Quaternion=5]="Quaternion"}(Ao||(Ao={}));var Mo,Eo,Fo,Ro=function(){function e(){}return e.scaleWeight=function(e,t,n){var i=e.x,r=e.y,a=e.z;n.x=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),n.y=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t),n.z=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t)},e.scaleBlend=function(t,n,i,r){var a=e._tempVector30,o=e._tempVector31;e.scaleWeight(t,1-i,a),e.scaleWeight(n,i,o);var s=i>.5?n:t;r.x=s.x>0?Math.abs(a.x*o.x):-Math.abs(a.x*o.x),r.y=s.y>0?Math.abs(a.y*o.y):-Math.abs(a.y*o.y),r.z=s.z>0?Math.abs(a.z*o.z):-Math.abs(a.z*o.z)},e.quaternionWeight=function(e,t,n){n.x=e.x*t,n.y=e.y*t,n.z=e.z*t,n.w=e.w},e}();Ro._tempVector30=new o,Ro._tempVector31=new o,function(e){e[e.Override=0]="Override",e[e.Additive=1]="Additive"}(Mo||(Mo={})),function(e){e[e.UnStarted=0]="UnStarted",e[e.Playing=1]="Playing",e[e.Finished=2]="Finished"}(Eo||(Eo={})),function(e){e[e.Standby=0]="Standby",e[e.Playing=1]="Playing",e[e.CrossFading=2]="CrossFading",e[e.FixedCrossFading=3]="FixedCrossFading"}(Fo||(Fo={}));var Lo,Do=function(){function e(e,t,n){switch(this.crossCurveMark=0,this.crossCurveIndex=void 0,this.target=void 0,this.type=void 0,this.property=void 0,this.component=void 0,this.defaultValue=void 0,this.fixedPoseValue=void 0,this._hasSavedDefaultValue=!1,this.target=e,this.type=t,this.property=n,n){case Co.Position:this.defaultValue=new o,this.fixedPoseValue=new o,this.component=e.transform;break;case Co.Rotation:this.defaultValue=new _,this.fixedPoseValue=new _,this.component=e.transform;break;case Co.Scale:this.defaultValue=new o,this.fixedPoseValue=new o,this.component=e.transform;break;case Co.BlendShapeWeights:this.component=e.getComponent(qi);var i=this.component.blendShapeWeights.length;this.defaultValue=new Float32Array(i),this.fixedPoseValue=new Float32Array(i)}}var t=e.prototype;return t.saveDefaultValue=function(){switch(this.property){case Co.Position:this.defaultValue.copyFrom(this.target.transform.position);break;case Co.Rotation:this.defaultValue.copyFrom(this.target.transform.rotationQuaternion);break;case Co.Scale:this.defaultValue.copyFrom(this.target.transform.scale);break;case Co.BlendShapeWeights:for(var e=this.component.blendShapeWeights,t=0,n=e.length;t<n;++t)this.defaultValue[t]=e[t]}this._hasSavedDefaultValue=!0},t.saveFixedPoseValue=function(){switch(this.property){case Co.Position:this.fixedPoseValue.copyFrom(this.target.transform.position);break;case Co.Rotation:this.fixedPoseValue.copyFrom(this.target.transform.rotationQuaternion);break;case Co.Scale:this.fixedPoseValue.copyFrom(this.target.transform.scale);break;case Co.BlendShapeWeights:for(var e=0,t=this.component.blendShapeWeights.length;e<t;++e)this.fixedPoseValue[e]=this.component.blendShapeWeights[e]}},e}(),Bo=function(){this.event=void 0,this.handlers=[]},Io=function(){this.duration=0,this.offset=0,this.exitTime=1,this.destinationState=void 0};!function(e){e[e.Once=0]="Once",e[e.Loop=1]="Loop"}(Lo||(Lo={}));var Oo,zo,No,Vo,Uo,ko,Go,Ho,Wo,jo,Xo,Ko,qo=function(){function e(){this.state=void 0,this.stateData=void 0,this.frameTime=void 0,this.playState=void 0,this.clipTime=void 0,this.currentEventIndex=void 0}var t=e.prototype;return t.reset=function(e,t,n){this.state=e,this.frameTime=n,this.stateData=t,this.playState=Eo.UnStarted,this.clipTime=e.clipStartTime*e.clip.length,this.currentEventIndex=0},t.update=function(e){var t=this.state,n=this.frameTime,i=t._getDuration();this.playState=Eo.Playing,t.wrapMode===Lo.Loop?n=i?n%i:0:Math.abs(n)>i&&(n=n<0?-i:i,this.playState=Eo.Finished),e&&0===n?this.clipTime=t.clipEndTime*t.clip.length:(n<0&&(n+=i),this.clipTime=n+t.clipStartTime*t.clip.length)},e}(),Yo=function(){function e(){this.animatorStateDataMap={},this.srcPlayData=new qo,this.destPlayData=new qo,this.layerState=Fo.Standby,this.crossCurveMark=0,this.manuallyTransition=new Io,this.crossFadeTransition=void 0}return e.prototype.switchPlayData=function(){var e=this.destPlayData,t=this.srcPlayData;this.srcPlayData=e,this.destPlayData=t},e}(),Qo=function(){this.curveOwners=[],this.eventHandlers=[]},Jo=function(){this.curveOwner=void 0,this.srcCurveIndex=void 0,this.destCurveIndex=void 0},Zo=function(){function e(){this.vector2=new p,this.vector3=new o,this.vector4=new g,this.quaternion=new _,this._floatArrayPool=[]}return e.prototype.getFloatArray=function(e){var t=this._floatArrayPool[e];return t||(this._floatArrayPool[e]=t=new Float32Array(e)),t},e}(),$o=(Xo=function(e){function t(t){var n;return(n=e.call(this,t)||this)._animatorController=void 0,I(n,"_speed",zo,L(n)),I(n,"_controllerUpdateFlag",No,L(n)),I(n,"_animatorLayersData",Vo,L(n)),I(n,"_crossCurveDataCollection",Uo,L(n)),I(n,"_animationCurveOwners",ko,L(n)),I(n,"_crossCurveDataPool",Go,L(n)),I(n,"_animationEventHandlerPool",Ho,L(n)),I(n,"_baseTempValue",Wo,L(n)),I(n,"_crossTempValue",jo,L(n)),n}A(t,e);var n=t.prototype;return n.play=function(e,n,i){var r;void 0===n&&(n=-1),void 0===i&&(i=0),null!==(r=this._controllerUpdateFlag)&&void 0!==r&&r.flag&&this._clearPlayData();var a=this._getAnimatorStateInfo(e,n,t._animatorInfo),o=a.state;if(o)if(o.clip){var s=this._getAnimatorLayerData(a.layerIndex),l=s.srcPlayData,u=l.state;u&&u!==o&&this._revertDefaultValue(l.state,l.stateData);var c=this._getAnimatorStateData(e,o,s);s.layerState=Fo.Playing,l.reset(o,c,o._getDuration()*i),this._saveDefaultValues(c)}else console.warn("The state named "+e+" has no AnimationClip data.")},n._reset=function(){var e=this._animatorController;if(e)for(var t=e.layers,n=0,i=t.length;n<i;++n)for(var r=t[n].stateMachine.states,a=this._getAnimatorLayerData(n),o=0,s=r.length;o<s;++o){var l=r[o],u=this._getAnimatorStateData(l.name,l,a);this._revertDefaultValue(l,u)}this._clearPlayData()},n.crossFade=function(e,n,i,r){var a;void 0===i&&(i=-1),void 0===r&&(r=0),null!==(a=this._controllerUpdateFlag)&&void 0!==a&&a.flag&&this._clearPlayData();var o=this._getAnimatorStateInfo(e,i,t._animatorInfo).state,s=this._getAnimatorLayerData(i).manuallyTransition;s.duration=n,s.offset=r,s.destinationState=o,this._crossFadeByTransition(s,i)},n.update=function(e){var t;if(0!==this.speed){var n=this._animatorController;if(n&&(null===(t=this._controllerUpdateFlag)||void 0===t||!t.flag)){e*=this.speed;for(var i=0,r=n.layers.length;i<r;i++){this._getAnimatorLayerData(i).layerState!==Fo.Standby&&this._updateLayer(i,0===i,e/1e3)}}}},n.getCurrentAnimatorState=function(e){var t,n;return null===(t=this._animatorLayersData[e])||void 0===t||null===(n=t.srcPlayData)||void 0===n?void 0:n.state},n._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},n._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},n._getAnimatorStateInfo=function(e,t,n){var i=null,r=this._animatorController;if(r){var a=r.layers;if(-1===t){for(var o=0,s=a.length;o<s;o++)if(i=a[o].stateMachine.findStateByName(e)){t=o;break}}else i=a[t].stateMachine.findStateByName(e)}return n.layerIndex=t,n.state=i,n},n._saveDefaultValues=function(e){for(var t=e.curveOwners,n=t.length-1;n>=0;n--)t[n].saveDefaultValue()},n._getAnimatorStateData=function(e,t,n){var i=n.animatorStateDataMap,r=i[e];return r||(r=new Qo,i[e]=r,this._saveAnimatorStateData(t,r),this._saveAnimatorEventHandlers(t,r)),r},n._saveAnimatorStateData=function(e,t){for(var n=this.entity,i=this._animationCurveOwners,r=t.curveOwners,a=e.clip._curveBindings,o=a.length-1;o>=0;o--){var s=a[o],l=""===s.relativePath?n:n.findByPath(s.relativePath),u=s.property,c=l.instanceId,h=i[c]||(i[c]=[]);r[o]=h[u]||(h[u]=new Do(l,s.type,u))}},n._saveAnimatorEventHandlers=function(e,t){var n=this._animationEventHandlerPool,i=this._entity._scripts,r=i.length,a=t.eventHandlers,o=e.clip.events;a.length=0;for(var s=0,l=o.length;s<l;s++){var u=o[s],c=n.getFromPool(),h=u.functionName,_=c.handlers;c.event=u,_.length=0;for(var d=r-1;d>=0;d--){var f=i.get(d)[h];f&&_.push(f)}a.push(c)}},n._clearCrossData=function(e){e.crossCurveMark++,this._crossCurveDataCollection.length=0,this._crossCurveDataPool.resetPool()},n._addCrossCurveData=function(e,t,n,i){var r=this._crossCurveDataPool.getFromPool();r.curveOwner=t,r.srcCurveIndex=n,r.destCurveIndex=i,e.push(r)},n._prepareCrossFading=function(e){var t=this._crossCurveDataCollection,n=e.crossCurveMark;this._prepareSrcCrossData(t,e.srcPlayData,n,!1),this._prepareDestCrossData(t,e.destPlayData,n,!1)},n._prepareStandbyCrossFading=function(e){var t=this._crossCurveDataCollection,n=e.srcPlayData,i=e.crossCurveMark;n.state&&this._prepareSrcCrossData(t,n,i,!0),this._prepareDestCrossData(t,e.destPlayData,i,!0)},n._prepareFixedPoseCrossFading=function(e){for(var t=this._crossCurveDataCollection,n=t.length-1;n>=0;n--){var i=t[n];i.curveOwner.saveFixedPoseValue(),i.destCurveIndex=-1}this._prepareDestCrossData(t,e.destPlayData,e.crossCurveMark,!0)},n._prepareSrcCrossData=function(e,t,n,i){for(var r=t.stateData.curveOwners,a=r.length-1;a>=0;a--){var o=r[a];o.crossCurveMark=n,o.crossCurveIndex=e.length,i&&o.saveFixedPoseValue(),this._addCrossCurveData(e,o,a,-1)}},n._prepareDestCrossData=function(e,t,n,i){for(var r=t.stateData.curveOwners,a=r.length-1;a>=0;a--){var o=r[a];o.crossCurveMark===n?e[o.crossCurveIndex].destCurveIndex=a:(o.saveDefaultValue(),i&&o.saveFixedPoseValue(),o.crossCurveMark=n,o.crossCurveIndex=e.length,this._addCrossCurveData(e,o,-1,a))}},n._evaluateCurve=function(e,n,i,r,a){var s;switch(r&&(s=n.keys[0].value),n._valueType){case Ao.Float:var l=n.evaluate(i);return r?l-s:l;case Ao.FloatArray:var u=a.getFloatArray(n._valueSize);if(n._evaluate(i,u),r)for(var c=0,h=u.length;c<h;c++)u[c]=u[c]-s[c];return u;case Ao.Vector2:var d=a.vector2;return n._evaluate(i,d),r&&(e===Co.Scale?p.divide(d,s,d):p.subtract(d,s,d)),d;case Ao.Vector3:var f=a.vector3;return n._evaluate(i,f),r&&(e===Co.Scale?o.divide(f,s,f):o.subtract(f,s,f)),f;case Ao.Vector4:var v=a.vector4;return n._evaluate(i,v),r&&g.subtract(v,s,v),v;case Ao.Quaternion:var m=a.quaternion;if(n._evaluate(i,m),r){var y=t._tempQuat;_.conjugate(s,y),_.multiply(y,m,m)}return m}},n._getAnimatorLayerData=function(e){var t=this._animatorLayersData[e];return t||(this._animatorLayersData[e]=t=new Yo),t},n._updateLayer=function(e,t,n){var i=this._animatorController.layers[e],r=i.blendingMode,a=i.weight,o=this._animatorLayersData[e],s=o.srcPlayData,l=o.destPlayData,u=o.crossFadeTransition,c=r===Mo.Additive,h=t?1:a;switch(o.layerState!==Fo.FixedCrossFading&&this._checkTransition(s,u,e),o.layerState){case Fo.Playing:this._updatePlayingState(s,o,e,h,n,c);break;case Fo.FixedCrossFading:this._updateCrossFadeFromPose(l,o,e,h,n,c);break;case Fo.CrossFading:this._updateCrossFade(s,l,o,e,h,n,c)}},n._updatePlayingState=function(e,t,n,i,r,a){var o=e.stateData,s=o.curveOwners,l=o.eventHandlers,u=e.state,c=e.playState,h=e.clipTime,_=u.clip._curveBindings;e.update(this.speed<0);var d=e.clipTime,f=e.playState;l.length&&this._fireAnimationEvents(e,l,h,d);for(var p=_.length-1;p>=0;p--){var g=s[p],v=this._evaluateCurve(g.property,_[p].curve,d,a,this._baseTempValue);a?this._applyClipValueAdditive(g,v,i):this._applyClipValue(g,v,i)}e.frameTime+=u.speed*r,f===Eo.Finished&&(t.layerState=Fo.Standby),c===Eo.UnStarted&&this._callAnimatorScriptOnEnter(u,n),f===Eo.Finished?this._callAnimatorScriptOnExit(u,n):this._callAnimatorScriptOnUpdate(u,n)},n._updateCrossFade=function(e,t,n,i,r,a,o){var s=this._crossCurveDataCollection,l=e.state.clip._curveBindings,u=e.state,c=e.stateData,h=e.playState,_=c.eventHandlers,d=t.state,f=t.stateData,p=t.playState,g=f.eventHandlers,v=d.clip._curveBindings,m=e.clipTime,y=t.clipTime,x=Math.abs(t.frameTime)/(d._getDuration()*n.crossFadeTransition.duration);x>=1&&(x=1),e.update(this.speed<0),t.update(this.speed<0);var w=e.playState,b=t.playState;this._updateCrossFadeData(n,x,a,!1);var C=e.clipTime,T=t.clipTime;_.length&&this._fireAnimationEvents(e,_,m,C),g.length&&this._fireAnimationEvents(t,g,y,T),h===Eo.UnStarted&&this._callAnimatorScriptOnEnter(u,i),1===x||w===Eo.Finished?this._callAnimatorScriptOnExit(u,i):this._callAnimatorScriptOnUpdate(u,i),p===Eo.UnStarted&&this._callAnimatorScriptOnEnter(d,i),b===Eo.Finished?this._callAnimatorScriptOnExit(d,i):this._callAnimatorScriptOnUpdate(d,i);for(var S=s.length-1;S>=0;S--){var A=s[S],P=A.curveOwner,M=A.srcCurveIndex,E=A.destCurveIndex,F=P.property,R=P.defaultValue,L=M>=0?this._evaluateCurve(F,l[M].curve,C,o,this._baseTempValue):R,D=E>=0?this._evaluateCurve(F,v[E].curve,T,o,this._crossTempValue):R;this._applyCrossClipValue(P,L,D,x,r,o)}},n._updateCrossFadeFromPose=function(e,t,n,i,r,a){var o=this._crossCurveDataCollection,s=e.state,l=e.stateData,u=e.playState,c=l.eventHandlers,h=s.clip._curveBindings,_=e.clipTime,d=Math.abs(e.frameTime)/(s._getDuration()*t.crossFadeTransition.duration);d>=1&&(d=1),e.update(this.speed<0);var f=e.playState;this._updateCrossFadeData(t,d,r,!0);var p=e.clipTime;c.length&&this._fireAnimationEvents(e,c,_,p),u===Eo.UnStarted&&this._callAnimatorScriptOnEnter(s,n),f===Eo.Finished?this._callAnimatorScriptOnExit(s,n):this._callAnimatorScriptOnUpdate(s,n);for(var g=o.length-1;g>=0;g--){var v=o[g],m=v.curveOwner,y=v.destCurveIndex,x=y>=0?this._evaluateCurve(m.property,h[y].curve,p,a,this._crossTempValue):m.defaultValue;this._applyCrossClipValue(m,m.fixedPoseValue,x,d,i,a)}},n._updateCrossFadeData=function(e,t,n,i){var r=e.destPlayData;r.frameTime+=r.state.speed*n,1===t?(r.playState===Eo.Finished?e.layerState=Fo.Standby:e.layerState=Fo.Playing,e.switchPlayData()):i||(e.srcPlayData.frameTime+=e.srcPlayData.state.speed*n)},n._applyCrossClipValue=function(e,t,n,i,r,a){var s;if(e.type===Ze)switch(e.property){case Co.Position:s=this._baseTempValue.vector3,o.lerp(t,n,i,s);break;case Co.Rotation:s=this._baseTempValue.quaternion,_.slerp(t,n,i,s);break;case Co.Scale:s=this._baseTempValue.vector3,o.lerp(t,n,i,s)}else if(e.type===qi&&e.property===Co.BlendShapeWeights)for(var l=0,u=(s=this._baseTempValue.getFloatArray(t.length)).length;l<u;++l)s[l]=t[l]+(n[l]-t[l])*i;a?this._applyClipValueAdditive(e,s,r):this._applyClipValue(e,s,r)},n._applyClipValue=function(e,t,n){if(e.type===Ze){var i=e.target.transform;switch(e.property){case Co.Position:if(1===n)i.position=t;else{var r=i.position;o.lerp(r,t,n,r)}break;case Co.Rotation:if(1===n)i.rotationQuaternion=t;else{var a=i.rotationQuaternion;_.slerp(a,t,n,a)}break;case Co.Scale:if(1===n)i.scale=t;else{var s=i.scale;o.lerp(s,t,n,s)}}}else if(e.type===qi&&e.property===Co.BlendShapeWeights)if(1===n)e.component.blendShapeWeights=t;else for(var l=e.component.blendShapeWeights,u=0,c=l.length;u<c;++u)l[u]+=(t[u]-l[u])*n},n._applyClipValueAdditive=function(e,t,n){if(e.type===Ze){var i=e.target.transform;switch(e.property){case Co.Position:var r=i.position;r.x+=t.x*n,r.y+=t.y*n,r.z+=t.z*n,i.position=r;break;case Co.Rotation:var a=i.rotationQuaternion;Ro.quaternionWeight(t,n,t),t.normalize(),a.multiply(t),i.rotationQuaternion=a;break;case Co.Scale:var s=i.scale;Ro.scaleWeight(s,n,s),o.multiply(s,t,s),i.scale=s;break;case Co.BlendShapeWeights:for(var l=0,u=e.component.blendShapeWeights.length;l<u;++l)e.component.blendShapeWeights[l]+=t[l]*n}}},n._revertDefaultValue=function(e,t){var n=e.clip;if(n)for(var i=n._curveBindings,r=t.curveOwners,a=i.length-1;a>=0;a--){var o=r[a],s=o.target.transform;if(o._hasSavedDefaultValue)switch(o.property){case Co.Position:s.position=o.defaultValue;break;case Co.Rotation:s.rotationQuaternion=o.defaultValue;break;case Co.Scale:s.scale=o.defaultValue;break;case Co.BlendShapeWeights:for(var l=0,u=o.component.blendShapeWeights.length;l<u;++l)o.component.blendShapeWeights[l]=o.defaultValue[l]}}},n._checkTransition=function(e,t,n){for(var i=e.state,r=e.clipTime,a=i._getDuration(),o=i.transitions,s=0,l=o.length;s<l;++s){var u=o[s];a*u.exitTime<=r&&t!==u&&this._crossFadeByTransition(u,n)}},n._crossFadeByTransition=function(e,n){var i=e.destinationState.name,r=this._getAnimatorStateInfo(i,n,t._animatorInfo),a=r.state;if(a)if(a.clip){var o=this._getAnimatorLayerData(r.layerIndex),s=o.layerState,l=o.destPlayData,u=this._getAnimatorStateData(i,a,o),c=a._getDuration()*e.offset;switch(l.reset(a,u,c),s){case Fo.Standby:o.layerState=Fo.FixedCrossFading,this._clearCrossData(o),this._prepareStandbyCrossFading(o);break;case Fo.Playing:o.layerState=Fo.CrossFading,this._clearCrossData(o),this._prepareCrossFading(o);break;case Fo.CrossFading:o.layerState=Fo.FixedCrossFading,this._prepareFixedPoseCrossFading(o);break;case Fo.FixedCrossFading:this._prepareFixedPoseCrossFading(o)}o.crossFadeTransition=e}else console.warn("The state named "+i+" has no AnimationClip data.")},n._fireAnimationEvents=function(e,t,n,i){var r=e.state,a=r.clip.length;this.speed>=0?i<n?(this._fireSubAnimationEvents(e,t,n,r.clipEndTime*a),e.currentEventIndex=0,this._fireSubAnimationEvents(e,t,r.clipStartTime*a,i)):this._fireSubAnimationEvents(e,t,n,i):i>n?(this._fireBackwardSubAnimationEvents(e,t,n,r.clipStartTime*a),e.currentEventIndex=t.length-1,this._fireBackwardSubAnimationEvents(e,t,r.clipEndTime*a,i)):this._fireBackwardSubAnimationEvents(e,t,n,i)},n._fireSubAnimationEvents=function(e,t,n,i){for(var r=e.currentEventIndex,a=t.length;r<a;r++){var o=t[r],s=o.event,l=s.time,u=s.parameter;if(l>i)break;var c=o.handlers;if(l>=n){for(var h=c.length-1;h>=0;h--)c[h](u);e.currentEventIndex=Math.min(r+1,a-1)}}},n._fireBackwardSubAnimationEvents=function(e,t,n,i){for(var r=e.currentEventIndex;r>=0;r--){var a=t[r],o=a.event,s=o.time,l=o.parameter;if(s<i)break;var u=a.handlers;if(s<=n){for(var c=u.length-1;c>=0;c--)u[c](l);e.currentEventIndex=Math.max(r-1,0)}}},n._callAnimatorScriptOnEnter=function(e,t){for(var n=e._onStateEnterScripts,i=0,r=n.length;i<r;i++)n[i].onStateEnter(this,e,t)},n._callAnimatorScriptOnUpdate=function(e,t){for(var n=e._onStateUpdateScripts,i=0,r=n.length;i<r;i++)n[i].onStateUpdate(this,e,t)},n._callAnimatorScriptOnExit=function(e,t){for(var n=e._onStateExitScripts,i=0,r=n.length;i<r;i++)n[i].onStateExit(this,e,t)},n._clearPlayData=function(){this._animatorLayersData.length=0,this._crossCurveDataCollection.length=0,this._animationCurveOwners.length=0,this._animationEventHandlerPool.resetPool(),this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},C(t,[{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),t}(Ye),Xo._tempQuat=new _,Xo._animatorInfo=new function(){this.layerIndex=void 0,this.state=void 0},zo=O((Oo=Xo).prototype,"_speed",[J],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),No=O(Oo.prototype,"_controllerUpdateFlag",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vo=O(Oo.prototype,"_animatorLayersData",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uo=O(Oo.prototype,"_crossCurveDataCollection",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ko=O(Oo.prototype,"_animationCurveOwners",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Go=O(Oo.prototype,"_crossCurveDataPool",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(Jo)}}),Ho=O(Oo.prototype,"_animationEventHandlerPool",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Bn(Bo)}}),Wo=O(Oo.prototype,"_baseTempValue",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zo}}),jo=O(Oo.prototype,"_crossTempValue",[Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zo}}),Oo),es=function(){function e(){this._updateFlagManager=new Je,this._layers=[],this._layersMap={}}var t=e.prototype;return t.findLayerByName=function(e){return this._layersMap[e]},t.addLayer=function(e){this._layers.push(e),this._layersMap[e.name]=e,this._distributeUpdateFlag()},t.removeLayer=function(e){var t=this.layers[e];this._layers.splice(e,1),delete this._layersMap[t.name],this._distributeUpdateFlag()},t.clearLayers=function(){for(var e in this._layers.length=0,this._layersMap)delete this._layersMap[e];this._distributeUpdateFlag()},t._registerChangeFlag=function(){return this._updateFlagManager.createFlag(qe)},t._distributeUpdateFlag=function(){this._updateFlagManager.dispatch()},C(e,[{key:"layers",get:function(){return this._layers}}]),e}(),ts=function(e){this.name=e,this.weight=1,this.blendingMode=Mo.Override,this.stateMachine=void 0},ns=function(){function e(){this._destroyed=!1,this._state=void 0}var t=e.prototype;return t.onStateEnter=function(e,t,n){},t.onStateUpdate=function(e,t,n){},t.onStateExit=function(e,t,n){},t.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},e}(),is=function(){function e(e){this.name=e,this.speed=1,this.wrapMode=Lo.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._clipStartTime=0,this._clipEndTime=1,this._clip=void 0,this._transitions=[]}var t=e.prototype;return t.addTransition=function(e){this._transitions.push(e)},t.removeTransition=function(e){var t=this._transitions.indexOf(e);-1!==t&&this._transitions.splice(t,1)},t.addStateMachineScript=function(e){var t=new e;t._state=this;var n=ns.prototype;return t.onStateEnter!==n.onStateEnter&&this._onStateEnterScripts.push(t),t.onStateUpdate!==n.onStateUpdate&&this._onStateUpdateScripts.push(t),t.onStateExit!==n.onStateExit&&this._onStateExitScripts.push(t),t},t.clearTransitions=function(){this._transitions.length=0},t._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},t._removeStateMachineScript=function(e){var t=ns.prototype;if(e.onStateEnter!==t.onStateEnter){var n=this._onStateEnterScripts.indexOf(e);-1!==n&&this._onStateEnterScripts.splice(n,1)}if(e.onStateUpdate!==t.onStateUpdate){var i=this._onStateUpdateScripts.indexOf(e);-1!==i&&this._onStateUpdateScripts.splice(i,1)}if(e.onStateExit!==t.onStateExit){var r=this._onStateExitScripts.indexOf(e);-1!==r&&this._onStateExitScripts.splice(r,1)}},C(e,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip=e,this._clipEndTime=Math.min(this._clipEndTime,1)}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(e){this._clipStartTime=Math.max(e,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(e){this._clipEndTime=Math.min(e,1)}}]),e}(),rs=function(){function e(){this.states=[],this._statesMap={}}var t=e.prototype;return t.addState=function(e){var t=this.findStateByName(e);return t?console.warn("The state named "+e+" has existed."):(t=new is(e),this.states.push(t),this._statesMap[e]=t),t},t.removeState=function(e){var t=e.name,n=this.states.indexOf(e);n>-1&&this.states.splice(n,1),delete this._statesMap[t]},t.findStateByName=function(e){return this._statesMap[e]},t.makeUniqueStateName=function(e){for(var t=this._statesMap,n=e,i=0;t[e];)e=n+" "+i,i++;return e},e}();!function(e){e[e.Linear=0]="Linear",e[e.CubicSpine=1]="CubicSpine",e[e.Step=2]="Step",e[e.Hermite=3]="Hermite"}(Ko||(Ko={}));var as,os=function(){function e(){this.keys=[],this.interpolation=void 0,this._valueSize=void 0,this._valueType=void 0,this._tempValue=void 0,this._length=0,this._currentIndex=0}var t=e.prototype;return t.addKey=function(e){var t=e.time;if(this.keys.push(e),t>this._length&&(this._length=t),!this._valueSize&&("number"==typeof e.value&&(this._valueSize=1,this._valueType=Ao.Float,this._tempValue=0),e.value instanceof p&&(this._valueSize=2,this._valueType=Ao.Vector2,this._tempValue=new p),e.value instanceof o&&(this._valueSize=3,this._valueType=Ao.Vector3,this._tempValue=new o),e.value instanceof g&&(this._valueSize=4,this._valueType=Ao.Vector4,this._tempValue=new g),e.value instanceof _&&(this._valueSize=4,this._valueType=Ao.Quaternion,this._tempValue=new _),e.value instanceof Float32Array)){var n=e.value.length;this._valueSize=n,this._valueType=Ao.FloatArray,this._tempValue=new Float32Array(n)}this.keys.sort((function(e,t){return e.time-t.time}))},t.evaluate=function(e){return this._evaluate(e,this._tempValue)},t.moveKey=function(e,t){this.keys[e]=t},t.removeKey=function(e){this.keys.splice(e,1);for(var t=this.keys,n=0,i=this.keys.length-1;i>=0;i--)t[i].time>length&&(n=t[i].time);this._length=n},t._evaluate=function(e,t){var n=this.keys,i=this.interpolation;this._valueType;var r=this.keys.length,a=this._currentIndex;-1!==a&&e<n[a].time&&(a=-1);for(var o,s=a+1;s<r&&!(e<n[s].time);)a++,s++;if(this._currentIndex=a,-1===a)o=this._evaluateStep(0,t);else if(s===r)o=this._evaluateStep(a,t);else{var l=n[a].time,u=n[s].time-l,c=(e-l)/u,h=u;switch(i){case Ko.Linear:o=this._evaluateLinear(a,s,c,t);break;case Ko.Step:o=this._evaluateStep(a,t);break;case Ko.CubicSpine:case Ko.Hermite:o=this._evaluateHermite(a,s,c,h,t)}}return o},t._evaluateLinear=function(e,t,n,i){var r=this._valueType,a=this.keys;switch(r){case Ao.Float:return a[e].value*(1-n)+a[t].value*n;case Ao.FloatArray:for(var s=a[e].value,l=a[t].value,u=0,c=s.length;u<c;u++)i[u]=s[u]*(1-n)+l[u]*n;return i;case Ao.Vector2:return p.lerp(a[e].value,a[t].value,n,i),i;case Ao.Vector3:return o.lerp(a[e].value,a[t].value,n,i),i;case Ao.Vector4:return g.lerp(a[e].value,a[t].value,n,i),i;case Ao.Quaternion:return _.slerp(a[e].value,a[t].value,n,i),i}},t._evaluateStep=function(e,t){var n=this._valueType,i=this.keys;switch(n){case Ao.Float:return i[e].value;case Ao.FloatArray:for(var r=i[e].value,a=0,o=r.length;a<o;a++)t[a]=r[a];return t;case Ao.Vector2:case Ao.Vector3:case Ao.Vector4:case Ao.Quaternion:return t.copyFrom(i[e].value),t}},t._evaluateHermite=function(e,t,n,i,r){var a=this._valueSize,o=this.keys,s=o[e],l=o[t];switch(a){case 1:var u=s.outTangent,c=l.inTangent,h=s.value,_=l.value;if(Number.isFinite(u)&&Number.isFinite(c)){var d=n*n,f=d*n;return(2*f-3*d+1)*h+(f-2*d+n)*u*i+(f-d)*c*i+(-2*f+3*d)*_}return s.value;case 2:var p=s.value,g=s.outTangent,v=l.value,m=l.inTangent,y=n*n,x=y*n,w=2*x-3*y+1,b=x-2*y+n,C=x-y,T=-2*x+3*y,S=g.x,A=m.x;return Number.isFinite(S)&&Number.isFinite(A)?r.x=w*p.x+b*S*i+C*A*i+T*v.x:r.x=p.x,S=g.y,A=m.y,Number.isFinite(S)&&Number.isFinite(A)?r.y=w*p.y+b*S*i+C*A*i+T*v.y:r.y=p.y,r;case 3:var P=s.value,M=s.outTangent,E=l.value,F=l.inTangent,R=n*n,L=R*n,D=2*L-3*R+1,B=L-2*R+n,I=L-R,O=-2*L+3*R,z=M.x,N=F.x;return Number.isFinite(z)&&Number.isFinite(N)?r.x=D*P.x+B*z*i+I*N*i+O*E.x:r.x=P.x,z=M.y,N=F.y,Number.isFinite(z)&&Number.isFinite(N)?r.y=D*P.y+B*z*i+I*N*i+O*E.y:r.y=P.y,z=M.z,N=F.z,Number.isFinite(z)&&Number.isFinite(N)?r.z=D*P.z+B*z*i+I*N*i+O*E.z:r.z=P.z,r;case 4:var V=s.value,U=s.outTangent,k=l.value,G=l.inTangent,H=n*n,W=H*n,j=2*W-3*H+1,X=W-2*H+n,K=W-H,q=-2*W+3*H,Y=U.x,Q=G.x;return Number.isFinite(Y)&&Number.isFinite(Q)?r.x=j*V.x+X*Y*i+K*Q*i+q*k.x:r.x=V.x,Y=U.y,Q=G.y,Number.isFinite(Y)&&Number.isFinite(Q)?r.y=j*V.y+X*Y*i+K*Q*i+q*k.y:r.y=V.y,Y=U.z,Q=G.z,Number.isFinite(Y)&&Number.isFinite(Q)?r.z=j*V.z+X*Y*i+K*Q*i+q*k.z:r.z=V.z,Y=U.w,Q=G.w,Number.isFinite(Y)&&Number.isFinite(Q)?r.w=j*V.w+X*Y*i+K*Q*i+q*k.w:r.w=V.w,r}},C(e,[{key:"length",get:function(){return this._length}}]),e}(),ss=function(){this.time=void 0,this.value=void 0},ls=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).inTangent=void 0,t.outTangent=void 0,t}return A(t,e),t}(ss);!function(e){e[e.If=0]="If",e[e.IfNot=1]="IfNot",e[e.Greater=2]="Greater",e[e.Less=3]="Less",e[e.Equals=4]="Equals",e[e.NotEquals=5]="NotEquals"}(as||(as={}));var us,cs,hs=function(e){function t(t){var n;return(n=e.call(this,t,Zt.find("skybox"))||this)._decodeParam=new g(0,5,0,0),n.renderState.rasterState.cullMode=sn.Off,n.renderState.depthState.compareFunction=rn.LessEqual,n.shaderData.setVector4("u_cubeDecodeParam",n._decodeParam),n}return A(t,e),C(t,[{key:"textureDecodeRGBM",get:function(){return Boolean(this._decodeParam.x)},set:function(e){this._decodeParam.x=Number(e)}},{key:"RGBMDecodeFactor",get:function(){return this._decodeParam.y},set:function(e){this._decodeParam.y=e}},{key:"textureCubeMap",get:function(){return this.shaderData.getTexture("u_cube")},set:function(e){this.shaderData.setTexture("u_cube",e)}}]),t}(Dn);!function(e){e[e.Position=1]="Position",e[e.Velocity=2]="Velocity",e[e.Acceleration=4]="Acceleration",e[e.Color=8]="Color",e[e.Alpha=16]="Alpha",e[e.Size=32]="Size",e[e.StartAngle=64]="StartAngle",e[e.StartTime=128]="StartTime",e[e.LifeTime=256]="LifeTime",e[e.RotateVelocity=512]="RotateVelocity",e[e.Scale=1024]="Scale",e[e.Everything=4294967295]="Everything"}(us||(us={})),function(e){e[e.Transparent=0]="Transparent",e[e.Additive=1]="Additive"}(cs||(cs={}));var _s=function(e){function t(t){var n;return(n=e.call(this,t)||this)._vertexStride=void 0,n._vertices=void 0,n._vertexBuffer=void 0,n._maxCount=1e3,n._position=new o,n._positionRandomness=new o,n._positionArray=void 0,n._velocity=new o,n._velocityRandomness=new o,n._acceleration=new o,n._accelerationRandomness=new o,n._color=new v(1,1,1,1),n._colorRandomness=0,n._size=1,n._sizeRandomness=0,n._alpha=1,n._alphaRandomness=0,n._startAngle=0,n._startAngleRandomness=0,n._rotateVelocity=0,n._rotateVelocityRandomness=0,n._lifetime=5,n._startTimeRandomness=0,n._scale=1,n._isOnce=!1,n._onceTime=0,n._time=0,n._isInit=!1,n._isStart=!1,n._updateDirtyFlag=us.Everything,n._isRotateToVelocity=!1,n._isUseOriginColor=!1,n._isScaleByLifetime=!1,n._is2d=!0,n._isFadeIn=!1,n._isFadeOut=!1,n._playOnEnable=!0,n._blendMode=cs.Transparent,n.spriteSheet=void 0,n.setMaterial(n._createMaterial()),n}A(t,e),t._getRandom=function(){return Math.random()-.5};var n=t.prototype;return n.update=function(e){if(this._isInit&&this._isStart){if(this._isOnce&&this._time>this._onceTime)return this.stop();this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time)}},n._onEnable=function(){e.prototype._onEnable.call(this),this._playOnEnable&&this.start()},n.start=function(){this._isStart=!0,this._time=0},n.stop=function(){this._isStart=!1},n._createMaterial=function(){var e=new Dn(this.engine,Zt.find("particle-shader")),t=e.renderState,n=t.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=$t.SourceAlpha,n.destinationColorBlendFactor=$t.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=$t.One,n.destinationAlphaBlendFactor=$t.OneMinusSourceAlpha,t.depthState.writeEnabled=!1,e.renderQueueType=zt.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,e},n._createMesh=function(){var e=new Qi(this._entity.engine,"particleMesh"),n=4*this._maxCount,i=96*n,r=new Float32Array(i),a=null,o=!1;if(n>t._uint16VertexLimit){if(!this.engine._hardwareRenderer.canIUse(le.elementIndexUint))throw Error("The vertex count is over limit.");o=!0,a=new Uint32Array(6*this._maxCount)}else a=new Uint16Array(6*this._maxCount);for(var s=0,l=0;s<this._maxCount;++s){var u=4*s;a[l++]=u,a[l++]=u+1,a[l++]=u+2,a[l++]=u,a[l++]=u+2,a[l++]=u+3}var c=[new _i("a_position",0,ai.Vector3,0),new _i("a_velocity",12,ai.Vector3,0),new _i("a_acceleration",24,ai.Vector3,0),new _i("a_color",36,ai.Vector4,0),new _i("a_lifeAndSize",52,ai.Vector4,0),new _i("a_rotation",68,ai.Vector2,0),new _i("a_uv",76,ai.Vector3,0),new _i("a_normalizedUv",88,ai.Vector2,0)],h=new fi(this.engine,ui.VertexBuffer,4*i,oi.Dynamic),_=new fi(this.engine,ui.IndexBuffer,a,oi.Dynamic);return e.setVertexBufferBinding(h,96),e.setIndexBufferBinding(_,o?si.UInt32:si.UInt16),e.setVertexElements(c),e.addSubMesh(0,a.length),this._vertexBuffer=h,this._vertexStride=24,this._vertices=r,e},n._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},n._updateSingleBuffer=function(e){var n=this._updateDirtyFlag,i=this._vertices,r=this._vertexStride,o=t._getRandom,s=4*e,l=s*r,u=(s+1)*r,c=(s+2)*r,h=(s+3)*r;if(n&us.Position){var _=this._position,d=_.x,f=_.y,p=_.z,g=this._positionArray,v=this._positionRandomness;if(g){if(g.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var m=g[e];d+=m.x,f+=m.y,p+=m.z}else d+=o()*v.x,f+=o()*v.y,p+=o()*v.z;i[l]=i[u]=i[c]=i[h]=d,i[l+1]=i[u+1]=i[c+1]=i[h+1]=f,i[l+2]=i[u+2]=i[c+2]=i[h+2]=p}if(n&us.Velocity){var y=this._velocity,x=this._velocityRandomness;i[l+3]=i[u+3]=i[c+3]=i[h+3]=y.x+o()*x.x,i[l+4]=i[u+4]=i[c+4]=i[h+4]=y.y+o()*x.y,i[l+5]=i[u+5]=i[c+5]=i[h+5]=y.z+o()*x.z}if(n&us.Acceleration){var w=this._acceleration,b=this._accelerationRandomness;i[l+6]=i[u+6]=i[c+6]=i[h+6]=w.x+o()*b.x,i[l+7]=i[u+7]=i[c+7]=i[h+7]=w.y+o()*b.y,i[l+8]=i[u+8]=i[c+8]=i[h+8]=w.z+o()*b.z}if(n&us.Color){var C=this._color,T=this._colorRandomness;i[l+9]=i[u+9]=i[c+9]=i[h+9]=a.clamp(C.r+o()*T,0,1),i[l+10]=i[u+10]=i[c+10]=i[h+10]=a.clamp(C.g+o()*T,0,1),i[l+11]=i[u+11]=i[c+11]=i[h+11]=a.clamp(C.b+o()*T,0,1)}if(n&us.Alpha&&(i[l+12]=i[u+12]=i[c+12]=i[h+12]=a.clamp(this._alpha+o()*this._alphaRandomness,0,1)),n&us.StartTime&&(i[l+13]=i[u+13]=i[c+13]=i[h+13]=Math.random()*this._startTimeRandomness),n&us.LifeTime){var S=this._lifetime;i[l+14]=i[u+14]=i[c+14]=i[h+14]=S+o()*S}if((n&us.StartTime||n&us.LifeTime)&&(this._onceTime=Math.max(this._onceTime,i[l+13]+i[l+14])),n&us.Size){var A=this._size;i[l+15]=i[u+15]=i[c+15]=i[h+15]=Math.max(A+o()*this._sizeRandomness*A*2,0)}n&us.Scale&&(i[l+16]=i[u+16]=i[c+16]=i[h+16]=this._scale),n&us.StartAngle&&(i[l+17]=i[u+17]=i[c+17]=i[h+17]=this._startAngle+o()*Math.PI*this._startAngleRandomness*2),n&us.RotateVelocity&&(i[l+18]=i[u+18]=i[c+18]=i[h+18]=this._rotateVelocity+o()*this._rotateVelocityRandomness),this._updateSingleUv(e,l,u,c,h)},n._updateSingleUv=function(e,t,n,i,r){var a=this.spriteSheet,o=this.getMaterial().shaderData.getTexture("u_texture"),s=this._vertices;if(o){var l=o.width,u=o.height;if(a){var c=a[e%a.length],h=c.x,_=c.y,d=c.w,f=c.h,p=h/l,g=_/u,v=p+d/l,m=g+f/u,y=f/d;s[t+19]=p,s[t+20]=m,s[t+21]=y,s[n+19]=v,s[n+20]=m,s[n+21]=y,s[i+19]=v,s[i+20]=g,s[i+21]=y,s[r+19]=p,s[r+20]=g,s[r+21]=y}else{var x=u/l;s[t+19]=0,s[t+20]=1,s[t+21]=x,s[n+19]=1,s[n+20]=1,s[n+21]=x,s[i+19]=1,s[i+20]=0,s[i+21]=x,s[r+19]=0,s[r+20]=0,s[r+21]=x}}else s[t+19]=0,s[t+20]=0,s[t+21]=1,s[n+19]=1,s[n+20]=0,s[n+21]=1,s[i+19]=1,s[i+20]=1,s[i+21]=1,s[r+19]=0,s[r+20]=1,s[r+21]=1;s[t+22]=-.5,s[t+23]=-.5,s[n+22]=.5,s[n+23]=-.5,s[i+22]=.5,s[i+23]=.5,s[r+22]=-.5,s[r+23]=.5},C(t,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=us.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=us.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=us.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=us.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=us.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=us.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=us.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=us.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=us.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=us.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=us.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=us.Alpha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=us.Alpha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=us.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=us.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=us.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=us.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=us.LifeTime,this._lifetime=e,this._onceTime=0}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=us.StartTime,this._startTimeRandomness=e,this._onceTime=0}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=us.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=us.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0,this.shaderData.setFloat("u_time",0)}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(e){e?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=sn.Off),this._is2d=e}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){var t=this.getMaterial().renderState.blendState.targetBlendState;e===cs.Transparent?(t.enabled=!0,t.sourceColorBlendFactor=$t.SourceAlpha,t.destinationColorBlendFactor=$t.OneMinusSourceAlpha,t.sourceAlphaBlendFactor=$t.One,t.destinationAlphaBlendFactor=$t.OneMinusSourceAlpha):e===cs.Additive&&(t.enabled=!0,t.sourceColorBlendFactor=$t.SourceAlpha,t.destinationColorBlendFactor=$t.One,t.sourceAlphaBlendFactor=$t.One,t.destinationAlphaBlendFactor=$t.OneMinusSourceAlpha),this._blendMode=e}}]),t}(Ki);_s._uint16VertexLimit=65535;Zt.create("trail","#define GLSLIFY 1\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}");var ds=function(e){function t(t){var n,i=(n=e.call(this,t,Zt.find("trail"))||this).renderState.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=$t.SourceAlpha,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=$t.One,n.renderState.depthState.writeEnabled=!1,n}return A(t,e),t}(Dn),fs=new o,ps=function(e){function t(t,n){var i;(i=e.call(this,t)||this)._vertexStride=void 0,i._vertices=void 0,i._vertexBuffer=void 0,i._stroke=void 0,i._minSeg=void 0,i._lifetime=void 0,i._maxPointNum=void 0,i._points=void 0,i._pointStates=void 0,i._strapPoints=void 0,i._curPointNum=void 0,i._prePointsNum=void 0,i._stroke=n.stroke||.2,i._minSeg=n.minSeg||.02,i._lifetime=n.lifetime||1e3,i._maxPointNum=i._lifetime/1e3*t.engine.targetFrameRate,i._points=[],i._pointStates=[],i._strapPoints=[];for(var r=0;r<i._maxPointNum;r++)i._points.push(new o),i._pointStates.push(i._lifetime),i._strapPoints.push(new o),i._strapPoints.push(new o);i._curPointNum=0;var a=n.material||new ds(i.engine);return i.setMaterial(a),i.setTexture(n.texture),i._initGeometry(),i}A(t,e);var n=t.prototype;return n.update=function(e){for(var t=0,n=0,i=0;i<this._curPointNum;i++)this._pointStates[i]-=e,this._pointStates[i]<0?t++:t>0&&(n=i-t,this._pointStates[n]=this._pointStates[i],this._points[n].copyFrom(this._points[i]));this._curPointNum-=t;var r=!0;if(this._curPointNum===this._maxPointNum)r=!1;else if(this._curPointNum>0){var a=this._points[this._points.length-1];o.distance(this.entity.transform.worldPosition,a)<this._minSeg&&(r=!1)}r&&(this._pointStates[this._curPointNum]=this._lifetime,this._points[this._curPointNum].copyFrom(this.entity.transform.worldPosition),this._curPointNum++)},n._render=function(t){this._updateStrapVertices(t,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),e.prototype._render.call(this,t)},n.setTexture=function(e){e&&this.getMaterial().shaderData.setTexture("u_texture",e)},n._initGeometry=function(){var e=new Qi(this._entity.engine),t=2*this._maxPointNum,n=20*t,i=new Float32Array(n),r=[new _i("POSITION",0,ai.Vector3,0),new _i("TEXCOORD_0",12,ai.Vector2,0)],a=new fi(this.engine,4*n,oi.Dynamic);e.setVertexBufferBinding(a,20),e.setVertexElements(r),e.addSubMesh(0,t,di.TriangleStrip),this._vertexBuffer=a,this._vertexStride=20,this._vertices=i,this.mesh=e},n._updateStrapVertices=function(e,t){var n=e.viewMatrix.elements,i=new o(n[0],n[4],n[8]),r=new o(n[1],n[5],n[9]),a=new o(n[2],n[6],n[10]),s=this._stroke;r.scale(s);var l=new o,u=new o,c=new _;o.transformByQuat(i,c,i),o.transformByQuat(r,c,r);var h=new o,d=new o,f=new o;i.normalize();for(var p=this._vertices,g=0;g<this._maxPointNum;g++){if(g<this._curPointNum){var v=t[g];g===this._curPointNum-1&&0!==g?o.subtract(v,t[g-1],f):o.subtract(t[g+1],v,f),this._projectOnPlane(f,a,f),f.normalize();var m=Math.acos(o.dot(i,f));o.cross(i,f,d),o.dot(d,a)<=0&&(m=2*Math.PI-m),_.rotationAxisAngle(a,m,c),o.transformByQuat(r,c,h),o.add(v,h,l),o.subtract(v,h,u)}var y=2*g*this._vertexStride/4,x=(2*g+1)*this._vertexStride/4;p[y]=l.x,p[y+1]=l.y,p[y+2]=l.z,p[x]=u.x,p[x+1]=u.y,p[x+2]=u.z}},n._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,t=1/e,n=this._vertices,i=0;i<e;i++){var r=1-i*t,a=2*i*this._vertexStride/4,o=(2*i+1)*this._vertexStride/4;n[a]=0,n[a+1]=r,n[o]=1,n[o+1]=r}}},n._projectOnVector=function(e,t,n){var i=t.clone();o.normalize(i,i);var r=o.dot(e,i);n.x=i.x*r,n.y=i.y*r,n.z=i.z*r},n._projectOnPlane=function(e,t,n){this._projectOnVector(e,t,fs),o.subtract(e,fs,n)},t}(Ki),gs=function(e){function t(t){var n;return(n=e.call(this,t)||this)._color=new v(1,0,0,1),n.color=n._color,n}A(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.shaderData.enableMacro("O3_HAS_FOG")},n._onDisable=function(){this.scene.shaderData.disableMacro("O3_HAS_FOG")},C(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(t._colorProperty,e)}}]),t}(Ye);gs._colorProperty=Zt.getPropertyByName("u_fogColor");var vs=function(e){function t(t){var n;return(n=e.call(this,t)||this)._density=.0025,n.density=n._density,n}A(t,e);var n=t.prototype;return n._onEnable=function(){this.scene.shaderData.enableMacro("O3_FOG_EXP2")},n._onDisable=function(){this.scene.shaderData.disableMacro("O3_FOG_EXP2")},C(t,[{key:"density",get:function(){return this._density},set:function(e){this._density=e,this.scene.shaderData.setFloat(t._densityProperty,e)}}]),t}(gs);vs._densityProperty=Zt.getPropertyByName("u_fogDensity");var ms=function(e){function t(t){var n;return(n=e.call(this,t)||this)._near=1,n._far=1e3,n.near=n._near,n.far=n._far,n}return A(t,e),C(t,[{key:"near",get:function(){return this._near},set:function(e){this._near=e,this.scene.shaderData.setFloat(t._nearProperty,e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this.scene.shaderData.setFloat(t._farProperty,e)}}]),t}(gs);ms._nearProperty=Zt.getPropertyByName("u_fogNear"),ms._farProperty=Zt.getPropertyByName("u_fogFar");var ys=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).probeLayer=we.Everything,t.width=1024,t.height=1024,t.antiAliasing=1,t._isCube=!1,t._oriCameraRenderTarget=void 0,t._renderTarget=void 0,t._renderTargetSwap=void 0,t._activeRenderTarget=void 0,t._camera=void 0,t._oriCameraCullingMask=void 0,t}A(t,e);var n=t.prototype;return n.onTextureChange=function(e){},n.onBeginRender=function(e){this.enabled&&(this._camera=e,this._oriCameraCullingMask=e.cullingMask,e.cullingMask=this.probeLayer,this._activeRenderTarget&&this._activeRenderTarget.width===this.width&&this._activeRenderTarget.height===this.height&&this._activeRenderTarget.antiAliasing===this.antiAliasing||(this._renderTarget=new Ti(this.engine,this.width,this.height,this._isCube?new Pi(this.engine,this.width):new Si(this.engine,this.width,this.height),pi.Depth,this.antiAliasing),this._renderTargetSwap=new Ti(this.engine,this.width,this.height,this._isCube?new Pi(this.engine,this.width):new Si(this.engine,this.width,this.height),pi.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=e.renderTarget,e.renderTarget=this._activeRenderTarget)},n.onEndRender=function(e){this.enabled&&(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},n._reset=function(){this.enabled&&(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},C(t,[{key:"_texture",get:function(){var e;return null===(e=this._activeRenderTarget)||void 0===e?void 0:e.getColorTexture()}}]),t}(Ir),xs=new o,ws=new o,bs=new o,Cs=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).position=new o(0,0,0),t._isCube=!0,t.oriViewMatrix=new d,t._oriFieldOfView=void 0,t}A(t,e);var n=t.prototype;return n.onBeginRender=function(t){if(this.enabled){e.prototype.onBeginRender.call(this,t),this._storeCamera(t);for(var n=0;n<6;n++)this._setCamera(n,t),t.render(gi.PositiveX+n);this._restoreCamera(t),e.prototype._reset.call(this)}},n._storeCamera=function(e){this.oriViewMatrix.copyFrom(e.viewMatrix),this._oriFieldOfView=e.fieldOfView},n._restoreCamera=function(e){e.viewMatrix.copyFrom(this.oriViewMatrix),e.fieldOfView=this._oriFieldOfView},n._setCamera=function(e,t){switch(e){case 0:ws.set(0,-1,0),bs.set(1,0,0);break;case 1:ws.set(0,-1,0),bs.set(-1,0,0);break;case 2:ws.set(0,0,1),bs.set(0,1,0);break;case 3:ws.set(0,0,-1),bs.set(0,-1,0);break;case 4:ws.set(0,-1,0),bs.set(0,0,1);break;case 5:ws.set(0,-1,0),bs.set(0,0,-1)}o.add(this.position,bs,xs),d.lookAt(this.position,xs,ws,t.viewMatrix),t.fieldOfView=90},t}(ys),Ts=function(){function e(e,t){void 0===t&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new d,this.light=e;var n=t,i=n.engine,r=n.width,a=n.height;this._mapSize=new p(r,a),this._renderTarget=new Ti(i,r,a,new Si(i,r,a))}e._updateShaderData=function(t){var n=e._combinedData;t.setFloatArray(e._viewMatFromLightProperty,n.viewMatrix),t.setFloatArray(e._projMatFromLightProperty,n.projectionMatrix),t.setFloatArray(e._shadowBiasProperty,n.bias),t.setFloatArray(e._shadowIntensityProperty,n.intensity),t.setFloatArray(e._shadowRadiusProperty,n.radius),t.setFloatArray(e._shadowMapSizeProperty,n.mapSize),t.setTextureArray(e._shadowMapsProperty,n.map)},e.clearMap=function(){e._combinedData.map.length=0};var t=e.prototype;return t.initShadowProjectionMatrix=function(e){if(e instanceof hr&&d.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),e instanceof _r&&d.perspective(a.degreeToRadian(50),1,.5,50,this.projectionMatrix),e instanceof dr){var t=Math.min(Math.PI/2,2*e.angle*Math.sqrt(2));d.perspective(t,1,.1,e.distance+5,this.projectionMatrix)}},t.appendData=function(t){var n=16*t,i=16*t,r=t,a=t,o=t,s=2*t,l=t,u=e._combinedData;u.viewMatrix.set(this.light.viewMatrix.elements,n),u.projectionMatrix.set(this.projectionMatrix.elements,i),u.bias[r]=this.bias,u.intensity[a]=this.intensity,u.radius[o]=this.radius,u.mapSize[s]=this.mapSize.x,u.mapSize[s+1]=this.mapSize.y,u.map[l]=this.map},C(e,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),e}();Ts._viewMatFromLightProperty=Zt.getPropertyByName("u_viewMatFromLight"),Ts._projMatFromLightProperty=Zt.getPropertyByName("u_projMatFromLight"),Ts._shadowBiasProperty=Zt.getPropertyByName("u_shadowBias"),Ts._shadowIntensityProperty=Zt.getPropertyByName("u_shadowIntensity"),Ts._shadowRadiusProperty=Zt.getPropertyByName("u_shadowRadius"),Ts._shadowMapSizeProperty=Zt.getPropertyByName("u_shadowMapSize"),Ts._shadowMapsProperty=Zt.getPropertyByName("u_shadowMaps"),Ts._maxLight=3,Ts._combinedData={viewMatrix:new Float32Array(16*Ts._maxLight),projectionMatrix:new Float32Array(16*Ts._maxLight),bias:new Float32Array(Ts._maxLight),intensity:new Float32Array(Ts._maxLight),radius:new Float32Array(Ts._maxLight),mapSize:new Float32Array(2*Ts._maxLight),map:[]},Object.defineProperty(cr.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(e){if(this._enableShadow=e,this._enableShadow){if(this instanceof lr)return this._enableShadow=!1,void pe.warn("Has no shadow!");this.shadow=this.shadow||new Ts(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}}),Object.defineProperty(Ye.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}}),Object.defineProperty(Ye.prototype,"castShadow",{get:function(){return this._castShadow},set:function(e){this._castShadow=e}});var Ss=function(e){function t(t){var n;return(n=e.call(this,t,Zt.find("shadow-map"))||this).shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),n}return A(t,e),t}(Dn),As=function(e){function t(t,n,i,r,a,o){var s;return(s=e.call(this,t,n,i,r,a)||this).light=void 0,s.light=o,s.clearColor=new v(1,1,1,1),s}return A(t,e),t.prototype.preRender=function(e,n){var i=this.replaceMaterial.shaderData;i.setMatrix(t._viewMatFromLightProperty,this.light.viewMatrix),i.setMatrix(t._projMatFromLightProperty,this.light.shadow.projectionMatrix)},t}(zr);As._viewMatFromLightProperty=Zt.getPropertyByName("u_viewMatFromLight"),As._projMatFromLightProperty=Zt.getPropertyByName("u_projMatFromLight");var Ps=function(e){function t(t){var n,i=(n=e.call(this,t,Zt.find("shadow"))||this).renderState.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=$t.DestinationColor,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=$t.Zero,n.renderState.depthState.compareFunction=rn.LessEqual,n.renderQueueType=zt.Transparent,n}return A(t,e),t}(Dn),Ms=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).clearFlags=nt.None,t}return A(t,e),t.prototype.preRender=function(e,t){this.enabled=!1;var n=e.scene.findFeature(fr).visibleLights,i=this.replaceMaterial.shaderData,r=e._renderPipeline.defaultRenderPass;this.renderTarget=r.renderTarget;var a=0;Ts.clearMap();for(var o=0,s=n.length;o<s;o++){var l=n[o];l.enableShadow&&l.shadow.appendData(a++)}a?(this.enabled=!0,Ts._updateShaderData(i),i.enableMacro("O3_SHADOW_MAP_COUNT",a.toString())):i.disableMacro("O3_SHADOW_MAP_COUNT")},t}(zr),Es=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowPass=void 0,t._shadowMapMaterial=void 0,t}A(t,e);var n=t.prototype;return n.preRender=function(e,t){var n=e.findFeature(fr).visibleLights;if(n.length>0){this._shadowPass||this.addShadowPass(t);for(var i=t._renderPipeline,r=0,a=n.length;r<a;r++){var o=n[r];o.enableShadow&&!o.shadowMapPass?o.shadowMapPass=this.addShadowMapPass(t,o):!o.enableShadow&&o.shadowMapPass&&(i.removeRenderPass(o.shadowMapPass),o.shadowMapPass=null)}this.updatePassRenderFlag(i._opaqueQueue),this.updatePassRenderFlag(i._alphaTestQueue),this.updatePassRenderFlag(i._transparentQueue)}},n.addShadowPass=function(e){var t=new Ps(e.engine);this._shadowPass=new Ms("ShadowPass",1,null,t,we.Layer30),e._renderPipeline.addRenderPass(this._shadowPass)},n.addShadowMapPass=function(e,t){this._shadowMapMaterial=this._shadowMapMaterial||new Ss(e.engine);var n=new As("ShadowMapPass",-1,t.shadow.renderTarget,this._shadowMapMaterial,we.Layer31,t);return e._renderPipeline.addRenderPass(n),n},n.updatePassRenderFlag=function(e){for(var t=e.items,n=0,i=t.length;n<i;n++){var r=t[n].component,a=r.receiveShadow,o=r.castShadow;!0===a?r.entity.layer|=we.Layer30:!1===a&&(r.entity.layer&=~we.Layer30),!0===o?r.entity.layer|=we.Layer31:!1===o&&(r.entity.layer&=~we.Layer31)}},t}(ur);pr.registerFeature(Es),pr.registerFeature(fr),pr.prototype.hasLight=function(){return this.findFeature(fr).visibleLights.length>0};var Fs,Rs=Object.freeze({__proto__:null,AmbientLight:lr,AnimationClip:Po,AnimationClipCurveBinding:To,AnimationCurve:os,AnimationEvent:So,get AnimationProperty(){return Co},Animator:$o,get AnimatorConditionMode(){return as},AnimatorController:es,AnimatorControllerLayer:ts,get AnimatorLayerBlendingMode(){return Mo},AnimatorState:is,AnimatorStateMachine:rs,AnimatorStateTransition:Io,AssetPromise:j,get AssetPromiseStatus(){return U},get AssetType(){return la},Background:sr,get BackgroundMode(){return er},get BackgroundTextureFillMode(){return tr},BaseMaterial:fa,BasicRenderPipeline:ta,get BlendFactor(){return $t},get BlendMode(){return ca},get BlendOperation(){return en},BlendShape:Zi,BlendShapeFrame:Ji,BlinnPhongMaterial:pa,BoolUpdateFlag:qe,BoxColliderShape:gt,Buffer:fi,get BufferBindFlag(){return ui},BufferMesh:Qi,get BufferUsage(){return oi},BufferUtil:hi,Camera:ia,get CameraClearFlags(){return nt},CapsuleColliderShape:wt,CharacterController:dt,CloneManager:ne,Collider:_t,ColliderShape:ft,get ColliderShapeUpAxis(){return pt},get CollisionDetectionMode(){return Mt},get ColorSpace(){return Wt},get ColorWriteMask(){return tn},get CompareFunction(){return rn},Component:Ye,get ControllerCollisionFlag(){return St},get ControllerNonWalkableMode(){return ct},CubeProbe:Cs,get CullMode(){return sn},get DataType(){return se},get DiffuseMode(){return ar},DirectLight:hr,DynamicCollider:Dt,get DynamicColliderConstraints(){return Et},EXP2Fog:vs,Engine:br,EngineFeature:Br,EngineObject:ve,Entity:et,Event:Y,EventDispatcher:ue,FixedJoint:Tt,Fog:gs,Font:Ya,get FontStyle(){return ba},get GLCapabilityType(){return le},HingeJoint:At,HitResult:at,IndexBufferBinding:xi,get IndexFormat(){return si},InputManager:Vt,InterpolableKeyframe:ls,get InterpolableValueType(){return Ao},get InterpolationType(){return Ko},Joint:bt,JointLimits:function(){this.max=0,this.min=0,this.contactDistance=-1,this.stiffness=0,this.damping=0},JointMotor:function(){this.targetVelocity=0,this.forceLimit=Number.MAX_VALUE,this.gearRation=1,this.freeSpin=!1},Keyframe:ss,get Keys(){return exports.Keys},get Layer(){return we},Light:cr,LinearFog:ms,ListenerUpdateFlag:Qe,Loader:da,Logger:pe,Material:Dn,Mesh:bi,MeshRenderElement:On,MeshRenderer:Ki,get MeshTopology(){return di},ModelMesh:Fi,ObjectValues:V,get OverflowMode(){return wa},PBRBaseMaterial:ga,PBRMaterial:va,PBRSpecularMaterial:ma,ParticleRenderer:_s,get ParticleRendererBlendMode(){return cs},PhysicsManager:ot,PhysicsMaterial:ht,get PhysicsMaterialCombineMode(){return rt},PlaneColliderShape:mt,PointLight:_r,Pointer:It,get PointerButton(){return exports.PointerButton},get PointerPhase(){return Ft},PrimitiveMesh:Yi,Probe:ys,RefObject:kt,get RenderBufferDepthFormat(){return pi},get RenderFace(){return ua},RenderPass:zr,RenderQueue:ea,get RenderQueueType(){return zt},RenderTarget:Ti,Renderer:Gn,ResourceManager:X,Scene:pr,SceneFeature:ur,SceneManager:gr,Script:Ir,get SetDataOptions(){return ci},Shader:Zt,ShaderData:nn,ShaderFactory:Xt,ShaderProperty:Jt,get ShaderPropertyType(){return Gt},Skin:Xi,SkinnedMeshRenderer:qi,Sky:or,SkyBoxMaterial:hs,SphereColliderShape:vt,SpotLight:dr,SpringJoint:Pt,Sprite:Ea,SpriteAtlas:Sa,get SpriteDrawMode(){return Ta},SpriteElement:Nn,SpriteMask:li,get SpriteMaskInteraction(){return hn},get SpriteMaskLayer(){return Wn},SpriteRenderer:Ka,StateMachineScript:ns,StaticCollider:Lt,get StencilOperation(){return un},SubMesh:wi,SystemInfo:Dr,get TextHorizontalAlignment(){return ya},TextRenderer:bo,get TextVerticalAlignment(){return xa},Texture:Ht,Texture2D:Si,Texture2DArray:Ai,get TextureCoordinate(){return ha},TextureCube:Pi,get TextureCubeFace(){return gi},get TextureFilterMode(){return vi},get TextureFormat(){return mi},get TextureWrapMode(){return yi},Time:ge,TrailMaterial:ds,TrailRenderer:ps,Transform:Ze,UnlitMaterial:Ca,Util:z,VertexBufferBinding:Ci,VertexElement:_i,get VertexElementFormat(){return ai},get WrapMode(){return Lo},assignmentClone:J,deepClone:$,dependentComponents:Te,ignoreClone:Q,request:aa,resourceLoader:K,shallowClone:Z});function Ls(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ds(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Bs(e,t,n){return t&&Ds(e.prototype,t),n&&Ds(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Is(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Os(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,zs(e,t)}function zs(e,t){return zs=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},zs(e,t)}!function(e){e[e.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",e[e.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",e[e.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",e[e.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",e[e.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",e[e.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",e[e.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",e[e.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",e[e.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",e[e.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",e[e.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",e[e.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",e[e.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",e[e.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",e[e.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",e[e.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",e[e.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",e[e.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",e[e.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",e[e.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",e[e.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",e[e.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",e[e.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",e[e.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",e[e.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",e[e.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",e[e.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",e[e.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",e[e.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",e[e.R11_EAC=37488]="R11_EAC",e[e.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",e[e.RG11_EAC=37490]="RG11_EAC",e[e.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",e[e.RGB8_ETC2=37492]="RGB8_ETC2",e[e.SRGB8_ETC2=37493]="SRGB8_ETC2",e[e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",e[e.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",e[e.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",e[e.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",e[e.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",e[e.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",e[e.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",e[e.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",e[e.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",e[e.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT"}(Fs||(Fs={}));var Ns,Vs=function(){var e=t.prototype;function t(e){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new p;var t=e.width,n=e.height;this._webCanvas=e,this._width=t,this._height=n}return e.resizeByClientSize=function(e){void 0===e&&(e=n.polyfill.window.devicePixelRatio);var t=this._webCanvas;void 0!==n.polyfill.OffscreenCanvas&&t instanceof n.polyfill.OffscreenCanvas||(this.width=t.clientWidth*e,this.height=t.clientHeight*e)},e.setScale=function(e,t){this._scale.set(e,t),this.scale=this._scale},Bs(t,[{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._webCanvas.width=e,this._width=e)}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._webCanvas.height=e,this._height=e)}},{key:"scale",get:function(){var e=this._webCanvas;return void 0!==n.polyfill.OffscreenCanvas&&e instanceof n.polyfill.OffscreenCanvas||this._scale.set(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var t=this._webCanvas;void 0!==n.polyfill.OffscreenCanvas&&t instanceof n.polyfill.OffscreenCanvas||(t.style.transformOrigin="left top",t.style.transform="scale("+e.x+", "+e.y+")")}}]),t}(),Us=function(){function e(e){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=e,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var t=e.prototype;return t.canIUse=function(e){return this.capabilityList.get(e)},t.canIUseCompressedTextureInternalFormat=function(e){var t=Fs.RGBA_ASTC_4X4_KHR,n=Fs.RGBA_ASTC_12X12_KHR,i=Fs.SRGB8_ALPHA8_ASTC_4X4_KHR,r=Fs.SRGB8_ALPHA8_ASTC_12X12_KHR,a=Fs.RGB_ETC1_WEBGL,o=Fs.R11_EAC,s=Fs.SRGB8_ALPHA8_ETC2_EAC,l=Fs.RGB_PVRTC_4BPPV1_IMG,u=Fs.RGBA_PVRTC_2BPPV1_IMG,c=Fs.RGB_S3TC_DXT1_EXT,h=Fs.RGBA_S3TC_DXT5_EXT;return e>=t&&n<=n||e>=i&&e<=r?this.canIUse(le.astc):e===a?this.canIUse(le.etc1):e>=o&&e<=s?this.canIUse(le.etc):e>=l&&e<=u?this.canIUse(le.pvrtc):e>=c&&e<=h&&this.canIUse(le.s3tc)},t._init=function(){var e=this.capabilityList,t=this.rhi.isWebGL2,n=this.rhi.requireExtension.bind(this.rhi),i=le.shaderVertexID,r=le.standardDerivatives,a=le.shaderTextureLod,o=le.elementIndexUint,s=le.depthTexture,l=le.vertexArrayObject,u=le.instancedArrays,c=le.multipleSample,h=le.drawBuffers,_=le.astc,d=le.astc_webkit,f=le.etc,p=le.etc_webkit,g=le.etc1,v=le.etc1_webkit,m=le.pvrtc,y=le.pvrtc_webkit,x=le.s3tc,w=le.s3tc_webkit,b=le.textureFloat,C=le.textureHalfFloat,T=le.textureFloatLinear,S=le.textureHalfFloatLinear,A=le.WEBGL_colorBufferFloat,P=le.colorBufferFloat,M=le.colorBufferHalfFloat,E=le.textureFilterAnisotropic;e.set(i,t),e.set(r,t||!!n(r)),e.set(a,t||!!n(a)),e.set(o,t||!!n(o)),e.set(s,t||!!n(s)),e.set(l,t||!!n(l)),e.set(u,t||!!n(u)),e.set(c,t),e.set(h,t||!!n(h)),e.set(b,t||!!n(b)),e.set(C,t||!!n(C)),e.set(T,!!n(T)),e.set(S,t||!!n(S)),e.set(P,t&&!!n(P)||!!n(A)),e.set(M,t&&!!n(P)||!!n(M)),e.set(E,!!n(E)),e.set(_,!(!n(_)&&!n(d))),e.set(f,!(!n(f)&&!n(p))),e.set(g,!(!n(g)&&!n(v))),e.set(m,!(!n(m)&&!n(y))),e.set(x,!(!n(x)&&!n(w)))},t._compatibleInterface=function(e,t){var n,i=this.rhi,r=i.gl;if(n=i.requireExtension(e))for(var a in t){var o=n[t[a]];if(null!=o&&o.bind)r[a]=o.bind(n);else try{r[a]=o}catch(e){console.error(e)}}},t._compatibleAllInterface=function(){var e=le.depthTexture,t=le.vertexArrayObject,n=le.instancedArrays,i=le.drawBuffers,r=le.textureFilterAnisotropic,a=le.textureHalfFloat,o=le.colorBufferHalfFloat,s=le.WEBGL_colorBufferFloat;if(!this.rhi.isWebGL2){this._compatibleInterface(e,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(t,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(n,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(i,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var l={};if(this.canIUse(le.drawBuffers)){for(var u=this.maxDrawBuffers,c=0;c<u;c++)0!=c&&(l["COLOR_ATTACHMENT"+c]="COLOR_ATTACHMENT"+c+"_WEBGL"),l["DRAW_BUFFER"+c]="DRAW_BUFFER"+c+"_WEBGL";this._compatibleInterface(i,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ls(Object(n),!0).forEach((function(t){Is(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ls(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({drawBuffers:"drawBuffersWEBGL"},l))}this._compatibleInterface(a,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(o,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(s,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(r,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},Bs(e,[{key:"maxTextureSize",get:function(){return this.rhi.renderStates.getParameter(this.rhi.gl.MAX_TEXTURE_SIZE)}},{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(le.shaderVertexID)&&this.canIUse(le.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(le.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(le.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var e=this._rhi.requireExtension(le.textureFilterAnisotropic);this._maxAnisoLevel=e?this._rhi.gl.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var e=this._rhi.gl,t=this.canIUse(le.multipleSample);this._maxAntiAliasing=t?e.getParameter(e.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),e}(),ks=function(){function e(e){this.rhi=void 0,this._requireResult=void 0,this.rhi=e,this._requireResult=Object.assign({},n.polyfill.$defaultWebGLExtensions)}return e.prototype.requireExtension=function(e){return void 0!==this._requireResult[e]||(this._requireResult[e]=this.rhi.gl.getExtension(e)),this._requireResult[e]},e}(),Gs=function(){function e(e,t){this.attribLocArray=[],this._primitive=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=t,this.canUseInstancedArrays=e.canIUse(le.instancedArrays),this._useVao=e.canIUse(le.vertexArrayObject),this.gl=e.gl}var t=e.prototype;return t.draw=function(e,t){var n=this.gl,i=this._primitive,r=this._useVao&&i._enableVAO;if(r){this.vao.has(e.id)||this.registerVAO(e);var a=this.vao.get(e.id);n.bindVertexArray(a)}else this.bindBufferAndAttrib(e);var o=i._indexBufferBinding,s=i._instanceCount,l=i._glIndexType,u=i._glIndexByteCount,c=t.topology,h=t.start,_=t.count;if(s)if(this.canUseInstancedArrays)if(o)if(this._useVao)n.drawElementsInstanced(c,_,l,h*u,s);else{var d=o.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,d),n.drawElementsInstanced(c,_,l,h*u,s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArraysInstanced(c,h,_,s);else pe.error("ANGLE_instanced_arrays extension is not supported");else if(o)if(r)n.drawElements(c,_,l,h*u);else{var f=o.buffer._nativeBuffer;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,f),n.drawElements(c,_,l,h*u),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null)}else n.drawArrays(c,h,_);this._useVao?n.bindVertexArray(null):this.disableAttrib()},t.destroy=function(){if(this._useVao){var e=this.gl;this.vao.forEach((function(t){e.deleteVertexArray(t)})),this.vao.clear()}},t.bindBufferAndAttrib=function(e){var t=this.gl,n=this._primitive,i=n._vertexBufferBindings;this.attribLocArray.length=0;var r,a,o=e.attributeLocation,s=n._vertexElementMap;for(var l in o){var u=o[l];if(-1!==u){var c=s[l];if(c){var h=i[c.bindingIndex],_=h.buffer,d=h.stride;a!==(r=_._nativeBuffer)&&(a=r,t.bindBuffer(t.ARRAY_BUFFER,r)),t.enableVertexAttribArray(u);var f=c._glElementInfo;t.vertexAttribPointer(u,f.size,f.type,f.normalized,d,c.offset),this.canUseInstancedArrays&&t.vertexAttribDivisor(u,c.instanceStepRate),this.attribLocArray.push(u)}else pe.warn("vertex attribute not found: "+l)}}t.bindBuffer(t.ARRAY_BUFFER,null)},t.disableAttrib=function(){for(var e=this.gl,t=0,n=this.attribLocArray.length;t<n;t++)e.disableVertexAttribArray(this.attribLocArray[t])},t.registerVAO=function(e){var t=this.gl,n=t.createVertexArray();t.bindVertexArray(n);var i=this._primitive._indexBufferBinding;i&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.buffer._nativeBuffer),this.bindBufferAndAttrib(e),t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(e.id,n)},e}(),Hs=function(){function e(e){this._gl=void 0,this._parameters={},this._gl=e,this._parameters={},this._parameters[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_VERTEX_UNIFORM_VECTORS]=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[e.MAX_VERTEX_ATTRIBS]=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._parameters[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_TEXTURE_SIZE]=e.getParameter(e.MAX_TEXTURE_SIZE),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.depthMask(!0),e.disable(e.STENCIL_TEST),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,0,255),e.stencilFuncSeparate(e.BACK,e.ALWAYS,0,255),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0)}return e.prototype.getParameter=function(e){return this._parameters[e]},e}(),Ws=function(){function e(e,t,n){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=e,this._gl=e.gl,this._isWebGL2=e.isWebGL2,this._target=n,this._glTexture=this._gl.createTexture()}e._isPowerOf2=function(e){return 0==(e&e-1)},e._getFormatDetail=function(e,t,n){switch(e){case mi.R8G8B8:return{internalFormat:n?t.RGB8:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case mi.R8G8B8A8:return{internalFormat:n?t.RGBA8:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case mi.R4G4B4A4:return{internalFormat:n?t.RGBA4:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case mi.R5G5B5A1:return{internalFormat:n?t.RGB5_A1:t.RGBA,baseFormat:t.RGBA,dataType:t.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case mi.R5G6B5:return{internalFormat:n?t.RGB565:t.RGB,baseFormat:t.RGB,dataType:t.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case mi.Alpha8:return{internalFormat:t.ALPHA,baseFormat:t.ALPHA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case mi.LuminanceAlpha:return{internalFormat:t.LUMINANCE_ALPHA,baseFormat:t.LUMINANCE_ALPHA,dataType:t.UNSIGNED_BYTE,isCompressed:!1};case mi.R16G16B16A16:return{internalFormat:t.RGBA16F,baseFormat:t.RGBA,dataType:t.HALF_FLOAT,isCompressed:!1};case mi.R32G32B32A32:return{internalFormat:t.RGBA32F,baseFormat:t.RGBA,dataType:t.FLOAT,isCompressed:!1};case mi.DXT1:return{internalFormat:Fs.RGB_S3TC_DXT1_EXT,isCompressed:!0};case mi.DXT5:return{internalFormat:Fs.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case mi.ETC1_RGB:return{internalFormat:Fs.RGB_ETC1_WEBGL,isCompressed:!0};case mi.ETC2_RGB:return{internalFormat:Fs.RGB8_ETC2,isCompressed:!0};case mi.ETC2_RGBA5:return{internalFormat:Fs.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case mi.ETC2_RGBA8:return{internalFormat:Fs.RGBA8_ETC2_EAC,isCompressed:!0};case mi.PVRTC_RGB2:return{internalFormat:Fs.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case mi.PVRTC_RGBA2:return{internalFormat:Fs.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case mi.PVRTC_RGB4:return{internalFormat:Fs.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case mi.PVRTC_RGBA4:return{internalFormat:Fs.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case mi.ASTC_4x4:return{internalFormat:Fs.RGBA_ASTC_4X4_KHR,isCompressed:!0};case mi.ASTC_5x5:return{internalFormat:Fs.RGBA_ASTC_5X5_KHR,isCompressed:!0};case mi.ASTC_6x6:return{internalFormat:Fs.RGBA_ASTC_6X6_KHR,isCompressed:!0};case mi.ASTC_8x8:return{internalFormat:Fs.RGBA_ASTC_8X8_KHR,isCompressed:!0};case mi.ASTC_10x10:return{internalFormat:Fs.RGBA_ASTC_10X10_KHR,isCompressed:!0};case mi.ASTC_12x12:return{internalFormat:Fs.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+e)}},e._getRenderBufferDepthFormatDetail=function(e,t,n){switch(e){case mi.Depth:case pi.Depth:return{internalFormat:n?t.DEPTH_COMPONENT32F:t.DEPTH_COMPONENT16,baseFormat:t.DEPTH_COMPONENT,dataType:n?t.FLOAT:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case mi.DepthStencil:case pi.DepthStencil:return{internalFormat:n?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,baseFormat:t.DEPTH_STENCIL,dataType:t.UNSIGNED_INT_24_8,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};case mi.Stencil:case pi.Stencil:return{internalFormat:t.STENCIL_INDEX8,baseFormat:t.STENCIL_ATTACHMENT,dataType:t.UNSIGNED_BYTE,isCompressed:!1,attachment:t.STENCIL_ATTACHMENT};case mi.Depth16:case pi.Depth16:return{internalFormat:t.DEPTH_COMPONENT16,baseFormat:t.DEPTH_COMPONENT,dataType:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case mi.Depth24:case pi.Depth24:return{internalFormat:t.DEPTH_COMPONENT24,baseFormat:t.DEPTH_COMPONENT,dataType:t.UNSIGNED_INT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case mi.Depth32:case pi.Depth32:return{internalFormat:t.DEPTH_COMPONENT32F,baseFormat:t.DEPTH_COMPONENT,dataType:t.FLOAT,isCompressed:!1,attachment:t.DEPTH_ATTACHMENT};case mi.Depth24Stencil8:case pi.Depth24Stencil8:return{internalFormat:n?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL,baseFormat:t.DEPTH_STENCIL,dataType:t.UNSIGNED_INT_24_8,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};case mi.Depth32Stencil8:case pi.Depth32Stencil8:return{internalFormat:t.DEPTH32F_STENCIL8,baseFormat:t.DEPTH_STENCIL,dataType:t.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:t.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+e)}},e._supportTextureFormat=function(e,t){var n=!0;switch(e){case mi.R16G16B16A16:t.canIUse(le.textureHalfFloat)||(n=!1);break;case mi.R32G32B32A32:t.canIUse(le.textureFloat)||(n=!1)}return n},e._supportRenderBufferColorFormat=function(e,t){var n=!0;switch(e){case mi.R16G16B16A16:t.canIUse(le.colorBufferHalfFloat)&&t.canIUse(le.textureHalfFloat)||(n=!1);break;case mi.R32G32B32A32:t.canIUse(le.colorBufferFloat)&&t.canIUse(le.textureFloat)||(n=!1)}return n},e._supportRenderBufferDepthFormat=function(e,t,n){var i=t.isWebGL2,r=!0;if(n&&!t.canIUse(le.depthTexture))return!1;switch(e){case pi.Stencil:case mi.Stencil:r=!1;break;case mi.Depth24:case mi.Depth32:case mi.Depth32Stencil8:case pi.Depth24:case pi.Depth32:case pi.Depth32Stencil8:i||(r=!1)}return r};var t=e.prototype;return t.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},t.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},t._bind=function(){this._rhi.bindTexture(this)},t._initMipmap=function(e){var t=this._gl,n=this._isWebGL2,i=this._formatDetail,r=i.internalFormat,a=i.baseFormat,o=i.dataType,s=this._texture,l=s.mipmapCount,u=s.width,c=s.height;if(this._bind(),n&&a!==t.LUMINANCE_ALPHA&&a!==t.ALPHA)t.texStorage2D(this._target,l,r,u,c);else if(a!==r&&(r=a),e)for(var h=0;h<l;h++)for(var _=Math.max(1,u>>h),d=0;d<6;d++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+d,h,r,_,_,0,a,o,null);else for(var f=0;f<l;f++){var p=Math.max(1,u>>f),g=Math.max(1,c>>f);t.texImage2D(this._target,f,r,p,g,0,a,o,null)}},t._getPixelBuffer=function(e,t,n,i,r,a,o){var s=this._gl,l=this._formatDetail,u=l.baseFormat,c=l.dataType;s.bindFramebuffer(s.FRAMEBUFFER,this._getReadFrameBuffer()),a>0&&!this._isWebGL2&&(a=0,pe.error("mipLevel only take effect in WebGL2.0")),null!=e?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+e,this._glTexture,a):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._glTexture,a),s.readPixels(t,n,i,r,u,c,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},t._setWrapMode=function(t,n){var i=this._gl,r=this._isWebGL2,a=this._target,o=this._texture,s=o.width,l=o.height;switch(r||t===yi.Clamp||e._isPowerOf2(s)&&e._isPowerOf2(l)||(pe.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=yi.Clamp),t){case yi.Clamp:i.texParameteri(a,n,i.CLAMP_TO_EDGE);break;case yi.Repeat:i.texParameteri(a,n,i.REPEAT);break;case yi.Mirror:i.texParameteri(a,n,i.MIRRORED_REPEAT)}},t._getReadFrameBuffer=function(){var e=this._rhi._readFrameBuffer;return e||(this._rhi._readFrameBuffer=e=this._gl.createFramebuffer()),e},Bs(e,[{key:"wrapModeU",set:function(e){this._bind(),this._setWrapMode(e,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(e){this._bind(),this._setWrapMode(e,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(e){var t=this._gl,n=this._target,i=this._texture._mipmap;switch(this._bind(),e){case vi.Point:t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(n,t.TEXTURE_MIN_FILTER,i?t.NEAREST_MIPMAP_NEAREST:t.NEAREST);break;case vi.Bilinear:t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,i?t.LINEAR_MIPMAP_NEAREST:t.LINEAR);break;case vi.Trilinear:t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,i?t.LINEAR_MIPMAP_LINEAR:t.LINEAR)}}},{key:"anisoLevel",set:function(e){var t=this._gl;this._bind(),t.texParameterf(this._target,t.TEXTURE_MAX_ANISOTROPY_EXT,e)}}]),e}(),js=function(){function e(e,t){this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._frameBuffer=void 0,this._MSAAFrameBuffer=void 0,this._depthRenderBuffer=void 0,this._MSAAColorRenderBuffers=[],this._MSAADepthRenderBuffer=void 0,this._oriDrawBuffers=void 0,this._blitDrawBuffers=void 0,this._curMipLevel=0,this._gl=e.gl,this._isWebGL2=e.isWebGL2,this._target=t;for(var n=t._colorTextures,i=t._depth,r=t.width,a=t.height,o=i instanceof Ht,s=0,l=n.length;s<l;s++){var u=n[s]._format;if(!Ws._supportRenderBufferColorFormat(u,e))throw new Error("TextureFormat is not supported:"+mi[u]+" in RenderTarget")}if(!Ws._supportRenderBufferDepthFormat(o?i.format:i,e,o))throw new Error("TextureFormat is not supported:"+mi[i]+" in RenderTarget");if(n.length>1&&!e.canIUse(le.drawBuffers))throw new Error("MRT is not supported");if(n.some((function(e){return e.width!==r||e.height!==a})))throw new Error("ColorTexture's size must as same as RenderTarget");if(o&&(i.width!==r||i.height!==a))throw new Error("DepthTexture's size must as same as RenderTarget");if(n.length>1&&n.some((function(e){return e instanceof Pi})))throw new Error("MRT+Cube+[,MSAA] is not supported");var c=e.capability.maxAntiAliasing;t.antiAliasing>c&&(pe.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+c),t._antiAliasing=c),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var t=e.prototype;return t.setRenderTargetInfo=function(e,t){var n=this._gl,i=this._target,r=i.depthTexture,a=i.getColorTexture(0),o=t!==this._curMipLevel;if(n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer),a){var s=a instanceof Pi;(o||s)&&n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,s?n.TEXTURE_CUBE_MAP_POSITIVE_X+e:n.TEXTURE_2D,a._platformTexture._glTexture,t)}if(r){var l=r instanceof Pi;if(o||l){var u=r._platformTexture;n.framebufferTexture2D(n.FRAMEBUFFER,u._formatDetail.attachment,l?n.TEXTURE_CUBE_MAP_POSITIVE_X+e:n.TEXTURE_2D,u._glTexture,t)}}else if(o){var c=Ws._getRenderBufferDepthFormatDetail(i._depth,n,this._isWebGL2).internalFormat;n.bindRenderbuffer(n.RENDERBUFFER,this._depthRenderBuffer),n.renderbufferStorage(n.RENDERBUFFER,c,i.width>>t,i.height>>t)}this._curMipLevel=t,this._activeRenderTarget()},t.blitRenderTarget=function(){if(this._MSAAFrameBuffer){var e=this._gl,t=e.COLOR_BUFFER_BIT|(this._target.depthTexture?e.DEPTH_BUFFER_BIT:0),n=this._target,i=n.colorTextureCount,r=n.width,a=n.height;e.bindFramebuffer(e.READ_FRAMEBUFFER,this._MSAAFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._frameBuffer);for(var o=0;o<i;o++){var s=e.COLOR_ATTACHMENT0+o;this._blitDrawBuffers[o]=s,e.readBuffer(s),e.drawBuffers(this._blitDrawBuffers),e.blitFramebuffer(0,0,r,a,0,0,r,a,t,e.NEAREST),this._blitDrawBuffers[o]=e.NONE}e.bindFramebuffer(e.FRAMEBUFFER,null)}},t.destroy=function(){var e=this._gl;this._frameBuffer&&e.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&e.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&e.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&e.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var t=0;t<this._MSAAColorRenderBuffers.length;t++)e.deleteRenderbuffer(this._MSAAColorRenderBuffers[t]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},t._activeRenderTarget=function(){var e=this._gl;this._MSAAFrameBuffer?e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)},t._bindMainFBO=function(){var e=this._gl,t=this._isWebGL2,n=this._target,i=n._depth,r=n.colorTextureCount,a=n.width,o=n.height,s=new Array(r);e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer);for(var l=0;l<r;l++){var u=this._target.getColorTexture(l),c=e.COLOR_ATTACHMENT0+l;s[l]=c,u instanceof Pi||e.framebufferTexture2D(e.FRAMEBUFFER,c,e.TEXTURE_2D,u._platformTexture._glTexture,0)}if(r>1&&e.drawBuffers(s),this._oriDrawBuffers=s,null!==i)if(i instanceof Ht)i instanceof Pi||e.framebufferTexture2D(e.FRAMEBUFFER,i._platformTexture._formatDetail.attachment,e.TEXTURE_2D,i._platformTexture._glTexture,0);else if(this._target.antiAliasing<=1){var h=Ws._getRenderBufferDepthFormatDetail(i,e,t),_=h.internalFormat,d=h.attachment,f=e.createRenderbuffer();this._depthRenderBuffer=f,e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,_,a,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,d,e.RENDERBUFFER,f)}e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},t._bindMSAAFBO=function(){var e=this._gl,t=this._isWebGL2,n=e.createRenderbuffer(),i=this._target,r=i._depth,a=i.colorTextureCount,o=i.antiAliasing,s=i.width,l=i.height;this._blitDrawBuffers=new Array(a),this._MSAADepthRenderBuffer=n,e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer);for(var u=0;u<a;u++){var c=e.createRenderbuffer();this._MSAAColorRenderBuffers[u]=c,this._blitDrawBuffers[u]=e.NONE,e.bindRenderbuffer(e.RENDERBUFFER,c),e.renderbufferStorageMultisample(e.RENDERBUFFER,o,this._target.getColorTexture(u)._platformTexture._formatDetail.internalFormat,s,l),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+u,e.RENDERBUFFER,c)}if(e.drawBuffers(this._oriDrawBuffers),null!==r){var h=r instanceof Ht?r._platformTexture._formatDetail:Ws._getRenderBufferDepthFormatDetail(r,e,t),_=h.internalFormat,d=h.attachment;e.bindRenderbuffer(e.RENDERBUFFER,n),e.renderbufferStorageMultisample(e.RENDERBUFFER,o,_,s,l),e.framebufferRenderbuffer(e.FRAMEBUFFER,d,e.RENDERBUFFER,n)}this._checkFrameBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},t._checkFrameBuffer=function(){var e=this._gl,t=this._isWebGL2,n=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(n){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case e.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(t&&n===e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},e}(),Xs=function(e){function t(t,n){var i;(i=e.call(this,t,n,t.gl.TEXTURE_2D)||this)._compressedMipFilled=0;var r=n.format,a=n._mipmap,o=n.width,s=n.height,l=i._isWebGL2;if(!Ws._supportTextureFormat(r,t))throw new Error("Texture format is not supported:"+mi[r]);return!a||l||Ws._isPowerOf2(o)&&Ws._isPowerOf2(s)||(pe.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=Ws._getFormatDetail(r,i._gl,l),i._formatDetail.isCompressed&&!l||i._initMipmap(!1),i}Os(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a){void 0===t&&(t=0);var o=this._gl,s=this._isWebGL2,l=this._formatDetail,u=l.internalFormat,c=l.baseFormat,h=l.dataType,_=l.isCompressed,d=Math.max(1,this._texture.width>>t),f=Math.max(1,this._texture.height>>t);if(r=r||d-n,a=a||f-i,this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),_){var p=1<<t;s||this._compressedMipFilled&p?o.compressedTexSubImage2D(this._target,t,n,i,r,a,u,e):(o.compressedTexImage2D(this._target,t,u,r,a,0,e),this._compressedMipFilled|=p)}else o.texSubImage2D(this._target,t,n,i,r,a,c,h,e)},n.setImageSource=function(e,t,n,i,r,a){var o=this._gl,s=this._formatDetail,l=s.baseFormat,u=s.dataType;this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,+n),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),o.texImage2D(this._target,t,l,l,u,e)},n.getPixelBuffer=function(t,n,i,r,a,o){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");e.prototype._getPixelBuffer.call(this,null,t,n,i,r,a,o)},t}(Ws),Ks=function(e){function t(t,n){var i;i=e.call(this,t,n,t.gl.TEXTURE_2D_ARRAY)||this;var r=n.format,a=n.width,o=n.height,s=n.length,l=n.mipmapCount;if(!i._isWebGL2)throw new Error("Texture2D Array is not supported in WebGL1.0");if(!Ws._supportTextureFormat(r,t))throw new Error("Texture format is not supported:"+mi[r]);return i._bind(),i._formatDetail=Ws._getFormatDetail(r,i._gl,!0),i._gl.texStorage3D(i._target,l,i._formatDetail.internalFormat,a,o,s),i}Os(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o,s){var l=this._target,u=this._gl,c=this._formatDetail,h=c.internalFormat,_=c.baseFormat,d=c.dataType,f=c.isCompressed;a=a||Math.max(1,this._texture.width>>n)-i,o=o||Math.max(1,this._texture.height>>n)-r,s=s||this._texture.length,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),f?u.compressedTexSubImage3D(l,n,i,r,e,a,o,s,h,t):u.texSubImage3D(l,n,i,r,e,a,o,s,_,d,t)},n.setImageSource=function(e,t,n,i,r,a,o){var s=this._gl,l=this._formatDetail,u=l.baseFormat,c=l.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+i),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+r),s.texSubImage3D(this._target,n,a,o,e,t.width,t.height,1,u,c,t)},n.getPixelBuffer=function(e,t,n,i,r,a,o){var s=this._gl,l=this._formatDetail;if(l.isCompressed)throw new Error("Unable to read compressed texture");s.bindFramebuffer(s.FRAMEBUFFER,this._getReadFrameBuffer()),s.framebufferTextureLayer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,this._glTexture,a,e),s.readPixels(t,n,i,r,l.baseFormat,l.dataType,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},t}(Ws),qs=function(e){function t(t,n){var i;(i=e.call(this,t,n,t.gl.TEXTURE_CUBE_MAP)||this)._compressedFaceFilled=[0,0,0,0,0,0];var r=n.format,a=n._mipmap,o=n.width,s=i._isWebGL2;if(!Ws._supportTextureFormat(r,t))throw new Error("Texture format is not supported:"+mi[r]);return!a||s||Ws._isPowerOf2(o)||(pe.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=Ws._getFormatDetail(r,i._gl,s),i._formatDetail.isCompressed&&!s||i._initMipmap(!0),i}Os(t,e);var n=t.prototype;return n.setPixelBuffer=function(e,t,n,i,r,a,o){var s=this._gl,l=this._isWebGL2,u=this._formatDetail,c=u.internalFormat,h=u.baseFormat,_=u.dataType,d=u.isCompressed,f=Math.max(1,this._texture.width>>n);if(a=a||f-i,o=o||f-r,this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),d){var p=1<<n;l||this._compressedFaceFilled[e]&p?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,c,t):(s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,c,a,o,0,t),this._compressedFaceFilled[e]|=p)}else s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,i,r,a,o,h,_,t)},n.setImageSource=function(e,t,n,i,r,a,o){var s=this._gl,l=this._formatDetail,u=l.baseFormat,c=l.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+i),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+r),s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,a||0,o||0,u,c,t)},n.getPixelBuffer=function(t,n,i,r,a,o,s){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");e.prototype._getPixelBuffer.call(this,t,n,i,r,a,o,s)},t}(Ws);!function(e){e[e.Auto=0]="Auto",e[e.WebGL2=1]="WebGL2",e[e.WebGL1=2]="WebGL1"}(Ns||(Ns={}));var Ys=function(){function e(e){void 0===e&&(e={}),this._readFrameBuffer=void 0,this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._capability=void 0,this._isWebGL2=void 0,this._webCanvas=void 0,this._activeTextureID=void 0,this._activeTextures=new Array(32),this._lastViewport=new g(null,null,null,null),this._lastClearColor=new v(null,null,null,null),this._scissorEnable=!1,this._options=e}var t=e.prototype;return t.init=function(e){var t=this._options;void 0===t.alpha&&(t.alpha=!1),void 0===t.stencil&&(t.stencil=!0);var i,r=this._webCanvas=e._webCanvas,a=t.webGLMode||Ns.Auto;if(a!=Ns.Auto&&a!=Ns.WebGL2||((i=r.getContext("webgl2",t))||void 0!==n.polyfill.OffscreenCanvas&&r instanceof n.polyfill.OffscreenCanvas||(i=r.getContext("experimental-webgl2",t)),this._isWebGL2=!0,i&&!i.deleteQuery&&(this._isWebGL2=!1)),i||a!=Ns.Auto&&a!=Ns.WebGL1||((i=r.getContext("webgl",t))||void 0!==n.polyfill.OffscreenCanvas&&r instanceof n.polyfill.OffscreenCanvas||(i=r.getContext("experimental-webgl",t)),this._isWebGL2=!1),!i)throw new Error("Get GL Context FAILED.");this._gl=i,this._activeTextureID=i.TEXTURE0,this._renderStates=new Hs(i),this._extensions=new ks(this),this._capability=new Us(this),i.activeTexture(i.TEXTURE0),this._options=null},t.createPlatformPrimitive=function(e){return new Gs(this,e)},t.createPlatformTexture2D=function(e){return new Xs(this,e)},t.createPlatformTexture2DArray=function(e){return new Ks(this,e)},t.createPlatformTextureCube=function(e){return new qs(this,e)},t.createPlatformRenderTarget=function(e){return new js(this,e)},t.requireExtension=function(e){return this._extensions.requireExtension(e)},t.canIUse=function(e){return this.capability.canIUse(e)},t.canIUseCompressedTextureInternalFormat=function(e){return this.capability.canIUseCompressedTextureInternalFormat(e)},t.viewport=function(e,t,n,i){var r=this._gl,a=this._lastViewport;if(e!==a.x||t!==a.y||n!==a.z||i!==a.w){var o=this._webCanvas;0===e&&0===t&&n===o.width&&i===o.height?this._scissorEnable&&(r.disable(r.SCISSOR_TEST),this._scissorEnable=!1):(this._scissorEnable||(r.enable(r.SCISSOR_TEST),this._scissorEnable=!0),r.scissor(e,t,n,i)),r.viewport(e,t,n,i),a.set(e,t,n,i)}},t.colorMask=function(e,t,n,i){this._gl.colorMask(e,t,n,i)},t.clearRenderTarget=function(e,t,n){var i=this._gl,r=e._lastRenderState,a=r.blendState.targetBlendState,o=r.depthState,s=r.stencilState,l=0;if(t&nt.Color){l|=i.COLOR_BUFFER_BIT;var u=this._lastClearColor,c=n.r,h=n.g,_=n.b,d=n.a;!n||c===u.r&&h===u.g&&_===u.b&&d===u.a||(i.clearColor(c,h,_,d),u.set(c,h,_,d)),a.colorWriteMask!==tn.All&&(i.colorMask(!0,!0,!0,!0),a.colorWriteMask=tn.All)}t&nt.Depth&&(l|=i.DEPTH_BUFFER_BIT,!0!==o.writeEnabled&&(i.depthMask(!0),o.writeEnabled=!0)),t&nt.Stencil&&(l|=i.STENCIL_BUFFER_BIT,255!==s.writeMask&&(i.stencilMask(255),s.writeMask=255)),i.clear(l)},t.drawPrimitive=function(e,t,n){e?e._draw(n,t):pe.error("draw primitive failed.")},t.activeRenderTarget=function(e,t,n){var i=this._gl;if(e){var r;null===(r=e._platformRenderTarget)||void 0===r||r._activeRenderTarget();var a=e.width,o=e.height;this.viewport(0,0,a>>n,o>>n)}else{i.bindFramebuffer(i.FRAMEBUFFER,null);var s=t.viewport,l=i.drawingBufferWidth,u=i.drawingBufferHeight,c=l*s.z,h=u*s.w,_=s.x*l,d=u-s.y*u-h;this.viewport(_,d,c,h)}},t.destroy=function(){},t.activeTexture=function(e){this._activeTextureID!==e&&(this._gl.activeTexture(e),this._activeTextureID=e)},t.bindTexture=function(e){var t=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[t]!==e&&(this._gl.bindTexture(e._target,e._glTexture),this._activeTextures[t]=e)},Bs(e,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),e}(),Qs=function(e){function t(t,i){var r=new Vs("string"==typeof t?n.polyfill.document.getElementById(t):t),a=new Ys(i);return e.call(this,r,a)||this}return Os(t,e),Bs(t,[{key:"canvas",get:function(){return this._canvas}}]),t}(br);function Js(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var Zs,$s,el,tl,nl,il,rl,al,ol,sl,ll=function(){function e(e,t){var n=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(e),this._worker.onmessage=function(e){var t=e.data;switch(t.type){case"decode":n._callbacks[t.id].resolve(t.geometry);break;case"error":n._callbacks[t.id].reject(t);break;default:pe.error('DRACOWorker: Unexpected message, "'+t.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var t,n,i,r=e.prototype;return r.setCosts=function(e,t){this._costs[e]=t},r.addCurrentLoad=function(e){this._currentLoad+=e},r.setCallback=function(e,t,n){this._callbacks[e]={resolve:t,reject:n}},r.decode=function(e,t,n){this._worker.postMessage({type:"decode",id:e,taskConfig:t,buffer:n},[n])},r.releaseTask=function(e){this._currentLoad-=this._costs[e],delete this._callbacks[e],delete this._costs[e]},t=e,(n=[{key:"currentLoad",get:function(){return this._currentLoad}}])&&Js(t.prototype,n),i&&Js(t,i),Object.defineProperty(t,"prototype",{writable:!1}),e}(),ul='let decoderPending;\nlet decoderConfig;\n\nonmessage = function(e) {\n  const message = e.data;\n\n  switch (message.type) {\n    case "init":\n      decoderConfig = message.decoderConfig;\n      decoderPending = new Promise(function(resolve /*, reject*/) {\n        decoderConfig.onModuleLoaded = function(draco) {\n          // Module is Promise-like. Wrap before resolving to avoid loop.\n          resolve({ draco: draco });\n        };\n        DracoDecoderModule(decoderConfig);\n      });\n      break;\n\n    case "decode":\n      const buffer = message.buffer;\n      const taskConfig = message.taskConfig;\n      decoderPending.then(module => {\n        const draco = module.draco;\n        const decoder = new draco.Decoder();\n        const decoderBuffer = new draco.DecoderBuffer();\n        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);\n        try {\n          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);\n          const buffers = geometry.attributes.map(attr => attr.array.buffer);\n          if (geometry.index) buffers.push(geometry.index.array.buffer);\n          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);\n        } catch (error) {\n          console.error(error);\n          self.postMessage({ type: "error", id: message.id, error: error.message });\n        } finally {\n          draco.destroy(decoderBuffer);\n          draco.destroy(decoder);\n        }\n      });\n      break;\n  }\n};\n\nfunction decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {\n  const attributeIDs = taskConfig.attributeIDs;\n  const attributeTypes = taskConfig.attributeTypes;\n\n  let dracoGeometry;\n  let decodingStatus;\n\n  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    dracoGeometry = new draco.Mesh();\n    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);\n  } else {\n    throw new Error("DRACODecoder worker: Unexpected geometry type.");\n  }\n\n  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {\n    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());\n  }\n\n  const geometry = { index: null, attributes: [] };\n\n  // Gather all vertex attributes.\n  for (let attributeName in attributeIDs) {\n    const attributeType = self[attributeTypes[attributeName]];\n\n    let attribute;\n    let attributeID;\n\n    // A Draco file may be created with default vertex attributes, whose attribute IDs\n    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,\n    // a Draco file may contain a custom set of attributes, identified by known unique\n    // IDs. glTF files always do the latter, and .drc files typically do the former.\n    if (taskConfig.useUniqueIDs) {\n      attributeID = attributeIDs[attributeName];\n      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);\n    } else {\n      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);\n      if (attributeID === -1) continue;\n      attribute = decoder.GetAttribute(dracoGeometry, attributeID);\n    }\n    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));\n  }\n  // Add index.\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    // Generate mesh faces.\n    const numFaces = dracoGeometry.num_faces();\n    const numIndices = numFaces * 3;\n    let dataSize;\n    let ptr;\n    let index;\n    const indexType = self[taskConfig.indexType];\n\n    switch (indexType) {\n      case Uint16Array:\n        dataSize = numIndices * 2;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);\n        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      case Uint32Array:\n        dataSize = numIndices * 4;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);\n        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      default:\n        throw new Error("DRACODecoder: Unexpected index type.");\n    }\n    geometry.index = { array: index, itemSize: 1 };\n  }\n  draco.destroy(dracoGeometry);\n  return geometry;\n}\n\nfunction decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {\n  const numComponents = attribute.num_components();\n  const numPoints = dracoGeometry.num_points();\n  const numValues = numPoints * numComponents;\n  let ptr;\n  let array;\n  let dataSize;\n  switch (attributeType) {\n    case Float32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);\n      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);\n      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);\n      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);\n      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);\n      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);\n      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);\n      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    default:\n      throw new Error("DRACODecoder: Unexpected attribute type.");\n  }\n\n  return {\n    name: attributeName,\n    array: array,\n    itemSize: numComponents\n  };\n}\n',cl="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",hl=function(){function e(e){var t;(void 0===e&&(e={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(n.polyfill.navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,e.workerLimit>this.workerLimit)?pe.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+e.workerLimit):this.workerLimit=null!=(t=e.workerLimit)?t:4;this.useJS="object"!=typeof WebAssembly||"js"===e.type,this.loadLibPromise=this.preloadLib()}var t=e.prototype;return t.preloadLib=function(){var e=this;return this.loadLibPromise?this.loadLibPromise:new Promise((function(t,i){e.useJS?aa(cl+"draco_decoder_gltf.js",{type:"text"}).then((function(e){var i=[e,ul].join("\n"),r=n.polyfill.URL.createObjectURL(new n.polyfill.Blob([i]));t({workerSourceURL:r,decoderWASMBinary:null})})).catch((function(e){i(e)})):Promise.all([aa(cl+"draco_wasm_wrapper_gltf.js",{type:"text"}),aa(cl+"draco_decoder_gltf.r3bin",{type:"arraybuffer"})]).then((function(e){var i=e[0],r=e[1],a=[i,ul].join("\n"),o=n.polyfill.URL.createObjectURL(new n.polyfill.Blob([a]));t({workerSourceURL:o,decoderWASMBinary:r})})).catch((function(e){i(e)}))}))},t.getWorker=function(){var e=this;return this.preloadLib().then((function(t){if(e.pool.length<e.workerLimit){var n=new ll(t.workerSourceURL,t.decoderWASMBinary);e.pool.push(n)}else e.pool.sort((function(e,t){return e.currentLoad>t.currentLoad?-1:1}));return e.pool[e.pool.length-1]}))},t.decode=function(e,t){var n=this,i=JSON.stringify(t);if(this.taskCache.has(e)){var r=this.taskCache.get(e);if(r.key===i)return r.promise;if(0===e.byteLength)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a,o=this.currentTaskId++,s=e.byteLength,l=new Promise((function(i,r){n.getWorker().then((function(n){a=n,n.setCosts(o,s),n.addCurrentLoad(s),n.setCallback(o,i,r),n.decode(o,t,e)})).catch((function(e){r(e)}))}));return l.finally((function(){a&&o&&a.releaseTask(o)})),this.taskCache.set(e,{key:i,promise:l}),l},e}();function _l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function dl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_l(Object(n),!0).forEach((function(t){yl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function fl(){fl=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",s=r.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof _?t:_,o=Object.create(a.prototype),s=new S(r||[]);return i(o,"_invoke",{value:w(e,n,s)}),o}function c(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var h={};function _(){}function d(){}function f(){}var p={};l(p,a,(function(){return this}));var g=Object.getPrototypeOf,v=g&&g(g(A([])));v&&v!==t&&n.call(v,a)&&(p=v);var m=f.prototype=_.prototype=Object.create(p);function y(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function x(e,t){function r(i,a,o,s){var l=c(e[i],e,a);if("throw"!==l.type){var u=l.arg,h=u.value;return h&&"object"==typeof h&&n.call(h,"__await")?t.resolve(h.__await).then((function(e){r("next",e,o,s)}),(function(e){r("throw",e,o,s)})):t.resolve(h).then((function(e){u.value=e,o(u)}),(function(e){return r("throw",e,o,s)}))}s(l.arg)}var a;i(this,"_invoke",{value:function(e,n){function i(){return new t((function(t,i){r(e,n,t,i)}))}return a=a?a.then(i,i):i()}})}function w(e,t,n){var i="suspendedStart";return function(r,a){if("executing"===i)throw new Error("Generator is already running");if("completed"===i){if("throw"===r)throw a;return P()}for(n.method=r,n.arg=a;;){var o=n.delegate;if(o){var s=b(o,n);if(s){if(s===h)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===i)throw i="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i="executing";var l=c(e,t,n);if("normal"===l.type){if(i=n.done?"completed":"suspendedYield",l.arg===h)continue;return{value:l.arg,done:n.done}}"throw"===l.type&&(i="completed",n.method="throw",n.arg=l.arg)}}}function b(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,b(e,t),"throw"===t.method))return h;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var i=c(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var r=i.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function A(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,r=function t(){for(;++i<e.length;)if(n.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return r.next=r}}return{next:P}}function P(){return{value:void 0,done:!0}}return d.prototype=f,i(m,"constructor",{value:f,configurable:!0}),i(f,"constructor",{value:d,configurable:!0}),d.displayName=l(f,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,l(e,s,"GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},y(x.prototype),l(x.prototype,o,(function(){return this})),e.AsyncIterator=x,e.async=function(t,n,i,r,a){void 0===a&&(a=Promise);var o=new x(u(t,n,i,r),a);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},y(m),l(m,s,"Generator"),l(m,a,(function(){return this})),l(m,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),n=[];for(var i in t)n.push(i);return n.reverse(),function e(){for(;n.length;){var i=n.pop();if(i in t)return e.value=i,e.done=!1,e}return e.done=!0,e}},e.values=A,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(n,i){return o.type="throw",o.arg=e,t.next=n,i&&(t.method="next",t.arg=void 0),!!i}for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r],o=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var s=n.call(a,"catchLoc"),l=n.call(a,"finallyLoc");if(s&&l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var r=this.tryEntries[i];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;T(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:A(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),h}},e}function pl(e,t,n,i,r,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(i,r)}function gl(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var a=e.apply(t,n);function o(e){pl(a,i,r,o,s,"next",e)}function s(e){pl(a,i,r,o,s,"throw",e)}o(void 0)}))}}function vl(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ml(e,t,n){return t&&vl(e.prototype,t),n&&vl(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function yl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function xl(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,wl(e,t)}function wl(e,t){return wl=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},wl(e,t)}function bl(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function Cl(e,t,n){return Cl=bl()?Reflect.construct.bind():function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&wl(r,n.prototype),r},Cl.apply(null,arguments)}function Tl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Sl(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Tl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Tl(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}K(la.Buffer,["bin","r3bin"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e){var t=e.url;return function(e){return/^data:(.+?);base64,/.test(e)}(t)?new j((function(e){var i=t.slice(13+RegExp.$1.length);e(Uint8Array.from(n.polyfill.atob(i),(function(e){return e.charCodeAt(0)})).buffer)})):this.request(t,dl(dl({},e),{},{type:"arraybuffer"}))},t}(da)),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(Zs||(Zs={})),function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"}($s||($s={})),function(e){e.TRANSLATION="translation",e.ROTATION="rotation",e.SCALE="scale",e.WEIGHTS="weights"}(el||(el={})),function(e){e.Linear="LINEAR",e.Step="STEP",e.CubicSpine="CUBICSPLINE"}(tl||(tl={})),function(e){e.PERSPECTIVE="perspective",e.ORTHOGRAPHIC="orthographic"}(nl||(nl={})),function(e){e.JPEG="image/jpeg",e.PNG="image/png"}(il||(il={})),function(e){e.OPAQUE="OPAQUE",e.MASK="MASK",e.BLEND="BLEND"}(rl||(rl={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR"}(al||(al={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(ol||(ol={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(sl||(sl={}));var Al=function(){function e(){}return e.floatBufferToVector2Array=function(e){for(var t=e.length,n=new Array(t/2),i=0;i<t;i+=2)n[i/2]=new p(e[i],e[i+1]);return n},e.floatBufferToVector3Array=function(e){for(var t=e.length,n=new Array(t/3),i=0;i<t;i+=3)n[i/3]=new o(e[i],e[i+1],e[i+2]);return n},e.floatBufferToVector4Array=function(e){for(var t=e.length,n=new Array(t/4),i=0;i<t;i+=4)n[i/4]=new g(e[i],e[i+1],e[i+2],e[i+3]);return n},e.floatBufferToColorArray=function(e,t){var n=e.length,i=new Array(n/(t?3:4));if(t)for(var r=0;r<n;r+=3)i[r/3]=new v(e[r],e[r+1],e[r+2],1);else for(var a=0;a<n;a+=4)i[a/4]=new v(e[a],e[a+1],e[a+2],e[a+3]);return i},e.decodeText=function(e){if(void 0!==n.polyfill.TextDecoder)return(new n.polyfill.TextDecoder).decode(e);for(var t="",i=0,r=e.length;i<r;i++)t+=String.fromCharCode(e[i]);return decodeURIComponent(encodeURIComponent(t))},e.getAccessorTypeSize=function(e){switch(e){case $s.SCALAR:return 1;case $s.VEC2:return 2;case $s.VEC3:return 3;case $s.VEC4:case $s.MAT2:return 4;case $s.MAT3:return 9;case $s.MAT4:return 16}},e.getComponentType=function(e){switch(e){case Zs.BYTE:return Int8Array;case Zs.UNSIGNED_BYTE:return Uint8Array;case Zs.SHORT:return Int16Array;case Zs.UNSIGNED_SHORT:return Uint16Array;case Zs.UNSIGNED_INT:return Uint32Array;case Zs.FLOAT:return Float32Array}},e.getAccessorData=function(t,n,i){var r,a,o=t.bufferViews,s=o[n.bufferView],l=i[s.buffer],u=n.hasOwnProperty("byteOffset")?n.byteOffset:0,c=s.hasOwnProperty("byteOffset")?s.byteOffset:0,h=u+c,_=e.getAccessorTypeSize(n.type),d=_*n.count,f=null!=(r=s.byteStride)?r:0,p=e.getComponentType(n.componentType);if(f){var g=_*p.BYTES_PER_ELEMENT;a=new Uint8Array(n.count*g);for(var v=new Uint8Array(l,c,s.byteLength),m=0;m<n.count;m++)for(var y=0;y<g;y++)a[m*g+y]=v[m*f+u+y]}else a=new Uint8Array(l.slice(h,h+d*p.BYTES_PER_ELEMENT));var x=new p(a.buffer);if(n.sparse)for(var w,b,C,T,S=n.sparse,A=S.count,P=S.indices,M=S.values,E=o[P.bufferView],F=o[M.bufferView],R=i[E.buffer],L=i[F.buffer],D=(null!=(w=P.byteOffset)?w:0)+(null!=(b=E.byteOffset)?b:0),B=E.byteLength,I=(null!=(C=M.byteOffset)?C:0)+(null!=(T=F.byteOffset)?T:0),O=F.byteLength,z=e.getComponentType(P.componentType),N=new z(R,D,B/z.BYTES_PER_ELEMENT),V=new p(L,I,O/p.BYTES_PER_ELEMENT),U=0;U<A;U++)for(var k=N[U],G=0;G<_;G++)x[k*_+G]=V[U*_+G];return x},e.getBufferViewData=function(e,t){var n=e.buffer,i=e.byteOffset,r=void 0===i?0:i,a=e.byteLength;return t[n].slice(r,r+a)},e.getVertexStride=function(t,n){var i,r=t.bufferViews[null!=(i=n.bufferView)?i:0].byteStride;return r||e.getAccessorTypeSize(n.type)*e.getComponentType(n.componentType).BYTES_PER_ELEMENT},e.createVertexElement=function(t,n,i){var r=e.getAccessorTypeSize(n.type);return new _i(t,0,e.getElementFormat(n.componentType,r,n.normalized),i)},e.getIndexFormat=function(e){switch(e){case Zs.UNSIGNED_BYTE:return si.UInt8;case Zs.UNSIGNED_SHORT:return si.UInt16;case Zs.UNSIGNED_INT:return si.UInt32}},e.getElementFormat=function(e,t,n){if(void 0===n&&(n=!1),e==Zs.FLOAT)switch(t){case 1:return ai.Float;case 2:return ai.Vector2;case 3:return ai.Vector3;case 4:return ai.Vector4}if(e==Zs.SHORT)switch(t){case 2:return n?ai.NormalizedShort2:ai.Short2;case 3:case 4:return n?ai.NormalizedShort4:ai.Short4}if(e==Zs.UNSIGNED_SHORT)switch(t){case 2:return n?ai.NormalizedUShort2:ai.UShort2;case 3:case 4:return n?ai.NormalizedUShort4:ai.UShort4}if(e==Zs.BYTE)switch(t){case 2:case 3:case 4:return n?ai.NormalizedByte4:ai.Byte4}if(e==Zs.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return n?ai.NormalizedUByte4:ai.UByte4}},e.loadImageBuffer=function(e,t){return new Promise((function(i,r){var a=new n.polyfill.window.Blob([e],{type:t}),o=new n.polyfill.Image;o.onerror=function(){r(new Error("Failed to load image buffer"))},o.onload=function(){n.polyfill.requestAnimationFrame((function(){i(o),o.onload=null,o.onerror=null,o.onabort=null}))},o.crossOrigin="anonymous",o.src=n.polyfill.URL.createObjectURL(a)}))},e.isAbsoluteUrl=function(e){return/^(?:http|blob|data:|\/)/.test(e)},e.parseRelativeUrl=function(t,n){return e.isAbsoluteUrl(n)?n:"."===n.charAt(0)?e._formatRelativePath(n+n):t.substring(0,t.lastIndexOf("/")+1)+n},e.parseGLB=function(t){var n=1313821514,i=5130562,r=new DataView(t),a={magic:r.getUint32(0,!0),version:r.getUint32(4,!0),length:r.getUint32(8,!0)};if(1179937895!==a.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+a.magic.toString(16)),null;var o=r.getUint32(12,!0),s=r.getUint32(16,!0);if(s!==n)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+s.toString(16)),null;for(var l=new Uint8Array(t,20,o),u=JSON.parse(e.decodeText(l)),c=[],h=20+o;h<a.length;){if(o=r.getUint32(h,!0),(s=r.getUint32(h+4,!0))!==i)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+s.toString(16)),null;var _=h+8,d=t.slice(_,_+o);c.push(d),h+=o+8}return{gltf:u,buffers:c}},e._formatRelativePath=function(e){for(var t=e.split("/"),n=0,i=t.length;n<i;n++)".."==t[n]&&(t.splice(n-1,2),n-=2);return t.join("/")},e}(),Pl=function(){function e(){}return e.parseEngineResource=function(t,n,i,r){var a=e._extensionParsers[t];if(null!=a&&a.length){for(var o=arguments.length,s=new Array(o>4?o-4:0),l=4;l<o;l++)s[l-4]=arguments[l];for(var u=0;u<a.length;u++){var c;(c=a[u]).parseEngineResource.apply(c,[n,i,r].concat(s))}}},e.createEngineResource=function(t,n,i){var r=e._extensionParsers[t];if(null!=r&&r.length){for(var a,o=arguments.length,s=new Array(o>3?o-3:0),l=3;l<o;l++)s[l-3]=arguments[l];return(a=r[0]).createEngineResource.apply(a,[n,i].concat(s))}},e.hasExtensionParser=function(t){var n=e._extensionParsers[t];return!(null==n||!n.length)},e.initialize=function(t){var n=e._extensionParsers[t];if(null!=n&&n.length)for(var i=0;i<n.length;i++)n[i].initialize()},e._addExtensionParser=function(t,n){e._extensionParsers[t]||(e._extensionParsers[t]=[]),e._extensionParsers[t].push(n)},e}();function Ml(e){return function(t){var n=new t;Pl._addExtensionParser(e,n)}}Pl._extensionParsers={};var El=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e);var n=t.prototype;return n.parse=function(e){var t=e.gltf,n=e.buffers,i=e.entities,r=t.animations,a=t.accessors;if(r){for(var o=r.length,s=new Array(o),l=new Array(o),u=0;u<o;u++){for(var c=r[u],h=c.channels,_=c.samplers,d=c.name,f=void 0===d?"AnimationClip"+u:d,p=new Po(f),g=new Array,v=0;v<_.length;v++){var m,y=_[v],x=a[y.input],w=a[y.output],b=Al.getAccessorData(t,x,n),C=Al.getAccessorData(t,w,n),T=C.length/b.length,S=void 0;switch(null!=(m=y.interpolation)?m:tl.Linear){case tl.CubicSpine:S=Ko.CubicSpine;break;case tl.Step:S=Ko.Step;break;case tl.Linear:S=Ko.Linear}b[b.length-1],g.push({type:w.type,interpolation:S,input:b,output:C,outputSize:T})}for(var A=0;A<h.length;A++){for(var P=h[A],M=P.target,E="",F=i[M.node];F.parent;)E=""===E?""+F.name:F.name+"/"+E,F=F.parent;var R=void 0,L=void 0,D=void 0;switch(M.path){case el.TRANSLATION:R=Ze,L="position",D=Ao.Vector3;break;case el.ROTATION:R=Ze,L="rotation",D=Ao.Quaternion;break;case el.SCALE:R=Ze,L="scale",D=Ao.Vector3;break;case el.WEIGHTS:R=qi,L="blendShapeWeights",D=Ao.FloatArray}var B=this._addCurve(D,P,g);p.addCurveBinding(E,R,L,B)}s[u]=p,l[u]={name:f,index:u}}e.animations=s,e._animationsIndices=l}},n._addCurve=function(e,t,n){var i=new os,r=n[t.sampler],a=r.input,s=r.output,l=r.outputSize;i.interpolation=r.interpolation;for(var u=0,c=a.length;u<c;u++){var h=u*l;if(e===Ao.Float){var d=new ls;d.time=a[u],d.inTangent=0,d.outTangent=0,d.value=s[h],i.addKey(d)}else if(e===Ao.FloatArray){var f=new ls;f.time=a[u],f.inTangent=new Float32Array(l),f.outTangent=new Float32Array(l),f.value=s.subarray(h,h+l),i.addKey(f)}else if(e===Ao.Vector2){var v=new ls;v.time=a[u],v.value=new p(s[h],s[h+1]),v.inTangent=new p,v.outTangent=new p,i.addKey(v)}else if(e===Ao.Vector3){var m=new ls;m.time=a[u],m.value=new o(s[h],s[h+1],s[h+2]),m.inTangent=new o,m.outTangent=new o,i.addKey(m)}else if(e===Ao.Vector4){var y=new ls;y.time=a[u],y.value=new g(s[h],s[h+1],s[h+2],s[h+3]),y.inTangent=new g,y.outTangent=new g,i.addKey(y)}else if(e===Ao.Quaternion){var x=new ls;x.time=a[u],x.value=new _(s[h],s[h+1],s[h+2],s[h+3]),x.inTangent=new g,x.outTangent=new g,i.addKey(x)}}return i},t}(Pl),Fl=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e);var n=t.prototype;return n.parse=function(e){var t=e.url,n=e.engine;return this._isGLB(t)?n.resourceManager.load({url:t,type:la.Buffer}).then(Al.parseGLB).then((function(t){var n=t.gltf,i=t.buffers;e.gltf=n,e.buffers=i})):n.resourceManager.load({url:t,type:la.JSON}).then((function(i){return e.gltf=i,Promise.all(i.buffers.map((function(e){return n.resourceManager.load({type:la.Buffer,url:Al.parseRelativeUrl(t,e.uri)})}))).then((function(t){e.buffers=t}))}))},n._isGLB=function(e){return"glb"===e.substring(e.lastIndexOf(".")+1)},t}(Pl),Rl=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e);var n=t.prototype;return n.parse=function(e){var n=e.engine,i=e.gltf.nodes;if(i){for(var r=[],a=0;a<i.length;a++){var o=i[a],s=o.matrix,l=o.translation,u=o.rotation,c=o.scale,h=new et(n,o.name||""+t._defaultName+a),_=h.transform;if(s){var d=_.localMatrix;d.copyFromArray(s),_.localMatrix=d}else l&&_.setPosition(l[0],l[1],l[2]),u&&_.setRotationQuaternion(u[0],u[1],u[2],u[3]),c&&_.setScale(c[0],c[1],c[2]);r[a]=h}e.entities=r,this._buildEntityTree(e),this._createSceneRoots(e)}},n._buildEntityTree=function(e){for(var t=e.gltf.nodes,n=e.entities,i=0;i<t.length;i++){var r=t[i].children,a=n[i];if(r)for(var o=0;o<r.length;o++){var s=n[r[o]];a.addChild(s)}}},n._createSceneRoots=function(e){var t=e.engine,n=e.gltf,i=n.scene,r=void 0===i?0:i,a=n.scenes,o=e.entities;if(a){for(var s=[],l=0;l<a.length;l++){var u=a[l].nodes;if(u)if(1===u.length)s[l]=o[u[0]];else{for(var c=new et(t,"GLTF_ROOT"),h=0;h<u.length;h++)c.addChild(o[u[h]]);s[l]=c}}e.sceneRoots=s,e.defaultSceneRoot=s[r]}},t}(Pl);Rl._defaultName="_GLTF_ENTITY_";var Ll=function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t._parseTextureTransform=function(e,t,n){void 0===t&&(t={});var i=t.KHR_texture_transform;i&&Pl.parseEngineResource("KHR_texture_transform",i,e,n)},t.prototype.parse=function(e){var n=e.gltf,i=e.engine,r=e.textures;if(n.materials){for(var a=[],o=0;o<n.materials.length;o++){var s,l,u=n.materials[o],c=u.extensions,h=void 0===c?{}:c,_=u.pbrMetallicRoughness,d=u.normalTexture,f=u.occlusionTexture,p=u.emissiveTexture,g=u.emissiveFactor,m=u.alphaMode,y=u.alphaCutoff,x=u.doubleSided,w=u.name,b=void 0===w?"":w,C=h.KHR_materials_unlit,T=h.KHR_materials_pbrSpecularGlossiness,S=h.KHR_materials_clearcoat,A=h.OASIS_materials_remap,P=null;if((P=C?Pl.createEngineResource("KHR_materials_unlit",C,e):T?Pl.createEngineResource("KHR_materials_pbrSpecularGlossiness",T,e):new va(i)).name=b,S&&Pl.parseEngineResource("KHR_materials_clearcoat",S,P,e),_){var M=_.baseColorFactor,E=_.baseColorTexture,F=_.metallicFactor,R=_.roughnessFactor,L=_.metallicRoughnessTexture;if(M&&(P.baseColor=new v(v.linearToGammaSpace(M[0]),v.linearToGammaSpace(M[1]),v.linearToGammaSpace(M[2]),M[3])),E&&(P.baseTexture=r[E.index],t._parseTextureTransform(P,E.extensions,e)),!C&&!T){var D=P;D.metallic=null!=F?F:1,D.roughness=null!=R?R:1,L&&(D.roughnessMetallicTexture=r[L.index],t._parseTextureTransform(P,L.extensions,e))}}if(!C){var B=P;if(p&&(B.emissiveTexture=r[p.index],t._parseTextureTransform(P,p.extensions,e)),g&&(B.emissiveColor=new v(v.linearToGammaSpace(g[0]),v.linearToGammaSpace(g[1]),v.linearToGammaSpace(g[2]))),d){var I=d.index,O=d.scale;B.normalTexture=r[I],t._parseTextureTransform(P,d.extensions,e),void 0!==O&&(B.normalTextureIntensity=O)}if(f){var z=f.index,N=f.strength,V=f.texCoord;B.occlusionTexture=r[z],t._parseTextureTransform(P,f.extensions,e),void 0!==N&&(B.occlusionTextureIntensity=N),V===ha.UV1?B.occlusionTextureCoord=ha.UV1:V>ha.UV1&&pe.warn("Occlusion texture uv coordinate must be UV0 or UV1.")}}if(A)e.gltf.extensions=null!=(s=e.gltf.extensions)?s:{},e.gltf.extensions.OASIS_materials_remap=null!=(l=e.gltf.extensions.OASIS_materials_remap)?l:{},e.gltf.extensions.OASIS_materials_remap[o]=Pl.createEngineResource("OASIS_materials_remap",A,e);switch(P.renderFace=x?ua.Double:ua.Front,m){case rl.OPAQUE:P.isTransparent=!1;break;case rl.BLEND:P.isTransparent=!0;break;case rl.MASK:P.alphaCutoff=null!=y?y:.5}a[o]=P}e.materials=a}},t}(Pl),Dl=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e);var n=t.prototype;return n.parse=function(e){var t=this,n=e.engine,i=e.gltf,r=e.buffers;if(i.meshes){for(var a=[],o=function(o){for(var s=i.meshes[o],l=[],u=function(a){var o=s.primitives[a],u=o.extensions,c=(void 0===u?{}:u).KHR_draco_mesh_compression;l.push(new Promise((function(l){var u=new Fi(n,s.name||a+"");c?Pl.createEngineResource("KHR_draco_mesh_compression",c,e,o).then((function(e){return t._parseMeshFromGLTFPrimitive(u,s,o,i,(function(t){for(var n=0;n<e.attributes.length;n++)if(e.attributes[n].name===t)return e.attributes[n].array;return null}),(function(e,t){throw"BlendShape animation is not supported when using draco."}),(function(){return e.index.array}),n)})).then(l):t._parseMeshFromGLTFPrimitive(u,s,o,i,(function(e){var t=o.attributes[e],n=i.accessors[t];return Al.getAccessorData(i,n,r)}),(function(e,t){var n=o.targets[t][e];if(n){var a=i.accessors[n];return Al.getAccessorData(i,a,r)}return null}),(function(){var e=i.accessors[o.indices];return Al.getAccessorData(i,e,r)}),n).then(l)})))},c=0;c<s.primitives.length;c++)u(c);a.push(Promise.all(l))},s=0;s<i.meshes.length;s++)o(s);return Promise.all(a).then((function(t){e.meshes=t}))}},n._parseMeshFromGLTFPrimitive=function(e,n,i,r,a,s,l,u){var c,h=i.attributes,_=i.targets,d=i.indices,f=i.mode,p=r.accessors,g=p[h.POSITION],v=a("POSITION"),m=Al.floatBufferToVector3Array(v);e.setPositions(m);var y=e.bounds;if(c=g.count,g.min&&g.max)y.min.copyFromArray(g.min),y.max.copyFromArray(g.max);else{var x=t._tempVector3,w=y.min,b=y.max;w.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),b.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var C=v.length/c,T=0;T<c;T++){var S=T*C;x.copyFromArray(v,S),o.min(w,x,w),o.max(b,x,b)}}for(var A in h)if("POSITION"!==A){var P=a(A);switch(A){case"NORMAL":var M=Al.floatBufferToVector3Array(P);e.setNormals(M);break;case"TEXCOORD_0":var E=Al.floatBufferToVector2Array(P);e.setUVs(E,0);break;case"TEXCOORD_1":var F=Al.floatBufferToVector2Array(P);e.setUVs(F,1);break;case"TEXCOORD_2":var R=Al.floatBufferToVector2Array(P);e.setUVs(R,2);break;case"TEXCOORD_3":var L=Al.floatBufferToVector2Array(P);e.setUVs(L,3);break;case"TEXCOORD_4":var D=Al.floatBufferToVector2Array(P);e.setUVs(D,4);break;case"TEXCOORD_5":var B=Al.floatBufferToVector2Array(P);e.setUVs(B,5);break;case"TEXCOORD_6":var I=Al.floatBufferToVector2Array(P);e.setUVs(I,6);break;case"TEXCOORD_7":var O=Al.floatBufferToVector2Array(P);e.setUVs(O,7);break;case"COLOR_0":var z=Al.floatBufferToColorArray(P,p[h.COLOR_0].type===$s.VEC3);e.setColors(z);break;case"TANGENT":var N=Al.floatBufferToVector4Array(P);e.setTangents(N);break;case"JOINTS_0":var V=Al.floatBufferToVector4Array(P);e.setBoneIndices(V);break;case"WEIGHTS_0":var U=Al.floatBufferToVector4Array(P);e.setBoneWeights(U)}}if(void 0!==d){var k=r.accessors[d],G=l();e.setIndices(G),e.addSubMesh(0,k.count,f)}else e.addSubMesh(0,c,f);return _&&this._createBlendShape(e,n,_,s),e.uploadData(!0),Promise.resolve(e)},n._createBlendShape=function(e,t,n,i){for(var r=t.extras?t.extras.targetNames:null,a=0,o=n.length;a<o;a++){var s=r?r[a]:"blendShape"+a,l=i("POSITION",a),u=i("NORMAL",a),c=i("TANGENT",a),h=l?Al.floatBufferToVector3Array(l):null,_=u?Al.floatBufferToVector3Array(u):null,d=c?Al.floatBufferToVector3Array(c):null,f=new Zi(s);f.addFrame(1,h,_,d),e.addBlendShape(f)}},t}(Pl);Dl._tempVector3=new o;var Bl=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e),t._getDefaultMaterial=function(e){return t._defaultMaterial||(t._defaultMaterial=new pa(e)),t._defaultMaterial};var n=t.prototype;return n.parse=function(e){var t=e.gltf,n=t.nodes,i=t.cameras,r=e.entities;if(n){for(var a=[],o=0;o<n.length;o++){var s=n[o],l=s.camera,u=s.mesh,c=s.extensions,h=(void 0===c?{}:c).KHR_lights_punctual,_=r[o];if(void 0!==l&&this._createCamera(e,i[l],_),void 0!==u&&a.push(this._createRenderer(e,s,_)),h){var d=h.light,f=e.gltf.extensions.KHR_lights_punctual.lights;Pl.parseEngineResource("KHR_lights_punctual",f[d],_,e)}}return e.defaultSceneRoot&&this._createAnimator(e),e.gltf.extensions&&delete e.gltf.extensions.OASIS_materials_remap,Promise.all(a)}},n._createCamera=function(e,t,n){var i=t.orthographic,r=t.perspective,a=t.type,o=n.addComponent(ia);if(a===nl.ORTHOGRAPHIC){var s=i.xmag,l=i.ymag,u=i.zfar,c=i.znear;o.isOrthographic=!0,void 0!==c&&(o.nearClipPlane=c),void 0!==u&&(o.farClipPlane=u),o.orthographicSize=Math.max(null!=l?l:0,null!=s?s:0)/2}else if(a===nl.PERSPECTIVE){var h=r.aspectRatio,_=r.yfov,d=r.zfar,f=r.znear;void 0!==h&&(o.aspectRatio=h),void 0!==_&&(o.fieldOfView=180*_/Math.PI),void 0!==d&&(o.farClipPlane=d),void 0!==f&&(o.nearClipPlane=f)}e.cameras||(e.cameras=[]),e.cameras.push(o),o.enabled=!1},n._createRenderer=function(e,n,i){for(var r=e.engine,a=e.gltf.meshes,o=e.meshes,s=e.materials,l=e.skins,u=n.mesh,c=n.skin,h=a[u],_=h.primitives,d=n.weights||h.weights,f=[],p=function(n){var a=o[u][n],h=void 0;if(void 0!==c||d){var p=i.addComponent(qi);p.mesh=a,void 0!==c&&(p.skin=l[c]),d&&(p.blendShapeWeights=new Float32Array(d)),h=p}else(h=i.addComponent(Ki)).mesh=a;var g=_[n].material,v=e.gltf.extensions&&e.gltf.extensions.OASIS_materials_remap;if(v&&v[g])f.push(v[g].then((function(e){h.setMaterial(e)})));else{var m=(null==s?void 0:s[g])||t._getDefaultMaterial(r);h.setMaterial(m)}var y=_[n].extensions,x=(void 0===y?{}:y).KHR_materials_variants;x&&Pl.parseEngineResource("KHR_materials_variants",x,h,e)},g=0;g<_.length;g++)p(g);return Promise.all(f)},n._createAnimator=function(e){var t=e.defaultSceneRoot,n=e.animations;if(n){var i=t.addComponent($o),r=new es,a=new ts("layer"),o=new rs;if(r.addLayer(a),i.animatorController=r,a.stateMachine=o,n)for(var s=0;s<n.length;s++){var l=n[s],u=l.name,c=o.makeUniqueStateName(u);c!==u&&console.warn("AnimatorState name is existed, name: "+u+" reset to "+c),o.addState(c).clip=l}}},t}(Pl);Bl._defaultMaterial=void 0;var Il=function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.parse=function(e){var t=e.gltf,n=e.buffers,i=e.entities,r=e.defaultSceneRoot,a=t.skins;if(a){for(var o=[],s=0;s<a.length;s++){var l=a[s],u=l.inverseBindMatrices,c=l.skeleton,h=l.joints,_=l.name,f=void 0===_?"SKIN_"+s:_,p=h.length,g=new Xi(f);g.inverseBindMatrices.length=p;for(var v=t.accessors[u],m=Al.getAccessorData(t,v,n),y=0;y<p;y++){var x=new d;x.copyFromArray(m,16*y),g.inverseBindMatrices[y]=x}for(var w=0;w<p;w++)g.joints[w]=i[h[w]].name;g.skeleton=void 0!==c?i[c].name:r.name,o[s]=g}e.skins=o}},t}(Pl),Ol=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e);var n=t.prototype;return n.parse=function(e){var t=this,n=e.gltf,i=e.buffers,r=e.engine,a=e.url;if(n.textures)return Promise.all(n.textures.map((function(e,o){var s=e.sampler,l=e.source,u=void 0===l?0:l,c=e.name,h=n.images[u],_=h.uri,d=h.bufferView,f=h.mimeType,p=h.name;if(_)return r.resourceManager.load({url:Al.parseRelativeUrl(a,_),type:la.Texture2D}).then((function(e){return e.name||(e.name=c||p||"texture_"+o),void 0!==s&&t._parseSampler(e,n.samplers[s]),e}));var g=n.bufferViews[d],v=Al.getBufferViewData(g,i);return Al.loadImageBuffer(v,f).then((function(e){var i=new Si(r,e.width,e.height);return i.setImageSource(e),i.generateMipmaps(),i.name=c||p||"texture_"+o,void 0!==s&&t._parseSampler(i,n.samplers[s]),i}))}))).then((function(t){e.textures=t}))},n._parseSampler=function(e,n){var i=n.magFilter,r=n.minFilter,a=n.wrapS,o=n.wrapT;(i||r)&&pe.warn("texture use filterMode in engine"),a&&(e.wrapModeU=t._wrapMap[a]),o&&(e.wrapModeV=t._wrapMap[o])},t}(Pl);Ol._wrapMap={33071:yi.Clamp,33648:yi.Mirror,10497:yi.Repeat};var zl=function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.parse=function(e){var t=e.gltf,n=t.asset.version,i=t.extensionsUsed,r=t.extensionsRequired,a=Number(n);if(!(a>=2&&a<3))throw"Only support gltf 2.x.";if(i){pe.info("extensionsUsed: ",i);for(var o=0;o<i.length;o++)Pl.hasExtensionParser(i[o])||pe.warn("Extension "+i[o]+" is not implemented, you can customize this extension in gltf.")}if(r){pe.info("extensionsRequired: "+r);for(var s=0;s<r.length;s++){var l=r[s];Pl.hasExtensionParser(l)?Pl.initialize(l):pe.error("GLTF parser has not supported required extension "+l+".")}}},t}(Pl),Nl=function(){function e(e){var t=this;this._pipes=[],e.forEach((function(e,n){t._pipes[n]=new e}))}return e.prototype.parse=function(e){var t,n=this;return new Promise((function(i,r){n._pipes.forEach((function(n){t=t?t.then((function(){return n.parse(e)})):n.parse(e)})),t?t.then((function(){i(e)})).catch(r):i(e)}))},e}();Nl.instance=new Nl([Fl,zl,Ol,Ll,Dl,Rl,Il,El,Bl]);var Vl=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).url=void 0,t.gltf=void 0,t.buffers=void 0,t.textures=void 0,t.materials=void 0,t.meshes=void 0,t.skins=void 0,t.animations=void 0,t.entities=void 0,t.cameras=void 0,t.lights=void 0,t.sceneRoots=void 0,t.defaultSceneRoot=void 0,t.variants=void 0,t}return xl(t,e),t}(ve);K(la.Prefab,["gltf","glb"])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=e.url;return new j((function(e,i){var r=new Vl(t.engine);r.url=n,Nl.instance.parse(r).then(e).catch((function(e){console.error(e),i("Error loading glTF model from "+n+" .")}))}))},t}(da)),K(la.JSON,["json"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e){return this.request(e.url,dl(dl({},e),{},{type:"json"}))},t}(da));var Ul,kl=function(e,t,n,i){if(void 0===i&&(i=!1),!function(e){if(e.byteLength>=12){var t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}(e))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(e,12,13*r),o=67305985===a.getUint32(0,!0),s={buffer:e,glType:a.getUint32(1*r,o),glTypeSize:a.getUint32(2*r,o),glFormat:a.getUint32(3*r,o),glInternalFormat:a.getUint32(4*r,o),glBaseInternalFormat:a.getUint32(5*r,o),pixelWidth:a.getUint32(6*r,o),pixelHeight:a.getUint32(7*r,o),pixelDepth:a.getUint32(8*r,o),numberOfArrayElements:a.getUint32(9*r,o),numberOfFaces:a.getUint32(10*r,o),numberOfMipmapLevels:a.getUint32(11*r,o),bytesOfKeyValueData:a.getUint32(12*r,o),loadType:0};if(0!==s.glType)throw new Error("only compressed formats currently supported");if(s.numberOfMipmapLevels=Math.max(1,s.numberOfMipmapLevels),0===s.pixelHeight||0!==s.pixelDepth)throw new Error("only 2D textures currently supported");if(0!==s.numberOfArrayElements)throw new Error("texture arrays not currently supported");if(s.numberOfFaces!==t)throw new Error("number of faces expected"+t+", but found "+s.numberOfFaces);return n&&(s.mipmaps=function(e,t){for(var n=[],i=64+e.bytesOfKeyValueData,r=e.pixelWidth,a=e.pixelHeight,o=t?e.numberOfMipmapLevels:1,s=0;s<o;s++){var l=new Int32Array(e.buffer,i,1)[0];i+=4;for(var u=0;u<e.numberOfFaces;u++){var c=new Uint8Array(e.buffer,i,l);n.push({data:c,width:r,height:a}),i+=l,i+=3-(l+3)%4}r=Math.max(1,.5*r),a=Math.max(1,.5*a)}return n}(s,!0)),i&&(s.engineFormat=function(e){switch(e){case Fs.RGB_S3TC_DXT1_EXT:return mi.DXT1;case Fs.RGBA_S3TC_DXT5_EXT:return mi.DXT5;case Fs.RGB_ETC1_WEBGL:return mi.ETC1_RGB;case Fs.RGB8_ETC2:return mi.ETC2_RGB;case Fs.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return mi.ETC2_RGBA5;case Fs.RGBA8_ETC2_EAC:return mi.ETC2_RGBA8;case Fs.RGB_PVRTC_2BPPV1_IMG:return mi.PVRTC_RGB2;case Fs.RGBA_PVRTC_2BPPV1_IMG:return mi.PVRTC_RGBA2;case Fs.RGB_PVRTC_4BPPV1_IMG:return mi.PVRTC_RGB4;case Fs.RGBA_PVRTC_4BPPV1_IMG:return mi.PVRTC_RGBA4;case Fs.RGBA_ASTC_4X4_KHR:return mi.ASTC_4x4;case Fs.RGBA_ASTC_5X5_KHR:return mi.ASTC_5x5;case Fs.RGBA_ASTC_6X6_KHR:return mi.ASTC_6x6;case Fs.RGBA_ASTC_8X8_KHR:return mi.ASTC_8x8;case Fs.RGBA_ASTC_10X10_KHR:return mi.ASTC_10x10;case Fs.RGBA_ASTC_12X12_KHR:return mi.ASTC_12x12;default:var t=Fs[e];throw new Error("this format is not supported in Oasis Engine: "+t)}}(s.glInternalFormat)),s};K(la.KTXCube,[])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){Promise.all(e.urls.map((function(t){return n.request(t,dl(dl({},e),{},{type:"arraybuffer"}))}))).then((function(e){for(var n=function(e){for(var t,n,i,r,a=[],o=0;o<e.length;o++){var s=kl(e[o],1,!0,!0);a.push(s.mipmaps),0===o&&(i=s.pixelWidth,r=s.pixelHeight,t=s.glInternalFormat,n=s.engineFormat)}return{mipmapsFaces:a,engineFormat:n,internalFormat:t,width:i,height:r}}(e),r=n.width,a=n.mipmapsFaces,o=n.engineFormat,s=a[0].length>1,l=new Pi(t.engine,r,o,s),u=0;u<6;u++)for(var c=a[u].length,h=0;h<c;h++){var _=a[u][h],d=_.data,f=_.width,p=_.height;l.setPixelBuffer(gi.PositiveX+u,d,h,0,0,f,p)}i(l)})).catch((function(e){r(e)}))}))},t}(da)),K(la.KTX,["ktx"])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,dl(dl({},e),{},{type:"arraybuffer"})).then((function(e){for(var n=function(e){var t=kl(e,1,!0,!0);return{mipmaps:t.mipmaps,engineFormat:t.engineFormat,internalFormat:t.glInternalFormat,width:t.pixelWidth,height:t.pixelHeight}}(e),r=n.width,a=n.height,o=n.mipmaps,s=n.engineFormat,l=o.length>1,u=new Si(t.engine,r,a,s,l),c=0;c<o.length;c++){var h=o[c],_=h.width,d=h.height,f=h.data;u.setPixelBuffer(f,c,0,0,_,d)}i(u)})).catch((function(e){r(e)}))}))},t}(da)),K(la.Texture2D,["png","jpg","webp","jpeg"])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,dl(dl({},e),{},{type:"image"})).then((function(n){var r=new Si(t.engine,n.width,n.height);if(r._platformTexture){if(r.setImageSource(n),r.generateMipmaps(),0!==e.url.indexOf("data:")){var a=e.url.split("/");r.name=a[a.length-1]}i(r)}})).catch((function(e){r(e)}))}))},t}(da)),K(la.TextureCube,[""])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){Promise.all(e.urls.map((function(t){return n.request(t,dl(dl({},e),{},{type:"image"}))}))).then((function(e){var n=e[0],r=n.width;if(r===n.height){var a=new Pi(t.engine,r);if(a._platformTexture){for(var o=0;o<6;o++)a.setImageSource(gi.PositiveX+o,e[o],0);a.generateMipmaps(),i(a)}}else console.error("The cube texture must have the same width and height")})).catch((function(e){r(e)}))}))},t}(da)),K(la.Sprite,["sprite"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,dl(dl({},e),{},{type:"json"})).then((function(e){t.getResourceByRef(e.texture).then((function(n){var r=new Ea(t.engine,n);r.region=e.region,r.pivot=e.pivot,i(r)}))}))}))},t}(da)),K(la.SpriteAtlas,["atlas"],!1)(function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._tempRect=new m,t._tempVec2=new p,t}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,dl(dl({},e),{},{type:"json"})).then((function(r){var a=r.atlasItems,o=r.format,s=a.length;Promise.all(a.map((function(t){var i=t.img;return n.request(Al.parseRelativeUrl(e.url,i),dl(dl({},e),{},{type:"image"}))}))).then((function(e){for(var r=t.engine,l=n._tempRect,u=n._tempVec2,c=new Sa(r),h=0;h<s;h++){var _=e[h],d=_.width,f=_.height,p=new Si(r,d,f,o);p.setImageSource(_),p.generateMipmaps();for(var g=a[h].sprites,v=1/d,m=1/f,y=g.length-1;y>=0;y--){var x=g[y],w=x.region,b=x.atlasRegionOffset,C=x.atlasRegion,T=x.id,S=x.pivot,A=new Ea(r,p,w?l.set(w.x,w.y,w.w,w.h):void 0,S?u.set(S.x,S.y):void 0,void 0,x.name);if(A.atlasRegion.set(C.x*v,C.y*m,C.w*v,C.h*m),x.atlasRotated&&(A.atlasRotated=!0),b){var P=b.x,M=b.y,E=b.z,F=b.w;A.atlasRegionOffset.set(P*v,M*m,E*v,F*m)}void 0!==T&&(A._assetID=T),c._addSprite(A)}}i(c)}))})).catch((function(e){r(e)}))}))},t}(da)),K(la.Env,["env"])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,{type:"arraybuffer"}).then((function(e){var n,r=new Float32Array(e,0,27),a=null===(n=new Uint16Array(e,108,1))||void 0===n?void 0:n[0],o=new Pi(t.engine,a);o.filterMode=vi.Trilinear;for(var s=o.mipmapCount,l=110,u=0;u<s;u++)for(var c=a>>u,h=0;h<6;h++){var _=c*c*4,d=new Uint8Array(e,l,_);l+=_,o.setPixelBuffer(gi.PositiveX+h,d,u)}var f=new lr,p=new y;f.diffuseMode=ar.SphericalHarmonics,p.copyFromArray(r),f.diffuseSphericalHarmonics=p,f.specularTexture=o,f.specularTextureDecodeRGBM=!0,i(f)})).catch((function(e){r(e)}))}))},t}(da));var Gl=Math.PI;K(la.HDR,["hdr"])(((Ul=function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t._convertToCubemap=function(e,t,n,i){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*n*4)throw"ConvertPanoramaToCubemap: input size is wrong";return[this._createCubemapData(i,this._faceRight,e,t,n),this._createCubemapData(i,this._faceLeft,e,t,n),this._createCubemapData(i,this._faceUp,e,t,n),this._createCubemapData(i,this._faceBottom,e,t,n),this._createCubemapData(i,this._faceFront,e,t,n),this._createCubemapData(i,this._faceBack,e,t,n)]},t._createCubemapData=function(e,t,n,i,r){for(var a=new Uint8ClampedArray(e*e*4),o=this._tempVector3.set(0,0,0).add(t[1]).subtract(t[0]).scale(1/e),s=this._temp2Vector3.set(0,0,0).add(t[3]).subtract(t[2]).scale(1/e),l=1/e,u=0,c=0;c<e;c++){for(var h=this._temp3Vector3.set(0,0,0).add(t[0]),_=this._temp4Vector3.set(0,0,0).add(t[2]),d=0;d<e;d++){var f=this._temp5Vector3.set(0,0,0).add(_).subtract(h).scale(u).add(h);f.normalize();var p=this._calcProjectionSpherical(f,n,i,r);this._RGBEToLinear(p),this._linearToRGBM(p,5);var g=c*e*4+4*d;a[g]=p.r,a[g+1]=p.g,a[g+2]=p.b,a[g+3]=p.a,h.add(o),_.add(s)}u+=l}return a},t._calcProjectionSpherical=function(e,t,n,i){for(var r=Math.atan2(e.z,-e.x),a=Math.acos(e.y);r<-Gl;)r+=2*Gl;for(;r>Gl;)r-=2*Gl;var o=r/Gl,s=a/Gl;o=.5*o+.5;var l=Math.round(o*n);l<0?l=0:l>=n&&(l=n-1);var u=Math.round(s*i);u<0?u=0:u>=i&&(u=i-1);var c=(i-u-1)*n*4+4*l,h=t[c],_=t[c+1],d=t[c+2],f=t[c+3];return new v(h,_,d,f)},t._readStringLine=function(e,t){for(var n="",i="",r=t;r<e.length-t&&"\n"!=(i=String.fromCharCode(e[r]));r++)n+=i;return n},t._parseHeader=function(e){var t,n,i=this._readStringLine(e,0);if("#"!=i[0]||"?"!=i[1])throw"Bad HDR Format.";var r=!1,a=!1,o=0;do{o+=i.length+1,"FORMAT=32-bit_rle_rgbe"==(i=this._readStringLine(e,o))?a=!0:0==i.length&&(r=!0)}while(!r);if(!a)throw"HDR Bad header format, unsupported FORMAT";o+=i.length+1,i=this._readStringLine(e,o);var s=/^\-Y (.*) \+X (.*)$/g.exec(i);if(!s||s.length<3)throw"HDR Bad header format, no size";if(n=parseInt(s[2]),t=parseInt(s[1]),n<8||n>32767)throw"HDR Bad header format, unsupported size";return{height:t,width:n,dataPosition:o+=i.length+1}},t._readPixels=function(e,t,n){for(var i=t,r=e.byteLength,a=new Uint8Array(4*t*n),o=0,s=0,l=4*i,u=new Uint8Array(4),c=new Uint8Array(l),h=n;h>0&&s<r;){if(u[0]=e[s++],u[1]=e[s++],u[2]=e[s++],u[3]=e[s++],2!=u[0]||2!=u[1]||(u[2]<<8|u[3])!=i)throw"HDR Bad header format, wrong scan line width";for(var _=0,d=void 0;_<l&&s<r;){var f=(d=e[s++])>128;if(f&&(d-=128),0===d||_+d>l)throw"HDR Bad Format, bad scanline data (run)";if(f)for(var p=e[s++],g=0;g<d;g++)c[_++]=p;else c.set(e.subarray(s,s+d),_),_+=d,s+=d}for(var v=i,m=0;m<v;m++){var y=0;a[o]=c[m+y],y+=i,a[o+1]=c[m+y],y+=i,a[o+2]=c[m+y],y+=i,a[o+3]=c[m+y],o+=4}h--}return a},t._RGBEToLinear=function(e){var t=Math.pow(2,e.a-128)/255;e.r*=t,e.g*=t,e.b*=t,e.a=1},t._linearToRGBM=function(e,t){var n=Math.max(e.r,Math.max(e.g,e.b)),i=Math.min(n/t,1),r=65025/((i=Math.ceil(255*i))*t);e.r*=r,e.g*=r,e.b*=r,e.a*=i},t.prototype.load=function(e,n){var i=this;return new j((function(r,a){var o=n.engine;i.request(e.url,{type:"arraybuffer"}).then((function(e){for(var n=new Uint8Array(e),i=t._parseHeader(n),a=i.width,s=i.height,l=i.dataPosition,u=t._readPixels(n.subarray(l),a,s),c=s>>1,h=t._convertToCubemap(u,a,s,c),_=new Pi(o,c),d=0;d<6;d++)_.setPixelBuffer(gi.PositiveX+d,h[d],0);_.generateMipmaps(),r(_)})).catch(a)}))},t}(da))._rightBottomBack=new o(1,-1,-1),Ul._rightBottomFront=new o(1,-1,1),Ul._rightUpBack=new o(1,1,-1),Ul._rightUpFront=new o(1,1,1),Ul._leftBottomBack=new o(-1,-1,-1),Ul._leftBottomFront=new o(-1,-1,1),Ul._leftUpBack=new o(-1,1,-1),Ul._leftUpFront=new o(-1,1,1),Ul._faceRight=[Ul._rightBottomBack,Ul._rightBottomFront,Ul._rightUpBack,Ul._rightUpFront],Ul._faceLeft=[Ul._leftBottomFront,Ul._leftBottomBack,Ul._leftUpFront,Ul._leftUpBack],Ul._faceUp=[Ul._leftBottomFront,Ul._rightBottomFront,Ul._leftBottomBack,Ul._rightBottomBack],Ul._faceBottom=[Ul._leftUpBack,Ul._rightUpBack,Ul._leftUpFront,Ul._rightUpFront],Ul._faceFront=[Ul._leftBottomBack,Ul._rightBottomBack,Ul._leftUpBack,Ul._rightUpBack],Ul._faceBack=[Ul._rightBottomFront,Ul._leftBottomFront,Ul._rightUpFront,Ul._leftUpFront],Ul._tempVector3=new o,Ul._temp2Vector3=new o,Ul._temp3Vector3=new o,Ul._temp4Vector3=new o,Ul._temp5Vector3=new o,Ul));var Hl,Wl=function(){function e(){}var t=e.prototype;return t.initialize=function(){},t.parseEngineResource=function(e,t,n){},t.createEngineResource=function(e,t){return null},e}();Ml("KHR_draco_mesh_compression")(((Hl=function(e){function t(){return e.apply(this,arguments)||this}xl(t,e);var n=t.prototype;return n.initialize=function(){t._decoder||(t._decoder=new hl)},n.createEngineResource=function(e,n,i){var r=n.gltf,a=n.buffers,o=r.bufferViews,s=r.accessors,l=e.bufferView,u=e.attributes,c={},h={};for(var _ in u)c[_]=u[_];for(var d in i.attributes)if(void 0!==u[d]){var f=s[i.attributes[d]];h[d]=Al.getComponentType(f.componentType).name}var p=s[i.indices],g={attributeIDs:c,attributeTypes:h,useUniqueIDs:!0,indexType:Al.getComponentType(p.componentType).name},v=Al.getBufferViewData(o[l],a);return t._decoder.decode(v,g).then((function(e){return e}))},t}(Wl))._decoder=void 0,Hl)),Ml("KHR_lights_punctual")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.parseEngineResource=function(e,t,n){var i,r=e.color,a=e.intensity,o=void 0===a?1:a,s=e.type,l=e.range,u=e.spot;if("directional"===s?i=t.addComponent(hr):"point"===s?i=t.addComponent(_r):"spot"===s&&(i=t.addComponent(dr)),r&&i.color.set(r[0],r[1],r[2],1),i.intensity=o,!l||i instanceof hr||(i.distance=l),u&&i instanceof dr){var c=u.innerConeAngle,h=void 0===c?0:c,_=u.outerConeAngle,d=void 0===_?Math.PI/4:_;i.angle=h,i.penumbra=d-h}n.lights||(n.lights=[]),n.lights.push(i)},t}(Wl)),Ml("KHR_materials_clearcoat")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.parseEngineResource=function(e,t,n){var i=n.textures,r=e.clearcoatFactor,a=void 0===r?0:r,o=e.clearcoatTexture,s=e.clearcoatRoughnessFactor,l=void 0===s?0:s,u=e.clearcoatRoughnessTexture,c=e.clearcoatNormalTexture;t.clearCoat=a,t.clearCoatRoughness=l,o&&(t.clearCoatTexture=i[o.index],Ll._parseTextureTransform(t,o.extensions,n)),u&&(t.clearCoatRoughnessTexture=i[u.index],Ll._parseTextureTransform(t,u.extensions,n)),c&&(t.clearCoatNormalTexture=i[c.index],Ll._parseTextureTransform(t,c.extensions,n))},t}(Wl)),Ml("KHR_materials_pbrSpecularGlossiness")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.createEngineResource=function(e,t){var n=t.engine,i=t.textures,r=new ma(n),a=e.diffuseFactor,o=e.diffuseTexture,s=e.specularFactor,l=e.glossinessFactor,u=e.specularGlossinessTexture;return a&&(r.baseColor=new v(v.linearToGammaSpace(a[0]),v.linearToGammaSpace(a[1]),v.linearToGammaSpace(a[2]),a[3])),o&&(r.baseTexture=i[o.index],Ll._parseTextureTransform(r,o.extensions,t)),s&&(r.specularColor=new v(v.linearToGammaSpace(s[0]),v.linearToGammaSpace(s[1]),v.linearToGammaSpace(s[2]))),void 0!==l&&(r.glossiness=l),u&&(r.specularGlossinessTexture=i[u.index],Ll._parseTextureTransform(r,u.extensions,t)),r},t}(Wl)),Ml("KHR_materials_unlit")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.createEngineResource=function(e,t){var n=t.engine;return new Ca(n)},t}(Wl)),Ml("KHR_materials_variants")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.parseEngineResource=function(e,t,n){for(var i=n.gltf.extensions.KHR_materials_variants.variants,r=n.materials,a=e.mappings,o=0;o<a.length;o++){var s=a[o],l=s.material,u=s.variants;n.variants||(n.variants=[]),n.variants.push({renderer:t,material:r[l],variants:u.map((function(e){return i[e].name}))})}},t}(Wl)),Ml("KHR_mesh_quantization")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t}(Wl)),Ml("KHR_texture_transform")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.parseEngineResource=function(e,t,n){var i=e.offset,r=e.rotation,a=e.scale,o=e.texCoord;i&&(t.tilingOffset.z=i[0],t.tilingOffset.w=i[1]),a&&(t.tilingOffset.x=a[0],t.tilingOffset.y=a[1]),r&&pe.warn("rotation in KHR_texture_transform is not supported now"),o&&pe.warn("texCoord in KHR_texture_transform is not supported now")},t}(Wl)),Ml("OASIS_materials_remap")(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.createEngineResource=function(e,t){return t.engine.resourceManager.getResourceByRef(e)},t}(Wl)),K(la.Material,["json"])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,dl(dl({},e),{},{type:"json"})).then((function(e){var n,r=t.engine,a=e.shader,s=e.shaderData,l=e.macros,u=e.renderState;switch(a){case"pbr":n=new va(r);break;case"pbr-specular":n=new ma(r);break;case"unlit":n=new Ca(r);break;case"blinn-phong":n=new pa(r)}var c=new Array,h=n.shaderData,_=function(e){var n=s[e],i=n.type,r=n.value;switch(i){case"Vector2":h.setVector2(e,new p(r.x,r.y));break;case"Vector3":h.setVector3(e,new o(r.x,r.y,r.z));break;case"Vector4":h.setVector4(e,new g(r.x,r.y,r.z,r.w));break;case"Color":h.setColor(e,new v(r.r,r.g,r.b,r.a));break;case"Float":h.setFloat(e,r);break;case"Texture":c.push(t.getResourceByRef(r).then((function(t){h.setTexture(e,t)})))}};for(var d in s)_(d);for(var f=0,m=l.length;f<m;f++){var y=l[f],x=y.name,w=y.value;null==w?h.enableMacro(x):h.enableMacro(x,w)}for(var b in u)n[b]=u[b];Promise.all(c).then((function(){i(n)}))}))}))},t}(da));var jl=function(){function e(e,t,n,i){void 0===t&&(t=0),void 0===i&&(i=!0),this.buffer=e,this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e),this._littleEndian=i,this._offset=t}var t=e.prototype;return t.nextUint8=function(){var e=this._dataView.getUint8(this._offset);return this._offset+=1,e},t.nextUint16=function(){var e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e},t.nextUint32=function(){var e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e},t.nextInt32=function(){var e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e},t.nextInt32Array=function(e){var t=new Int32Array(this.buffer,this._offset,e);return this._offset+=4*e,t},t.nextFloat32=function(){var e=this._dataView.getFloat32(this._offset,this._littleEndian);return this._offset+=4,e},t.nextFloat32Array=function(e){var t=new Float32Array(this.buffer,this._offset,e);return this._offset+=4*e,t},t.nextUint32Array=function(e){var t=new Uint32Array(this.buffer,this._offset,e);return this._offset+=4*e,t},t.nextUint8Array=function(e){var t=new Uint8Array(this.buffer,this._offset,e);return this._offset+=e,t},t.nextUint64=function(){var e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),n=e+Math.pow(2,32)*t;return this._offset+=8,n},t.nextStr=function(){var e=this.nextUint16(),t=new Uint8Array(this.buffer,this._offset,e);return this._offset+=e,Al.decodeText(t)},t.nextImageData=function(e){return this.buffer.slice(this._offset)},t.nextImagesData=function(e){for(var t=new Array(e),n=0;n<e;n++){var i=this._dataView.getUint32(this._offset,this._littleEndian);t[n]=i,this._offset+=4}for(var r=[],a=0;a<e;a++){var o=t[a],s=this.buffer.slice(this._offset,this._offset+o);this._offset+=o,r.push(s)}return r},t.skip=function(e){return this._offset+=e,this},t.scan=function(e,t){void 0===t&&(t=0);for(var n=this._offset,i=0;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,i)},ml(e,[{key:"offset",get:function(){return this._offset}}]),e}();jl.imageMapping={0:"image/png",1:"image/jpg",2:"image/webp",3:"ktx"};var Xl={};function Kl(e){return function(t){Xl[e]=t}}var ql=function(){function e(){this.totalLength=0,this.version=0,this.type="",this.name="",this.headerLength=0}return e.decode=function(t){var n=new DataView(t),i=n.getUint32(0,!0),r=n.getUint8(4),a=n.getUint16(5,!0),o=new Uint8Array(t,7,a),s=n.getUint16(7+a,!0),l=new Uint8Array(t,9+a,s),u=Al.decodeText(l),c=Al.decodeText(o),h=new e;return h.totalLength=i,h.name=u,h.type=c,h.version=r,h.headerLength=l.byteLength+o.byteLength+9,h},ml(e,[{key:"dataLength",get:function(){return this.totalLength-this.headerLength}}]),e}();function Yl(e,t){for(var n=new Array(t),i=0;i<t;i++)n[i]=new g(e[4*i],e[4*i+1],e[4*i+2],e[4*i+3]);return n}function Ql(e,t){for(var n=new Array(t),i=0;i<t;i++)n[i]=new o(e[3*i],e[3*i+1],e[3*i+2]);return n}function Jl(e,t){for(var n=new Array(t),i=0;i<t;i++)n[i]=new p(e[2*i],e[2*i+1]);return n}Kl("Mesh")(function(){function e(){}return e.decode=function(e,t){return new Promise((function(n){var i=new Fi(e),r=t.nextStr(),a=JSON.parse(r),o=4*Math.ceil(t.offset/4),s=new Float32Array(t.buffer,a.positions.start+o,(a.positions.end-a.positions.start)/4),l=s.length/3,u=Ql(s,l);if(i.setPositions(u),a.normals){var c=Ql(new Float32Array(t.buffer,a.normals.start+o,(a.normals.end-a.normals.start)/4),l);i.setNormals(c)}if(a.uvs){var h=new Float32Array(t.buffer,a.uvs.start+o,(a.uvs.end-a.uvs.start)/4);i.setUVs(Jl(h,l))}if(a.uv1){var _=new Float32Array(t.buffer,a.uv1.start+o,(a.uv1.end-a.uv1.start)/4);i.setUVs(Jl(_,l),1)}if(a.uv2){var d=new Float32Array(t.buffer,a.uv2.start+o,(a.uv2.end-a.uv2.start)/4);i.setUVs(Jl(d,l),2)}if(a.uv3){var f=new Float32Array(t.buffer,a.uv3.start+o,(a.uv3.end-a.uv3.start)/4);i.setUVs(Jl(f,l),3)}if(a.uv4){var p=new Float32Array(t.buffer,a.uv4.start+o,(a.uv4.end-a.uv4.start)/4);i.setUVs(Jl(p,l),4)}if(a.uv5){var g=new Float32Array(t.buffer,a.uv5.start+o,(a.uv5.end-a.uv5.start)/4);i.setUVs(Jl(g,l),5)}if(a.uv6){var m=new Float32Array(t.buffer,a.uv6.start+o,(a.uv6.end-a.uv6.start)/4);i.setUVs(Jl(m,l),6)}if(a.uv7){var y=new Float32Array(t.buffer,a.uv7.start+o,(a.uv7.end-a.uv7.start)/4);i.setUVs(Jl(y,l),7)}if(a.colors){var x=new Float32Array(t.buffer,a.colors.start+o,(a.colors.end-a.colors.start)/4);i.setColors(function(e,t){for(var n=new Array(t),i=0;i<t;i++)n[i]=new v(e[4*i],e[4*i+1],e[4*i+2],e[4*i+3]);return n}(x,l))}if(a.boneWeights){var w=new Float32Array(t.buffer,a.boneWeights.start+o,(a.boneWeights.end-a.boneWeights.start)/4);i.setBoneWeights(Yl(w,l))}if(a.boneIndices){var b=new Float32Array(t.buffer,a.boneIndices.start+o,(a.boneIndices.end-a.boneIndices.start)/4);i.setBoneIndices(Yl(b,l))}if(a.blendShapes&&a.blendShapes.forEach((function(e){var n=new Zi(e.name);e.frames.forEach((function(e){var i=new Float32Array(t.buffer,e.deltaPosition.start+o,(e.deltaPosition.end-e.deltaPosition.start)/4),r=i.length/3,a=Ql(i,r);e.deltaNormals&&Ql(new Float32Array(t.buffer,e.deltaNormals.start+o,(e.deltaNormals.end-e.deltaNormals.start)/4),r);e.deltaTangents&&Yl(new Float32Array(t.buffer,e.deltaTangents.start+o,(e.deltaTangents.end-e.deltaTangents.start)/4),r);n.addFrame(e.weight,a)})),i.addBlendShape(n)})),a.indices){var C=null;C=0===a.indices.type?new Uint16Array(t.buffer,a.indices.start+o,(a.indices.end-a.indices.start)/2):new Uint32Array(t.buffer,a.indices.start+o,(a.indices.end-a.indices.start)/4),i.setIndices(C)}a.subMeshes.forEach((function(e){i.addSubMesh(e)})),i.uploadData(!1),n(i)}))},e}()),Kl("Texture2D")(function(){function e(){}return e.decode=function(e,t){return new Promise((function(i,r){var a=t.nextStr(),o=!!t.nextUint8(),s=t.nextUint8(),l=t.nextUint8(),u=t.nextUint8(),c=t.nextUint8(),h=t.nextUint8(),_=t.nextUint16(),d=t.nextUint16(),f=t.nextUint8(),p=t.nextUint8(),g=t.nextImagesData(p),v=new Si(e,_,d,h,o);if(v.filterMode=s,v.anisoLevel=l,v.wrapModeU=u,v.wrapModeV=c,f){var m=new Uint8Array(g[0]);if(v.setPixelBuffer(m),o){v.generateMipmaps();for(var y=1;y<p;y++){var x=new Uint8Array(g[y]);v.setPixelBuffer(x,y)}}e.resourceManager._objectPool[a]=v,i(v)}else{var w=new n.polyfill.window.Blob([g[0]]),b=new n.polyfill.Image;b.onload=function(){v.setImageSource(b);var e=0,t=function(){++e>=p&&i(v)};if(t(),o){v.generateMipmaps();for(var r=function(e){var i=new n.polyfill.window.Blob([g[e]]),r=new n.polyfill.Image;r.onload=function(){v.setImageSource(r,e),t()},r.src=n.polyfill.URL.createObjectURL(i)},a=1;a<p;a++)r(a)}},b.src=n.polyfill.URL.createObjectURL(w)}}))},e}());var Zl=function(){function e(){}return e.parseEntity=function(t,n){var i=this;return e.getEntityByConfig(t,n).then((function(e){var r;e.isActive=null==(r=t.isActive)||r;var a=t.position,o=t.rotation,s=t.scale;a&&e.transform.setPosition(a.x,a.y,a.z),o&&e.transform.setRotation(o.x,o.y,o.z),s&&e.transform.setScale(s.x,s.y,s.z);for(var l=[],u=0;u<t.components.length;u++){var c=t.components[u],h=c.refId?c.refId:c.class,_=void 0;"Animator"===h&&(_=e.getComponent(da.getClass(h))),_=_||e.addComponent(da.getClass(h));var d=i.parsePropsAndMethods(_,c,n);l.push(d)}return Promise.all(l).then((function(){return e}))}))},e.getEntityByConfig=function(e,t){var n=e.assetRefId;if(n)return t.resourceManager.getResourceByRef({refId:n,key:e.key});var i=new et(t,e.name);return Promise.resolve(i)},e.parseClassObject=function(e,t,n){var i;void 0===n&&(n=t.resourceManager);var r=Cl(da.getClass(e.class),null!=(i=e.constructParams)?i:[]);return this.parsePropsAndMethods(r,e,t,n)},e.parseBasicType=function(e,t,n){var i=this;return void 0===n&&(n=t.resourceManager),Array.isArray(e)?Promise.all(e.map((function(e){return i.parseBasicType(e,t,n)}))):"object"==typeof e&&null!=e?this._isClass(e)?this.parseClassObject(e,t,n):this._isRef(e)?n.getResourceByRef(e):Promise.resolve(e):Promise.resolve(e)},e.parsePropsAndMethods=function(e,t,n,i){var r=this;void 0===i&&(i=n.resourceManager);var a=[];if(t.methods)for(var o in t.methods)for(var s=t.methods[o],l=0,u=s.length;l<u;l++){var c=s[l],h=this.parseMethod(e,o,c,n,i);a.push(h)}if(t.props){var _=function(i){var o=t.props[i],s=r.parseBasicType(o,n).then((function(t){return e[i]=t}));a.push(s)};for(var d in t.props)_(d)}return Promise.all(a).then((function(){return e}))},e.parseMethod=function(e,t,n,i,r){var a=this;return void 0===r&&(r=i.resourceManager),Promise.all(n.map((function(e){return a.parseBasicType(e,i,r)}))).then((function(n){return e[t].apply(e,n)}))},e._isClass=function(e){return null!=e.class},e._isRef=function(e){return null!=e.refId},e}(),$l=function(){function e(e){this._engine=e}return e.prototype.parse=function(t){for(var n,i={},r={},a=[],o=t.entities,s=Sl(o);!(n=s()).done;){var l=n.value;r[l.id]=l,a.push(Zl.parseEntity(l,this._engine))}return Promise.all(a).then((function(t){var n=o[0].id;return t.forEach((function(e,t){i[o[t].id]=e})),e.parseChildren(r,i,n),i[n]}))},e.parseChildren=function(e,t,n){var i=e[n].children;if(i&&i.length>0)for(var r=t[n],a=0;a<i.length;a++){var o=i[a],s=t[o];r.addChild(s),this.parseChildren(e,t,o)}},e}(),eu=function(){function e(){}return e.parse=function(e,t){for(var n,i=new pr(e),r={},a={},o=[],s=t.entities,l=Sl(s);!(n=l()).done;){var u=n.value;a[u.id]=u,o.push(Zl.parseEntity(u,e))}return Promise.all(o).then((function(e){var t=[];e.forEach((function(e,n){r[s[n].id]=e,s[n].parent||t.push(s[n].id)}));for(var n=0,o=t;n<o.length;n++){var l=o[n];$l.parseChildren(a,r,l)}for(var u=t.map((function(e){return r[e]})),c=0;c<u.length;c++)i.addRootEntity(u[c]);return i}))},e}();function tu(e,t){var n=ql.decode(e),i=new jl(e,n.headerLength,n.dataLength);return Xl[n.type].decode(t,i).then((function(e){return e.name=n.name,e}))}K("Mesh",["prefab"],!0)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,{type:"arraybuffer"}).then((function(e){tu(e,t.engine).then((function(e){i(e)}))}))}))},t}(da)),K("EditorTexture2D",["prefab"],!0)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i){n.request(e.url,{type:"arraybuffer"}).then((function(e){tu(e,t.engine).then((function(e){i(e)}))}))}))},t}(da)),K(la.Mesh,["mesh"])(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i){n.request(e.url,dl(dl({},e),{},{type:"arraybuffer"})).then((function(e){return tu(e,t.engine)})).then((function(e){i(e)}))}))},t}(da)),K(la.AnimatorController,["json"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this;return new j((function(i,r){n.request(e.url,dl(dl({},e),{},{type:"json"})).then(function(){var e=gl(fl().mark((function e(n){var r,a,o;return fl().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=new es,a=n.layers,o=[],a.forEach((function(e,n){var i=e.name,a=e.blendingMode,s=e.weight,l=e.stateMachine,u=new ts(i);if(u.blendingMode=a,u.weight=s,l){var c=l.states,h=u.stateMachine=new rs;c.forEach((function(e,i){var r=e.name,a=e.speed,s=e.wrapMode,l=e.clipStartNormalizedTime,u=e.clipEndNormalizedTime;e.isDefaultState;var c=e.clip,_=h.addState(r);_.speed=a,_.wrapMode=s,_.clipStartTime=l,_.clipEndTime=u,c&&o.push(new Promise(function(){var e=gl(fl().mark((function e(r){return fl().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=r,e.t1=n,e.t2=i,e.next=5,t.getResourceByRef(c);case 5:e.t3=e.sent,e.t4={layerIndex:e.t1,stateIndex:e.t2,clip:e.t3},(0,e.t0)(e.t4);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))})),c.forEach((function(e){var t=e.name;e.transitions.forEach((function(e){var n=e.targetStateName,i=e.duration,r=e.offset,a=e.exitTime,o=h.findStateByName(t),s=h.findStateByName(n),l=new Io;l.destinationState=s,l.duration=i,l.exitTime=a,l.offset=r,o.addTransition(l)}))}))}r.addLayer(u)})),Promise.all(o).then((function(e){e.forEach((function(e){var t=e.layerIndex,n=e.stateIndex,i=e.clip;r.layers[t].stateMachine.states[n].clip=i})),i(r)}));case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}))},t}(da)),K(la.Scene,["prefab"],!0)(function(e){function t(){return e.apply(this,arguments)||this}return xl(t,e),t.prototype.load=function(e,t){var n=this,i=t.engine;return new j((function(r,a){return n.request(e.url,{type:"json"}).then((function(e){return i.resourceManager.initVirtualResources(e.files),eu.parse(i,e).then((function(n){var a=e.scene.ambient,o=Promise.resolve();a.ambientLight&&(o=t.getResourceByRef(e.scene.ambient.ambientLight).then((function(e){n.ambientLight=e,n.ambientLight.diffuseIntensity=a.diffuseIntensity,n.ambientLight.specularIntensity=a.specularIntensity})));var s=e.scene.background;n.background.mode=s.mode;var l=Promise.resolve();switch(n.background.mode){case er.SolidColor:n.background.solidColor.copyFrom(s.color);break;case er.Sky:s.sky&&(l=t.getResourceByRef(s.sky).then((function(e){var t=n.background.sky,r=new hs(i);r.textureCubeMap=e.specularTexture,r.textureDecodeRGBM=!0,t.material=r,t.mesh=Yi.createCuboid(i,1,1,1)})));break;case er.Texture:s.texture&&(l=t.getResourceByRef(s.texture).then((function(e){n.background.texture=e})))}return Promise.all([o,l]).then((function(){r(n)}))}))})).catch(a)}))},t}(da));for(var nu in console.log("oasis engine version: 0.8.3"),Rs)da.registerClass(nu,Rs[nu]);exports.BoundingBox=s,exports.Camera=ia,exports.DirectLight=hr,exports.MathUtil=a,exports.MeshRenderer=Ki,exports.PlatformManager=n,exports.Script=Ir,exports.Vector2=p,exports.Vector3=o,exports.WebGLEngine=Qs;
